(function(){if("undefined"!==typeof document){var d=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenchange",!0,!1,null);document.dispatchEvent(a)},a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitfullscreenchange",d,!1);document.addEventListener("mozfullscreenchange",d,!1);document.addEventListener("MSFullscreenChange",d,!1);document.addEventListener("webkitfullscreenerror",
a,!1);document.addEventListener("mozfullscreenerror",a,!1);document.addEventListener("MSFullscreenError",a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen||function(){};document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.fullscreenElement||
Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.fullscreenEnabled||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();(function(d){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!d.requestAnimationFrame;++c)d.requestAnimationFrame=d[b[c]+"RequestAnimationFrame"],d.cancelAnimationFrame=d[b[c]+"CancelAnimationFrame"]||d[b[c]+"CancelRequestAnimationFrame"];d.requestAnimationFrame||(d.requestAnimationFrame=function(b){var c=(new Date).getTime(),f=Math.max(0,16-(c-a)),k=d.setTimeout(function(){b(c+f)},f);a=c+f;return k});d.cancelAnimationFrame||(d.cancelAnimationFrame=function(a){clearTimeout(a)});d.requestAnimFrame=
d.requestAnimationFrame})("undefined"===typeof exports?this:exports);/*
 PlayCanvas Engine v0.144.3 revision c4fa70340d9c
 http://playcanvas.com
 Copyright 2011-2013 PlayCanvas Ltd. All rights reserved.
 Do not distribute.
 Contains: https://github.com/tildeio/rsvp.js - see page for license information
*/
var pc={config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(d){var a,b=[],c=d.length;for(a=0;a<c;++a)b.push(d[a]);return b},type:function(d){if(null===d)return"null";var a=typeof d;return"undefined"==a||"number"==a||"string"==a||"boolean"==a?a:_typeLookup[Object.prototype.toString.call(d)]},extend:function(d,a){var b,c;for(b in a)c=a[b],d[b]="object"==pc.type(c)?pc.extend({},c):
"array"==pc.type(c)?pc.extend([],c):c;return d},isDefined:function(d){return void 0!==d}},_typeLookup=function(){var d={},a,b="Array Object Function Date RegExp Float32Array".split(" ");for(a=0;a<b.length;++a)d["[object "+b[a]+"]"]=b[a].toLowerCase();return d}();"undefined"!==typeof exports&&(exports.pc=pc);pc.extend(pc,function(){var d=function(){this.data=new Float32Array(4);3<=arguments.length?(this.data[0]=arguments[0],this.data[1]=arguments[1],this.data[2]=arguments[2],this.data[3]=4<=arguments.length?arguments[3]:1):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=1)};d.prototype={clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},set:function(a,b,c,e){var g=this.data;g[0]=a;
g[1]=b;g[2]=c;g[3]="undefined"===typeof e?1:e;return this},fromString:function(a){var b=parseInt(a.replace("#","0x"));7<a.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(parseInt(255*this.r)<<16)+(parseInt(255*this.g)<<8)+parseInt(255*this.b)).toString(16).slice(1);!0===a&&(a=parseInt(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}};Object.defineProperty(d.prototype,
"r",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"g",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"b",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d.prototype,"a",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});return{Color:d}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var a=16*Math.random()|0;return("x"==d?a:a&3|8).toString(16)})}}}();pc.time=function(){var d=function(){this._isRunning=!1;this._b=this._a=0};d.prototype.start=function(){this._isRunning=!0;this._a=(new Date).getTime()};d.prototype.stop=function(){this._isRunning=!1;this._b=(new Date).getTime()};d.prototype.getMilliseconds=function(){return this._b-this._a};return{Timer:d,now:function(){return(new Date).getTime()}}}();pc.extend(pc,function(){return{createURI:function(d){var a="";if((d.authority||d.scheme)&&(d.host||d.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(d.host&&d.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(d.path&&d.hostpath)throw Error("Can't have 'path' and 'hostpath' option");d.scheme&&(a+=d.scheme+":");d.authority&&(a+="//"+d.authority);d.host&&(a+=d.host);d.path&&(a+=d.path);d.hostpath&&(a+=d.hostpath);d.query&&(a+="?"+d.query);
d.fragment&&(a+="#"+d.fragment);return a},URI:function(d){d=d.match(/^(([^:\/?\#]+):)?(\/\/([^\/?\#]*))?([^?\#]*)(\?([^\#]*))?(\#(.*))?/);this.scheme=d[2];this.authority=d[4];this.path=d[5];this.query=d[7];this.fragment=d[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,b,c={};this.query&&(a=decodeURIComponent(this.query).split("&"),
a.forEach(function(a){b=a.split("=");c[b[0]]=b[1]},this));return c};this.setQuery=function(a){q="";for(var b in a)a.hasOwnProperty(b)&&(""!==q&&(q+="&"),q+=encodeURIComponent(b)+"="+encodeURIComponent(a[b]));this.query=q}}}}());pc.extend(pc,function(){return{log:{write:function(d){console.log(d)},open:function(){pc.log.write(Date());pc.log.info("Log opened")},info:function(d){console.info("INFO:    "+d)},debug:function(d){console.debug("DEBUG:   "+d)},error:function(d){console.error("ERROR:   "+d)},warning:function(d){console.warn("WARNING: "+d)},alert:function(d){pc.log.write("ALERT:   "+d);alert(d)},assert:function(d,a){!1===d&&(pc.log.write("ASSERT:  "+a),alert("ASSERT failed: "+a))}}}}());
var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;Function.prototype.extendsFrom=function(d){var a,b,c=function(){};a=this;b=function(){d.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=d.prototype;c.prototype=d.prototype;b.prototype=new c;return b};pc.extend(pc,function(){return{inherits:function(d,a){var b=function(){},c=function(){a.apply(this,arguments);d.apply(this,arguments);this.constructor=d};c._super=a.prototype;b.prototype=a.prototype;c.prototype=new b;return c}}}());Function.prototype.bind||(Function.prototype.bind=function(d){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var a=Array.prototype.slice.call(arguments,1),b=this,c=function(){},e=function(){return b.apply(this instanceof c?this:d||window,a.concat(Array.prototype.slice.call(arguments)))};c.prototype=this.prototype;e.prototype=new c;return e});pc.path=function(){return{delimiter:"/",join:function(){var d,a=arguments.length,b=arguments[0];for(d=0;d<a-1;++d){var c=arguments[d],e=arguments[d+1];if(!pc.isDefined(c)||!pc.isDefined(e))throw Error("undefined argument to pc.path.join");b=e[0]===pc.path.delimiter?e:c&&e&&c[c.length-1]!==pc.path.delimiter&&e[0]!==pc.path.delimiter?b+(pc.path.delimiter+e):b+e}return b},getDirectory:function(d){d=d.split(pc.path.delimiter);return d.slice(0,d.length-1).join(pc.path.delimiter)},getExtension:function(d){var a=
d.split(".").pop();return a!==d?"."+a:""},isRelativePath:function(d){return"/"!==d.charAt(0)&&null===d.match(/:\/\//)},extractPath:function(d){var a=".",b=d.split("/"),c=0;if(1<b.length){!1===pc.path.isRelativePath(d)&&(a="");for(c=0;c<b.length-1;++c)a+="/"+b[c]}return a}}}();pc.string=function(){return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(d){var a=0,b,c=pc.makeArray(arguments);c.shift();for(a=0;a<c.length;a++)b=RegExp("\\{"+a+"\\}","gi"),d=d.replace(b,c[a]);return d},startsWith:function(d,a){return 0===d.indexOf(a)},endsWith:function(d,a){return-1!==d.lastIndexOf(a,d.length-a.length)},toBool:function(d,a){if("true"===d)return!0;if(a){if("false"===
d)return!1;throw Error("Not a boolean string");}return!1}}}();pc.extend(pc,function(){return{json:{parse:function(d,a){return JSON.parse(d,a)},stringify:function(d,a,b){return JSON.stringify(d,function(b,e){this[b]instanceof Float32Array&&(e=pc.makeArray(this[b]));return a?a(b,e):e},b)}}}}());pc.cookie=function(){return{set:function(d,a,b){b=b||{};d=d+"="+a;b.path&&(d+=";path="+b.path);b.domain&&(d+=";domain="+b.domain);b.path&&(d+=";path="+b.path);b.secure&&(d+=";secure");d=b.lifetime?d+(";max-age="+86400*b.lifetime):d+";max-age=86400";document.cookie=d},get:function(d){var a,b=document.cookie.split(";"),c,e=b.length;for(c=0;c<e;c++)if(a=b[c].trim(),pc.string.startsWith(a,d))return a.split("=")[1]},remove:function(d,a){a.lifetime=0;pc.cookie.set(d,"",a)}}}();pc.debug=function(){var d=null,a=null,b=null,c=null;return{display:function(e){d||(d=document.createElement("table"),a=document.createElement("tr"),b=document.createElement("td"),c=document.createElement("td"),d.style.cssText="position:absolute;font-family:sans-serif;font-size:12px",d.style.top="0px",d.style.left="0px",d.style.border="thin solid black",document.body.appendChild(d));d.innerHTML="";for(var g in e){var f=a.cloneNode(),k=b.cloneNode(),l=c.cloneNode();k.textContent=g;l.textContent=e[g];
f.appendChild(k);f.appendChild(l);d.appendChild(f)}}}}();pc.extend(pc,function(){var d=function(a,b){this.objects=[];this.ctor=a;this.name=b.name;this.useNew="undefined"===typeof b.useNew||b.useNew;if(this.metrics=b.metrics)this.used=this.total=0};d.prototype={_construct:function(a,b){function c(){return a.apply(this,b)}c.prototype=a.prototype;return new c},allocate:function(){var a;this.objects.length?(a=this.objects.pop(),this.ctor.apply(a,arguments),this.metrics&&this.used++):(a=this.useNew?this._construct(this.ctor,arguments):this.ctor.apply(this,arguments),
this.metrics&&(this.total++,this.used++));return a},free:function(a){this.objects.push(a);this.metrics&&this.used--;if(a.onFree)a.onFree()},usage:function(){return pc.string.format("{0} - total: {1}, used: {2}",this.name,this.total,this.used)}};return{ObjectPool:d}}());pc.events=function(){var d={attach:function(a){var b=pc.events;a.on=b.on;a.off=b.off;a.fire=b.fire;a.hasEvent=b.hasEvent;a.bind=b.on;a.unbind=b.off;return a},on:function(a,b,c){if("string"!=pc.type(a))throw new TypeError("Event name must be a string");var e=this._callbacks||(this._callbacks={});(e[a]||(e[a]=[])).push({callback:b,scope:c||this});return this},off:function(a,b,c){var e=this._callbacks;if(e){if(b){a=e[a];if(!a)return this;for(e=0;e<a.length;e++)if(a[e].callback===b&&(!c||c===a[e].scope))a.splice(e,
1),e--}else e[a]=[];return this}},fire:function(a){var b,c,e=pc.makeArray(arguments),g;e.shift();if(this._callbacks&&this._callbacks[a]){g=this._callbacks[a].slice();c=g.length;for(b=0;b<c;++b)g[b].callback.apply(g[b].scope,e)}return this},hasEvent:function(a){return"undefined"!==typeof this._callbacks&&"undefined"!==typeof this._callbacks[a]&&0<this._callbacks[a].length}};d.bind=d.on;d.unbind=d.off;return d}();pc.dom=function(){return{getWidth:function(d){return d.offsetWidth},getHeight:function(d){return d.offsetHeight},setText:function(d,a){d.textContent?d.textContent=a:d.innerText&&(d.innerText=a)},getText:function(d){return d.textContent||d.innerText}}}();pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(d,a,b){return d>=b?b:d<=a?a:d},intToBytes24:function(d){return[d>>16&255,d>>8&255,d&255]},intToBytes32:function(d){return[d>>24&255,d>>16&255,d>>8&255,d&255]},bytesToInt24:function(d,a,b){d.length&&(b=d[2],a=d[1],d=d[0]);return d<<16|a<<8|b},bytesToInt32:function(d,a,b,c){d.length&&(c=d[3],b=d[2],a=d[1],d=d[0]);return(d<<24|a<<16|b<<8|c)>>>32},lerp:function(d,a,b){return d+(a-d)*pc.math.clamp(b,0,1)},lerpAngle:function(d,a,b){180<
a-d&&(a-=360);-180>a-d&&(a+=360);return pc.math.lerp(d,a,pc.math.clamp(b,0,1))},powerOfTwo:function(d){return 0!==d&&!(d&d-1)},random:function(d,a){return Math.random()*(a-d)+d},smoothstep:function(d,a,b){if(b<=d)return 0;if(b>=a)return 1;b=(b-d)/(a-d);return b*b*(3-2*b)},smootherstep:function(d,a,b){if(b<=d)return 0;if(b>=a)return 1;b=(b-d)/(a-d);return b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;pc.math.bytesToInt=pc.math.bytesToInt32;pc.extend(pc,function(){var d=function(){this.data=new Float32Array(2);2===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*
a[0]+b[1]*a[1]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);e[1]=a[1]+c*(b[1]-a[1]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];
return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;return this},set:function(a,b){var c=this.data;c[0]=a;c[1]=b;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1);return function(){return a}}()});Object.defineProperty(d,"RIGHT",{get:function(){var a=new d(1,0);return function(){return a}}()});Object.defineProperty(d,"UP",{get:function(){var a=new d(0,1);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0);return function(){return a}}()});
return{Vec2:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(3);3===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];return this},
cross:function(a,b){var c,e,g,d,k,l,n;c=a.data;e=b.data;g=this.data;d=c[0];k=c[1];c=c[2];l=e[0];n=e[1];e=e[2];g[0]=k*e-n*c;g[1]=c*l-e*d;g[2]=d*n-l*k;return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},lerp:function(a,
b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);e[1]=a[1]+c*(b[1]-a[1]);e[2]=a[2]+c*(b[2]-a[2]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];g[2]=c[2]*e[2];return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return this},set:function(a,b,c){var e=this.data;e[0]=a;e[1]=b;e[2]=
c;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];g[2]=c[2]-e[2];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=
a}});Object.defineProperty(d.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d,"BACK",{get:function(){var a=new d(0,0,1);return function(){return a}}()});Object.defineProperty(d,"DOWN",{get:function(){var a=new d(0,-1,0);return function(){return a}}()});Object.defineProperty(d,"FORWARD",{get:function(){var a=new d(0,0,-1);return function(){return a}}()});Object.defineProperty(d,"LEFT",{get:function(){var a=new d(-1,0,0);return function(){return a}}()});
Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1,1);return function(){return a}}()});Object.defineProperty(d,"RIGHT",{get:function(){var a=new d(1,0,0);return function(){return a}}()});Object.defineProperty(d,"UP",{get:function(){var a=new d(0,1,0);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0);return function(){return a}}()});return{Vec3:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(4);4===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0)};d.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return this},add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];g[3]=c[3]+e[3];return this},clone:function(){return(new d).copy(this)},copy:function(a){var b=this.data,a=a.data;
b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,c){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+c*(b[0]-a[0]);
e[1]=a[1]+c*(b[1]-a[1]);e[2]=a[2]+c*(b[2]-a[2]);e[3]=a[3]+c*(b[3]-a[3]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return this},mul2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]*e[0];g[1]=c[1]*e[1];g[2]=c[2]*e[2];g[3]=c[3]*e[3];return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return this},set:function(a,b,c,e){var g=this.data;g[0]=a;g[1]=b;g[2]=
c;g[3]=e;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return this},sub2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]-e[0];g[1]=c[1]-e[1];g[2]=c[2]-e[2];g[3]=c[3]-e[3];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+", "+this.data[3]+"]"}};Object.defineProperty(d.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(d.prototype,"y",{get:function(){return this.data[1]},
set:function(a){this.data[1]=a}});Object.defineProperty(d.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(d.prototype,"w",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(d,"ONE",{get:function(){var a=new d(1,1,1,1);return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0);return function(){return a}}()});return{Vec4:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(9);9===arguments.length?this.data.set(arguments):this.setIdentity()};d.prototype={clone:function(){return(new pc.Mat3).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(){},isIdentity:function(){},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=
1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=9!==b?", ":"";return a+"]"},transpose:function(){var a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat3:d}}());pc.extend(pc,function(){var d=function(){this.data=new Float32Array(16);16===arguments.length?this.data.set(arguments):this.setIdentity()},a,b,c;a=new pc.Vec3;b=new pc.Vec3;c=new pc.Vec3;var e,g,f;e=new pc.Vec3;g=new pc.Vec3;f=new pc.Vec3;var k=new pc.Vec3;d.prototype={add2:function(a,b){var c=a.data,e=b.data,g=this.data;g[0]=c[0]+e[0];g[1]=c[1]+e[1];g[2]=c[2]+e[2];g[3]=c[3]+e[3];g[4]=c[4]+e[4];g[5]=c[5]+e[5];g[6]=c[6]+e[6];g[7]=c[7]+e[7];g[8]=c[8]+e[8];g[9]=c[9]+e[9];g[10]=c[10]+e[10];g[11]=c[11]+
e[11];g[12]=c[12]+e[12];g[13]=c[13]+e[13];g[14]=c[14]+e[14];g[15]=c[15]+e[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===
a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c,e,g,d,f,k,z,v,w,A,B,E,C,H,x,y,D,K,G,I;y=a.data;var J=b.data,L=this.data;c=y[0];e=y[1];g=y[2];
d=y[3];f=y[4];k=y[5];z=y[6];v=y[7];w=y[8];A=y[9];B=y[10];E=y[11];C=y[12];H=y[13];x=y[14];y=y[15];D=J[0];K=J[1];G=J[2];I=J[3];L[0]=c*D+f*K+w*G+C*I;L[1]=e*D+k*K+A*G+H*I;L[2]=g*D+z*K+B*G+x*I;L[3]=d*D+v*K+E*G+y*I;D=J[4];K=J[5];G=J[6];I=J[7];L[4]=c*D+f*K+w*G+C*I;L[5]=e*D+k*K+A*G+H*I;L[6]=g*D+z*K+B*G+x*I;L[7]=d*D+v*K+E*G+y*I;D=J[8];K=J[9];G=J[10];I=J[11];L[8]=c*D+f*K+w*G+C*I;L[9]=e*D+k*K+A*G+H*I;L[10]=g*D+z*K+B*G+x*I;L[11]=d*D+v*K+E*G+y*I;D=J[12];K=J[13];G=J[14];I=J[15];L[12]=c*D+f*K+w*G+C*I;L[13]=e*D+
k*K+A*G+H*I;L[14]=g*D+z*K+B*G+x*I;L[15]=d*D+v*K+E*G+y*I;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*c[0]+e[1]*c[4]+e[2]*c[8]+c[12],e[0]*c[1]+e[1]*c[5]+e[2]*c[9]+c[13],e[0]*c[2]+e[1]*c[6]+e[2]*c[10]+c[14])},transformVector:function(a,b){var c=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*c[0]+e[1]*c[4]+e[2]*c[8],e[0]*c[1]+e[1]*c[5]+e[2]*c[9],e[0]*c[2]+e[1]*c[6]+e[2]*c[10])},
setLookAt:function(e,g,d){c.sub2(e,g).normalize();b.copy(d).normalize();a.cross(b,c).normalize();b.cross(c,a);g=this.data;g[0]=a.x;g[1]=a.y;g[2]=a.z;g[3]=0;g[4]=b.x;g[5]=b.y;g[6]=b.z;g[7]=0;g[8]=c.x;g[9]=c.y;g[10]=c.z;g[11]=0;g[12]=e.x;g[13]=e.y;g[14]=e.z;g[15]=1;return this},setFrustum:function(a,b,c,e,g,d){var f,k,z,v,w;f=2*g;k=b-a;z=e-c;v=d-g;w=this.data;w[0]=f/k;w[1]=0;w[2]=0;w[3]=0;w[4]=0;w[5]=f/z;w[6]=0;w[7]=0;w[8]=(b+a)/k;w[9]=(e+c)/z;w[10]=(-d-g)/v;w[11]=-1;w[12]=0;w[13]=0;w[14]=-f*d/v;w[15]=
0;return this},setPerspective:function(a,b,c,e){a=c*Math.tan(a*Math.PI/360);b*=a;return this.setFrustum(-b,b,-a,a,c,e)},setOrtho:function(a,b,c,e,g,d){var f=this.data;f[0]=2/(b-a);f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/(e-c);f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/(d-g);f[11]=0;f[12]=-(b+a)/(b-a);f[13]=-(e+c)/(e-c);f[14]=-(d+g)/(d-g);f[15]=1;return this},setFromAxisAngle:function(a,b){var c,e,g,d,f,k,z,v,w,b=b*pc.math.DEG_TO_RAD;c=a.x;e=a.y;g=a.z;d=Math.cos(b);f=Math.sin(b);k=1-d;z=k*c;v=k*e;w=this.data;
w[0]=z*c+d;w[1]=z*e+f*g;w[2]=z*g-f*e;w[3]=0;w[4]=z*e-f*g;w[5]=v*e+d;w[6]=v*g+f*c;w[7]=0;w[8]=z*g+f*e;w[9]=v*g-c*f;w[10]=k*g*g+d;w[11]=0;w[12]=0;w[13]=0;w[14]=0;w[15]=1;return this},setTranslate:function(a,b,c){var e=this.data;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=a;e[13]=b;e[14]=c;e[15]=1;return this},setScale:function(a,b,c){var e=this.data;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=c;e[11]=0;e[12]=0;e[13]=0;e[14]=
0;e[15]=1;return this},invert:function(){var a,b,c,e,g,d,f,k,z,v,w,A,B,E,C,H,x,y,D,K,G,I,J,L,N,P,Q,R,O,M;M=this.data;a=M[0];b=M[1];c=M[2];e=M[3];g=M[4];d=M[5];f=M[6];k=M[7];z=M[8];v=M[9];w=M[10];A=M[11];B=M[12];E=M[13];C=M[14];H=M[15];x=a*d-b*g;y=a*f-c*g;D=a*k-e*g;K=b*f-c*d;G=b*k-e*d;I=c*k-e*f;J=z*E-v*B;L=z*C-w*B;N=z*H-A*B;P=v*C-w*E;Q=v*H-A*E;R=w*H-A*C;O=1/(x*R-y*Q+D*P+K*N-G*L+I*J);M[0]=(d*R-f*Q+k*P)*O;M[1]=(-b*R+c*Q-e*P)*O;M[2]=(E*I-C*G+H*K)*O;M[3]=(-v*I+w*G-A*K)*O;M[4]=(-g*R+f*N-k*L)*O;M[5]=(a*
R-c*N+e*L)*O;M[6]=(-B*I+C*D-H*y)*O;M[7]=(z*I-w*D+A*y)*O;M[8]=(g*Q-d*N+k*J)*O;M[9]=(-a*Q+b*N-e*J)*O;M[10]=(B*G-E*D+H*x)*O;M[11]=(-z*G+v*D-A*x)*O;M[12]=(-g*P+d*L-f*J)*O;M[13]=(a*P-b*L+c*J)*O;M[14]=(-B*K+E*y-C*x)*O;M[15]=(z*K-v*y+w*x)*O;return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var e,g,d,f,k,z,v,w,A,B,E,C,H;e=a.x;g=a.y;a=a.z;d=b.x;f=b.y;k=
b.z;z=b.w;b=c.x;v=c.y;c=c.z;w=d+d;A=f+f;B=k+k;E=d*w;C=d*A;d*=B;H=f*A;f*=B;k*=B;w*=z;A*=z;z*=B;B=this.data;B[0]=(1-(H+k))*b;B[1]=(C+z)*b;B[2]=(d-A)*b;B[3]=0;B[4]=(C-z)*v;B[5]=(1-(E+k))*v;B[6]=(f+w)*v;B[7]=0;B[8]=(d+A)*c;B[9]=(f-w)*c;B[10]=(1-(E+H))*c;B[11]=0;B[12]=e;B[13]=g;B[14]=a;B[15]=1;return this},transpose:function(){var a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},
invertTo3x3:function(a){var b,c,e,g,d,f,k,z,v,w;v=this.data;w=a.data;a=v[10]*v[5]-v[6]*v[9];b=-v[10]*v[1]+v[2]*v[9];c=v[6]*v[1]-v[2]*v[5];e=-v[10]*v[4]+v[6]*v[8];g=v[10]*v[0]-v[2]*v[8];d=-v[6]*v[0]+v[2]*v[4];f=v[9]*v[4]-v[5]*v[8];k=-v[9]*v[0]+v[1]*v[8];z=v[5]*v[0]-v[1]*v[4];v=v[0]*a+v[1]*e+v[2]*f;if(0===v)return console.warn("pc.Mat4#invertTo3x3: Matrix not invertible"),this;v=1/v;w[0]=v*a;w[1]=v*b;w[2]=v*c;w[3]=v*e;w[4]=v*g;w[5]=v*d;w[6]=v*f;w[7]=v*k;w[8]=v*z;return this},getTranslation:function(a){a=
void 0===a?new pc.Vec3:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(a){a=void 0===a?new pc.Vec3:a;this.getX(e);this.getY(g);this.getZ(f);a.set(e.length(),g.length(),f.length());
return a},setFromEulerAngles:function(a,b,c){var e,g,d,f,a=a*pc.math.DEG_TO_RAD,b=b*pc.math.DEG_TO_RAD,c=c*pc.math.DEG_TO_RAD;e=Math.sin(-a);a=Math.cos(-a);g=Math.sin(-b);b=Math.cos(-b);d=Math.sin(-c);c=Math.cos(-c);f=this.data;f[0]=b*c;f[1]=-b*d;f[2]=g;f[3]=0;f[4]=a*d+c*e*g;f[5]=a*c-e*g*d;f[6]=-b*e;f[7]=0;f[8]=e*d-a*c*g;f[9]=c*e+a*g*d;f[10]=a*b;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return this},getEulerAngles:function(a){var b,c,e,g,d,f,a=void 0===a?new pc.Vec3:a;this.getScale(k);e=k.x;b=k.y;g=
k.z;d=this.data;c=Math.asin(-d[2]/e);f=0.5*Math.PI;c<f?c>-f?(b=Math.atan2(d[6]/b,d[10]/g),e=Math.atan2(d[1]/e,d[0]/e)):(e=0,b=-Math.atan2(d[4]/b,d[5]/b)):(e=0,b=Math.atan2(d[4]/b,d[5]/b));return a.set(b,c,e).scale(pc.math.RAD_TO_DEG)},toString:function(){var a,b;b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,"ZERO",{get:function(){var a=new d(0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat4:d}}());pc.extend(pc,function(){var d=function(a,b,c,e){this.x=void 0===a?0:a;this.y=void 0===b?0:b;this.z=void 0===c?0:c;this.w=void 0===e?1:e};d.prototype={clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getEulerAngles:function(a){var b,c,e,g,d,k,a=void 0===a?new pc.Vec3:
a;e=this.x;g=this.y;d=this.z;k=this.w;c=2*(k*g-e*d);-0.99999>=c?(b=2*Math.atan2(e,k),c=-Math.PI/2,e=0):0.99999<=c?(b=2*Math.atan2(e,k),c=Math.PI/2,e=0):(b=Math.atan2(2*(k*e+g*d),1-2*(e*e+g*g)),c=Math.asin(c),e=Math.atan2(2*(k*d+e*g),1-2*(g*g+d*d)));return a.set(b,c,e).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){var a,b,c,e;a=this.x;b=this.y;c=this.z;e=this.w;return Math.sqrt(a*a+b*b+c*c+e*e)},lengthSq:function(){var a=this.data;return a[0]*a[0]+
a[1]*a[1]+a[2]*a[2]},mul:function(a){var b,c,e,g,d,k,l;b=this.x;c=this.y;e=this.z;g=this.w;d=a.x;k=a.y;l=a.z;a=a.w;this.x=g*d+b*a+c*l-e*k;this.y=g*k+c*a+e*d-b*l;this.z=g*l+e*a+b*k-c*d;this.w=g*a-b*d-c*k-e*l;return this},mul2:function(a,b){var c,e,g,d,k,l,n,r;c=a.x;e=a.y;g=a.z;d=a.w;k=b.x;l=b.y;n=b.z;r=b.w;this.x=d*k+c*r+e*n-g*l;this.y=d*l+e*r+g*k-c*n;this.z=d*n+g*r+c*l-e*k;this.w=d*r-c*k-e*l-g*n;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=
a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,e){this.x=a;this.y=b;this.z=c;this.w=e;return this},setFromAxisAngle:function(a,b){var c,e,b=b*0.5*pc.math.DEG_TO_RAD;c=Math.sin(b);e=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=c*a.z;this.w=e;return this},setFromEulerAngles:function(a,b,c){var e,g,d;e=0.5*pc.math.DEG_TO_RAD;a*=e;b*=e;c*=e;e=Math.sin(a);a=Math.cos(a);g=Math.sin(b);b=Math.cos(b);d=Math.sin(c);c=Math.cos(c);this.x=e*b*c-a*g*d;this.y=a*g*c+e*b*d;this.z=a*b*d-e*g*c;this.w=
a*b*c+e*g*d;return this},setFromMat4:function(a){var b,c,e,g,d,k,l,n,r,m,s,a=a.data;b=a[0];c=a[1];e=a[2];g=a[4];d=a[5];k=a[6];l=a[8];n=a[9];a=a[10];r=1/Math.sqrt(b*b+c*c+e*e);m=1/Math.sqrt(g*g+d*d+k*k);s=1/Math.sqrt(l*l+n*n+a*a);b*=r;c*=r;e*=r;g*=m;d*=m;k*=m;l*=s;n*=s;a*=s;r=b+d+a;0<=r?(b=Math.sqrt(r+1),this.w=0.5*b,b=0.5/b,this.x=(k-n)*b,this.y=(l-e)*b,this.z=(c-g)*b):b>d?b>a?(b=Math.sqrt(b-(d+a)+1),this.x=0.5*b,b=0.5/b,this.w=(k-n)*b,this.y=(c+g)*b,this.z=(e+l)*b):(b=Math.sqrt(a-(b+d)+1),this.z=
0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(l+e)*b,this.y=(n+k)*b):d>a?(b=Math.sqrt(d-(a+b)+1),this.y=0.5*b,b=0.5/b,this.w=(l-e)*b,this.z=(k+n)*b,this.x=(g+c)*b):(b=Math.sqrt(a-(b+d)+1),this.z=0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(l+e)*b,this.y=(n+k)*b);return this},slerp:function(a,b,c){var e,g,d,k,l,n,r,m,s,h;e=a.x;g=a.y;d=a.z;a=a.w;k=b.x;l=b.y;n=b.z;b=b.w;r=e*k+g*l+d*n+a*b;(s=0>r)&&(r*=-1);h=1-c;1>r&&(r=Math.acos(r),m=1/Math.sin(r),h=Math.sin(r*h)*m,c=Math.sin(r*c)*m,s&&(c=-c));this.x=h*e+c*k;this.y=h*
g+c*l;this.z=h*d+c*n;this.w=h*a+c*b;return this},transformVector:function(a,b){"undefined"===typeof b&&(b=new pc.Vec3);var c=a.x,e=a.y,g=a.z,d=this.x,k=this.y,l=this.z,n=this.w,r=n*c+k*g-l*e,m=n*e+l*c-d*g,s=n*g+d*e-k*c,c=-d*c-k*e-l*g;b.x=r*n+c*-d+m*-l-s*-k;b.y=m*n+c*-k+s*-d-r*-l;b.z=s*n+c*-l+r*-k-m*-d;return b},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};Object.defineProperty(d,"IDENTITY",{get:function(){var a=new d;return function(){return a}}()});Object.defineProperty(d,
"ZERO",{get:function(){var a=new d(0,0,0,0);return function(){return a}}()});return{Quat:d}}());pc.shape=function(){var d=function(){};d.prototype={containsPoint:function(){throw Error("Shape hasn't implemented containsPoint");}};return{Shape:d,Type:{CAPSULE:"Capsule",CONE:"Cone",CYLINDER:"Cylinder",CIRCLE:"Circle",RECT:"Rect"}}}();pc.shape.intersection=function(){return{aabbAabb:function(d,a){var b=d.getMax(),c=d.getMin(),e=a.getMax(),g=a.getMin();return c[0]<=e[0]&&b[0]>=g[0]&&c[1]<=e[1]&&b[1]>=g[1]&&c[2]<=e[2]&&b[2]>=g[2]},rayAabb:function(d,a,b){var c=new pc.Vec3,e,g=new pc.Vec3;e=new pc.Vec3;c.sub2(d,b.center);d=new pc.Vec3(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z));e.mul2(c,a);if(d.x>b.halfExtents.x&&0<=e.x||d.y>b.halfExtents.y&&0<=e.y||d.z>b.halfExtents.z&&0<=e.z)return!1;e=new pc.Vec3(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));
g.cross(a,c);g.set(Math.abs(g.x),Math.abs(g.y),Math.abs(g.z));return g.x>b.halfExtents.y*e.z+b.halfExtents.z*e.y||g.y>b.halfExtents.x*e.z+b.halfExtents.z*e.x||g.z>b.halfExtents.x*e.y+b.halfExtents.y*e.x?!1:!0},raySphere:function(d,a,b,c){var e=new pc.Vec3,g=0,f=0,k=0,k=0,c=c||{};e.sub2(d,b.center);if(e.dot(e)<b.radius*b.radius)return c.success=!0,c.t=0,!0;g=a.dot(a);f=2*a.dot(e);k=b.center.dot(b.center);k+=d.dot(d);k-=2*b.center.dot(d);k-=b.radius*b.radius;k=f*f-4*g*k;if(0>k)return c.success=!1,c.t=
0,!1;c.success=!0;c.t=(-f-Math.sqrt(k))/(2*g);return!0},rayTriangle:function(d,a,b,c){var e=d.clone().sub(b.v0),e=-b.n.dot(e),g=b.n.dot(a);if(1E-8>Math.fabs(g))return 0===e?2:0;e/=g;if(0>e)return 0;a=a.clone().scale(e);c.add2(d,a);c=(new pc.Vec3).sub2(c,b.v0);d=c.dot(b.u);c=c.dot(b.v);a=(b.uv*c-b.vv*d)/b.d;if(0>a||1<a)return 0;b=(b.uv*d-b.uu*c)/b.d;return 0>b||1<a+b?0:1}}}();pc.extend(pc.shape,function(){pc.shape.Type.AABB="Aabb";var d=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(0.5,0.5,0.5);this.type=pc.shape.Type.AABB},d=pc.inherits(d,pc.shape.Shape);d.prototype.add=function(a){var b=this.center,c=this.halfExtents,e=b.x-c.x,g=b.x+c.x,d=b.y-c.y,k=b.y+c.y,l=b.z-c.z,n=b.z+c.z,r=a.center,m=a.halfExtents,a=r.x-m.x,s=r.x+m.x,h=r.y-m.y,u=r.y+m.y,F=r.z-m.z,r=r.z+m.z;a<e&&(e=a);s>g&&(g=s);h<d&&(d=h);u>k&&(k=u);F<l&&(l=F);r>n&&(n=r);b.set(e+
g,d+k,l+n).scale(0.5);c.set(g-e,k-d,n-l).scale(0.5)};d.prototype.copy=function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type};d.prototype.setMinMax=function(a,b){this.center.add2(b,a).scale(0.5);this.halfExtents.sub2(b,a).scale(0.5)};d.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)};d.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)};d.prototype.containsPoint=function(a){var b=this.getMin(),c=this.getMax(),
e;for(e=0;3>e;++e)if(a.data[e]<b.data[e]||a.data[e]>c.data[e])return!1;return!0};d.prototype.setFromTransformedAabb=function(a,b){var c=this.center,e=this.halfExtents,d=a.center.data,f=a.halfExtents.data,b=b.data,k=b[0],l=b[4],n=b[8],r=b[1],m=b[5],s=b[9],h=b[2],u=b[6],F=b[10],z=Math.abs(k),v=Math.abs(l),w=Math.abs(n),A=Math.abs(r),B=Math.abs(m),E=Math.abs(s),C=Math.abs(h),H=Math.abs(u),x=Math.abs(F);c.set(b[12]+k*d[0]+l*d[1]+n*d[2],b[13]+r*d[0]+m*d[1]+s*d[2],b[14]+h*d[0]+u*d[1]+F*d[2]);e.set(z*f[0]+
v*f[1]+w*f[2],A*f[0]+B*f[1]+E*f[2],C*f[0]+H*f[1]+x*f[2])};d.prototype.compute=function(a){for(var b=new pc.Vec3(a[0],a[1],a[2]),c=new pc.Vec3(a[0],a[1],a[2]),e=a.length/3,d=1;d<e;d++){var f=a[3*d+0],k=a[3*d+1],l=a[3*d+2];f<b.x&&(b.x=f);k<b.y&&(b.y=k);l<b.z&&(b.z=l);f>c.x&&(c.x=f);k>c.y&&(c.y=k);l>c.z&&(c.z=l)}this.setMinMax(b,c)};return{Aabb:d}}());pc.extend(pc.shape,function(){function d(a,b){this.transform="undefined"===typeof a?new pc.Mat4:a;this.halfExtents="undefined"===typeof b?new pc.Vec3(0.5,0.5,0.5):b;this.type=pc.shape.Type.BOX}pc.shape.Type.BOX="Box";var a=new pc.Vec3,b=new pc.Vec3,c=new pc.Mat4,e=new pc.Mat4,d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(d){this.transform.getTranslation(a);var f=this.getHalfExtents();c.copy(this.transform);b.copy(f).scale(2);e.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,b);c.mul(e).invert();
c.transformPoint(d,b);return-0.5>b.x||0.5<b.x||-0.5>b.y||0.5<b.y||-0.5>b.z||0.5<b.z?!1:!0};d.prototype.getHalfExtents=function(){return this.halfExtents};return{Box:d}}());pc.extend(pc.shape,function(){pc.shape.Type.FRUSTUM="Frustum";var d=new pc.Mat4,a=function(a,c){a=a||(new pc.Mat4).setPerspective(90,16/9,0.1,1E3);c=c||new pc.Mat4;this.planes=[];for(var e=0;6>e;e++)this.planes[e]=[];this.update(a,c);this.type=pc.shape.Type.FRUSTUM},a=pc.inherits(a,pc.shape.Shape);a.prototype.update=function(a,c){d.mul2(a,c);var e=d.data;this.planes[0][0]=e[3]-e[0];this.planes[0][1]=e[7]-e[4];this.planes[0][2]=e[11]-e[8];this.planes[0][3]=e[15]-e[12];t=Math.sqrt(this.planes[0][0]*
this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=t;this.planes[0][1]/=t;this.planes[0][2]/=t;this.planes[0][3]/=t;this.planes[1][0]=e[3]+e[0];this.planes[1][1]=e[7]+e[4];this.planes[1][2]=e[11]+e[8];this.planes[1][3]=e[15]+e[12];t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=t;this.planes[1][1]/=t;this.planes[1][2]/=t;this.planes[1][3]/=t;this.planes[2][0]=
e[3]+e[1];this.planes[2][1]=e[7]+e[5];this.planes[2][2]=e[11]+e[9];this.planes[2][3]=e[15]+e[13];t=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=t;this.planes[2][1]/=t;this.planes[2][2]/=t;this.planes[2][3]/=t;this.planes[3][0]=e[3]-e[1];this.planes[3][1]=e[7]-e[5];this.planes[3][2]=e[11]-e[9];this.planes[3][3]=e[15]-e[13];t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+
this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=t;this.planes[3][1]/=t;this.planes[3][2]/=t;this.planes[3][3]/=t;this.planes[4][0]=e[3]-e[2];this.planes[4][1]=e[7]-e[6];this.planes[4][2]=e[11]-e[10];this.planes[4][3]=e[15]-e[14];t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=t;this.planes[4][1]/=t;this.planes[4][2]/=t;this.planes[4][3]/=t;this.planes[5][0]=e[3]+e[2];this.planes[5][1]=e[7]+e[6];this.planes[5][2]=
e[11]+e[10];this.planes[5][3]=e[15]+e[14];t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=t;this.planes[5][1]/=t;this.planes[5][2]/=t;this.planes[5][3]/=t};a.prototype.containsPoint=function(a){for(var c=0;6>c;c++)if(0>=this.planes[c][0]*a.x+this.planes[c][1]*a.y+this.planes[c][2]*a.z+this.planes[c][3])return!1;return!0};a.prototype.containsSphere=function(a){var c=0,e;for(p=0;6>p;p++){e=this.planes[p][0]*
a.center.x+this.planes[p][1]*a.center.y+this.planes[p][2]*a.center.z+this.planes[p][3];if(e<=-a.radius)return 0;e>a.radius&&c++}return 6===c?2:1};return{Frustum:a}}());pc.extend(pc.shape,function(){pc.shape.Type.PLANE="Plane";var d=function(a,b){this.normal=b||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0);this.d=-this.normal.dot(this.point);this.type=pc.shape.Type.PLANE},d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(){return!1};d.prototype.distance=function(a){return this.normal.dot(a)+this.d};d.prototype.intersect=function(a,b){var c=this.distance(a),e=this.distance(b);return c/(c-e)};d.prototype.intersectPosition=function(a,b){var c=
this.intersect(a,b),e=new pc.Vec3;e.lerp(a,b,c);return e};return{Plane:d}}());pc.extend(pc.shape,function(){function d(a,b){this.center=void 0===a?new pc.Vec3(0,0,0):a;this.radius=void 0===b?1:b;this.type=pc.shape.Type.SPHERE}pc.shape.Type.SPHERE="Sphere";var d=pc.inherits(d,pc.shape.Shape),a=d.prototype,b=new pc.Vec3;a.containsPoint=function(a){var a=b.sub2(a,this.center).lengthSq(),e=this.radius;return a<e*e};d.prototype.compute=function(a){var b,d=a.length/3,f=new pc.Vec3(0,0,0),k=new pc.Vec3(0,0,0),l=new pc.Vec3(0,0,0);for(b=0;b<d;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),l.addSelf(f),
0===b%100&&(l.scale(1/d),k.add(l),l.set(0,0,0));l.scale(1/d);k.add(l);this.center.copy(k);k=0;l=new pc.Vec3(0,0,0);for(b=0;b<d;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),l.sub2(f,this.center),k=Math.max(l.lengthSq(),k);this.radius=Math.sqrt(k)};return{Sphere:d}}());pc.extend(pc.shape,function(){pc.shape.Type.TORUS="Torus";var d=function(a,b,c){this.transform=a;this.iradius=b;this.oradius=c;this.type=pc.shape.Type.TORUS},d=pc.inherits(d,pc.shape.Shape);d.prototype.containsPoint=function(){throw Error("Not implemented yet");};return{Torus:d}}());pc.resources={};pc.extend(pc.resources,function(){var d=function(){"undefined"===typeof window.RSVP&&logERROR("Missing RSVP library");this._types={};this._handlers={};this._requests={};this._cache={};this._hashes={};this._canonicals={};this._sequence=this._loaded=this._requested=0;this.cache=!0;pc.events.attach(this)};d.prototype={createFileRequest:function(a,c){return new this._types[c](a)},registerHandler:function(a,c){var e=new a;if(""===e.type)throw Error("ResourceRequests must have a type");this._types[e.type]=
a;this._handlers[e.type]=c;c.setLoader(this)},request:function(a,c){var c=c||{},e=this,d=c.parent;c.cache=e.cache;return new RSVP.Promise(function(f,k){var l,n;void 0===a.length&&(a=[a]);var r=[],m=[];l=0;for(n=a.length;l<n;l++){var s=e._findExistingRequest(a[l]);s!==a[l]&&(s.data=a[l].data);e._makeCanonical(s);m.push(e._request(s,c));r.push(s);d&&d.children.push(s)}var h=function(a,b){var c=[],d=[];b.forEach(function(a){a.children.forEach(function(a){d.push(a);c.push.apply(c,a.promises)})});c.length?
RSVP.all(c).then(function(){h(a,d,c)},function(a){k(a)}):(e.fire("complete",a),f(a))};RSVP.all(m).then(function(a){h(a,r,m)},function(a){k(a)})})},open:function(a,c,e){a=new a;return this._handlers[a.type].open(c,a,e)},registerHash:function(a,c){this._hashes[c]||(this._hashes[c]=a);this._canonicals[a]||(this._canonicals[a]=c)},getHash:function(a){return this._hashes[a]},addToCache:function(a,c){var e=this.getHash(a);e&&(this._cache[e]=c)},getFromCache:function(a){return(a=this.getHash(a))?this._cache[a]:
null},removeFromCache:function(a){if(a=this.getHash(a))delete this._cache[a];else return null},resetProgress:function(){this._loaded=this._requested=0},_request:function(a,c){var e=this,d={};for(key in c)d[key]=c[key];null===a.id&&(a.id=this._sequence++);this.fire("request",a);a.promises.length?a.promises.push(new RSVP.Promise(function(c){a.promises[0].then(function(d){d=e._postOpen(d,a);c(d)})})):a.promises[0]=new RSVP.Promise(function(c,k){var l=e._handlers[a.type];if(l){var n=e.getFromCache(a.canonical);
n&&(void 0===a.Type||n instanceof a.Type)?(n=e._postOpen(n,a),c(n)):l.load(a,d).then(function(l){try{var m=e._open(l,a,d);m&&(m=e._postOpen(m,a));c(m)}catch(n){k(n)}},function(c){e.fire("error",a,c);k(c)})}else l="Missing handler for type: "+a.type,e.fire("error",a,l),k(l)});e._requests[a.canonical]=a;this._requested++;return a.promises[a.promises.length-1]},_open:function(a,c,e){return this._handlers[c.type].open(a,c,e)},_postOpen:function(a,c){this.addToCache(c.canonical,a);a=this._handlers[c.type].clone(a,
c);delete this._requests[c.canonical];this._loaded++;this.fire("progress",this._loaded/this._requested);this.fire("load",c,a);return a},_makeCanonical:function(a){var c=this.getHash(a.identifier);a.canonical=c&&this._canonicals[c]?this._canonicals[c]:a.identifier},_findExistingRequest:function(a){var c=this._requests[a.canonical];return c?c.type!==a.type||c.result||a.result?a:c:a}};var a=function(){};a.prototype={setLoader:function(a){this._loader=a},load:function(){throw Error("Not implemented");
},open:function(){throw Error("Not implemented");},clone:function(a){return a}};return{ResourceLoader:d,ResourceHandler:a,ResourceRequest:function(a,c,e){this.id=null;this.canonical=a;this.alternatives=[];this.promises=[];this.children=[];this.data=c;this.result=e;this.identifier=a}}}());pc.extend(pc.resources,function(){var d=function(a,b){b.on("request",this.handleRequest,this);b.on("load",this.handleLoad,this);b.on("error",this.handleError,this);b.on("progress",this.handleProgress,this);this.addCss();this._element=a;this._domCreate()};d.prototype={addCss:function(){var a=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}";
else{var b=document.createTextNode(".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}");a.appendChild(b)}},handleRequest:function(a){console.warn("request: "+a.id);this._domAddRequest(a)},
handleLoad:function(a){console.warn("load: "+a.id);if(a=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id))for(var b=0;b<a.length;b++)a[b].textContent="100%"},handleError:function(a,b){var c=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id);if(c)for(var e=0;e<c.length;e++)c[e].textContent=b},handleProgress:function(){},_domCreate:function(){this._rootTable=document.createElement("table");this._rootTable.setAttribute("class","pc-resourceloaderdisplay-root");
this._element.appendChild(this._rootTable)},_domAddRequest:function(a){var b="pc-resourcesloaderdisplay-progress-"+a.id,c=document.createElement("tr"),e=document.createElement("td");e.textContent=a.identifier;a=document.createElement("td");a.className=b;a.textContent="0%";c.appendChild(e);c.appendChild(a);this._rootTable.appendChild(c)},_sanitizeId:function(a){return a.replace(/\//,"").replace(/\./,"")}};return{ResourceLoaderDisplay:d}}());pc.extend(pc.resources,function(){var d=function(a){this.cache={};this.loader=a};d.prototype={getTexture:function(a){return(a=this.loader.getHash(a))&&this.cache[a]?this.cache[a]:null},addTexture:function(a,b){var c=this.loader.getHash(a);c&&(this.cache[c]=b)}};return{TextureCache:d}}());pc.gfx={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CLEARFLAG_COLOR:1,
CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,
PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINESTRIP:2,PRIMITIVE_TRIANGLES:3,PRIMITIVE_TRISTRIP:4,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",
SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",
SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2};pc.extend(pc.gfx,function(){var d=function(a){this.name=a;this.value=null;this.versionObject=new pc.gfx.VersionedObject};d.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}};return{ScopeId:d}}());pc.extend(pc.gfx,function(){var d=function(a){this.name=a;this.variables={};this.namespaces={}};d.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new pc.gfx.ScopeId(a));return this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new pc.gfx.ScopeSpace(a),logDEBUG("Added ScopeSpace: "+a));return this.namespaces[a]}};return{ScopeSpace:d}}());pc.extend(pc.gfx,function(){var d=function(){this.revision=this.globalId=0};d.prototype={equals:function(a){return this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:d}}());pc.extend(pc.gfx,function(){var d=0,a=function(){d++;this.version=new pc.gfx.Version;this.version.globalId=d};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());function WebGLValidator(d){function a(a){return function(){var c=b.gl[a].apply(b.gl,arguments);b.validate(a);return c}}this.gl=d;var b=this,c;for(c in d)this[c]="function"===typeof d[c]?a(c):d[c];this.errorString={};this.errorString[d.NO_ERROR]="NO_ERROR";this.errorString[d.INVALID_ENUM]="INVALID_ENUM";this.errorString[d.INVALID_VALUE]="INVALID_VALUE";this.errorString[d.INVALID_OPERATION]="INVALID_OPERATION";this.errorString[d.OUT_OF_MEMORY]="OUT_OF_MEMORY";this.errorString[d.INVALID_FRAMEBUFFER_OPERATION]=
"INVALID_FRAMEBUFFER_OPERATION"}WebGLValidator.prototype.validate=function(d){var a=this.gl,b=a.getError();return b!==a.NO_ERROR?(pc.log.error("WebGL error from "+d+": "+this.errorString[b]),!1):!0};pc.extend(pc.gfx,function(){function d(d,g){this.index=0;switch(g.dataType){case pc.gfx.ELEMENTTYPE_INT8:this.array=new Int8Array(d,g.offset);break;case pc.gfx.ELEMENTTYPE_UINT8:this.array=new Uint8Array(d,g.offset);break;case pc.gfx.ELEMENTTYPE_INT16:this.array=new Int16Array(d,g.offset);break;case pc.gfx.ELEMENTTYPE_UINT16:this.array=new Uint16Array(d,g.offset);break;case pc.gfx.ELEMENTTYPE_INT32:this.array=new Int32Array(d,g.offset);break;case pc.gfx.ELEMENTTYPE_UINT32:this.array=new Uint32Array(d,
g.offset);break;case pc.gfx.ELEMENTTYPE_FLOAT32:this.array=new Float32Array(d,g.offset)}switch(g.numComponents){case 1:this.set=a;break;case 2:this.set=b;break;case 3:this.set=c;break;case 4:this.set=e}}function a(a){this.array[this.index]=a}function b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function c(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function e(a,b,c,e){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+
2]=c;this.array[this.index+3]=e}function g(a){this.vertexBuffer=a;this.buffer=this.vertexBuffer.lock();this.setters=[];this.element={};for(var a=this.vertexBuffer.getFormat(),b=0;b<a.elements.length;b++){var c=a.elements[b];this.setters[b]=new d(this.buffer,c);this.element[c.name]=this.setters[b]}}g.prototype={next:function(){for(var a=0,b=this.setters,c=this.setters.length,e=this.vertexBuffer.getFormat();a<c;){var d=b[a++];d.index+=e.size/d.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};
return{VertexIterator:g}}());pc.extend(pc.gfx,function(){var d=[];d[pc.gfx.ELEMENTTYPE_INT8]=1;d[pc.gfx.ELEMENTTYPE_UINT8]=1;d[pc.gfx.ELEMENTTYPE_INT16]=2;d[pc.gfx.ELEMENTTYPE_UINT16]=2;d[pc.gfx.ELEMENTTYPE_INT32]=4;d[pc.gfx.ELEMENTTYPE_UINT32]=4;d[pc.gfx.ELEMENTTYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var c;this.elements=[];c=this.size=0;for(var e=b.length;c<e;c++){var g=b[c],g={name:g.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(g.semantic),dataType:g.type,numComponents:g.components,normalize:"undefined"===
typeof g.normalize?!1:g.normalize,size:g.components*d[g.type]};this.elements.push(g);this.size+=g.size}var f=0;c=0;for(e=this.elements.length;c<e;c++)g=this.elements[c],g.offset=f,g.stride=this.size,f+=g.size}}}());pc.extend(pc.gfx,function(){var d=function(a,b,c,e){this.usage=e||pc.gfx.BUFFER_STATIC;this.format=b;this.numVertices=c;this.numBytes=b.size*c;this.device=a;this.bufferId=this.device.gl.createBuffer();this.storage=new ArrayBuffer(this.numBytes)};d.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=
this.device.gl,b;switch(this.usage){case pc.gfx.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.gfx.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.gfx.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)}};return{VertexBuffer:d}}());pc.extend(pc.gfx,function(){var d=function(a,b,c,e){this.usage=e||pc.gfx.BUFFER_STATIC;this.format=b;this.numIndices=c;this.device=a;a=this.device.gl;this.bufferId=a.createBuffer();var d;b===pc.gfx.INDEXFORMAT_UINT8?(d=1,this.glFormat=a.UNSIGNED_BYTE):b===pc.gfx.INDEXFORMAT_UINT16?(d=2,this.glFormat=a.UNSIGNED_SHORT):b===pc.gfx.INDEXFORMAT_UINT32&&(d=4,this.glFormat=a.UNSIGNED_INT);this.storage=new ArrayBuffer(this.numIndices*d)};d.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},
getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl,b;switch(this.usage){case pc.gfx.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.gfx.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.gfx.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)}};return{IndexBuffer:d}}());pc.extend(pc.gfx,function(){var d=function(a,b){this.device=a;var c=4,e=4,d=pc.gfx.PIXELFORMAT_R8_G8_B8_A8,f=!1;"undefined"!==typeof b&&(c="undefined"!==typeof b.width?b.width:c,e="undefined"!==typeof b.height?b.height:e,d="undefined"!==typeof b.format?b.format:d,f="undefined"!==typeof b.cubemap?b.cubemap:f);this.name=null;this.autoMipmap=!0;var k=this.device.gl,l;this._glTextureId=k.createTexture();this._glTarget=f?k.TEXTURE_CUBE_MAP:k.TEXTURE_2D;this._cubemap=f;this._format=d;switch(d){case pc.gfx.PIXELFORMAT_A8:this._glInternalFormat=
this._glFormat=k.ALPHA;this._glPixelType=k.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_L8:this._glInternalFormat=this._glFormat=k.LUMINANCE;this._glPixelType=k.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_L8_A8:this._glInternalFormat=this._glFormat=k.LUMINANCE_ALPHA;this._glPixelType=k.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_R5_G6_B5:this._glInternalFormat=this._glFormat=k.RGB;this._glPixelType=k.UNSIGNED_SHORT_5_6_5;break;case pc.gfx.PIXELFORMAT_R5_G5_B5_A1:this._glInternalFormat=this._glFormat=
k.RGBA;this._glPixelType=k.UNSIGNED_SHORT_5_5_5_1;break;case pc.gfx.PIXELFORMAT_R4_G4_B4_A4:this._glInternalFormat=this._glFormat=k.RGBA;this._glPixelType=k.UNSIGNED_SHORT_4_4_4_4;break;case pc.gfx.PIXELFORMAT_R8_G8_B8:this._glInternalFormat=this._glFormat=k.RGB;this._glPixelType=k.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_R8_G8_B8_A8:this._glInternalFormat=this._glFormat=k.RGBA;this._glPixelType=k.UNSIGNED_BYTE;break;case pc.gfx.PIXELFORMAT_DXT1:l=this.device.extCompressedTextureS3TC;this._glFormat=
k.RGB;this._glInternalFormat=l.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.gfx.PIXELFORMAT_DXT3:l=this.device.extCompressedTextureS3TC;this._glFormat=k.RGBA;this._glInternalFormat=l.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.gfx.PIXELFORMAT_DXT5:l=this.device.extCompressedTextureS3TC,this._glFormat=k.RGBA,this._glInternalFormat=l.COMPRESSED_RGBA_S3TC_DXT5_EXT}this._compressed=d===pc.gfx.PIXELFORMAT_DXT1||d===pc.gfx.PIXELFORMAT_DXT3||d===pc.gfx.PIXELFORMAT_DXT5;this._width=c||4;this._height=e||4;this._addressv=
this._addressu=pc.gfx.ADDRESS_REPEAT;this._minFilter=pc.gfx.FILTER_NEAREST_MIPMAP_LINEAR;this._magFilter=pc.gfx.FILTER_LINEAR;this._maxAnisotropy=1;this._levels=f?[[null,null,null,null,null,null]]:[null];this._lockedLevel=-1;this.upload()};Object.defineProperty(d.prototype,"minFilter",{get:function(){return this._minFilter},set:function(a){if(!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))a===pc.gfx.FILTER_NEAREST||a===pc.gfx.FILTER_LINEAR||(logWARNING("Invalid filter mode set on non power of two texture. Forcing linear addressing."),
a=pc.gfx.FILTER_LINEAR);this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_MIN_FILTER,[b.NEAREST,b.LINEAR,b.NEAREST_MIPMAP_NEAREST,b.NEAREST_MIPMAP_LINEAR,b.LINEAR_MIPMAP_NEAREST,b.LINEAR_MIPMAP_LINEAR][a]);this._minFilter=a}});Object.defineProperty(d.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){a===pc.gfx.FILTER_NEAREST||a===pc.gfx.FILTER_LINEAR||logWARNING("Invalid maginication filter mode. Must be set to FILTER_NEAREST or FILTER_LINEAR.");
this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_MAG_FILTER,[b.NEAREST,b.LINEAR,b.NEAREST_MIPMAP_NEAREST,b.NEAREST_MIPMAP_LINEAR,b.LINEAR_MIPMAP_NEAREST,b.LINEAR_MIPMAP_LINEAR][a]);this._magFilter=a}});Object.defineProperty(d.prototype,"addressU",{get:function(){return this._addressu},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.gfx.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in U set on non power of two texture. Forcing clamp to edge addressing."),
a=pc.gfx.ADDRESS_CLAMP_TO_EDGE;this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_WRAP_S,[b.REPEAT,b.CLAMP_TO_EDGE,b.MIRRORED_REPEAT][a]);this._addressu=a}});Object.defineProperty(d.prototype,"addressV",{get:function(){return this._addressv},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.gfx.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in V set on non power of two texture. Forcing clamp to edge addressing."),a=pc.gfx.ADDRESS_CLAMP_TO_EDGE;
this.bind();var b=this.device.gl;b.texParameteri(this._glTarget,b.TEXTURE_WRAP_T,[b.REPEAT,b.CLAMP_TO_EDGE,b.MIRRORED_REPEAT][a]);this._addressv=a}});Object.defineProperty(d.prototype,"maxAnisotropy",{get:function(){return this._maxAnisotropy},set:function(a){this._maxAnisotropy=a;var b=this.device,c=b.extTextureFilterAnisotropic;if(c){this.bind();var e=b.gl,a=Math.min(a,b.maxSupportedMaxAnisotropy);e.texParameterf(this._glTarget,c.TEXTURE_MAX_ANISOTROPY_EXT,a)}}});Object.defineProperty(d.prototype,
"width",{get:function(){return this._width}});Object.defineProperty(d.prototype,"height",{get:function(){return this._height}});Object.defineProperty(d.prototype,"format",{get:function(){return this._format}});pc.extend(d.prototype,{bind:function(){this.device.gl.bindTexture(this._glTarget,this._glTextureId)},destroy:function(){this.device.gl.deleteTexture(this._glTextureId)},lock:function(a){a=a||{level:0,face:0,mode:pc.gfx.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=
0);void 0===a.mode&&(a.mode=pc.gfx.TEXTURELOCK_WRITE);this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case pc.gfx.PIXELFORMAT_A8:case pc.gfx.PIXELFORMAT_L8:this._levels[a.level]=new Uint8Array(this._width*this._height);break;case pc.gfx.PIXELFORMAT_L8_A8:this._levels[a.level]=new Uint8Array(2*this._width*this._height);break;case pc.gfx.PIXELFORMAT_R5_G6_B5:case pc.gfx.PIXELFORMAT_R5_G5_B5_A1:case pc.gfx.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new Uint16Array(this._width*
this._height);break;case pc.gfx.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=new Uint8Array(3*this._width*this._height);break;case pc.gfx.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(4*this._width*this._height);break;case pc.gfx.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(8*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.gfx.PIXELFORMAT_DXT3:case pc.gfx.PIXELFORMAT_DXT5:this._levels[a.level]=new Uint8Array(16*Math.floor((this._width+3)/4)*Math.floor((this._height+
3)/4))}return this._levels[a.level]},recover:function(){this._glTextureId=this.device.gl.createTexture();this.addressU=this._addressu;this.addressV=this._addressv;this.minFilter=this._minFilter;this.magFilter=this._magFilter;this.maxAnisotropy=this._maxAnisotropy;this.upload()},load:function(a,b){if(this._cubemap){var c=a.map(function(a){return new pc.resources.ImageRequest(a)});b.request(c).then(function(a){this.setSource(a)}.bind(this))}else c=new pc.resources.ImageRequest(a),b.request(c).then(function(a){this.setSource(a[0])}.bind(this))},
setSource:function(a){if(this._cubemap){logASSERT("[object Array]"===Object.prototype.toString.apply(a),"pc.gfx.Texture: setSource: supplied source is not an array");logASSERT(6===a.length,"pc.gfx.Texture: setSource: supplied source does not have 6 entries.");for(var b=0,c=!0,e=a[0].width,d=a[0].height,f=0;6>f;f++)(a[f]instanceof HTMLCanvasElement||a[f]instanceof HTMLImageElement||a[f]instanceof HTMLVideoElement)&&b++,a[f].width!==e&&(c=!1),a[f].height!==d&&(c=!1);logASSERT(6===b,"pc.gfx.Texture: setSource: Not all supplied source elements are of required type (canvas, image or video).");
logASSERT(c,"pc.gfx.Texture: setSource: Not all supplied source elements share the same dimensions.");this._width=a[0].width;this._height=a[0].height}else logASSERT(a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement,"pc.gfx.Texture: setSource: supplied source is not an instance of HTMLCanvasElement, HTMLImageElement or HTMLVideoElement."),this._width=a.width,this._height=a.height;this._levels[0]=a;this.upload();this.minFilter=this._minFilter;this.magFilter=
this._magFilter;this.addressu=this._addressu;this.addressv=this._addressv},unlock:function(){logASSERT(-1!==this._lockedLevel,"Attempting to unlock a texture that is not locked");this.upload();this._lockedLevel=-1},upload:function(){this.bind();var a=this.device.gl,b=this._levels[0];if(this._cubemap){var c;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(b[0]instanceof HTMLCanvasElement||b[0]instanceof HTMLImageElement||b[0]instanceof HTMLVideoElement)for(c=
0;6>c;c++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,this._glInternalFormat,this._glFormat,this._glPixelType,b[c]);else for(c=0;6>c;c++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,this._glInternalFormat,this._width,this._height,0,this._glFormat,this._glPixelType,b[c])}else b instanceof HTMLCanvasElement||b instanceof HTMLImageElement||b instanceof HTMLVideoElement?(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,0,this._glInternalFormat,
this._glFormat,this._glPixelType,b)):(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),this._compressed?a.compressedTexImage2D(a.TEXTURE_2D,0,this._glInternalFormat,this._width,this._height,0,b):a.texImage2D(a.TEXTURE_2D,0,this._glInternalFormat,this._width,this._height,0,this._glFormat,this._glPixelType,b));this.autoMipmap&&(pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)&&1===this._levels.length)&&a.generateMipmap(this._glTarget)}});return{Texture:d}}());pc.extend(pc.gfx,function(){var d={depth:!0,face:0},a=function(a,c,e){this._device=a;this._colorBuffer=c;e="undefined"!==typeof e?e:d;this._face="undefined"!==typeof e.face?e.face:0;this._depth="undefined"!==typeof e.depth?e.depth:!0;a=this._device.gl;this._frameBuffer=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,this._colorBuffer._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+this._face:a.TEXTURE_2D,this._colorBuffer._glTextureId,
0);this._depth&&(this._depthBuffer=a.createRenderbuffer(),a.bindRenderbuffer(a.RENDERBUFFER,this._depthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this._depthBuffer));switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:logERROR("RenderTarget error: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:logERROR("RenderTarget error: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:logERROR("RenderTarget error: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:logERROR("RenderTarget error: FRAMEBUFFER_UNSUPPORTED")}a.bindFramebuffer(a.FRAMEBUFFER,null)};a.prototype={bind:function(){var a=this._device.gl;a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer)},destroy:function(){var a=this._device.gl;a.deleteFramebuffer(this._frameBuffer);this._depthBuffer&&a.deleteRenderbuffer(this._depthBuffer)},unbind:function(){var a=
this._device.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)}};Object.defineProperty(a.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(a.prototype,"face",{get:function(){return this._face}});Object.defineProperty(a.prototype,"width",{get:function(){return this._colorBuffer.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._colorBuffer.height}});return{RenderTarget:a}}());pc.gfx.ShaderInputType={BOOL:0,INT:1,FLOAT:2,VEC2:3,VEC3:4,VEC4:5,IVEC2:6,IVEC3:7,IVEC4:8,BVEC2:9,BVEC3:10,BVEC4:11,MAT2:12,MAT3:13,MAT4:14,TEXTURE2D:15,TEXTURECUBE:16};pc.gfx.ShaderInput=function(d,a,b,c){this.locationId=c;this.scopeId=d.scope.resolve(a);this.version=new pc.gfx.Version;this.dataType=b};pc.extend(pc.gfx,function(){function d(a,c,e){var d=a.createShader(c);a.shaderSource(d,e);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS)){for(var f=a.getShaderInfoLog(d),k=logERROR,a="Failed to compile "+(c===a.VERTEX_SHADER?"vertex":"fragment")+" shader:\n\n",e=e.split("\n"),c=0,l=e.length;c<l;c++)e[c]=c+1+":\t"+e[c];e=e.join("\n");k(a+e+"\n\n"+f)}return d}var a=function(a,c){this.device=a;this.definition=c;var e=this.device.gl,g=d(e,e.VERTEX_SHADER,c.vshader),f=d(e,e.FRAGMENT_SHADER,
c.fshader),k=e.createProgram();e.attachShader(k,g);e.attachShader(k,f);e.linkProgram(k);if(!e.getProgramParameter(k,e.LINK_STATUS)){var l=e.getProgramInfoLog(k);logERROR("Failed to link shader program. Error: "+l)}this.program=k;e.deleteShader(g);e.deleteShader(f);this.attributes=[];this.uniforms=[];this.samplers=[];g=0;f={};f[e.BOOL]=pc.gfx.ShaderInputType.BOOL;f[e.INT]=pc.gfx.ShaderInputType.INT;f[e.FLOAT]=pc.gfx.ShaderInputType.FLOAT;f[e.FLOAT_VEC2]=pc.gfx.ShaderInputType.VEC2;f[e.FLOAT_VEC3]=
pc.gfx.ShaderInputType.VEC3;f[e.FLOAT_VEC4]=pc.gfx.ShaderInputType.VEC4;f[e.INT_VEC2]=pc.gfx.ShaderInputType.IVEC2;f[e.INT_VEC3]=pc.gfx.ShaderInputType.IVEC3;f[e.INT_VEC4]=pc.gfx.ShaderInputType.IVEC4;f[e.BOOL_VEC2]=pc.gfx.ShaderInputType.BVEC2;f[e.BOOL_VEC3]=pc.gfx.ShaderInputType.BVEC3;f[e.BOOL_VEC4]=pc.gfx.ShaderInputType.BVEC4;f[e.FLOAT_MAT2]=pc.gfx.ShaderInputType.MAT2;f[e.FLOAT_MAT3]=pc.gfx.ShaderInputType.MAT3;f[e.FLOAT_MAT4]=pc.gfx.ShaderInputType.MAT4;f[e.SAMPLER_2D]=pc.gfx.ShaderInputType.TEXTURE2D;
f[e.SAMPLER_CUBE]=pc.gfx.ShaderInputType.TEXTURECUBE;for(var n=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES);g<n;)k=e.getActiveAttrib(this.program,g++),l=e.getAttribLocation(this.program,k.name),"undefined"===typeof c.attributes[k.name]&&console.error('Vertex shader attribute "'+k.name+'" is not mapped to a semantic in shader definition.'),k=new pc.gfx.ShaderInput(a,c.attributes[k.name],f[k.type],l),this.attributes.push(k);g=0;for(n=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS);g<
n;)k=e.getActiveUniform(this.program,g++),l=e.getUniformLocation(this.program,k.name),k.type===e.SAMPLER_2D||k.type===e.SAMPLER_CUBE?this.samplers.push(new pc.gfx.ShaderInput(a,k.name,f[k.type],l)):this.uniforms.push(new pc.gfx.ShaderInput(a,k.name,f[k.type],l))};a.prototype={destroy:function(){this.device.gl.deleteProgram(this.program)}};return{Shader:a}}());pc.extend(pc.gfx,function(){var d=function(a){this._device=a;this._cache={};this._generators={}};d.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};d.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};d.prototype.isRegistered=function(a){return void 0!==this._generators[a]};d.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return logERROR("No program library functions registered for: "+a),null;var e=c.generateKey(d,
b),d=this._cache[e];if(!d){var d=this._device,c=c.createShaderDefinition(d,b);logDEBUG("\n"+e+": vertex shader\n"+c.vshader);logDEBUG("\n"+e+": fragment shader\n"+c.fshader);d=this._cache[e]=new pc.gfx.Shader(d,c)}return d};return{ProgramLibrary:d}}());pc.gfx.precalculatedTangents=!0;
pc.extend(pc.gfx,function(){function d(a){this.name="UnsupportedBrowserError";this.message=a||""}function a(a){this.name="ContextCreationError";this.message=a||""}d.prototype=Error.prototype;a.prototype=Error.prototype;var b=function(){logWARNING("Context lost.")},c=function(){logINFO("Context restored.")},e=function(a){this.gl=void 0;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.attributesInvalidated=!0;this.boundBuffer=null;this.enabledAttributes=
{};this.textureUnits=[];this.commitFunction={};if(!window.WebGLRenderingContext)throw new pc.gfx.UnsupportedBrowserError;for(var e={alpha:!1},d=["webgl","experimental-webgl","webkit-3d","moz-webgl"],l=null,n=0;n<d.length;n++){try{l=a.getContext(d[n],e)}catch(r){}if(l)break}this.gl=l;if(!this.gl)throw new pc.gfx.ContextCreationError;a.addEventListener("webglcontextlost",b,!1);a.addEventListener("webglcontextrestored",c,!1);this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision=
"highp";var m=this.gl;logINFO("Device started");logINFO("WebGL version:                "+m.getParameter(m.VERSION));logINFO("WebGL shader version:         "+m.getParameter(m.SHADING_LANGUAGE_VERSION));logINFO("WebGL vendor:                 "+m.getParameter(m.VENDOR));logINFO("WebGL renderer:               "+m.getParameter(m.RENDERER));logINFO("WebGL extensions:             "+m.getSupportedExtensions());logINFO("WebGL max vertex attribs:     "+m.getParameter(m.MAX_VERTEX_ATTRIBS));logINFO("WebGL max vshader vectors:    "+
m.getParameter(m.MAX_VERTEX_UNIFORM_VECTORS));logINFO("WebGL max varying vectors:    "+m.getParameter(m.MAX_VARYING_VECTORS));logINFO("WebGL max fshader vectors:    "+m.getParameter(m.MAX_FRAGMENT_UNIFORM_VECTORS));logINFO("WebGL max combined tex units: "+m.getParameter(m.MAX_COMBINED_TEXTURE_IMAGE_UNITS));logINFO("WebGL max vertex tex units:   "+m.getParameter(m.MAX_VERTEX_TEXTURE_IMAGE_UNITS));logINFO("WebGL max tex units:          "+m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS));logINFO("WebGL max texture size:       "+
m.getParameter(m.MAX_TEXTURE_SIZE));logINFO("WebGL max cubemap size:       "+m.getParameter(m.MAX_CUBE_MAP_TEXTURE_SIZE));a=m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.HIGH_FLOAT);d=m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.MEDIUM_FLOAT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.LOW_FLOAT);e=m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.HIGH_FLOAT);l=m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.MEDIUM_FLOAT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.LOW_FLOAT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,
m.HIGH_INT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.MEDIUM_INT);m.getShaderPrecisionFormat(m.VERTEX_SHADER,m.LOW_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.HIGH_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.MEDIUM_INT);m.getShaderPrecisionFormat(m.FRAGMENT_SHADER,m.LOW_INT);d=0<d.precision&&0<l.precision;0<a.precision&&0<e.precision||(d?(this.precision="mediump",console.warn("WARNING: highp not supported, using mediump")):(this.precision="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")));
this.defaultClearOptions={color:[0,0,0,1],depth:1,flags:pc.gfx.CLEARFLAG_COLOR|pc.gfx.CLEARFLAG_COLOR};this.glPrimitive=[m.POINTS,m.LINES,m.LINE_STRIP,m.TRIANGLES,m.TRIANGLE_STRIP];this.glBlendEquation=[m.FUNC_ADD,m.FUNC_SUBTRACT,m.FUNC_REVERSE_SUBTRACT];this.glBlendFunction=[m.ZERO,m.ONE,m.SRC_COLOR,m.ONE_MINUS_SRC_COLOR,m.DST_COLOR,m.ONE_MINUS_DST_COLOR,m.SRC_ALPHA,m.SRC_ALPHA_SATURATE,m.ONE_MINUS_SRC_ALPHA,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA];this.glClearFlag=[0,m.COLOR_BUFFER_BIT,m.DEPTH_BUFFER_BIT,
m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT];this.glType=[m.BYTE,m.UNSIGNED_BYTE,m.SHORT,m.UNSIGNED_SHORT,m.INT,m.UNSIGNED_INT,m.FLOAT];this.extTextureFloat=m.getExtension("OES_texture_float");this.extDepthTexture=null;(this.extStandardDerivatives=m.getExtension("OES_standard_derivatives"))&&m.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,
m.NICEST);this.maxTextureMaxAnisotropy=1;this.extTextureFilterAnisotropic=m.getExtension("EXT_texture_filter_anisotropic");this.extTextureFilterAnisotropic||(this.extTextureFilterAnisotropic=m.getExtension("WEBKIT_EXT_texture_filter_anisotropic"));this.extTextureFilterAnisotropic&&(this.maxTextureMaxAnisotropy=m.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT));if(this.extCompressedTextureS3TC=m.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")){a=m.getParameter(m.COMPRESSED_TEXTURE_FORMATS);
e="WebGL compressed texture formats:";for(d=0;d<a.length;d++)switch(a[d]){case this.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT:e+=" COMPRESSED_RGB_S3TC_DXT1_EXT";break;case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT:e+=" COMPRESSED_RGBA_S3TC_DXT1_EXT";break;case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT:e+=" COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case this.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT:e+=" COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:e+=
" UNKOWN("+a[d]+")"}logINFO(e)}(this.extDrawBuffers=m.getExtension("EXT_draw_buffers"))?(logINFO("WebGL max draw buffers:       "+m.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT)),logINFO("WebGL max color attachments:  "+m.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT))):(logINFO("WebGL max draw buffers:       1"),logINFO("WebGL max color attachments:  1"));this.renderTarget=null;this.scope=new pc.gfx.ScopeSpace("Device");this.commitFunction={};this.commitFunction[pc.gfx.ShaderInputType.BOOL]=
function(a,b){m.uniform1i(a,b)};this.commitFunction[pc.gfx.ShaderInputType.INT]=function(a,b){m.uniform1i(a,b)};this.commitFunction[pc.gfx.ShaderInputType.FLOAT]=function(a,b){"number"==typeof b?m.uniform1f(a,b):m.uniform1fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.VEC2]=function(a,b){m.uniform2fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.VEC3]=function(a,b){m.uniform3fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.VEC4]=function(a,b){m.uniform4fv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.IVEC2]=
function(a,b){m.uniform2iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.BVEC2]=function(a,b){m.uniform2iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.IVEC3]=function(a,b){m.uniform3iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.BVEC3]=function(a,b){m.uniform3iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.IVEC4]=function(a,b){m.uniform4iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.BVEC4]=function(a,b){m.uniform4iv(a,b)};this.commitFunction[pc.gfx.ShaderInputType.MAT2]=function(a,
b){m.uniformMatrix2fv(a,!1,b)};this.commitFunction[pc.gfx.ShaderInputType.MAT3]=function(a,b){m.uniformMatrix3fv(a,!1,b)};this.commitFunction[pc.gfx.ShaderInputType.MAT4]=function(a,b){m.uniformMatrix4fv(a,!1,b)};this.setBlending(!1);this.setBlendFunction(pc.gfx.BLENDMODE_ONE,pc.gfx.BLENDMODE_ZERO);this.setBlendEquation(pc.gfx.BLENDEQUATION_ADD);this.setColorWrite(!0,!0,!0,!0);this.setCullMode(pc.gfx.CULLFACE_BACK);this.setDepthTest(!0);this.setDepthWrite(!0);m.enable(m.SCISSOR_TEST);this.programLib=
new pc.gfx.ProgramLibrary(this);for(var s in pc.gfx.programlib)this.programLib.register(s,pc.gfx.programlib[s]);s=m.getParameter(m.MAX_VERTEX_UNIFORM_VECTORS);s=s-16-8;s-=1;s-=16;this.boneLimit=Math.floor(s/4);110<this.boneLimit&&(this.boneLimit=110);pc.events.attach(this);this.boundBuffer=null;this.textureUnits=[];this.attributesInvalidated=!0;this.enabledAttributes={};s=m.createBuffer();a=new ArrayBuffer(16);m.bindBuffer(m.ARRAY_BUFFER,s);m.bufferData(m.ARRAY_BUFFER,a,m.STATIC_DRAW);m.getError();
m.vertexAttribPointer(0,4,m.UNSIGNED_BYTE,!1,4,0);this.supportsUnsignedByte=0===m.getError();m.deleteBuffer(s)};e.prototype={setViewport:function(a,b,c,e){this.gl.viewport(a,b,c,e)},setScissor:function(a,b,c,e){this.gl.scissor(a,b,c,e)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=a},updateBegin:function(){logASSERT(null!==this.canvas,"Device has not been started");this.indexBuffer=this.boundBuffer=null;if(this.renderTarget)this.renderTarget.bind();
else{var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)}for(a=0;16>a;a++)this.textureUnits[a]=null},updateEnd:function(){},draw:function(a){var b=this.gl,c,e,d,r,m,s;c=this.shader;r=c.samplers;var h=c.uniforms;if(this.attributesInvalidated){var u=c.attributes;c=0;for(e=u.length;c<e;c++)d=u[c],m=d.scopeId.value,null!==m&&(s=this.vertexBuffers[m.stream],this.boundBuffer!==s.bufferId&&(b.bindBuffer(b.ARRAY_BUFFER,s.bufferId),this.boundBuffer=s.bufferId),this.enabledAttributes[d.locationId]||(b.enableVertexAttribArray(d.locationId),
this.enabledAttributes[d.locationId]=!0),b.vertexAttribPointer(d.locationId,m.numComponents,this.glType[m.dataType],m.normalize,m.stride,m.offset));this.attributesInvalidated=!1}c=0;for(e=r.length;c<e;c++)d=r[c],texture=d.scopeId.value,this.textureUnits[c]!==texture&&(b.activeTexture(b.TEXTURE0+c),texture.bind(),this.textureUnits[c]=texture),d.slot!==c&&(b.uniform1i(d.locationId,c),d.slot=c);c=0;for(e=h.length;c<e;c++)if(r=h[c],d=r.scopeId,m=r.version,s=d.versionObject.version,m.globalId!==s.globalId||
m.revision!==s.revision)m.globalId=s.globalId,m.revision=s.revision,this.commitFunction[r.dataType](r.locationId,d.value);a.indexed?b.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,2*a.base):b.drawArrays(this.glPrimitive[a.type],a.base,a.count)},clear:function(a){var b=this.defaultClearOptions,a=a||b,c=this.glClearFlag[a.flags||b.flags],e=this.gl;if(c&e.COLOR_BUFFER_BIT){var d=a.color||b.color;e.clearColor(d[0],d[1],d[2],d[3])}c&e.DEPTH_BUFFER_BIT&&e.clearDepth(a.depth||b.depth);
e.clear(c)},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,c,e){if(this.writeRed!==a||this.writeGreen!==
b||this.writeBlue!==c||this.writeAlpha!==e)this.gl.colorMask(a,b,c,e),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=e},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b},setBlendEquation:function(a){this.blendEquation!==
a&&(this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a)},setCullMode:function(a){if(this.cullMode!==a){var b=this.gl;switch(a){case pc.gfx.CULLFACE_NONE:b.disable(b.CULL_FACE);break;case pc.gfx.CULLFACE_FRONT:b.enable(b.CULL_FACE);b.cullFace(b.FRONT);break;case pc.gfx.CULLFACE_BACK:b.enable(b.CULL_FACE);b.cullFace(b.BACK);break;case pc.gfx.CULLFACE_FRONTANDBACK:b.enable(b.CULL_FACE),b.cullFace(b.FRONT_AND_BACK)}this.cullMode=a}},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=
a;var b=this.gl;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a?a.bufferId:null)}},setVertexBuffer:function(a,b){if(this.vertexBuffers[b]!==a){this.vertexBuffers[b]=a;for(var c=0,e=a.getFormat().elements,d=e.length;c<d;){var r=e[c++];r.stream=b;r.scopeId.setValue(r)}this.attributesInvalidated=!0}},setShader:function(a){a!==this.shader&&(this.shader=a,this.gl.useProgram(a.program),this.attributesInvalidated=!0)},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},enableValidation:function(a){!0===
a?this.gl instanceof WebGLRenderingContext&&(this.gl=new WebGLValidator(this.gl)):this.gl instanceof WebGLValidator&&(this.gl=Context.gl)},validate:function(){var a=this.gl,b=a.getError();return b!==a.NO_ERROR?(Log.error("WebGL error: "+WebGLValidator.ErrorString[b]),!1):!0}};Object.defineProperty(e.prototype,"maxSupportedMaxAnisotropy",{get:function(){return this.maxTextureMaxAnisotropy}});Object.defineProperty(e.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});
Object.defineProperty(e.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(e.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});return{UnsupportedBrowserError:d,ContextCreationError:a,Device:e}}());pc.gfx.programlib={getSnippet:function(d,a){var b="";switch(a){case "common_main_begin":b+="void main(void)\n{\n";break;case "common_main_end":b+="}\n";break;case "fs_alpha_test_decl":b+="uniform float alpha_ref;\n";break;case "fs_alpha_test":b+="    if (gl_FragColor.a < alpha_ref) discard;\n\n";break;case "fs_clamp":b+="    gl_FragColor = clamp(gl_FragColor, 0.0, 1.0);\n";break;case "fs_flat_color_decl":b+="uniform vec4 uColor;\n";break;case "fs_flat_color":b+="    gl_FragColor = uColor;\n";break;
case "fs_fog_linear_decl":case "fs_fog_exp_decl":case "fs_fog_exp2_decl":b+="uniform vec3 fog_color;\n";b="fs_fog_linear_decl"===a?b+"uniform float fog_start;\nuniform float fog_end;\n\n":b+"uniform float fog_density;\n\n";break;case "fs_fog_linear":case "fs_fog_exp":case "fs_fog_exp2":b+="    float depth = gl_FragCoord.z / gl_FragCoord.w;\n";b="fs_fog_linear"===a?b+"    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n":"fs_fog_exp"===a?b+"    float fogFactor = exp(-depth * fog_density);\n":
b+"    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n";b+="    fogFactor = clamp(fogFactor, 0.0, 1.0);\n";b+="    gl_FragColor.rgb = mix(fog_color, gl_FragColor.rgb, fogFactor);\n";break;case "fs_precision":b+="precision "+d.precision+" float;\n\n";break;case "fs_depth_encode_rgba":b+="    vec4 packedDepth = fract((gl_FragCoord.z * vec4(1.67772e+07, 65536.0, 256.0, 1.0)));\n";b+="    gl_FragData[0] = (packedDepth - (packedDepth.xxyz * vec4(0.0, 0.00390625, 0.00390625, 0.00390625)));\n";
break;case "fs_height_map_funcs":b+="vec3 perturb_normal( vec3 N, vec3 p, vec2 uv )\n";b+="{\n";b+="    vec3 dp1 = dFdx( p );\n";b+="    vec3 dp2 = dFdy( p );\n";b+="    vec2 duv1 = dFdx( uv );\n";b+="    vec2 duv2 = dFdy( uv );\n\n";b+="    vec3 dp2perp = cross( dp2, N );\n";b+="    vec3 dp1perp = cross( N, dp1 );\n\n";b+="    const float bumpScale = 0.125;\n";b+="    float Hll = bumpScale * texture2D( texture_heightMap, uv ).x;\n";b+="    float dBx = bumpScale * texture2D( texture_heightMap, uv + duv1 ).x - Hll;\n";
b+="    float dBy = bumpScale * texture2D( texture_heightMap, uv + duv2 ).x - Hll;\n\n";b+="    float fDet = dot( dp1, dp2perp );\n";b+="    vec3 vGrad = sign( fDet ) * ( dBx * dp2perp + dBy * dp1perp );\n";b+="    return normalize( abs( fDet ) * N - vGrad );\n";b+="}\n\n";break;case "fs_normal_map_funcs":pc.gfx.precalculatedTangents||(b+="mat3 cotangent_frame( vec3 N, vec3 p, vec2 uv )\n",b+="{\n",b+="    vec3 dp1 = dFdx( p );\n",b+="    vec3 dp2 = dFdy( p );\n",b+="    vec2 duv1 = dFdx( uv );\n",
b+="    vec2 duv2 = dFdy( uv );\n\n",b+="    vec3 dp2perp = cross( dp2, N );\n",b+="    vec3 dp1perp = cross( N, dp1 );\n",b+="    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n",b+="    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n",b+="    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n",b+="    return mat3( T * invmax, B * invmax, N );\n",b+="}\n\n",b+="vec3 perturb_normal( vec3 N, vec3 V, vec2 uv )\n",b+="{\n",b+="    vec3 map = texture2D( texture_normalMap, uv ).xyz;\n",b+="    map = map * 255./127. - 128./127.;\n",
b+="    map.xy = map.xy * material_bumpMapFactor;\n",b+="    mat3 TBN = cotangent_frame( N, -V, uv );\n",b+="    return normalize( TBN * map );\n",b+="}\n\n");break;case "vs_skin_position_decl":var c=d.getBoneLimit(),b=b+"attribute vec3 vertex_position;\n",b=b+"attribute vec4 vertex_boneWeights;\n",b=b+"attribute vec4 vertex_boneIndices;\n",b=b+("uniform mat4 matrix_pose["+c+"];\n"),b=b+"uniform mat4 matrix_viewProjection;\n\n";break;case "vs_skin_position":b+="    vec4 position, positionW;\n";b+=
"    position = vec4(vertex_position, 1.0);\n";b+="    positionW  = vertex_boneWeights[0] * matrix_pose[int(vertex_boneIndices[0])] * position;\n";b+="    positionW += vertex_boneWeights[1] * matrix_pose[int(vertex_boneIndices[1])] * position;\n";b+="    positionW += vertex_boneWeights[2] * matrix_pose[int(vertex_boneIndices[2])] * position;\n";b+="    positionW += vertex_boneWeights[3] * matrix_pose[int(vertex_boneIndices[3])] * position;\n";b+="    gl_Position = matrix_viewProjection * positionW;\n";
break;case "vs_skin_normal":b+="    vec3 normalW, normalE;\n";b+="    vec4 normal = vec4(vertex_normal, 0.0);\n";b+="    normalW  = (vertex_boneWeights[0] * matrix_pose[int(vertex_boneIndices[0])] * normal).xyz;\n";b+="    normalW += (vertex_boneWeights[1] * matrix_pose[int(vertex_boneIndices[1])] * normal).xyz;\n";b+="    normalW += (vertex_boneWeights[2] * matrix_pose[int(vertex_boneIndices[2])] * normal).xyz;\n";b+="    normalW += (vertex_boneWeights[3] * matrix_pose[int(vertex_boneIndices[3])] * normal).xyz;\n";
b+="    normalE = normalize((matrix_view * normalW).xyz);\n";break;case "vs_skin_tangent":b+="    vec3 tangentW, tangentE;\n";b+="    vec4 tangent = vec4(vertex_tangent, 0.0);\n";b+="    tangentW  = (vertex_boneWeights[0] * matrix_pose[int(vertex_boneIndices[0])] * tangent).xyz;\n";b+="    tangentW += (vertex_boneWeights[1] * matrix_pose[int(vertex_boneIndices[1])] * tangent).xyz;\n";b+="    tangentW += (vertex_boneWeights[2] * matrix_pose[int(vertex_boneIndices[2])] * tangent).xyz;\n";b+="    tangentW += (vertex_boneWeights[3] * matrix_pose[int(vertex_boneIndices[3])] * tangent).xyz;\n";
b+="    tangentE = normalize((matrix_view * tangentW).xyz);\n";break;case "vs_static_position_decl":b+="attribute vec3 vertex_position;\n";b+="uniform mat4 matrix_model;\n";b+="uniform mat4 matrix_viewProjection;\n\n";break;case "vs_static_position":b+="    vec4 positionW = matrix_model * vec4(vertex_position, 1.0);\n",b+="    gl_Position = matrix_viewProjection * positionW;\n"}return b}};pc.gfx.programlib.basic={generateKey:function(d,a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.gfx.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0);var c=pc.gfx.programlib.getSnippet,
e="",e=a.skin?e+c(d,"vs_skin_position_decl"):e+c(d,"vs_static_position_decl");a.vertexColors&&(e+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");a.diffuseMap&&(e+="attribute vec2 vertex_texCoord0;\n",e+="varying vec2 vUv0;\n");e+=c(d,"common_main_begin");e=a.skin?e+c(d,"vs_skin_position"):e+c(d,"vs_static_position");a.vertexColors&&(e+="    vColor = vertex_color;\n");a.diffuseMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end"),e=c(d,"fs_precision"),e=a.vertexColors?
e+"varying vec4 vColor;\n":e+"uniform vec4 uColor;\n";a.diffuseMap&&(e+="varying vec2 vUv0;\n",e+="uniform sampler2D texture_diffuseMap;\n");a.fog&&(e+=c(d,"fs_fog_decl"));a.alphatest&&(e+=c(d,"fs_alpha_test_decl"));e+=c(d,"common_main_begin");e=a.vertexColors?e+"    gl_FragColor = vColor;\n":e+"    gl_FragColor = uColor;\n";a.diffuseMap&&(e+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");a.alphatest&&(e+=c(d,"fs_alpha_test"));e+=c(d,"fs_clamp");a.fog&&(e+=c(d,"fs_fog"));e+=c(d,"common_main_end");
return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.depth={generateKey:function(d,a){var b="depth";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0);var c=pc.gfx.programlib.getSnippet,e="",e=a.skin?e+c(d,"vs_skin_position_decl"):e+c(d,"vs_static_position_decl");a.opacityMap&&
(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");e+=c(d,"common_main_begin");e=a.skin?e+c(d,"vs_skin_position"):e+c(d,"vs_static_position");a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end"),e=c(d,"fs_precision"),e=e+"uniform float camera_near;\n",e=e+"uniform float camera_far;\n",e=e+c(d,"common_main_begin"),e=e+"float depth = gl_FragCoord.z / gl_FragCoord.w;",e=e+"float color = 1.0 - smoothstep(camera_near, camera_far, depth);",e=e+"gl_FragColor = vec4(vec3(color), 1.0);",
e=e+c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.depthrgba={generateKey:function(d,a){var b="depthrgba";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0);var c=pc.gfx.programlib.getSnippet,e="",e=a.skin?e+c(d,"vs_skin_position_decl"):e+c(d,"vs_static_position_decl");a.opacityMap&&
(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");e+=c(d,"common_main_begin");e=a.skin?e+c(d,"vs_skin_position"):e+c(d,"vs_static_position");a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=c(d,"common_main_end"),e=c(d,"fs_precision");a.opacityMap&&(e+="varying vec2 vUv0;\n\n",e+="uniform sampler2D texture_opacityMap;\n\n");e+=c(d,"common_main_begin");a.opacityMap&&(e+="    if (texture2D(texture_opacityMap, vUv0).r < 0.25) discard;\n\n");e+=c(d,"fs_depth_encode_rgba");
e+=c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.particle={generateKey:function(d,a){var b="particle";a.billboard&&(b+="_bbrd");return b},createShaderDefinition:function(d,a){var b={particle_uvLifeTimeFrameStart:pc.gfx.SEMANTIC_ATTR0,particle_positionStartTime:pc.gfx.SEMANTIC_ATTR1,particle_velocityStartSize:pc.gfx.SEMANTIC_ATTR2,particle_accelerationEndSize:pc.gfx.SEMANTIC_ATTR3,particle_spinStartSpinSpeed:pc.gfx.SEMANTIC_ATTR4,particle_colorMult:pc.gfx.SEMANTIC_ATTR5};a.billboard||(b.particle_orientation=pc.gfx.SEMANTIC_ATTR6);
var c=pc.gfx.programlib.getSnippet,e;e="attribute vec4 particle_uvLifeTimeFrameStart;\nattribute vec4 particle_positionStartTime;\n";e+="attribute vec4 particle_velocityStartSize;\n";e+="attribute vec4 particle_accelerationEndSize;\n";e+="attribute vec4 particle_spinStartSpinSpeed;\n";e+="attribute vec4 particle_colorMult;\n";a.billboard||(e+="attribute vec4 particle_orientation;\n");e+="uniform mat4 matrix_viewProjection;\n";e+="uniform mat4 matrix_model;\n";e+="uniform mat4 matrix_viewInverse;\n";
e+="uniform vec3 particle_worldVelocity;\n";e+="uniform vec3 particle_worldAcceleration;\n";e+="uniform float particle_timeRange;\n";e+="uniform float particle_time;\n";e+="uniform float particle_timeOffset;\n";e+="uniform float particle_frameDuration;\n";e+="uniform float particle_numFrames;\n\n";e+="varying vec2 vUv0;\n";e+="varying float vAge;\n";e+="varying vec4 vColor;\n\n";e+="void main(void)\n";e+="{\n";e+="    vec2 uv = particle_uvLifeTimeFrameStart.xy;\n";e+="    float lifeTime = particle_uvLifeTimeFrameStart.z;\n";
e+="    float frameStart = particle_uvLifeTimeFrameStart.w;\n";e+="    vec3 position = particle_positionStartTime.xyz;\n";e+="    float startTime = particle_positionStartTime.w;\n";e+="    vec3 velocity = (matrix_model * vec4(particle_velocityStartSize.xyz, 0.0)).xyz + particle_worldVelocity;\n";e+="    float startSize = particle_velocityStartSize.w;\n";e+="    vec3 acceleration = (matrix_model * vec4(particle_accelerationEndSize.xyz, 0.0)).xyz + particle_worldAcceleration;\n";e+="    float endSize = particle_accelerationEndSize.w;\n";
e+="    float spinStart = particle_spinStartSpinSpeed.x;\n";e+="    float spinSpeed = particle_spinStartSpinSpeed.y;\n";e+="    float localTime = mod((particle_time - particle_timeOffset - startTime), particle_timeRange);\n";e+="    float percentLife = localTime / lifeTime;\n";e+="    float frame = mod(floor(localTime / particle_frameDuration + frameStart), particle_numFrames);\n";e+="    float uOffset = frame / particle_numFrames;\n";e+="    float u = uOffset + (uv.x + 0.5) * (1.0 / particle_numFrames);\n";
e+="    vUv0 = vec2(u, uv.y + 0.5);\n";e+="    vColor = particle_colorMult;\n";a.billboard?(e+="    vec3 basisX = matrix_viewInverse[0].xyz;\n",e+="    vec3 basisZ = matrix_viewInverse[1].xyz;\n",e+="    float size = mix(startSize, endSize, percentLife);\n",e+="    size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n",e+="    float s = sin(spinStart + spinSpeed * localTime);\n",e+="    float c = cos(spinStart + spinSpeed * localTime);\n",e+="    vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n",
e+="                             -uv.x * s + uv.y * c);\n",e+="    vec3 localPosition = vec3(basisX * rotatedPoint.x +\n",e+="                              basisZ * rotatedPoint.y) * size +\n",e+="                              velocity * localTime +\n",e+="                              acceleration * localTime * localTime + \n",e+="                              position;\n",e+="    vAge = percentLife;\n",e+="    gl_Position = matrix_viewProjection * vec4(localPosition + matrix_model[3].xyz, 1.0);\n"):
(e+="    float size = mix(startSize, endSize, percentLife);\n",e+="    size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n",e+="    float s = sin(spinStart + spinSpeed * localTime);\n",e+="    float c = cos(spinStart + spinSpeed * localTime);\n",e+="\n",e+="    vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.0, (uv.x * s - uv.y * c) * size, 1.0);\n",e+="    vec3 center = velocity * localTime + acceleration * localTime * localTime + position;\n",e+="\n",e+="    vec4 q2 = particle_orientation + particle_orientation;\n",
e+="    vec4 qx = particle_orientation.xxxw * q2.xyzx;\n",e+="    vec4 qy = particle_orientation.xyyw * q2.xyzy;\n",e+="    vec4 qz = particle_orientation.xxzw * q2.xxzz;\n",e+="\n",e+="    mat4 localMatrix =\n",e+="         mat4((1.0 - qy.y) - qz.z, qx.y + qz.w, qx.z - qy.w, 0,\n",e+="              qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n",e+="              qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n",e+="              center.x, center.y, center.z, 1);\n",e+="    rotatedPoint = localMatrix * rotatedPoint;\n",
e+="    vAge = percentLife;\n",e+="    gl_Position = matrix_viewProjection * vec4(rotatedPoint.xyz + matrix_model[3].xyz, 1.0);\n");var g=e+="}";e=c(d,"fs_precision");e+="varying vec2 vUv0;\n";e+="varying float vAge;\n";e+="varying vec4 vColor;\n";e+="uniform sampler2D texture_colorMap;\n";e+="uniform sampler2D texture_opacityMap;\n";e+="uniform sampler2D texture_rampMap;\n\n";e+="void main(void)\n";e+="{\n";e+="    vec4 colorMult = texture2D(texture_rampMap, vec2(vAge, 0.5)) * vColor;\n";e+="    vec3 rgb = texture2D(texture_colorMap, vUv0).rgb;\n";
e+="    float a = texture2D(texture_opacityMap, vUv0).r;\n";e+="    gl_FragColor = vec4(rgb, a) * colorMult;\n";e+="}";return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.phong={generateKey:function(d,a){var b="phong";a.skin&&(b+="_skin");switch(a.fog){case "none":b+="_fogn";break;case "linear":b+="_fogl";break;case "exp2":b+="_foge"}0<a.numDirs&&(b+="_"+a.numDirs+"dir");0<a.numPnts&&(b+="_"+a.numPnts+"pnt");0<a.numSpts&&(b+="_"+a.numSpts+"spt");0<a.numSDirs&&(b+="_"+a.numSDirs+"sdir");0<a.numSPnts&&(b+="_"+a.numSPnts+"spnt");0<a.numSSpts&&(b+="_"+a.numSSpts+"sspt");a.vertexColors&&(b+="_vcol");b=a.diffuseMapTransform?b+"_difx":a.diffuseMap?b+"_difm":
b+"_difc";b=a.specularMapTransform?b+"_spex":a.specularMap?b+"_spem":b+"_spec";a.glossMapTransform?b+="_glox":a.glossMap&&(b+="_glom");b=a.emissiveMapTransform?b+"_emix":a.emissiveMap?b+"_emim":b+"_emic";a.opacityMapTransform?b+="_opax":a.opacityMap&&(b+="_opam");a.normalMapTransform?b+="_norx":a.normalMap&&(b+="_norm");a.heightMapTransform?b+="_hgtx":a.heightMap&&(b+="_hgtm");a.sphereMap&&(b+="_sphr");a.cubeMap&&(b+="_cube");a.lightMap&&(b+="_lght");return b},createShaderDefinition:function(d,a){var b,
c=a.numSDirs+a.numSPnts+a.numSSpts,e=a.numDirs+a.numSDirs,g=a.numPnts+a.numSPnts,f=a.numSpts+a.numSSpts,k=a.numDirs+a.numPnts+a.numSpts+c,l=0<k,n=a.diffuseMap&&!a.diffuseMapTransform||a.specularMap&&!a.specularMapTransform||a.glossMap&&!a.glossMapTransform||a.emissiveMap&&!a.emissiveMapTransform||a.opacityMap&&!a.opacityMapTransform||a.normalMap&&!a.normalMapTransform||a.heightMap&&!a.heightMapTransform,r=pc.gfx.precalculatedTangents,m={vertex_position:pc.gfx.SEMANTIC_POSITION};if(l||a.cubeMap||a.sphereMap)m.vertex_normal=
pc.gfx.SEMANTIC_NORMAL,a.normalMap&&r&&(m.vertex_tangent=pc.gfx.SEMANTIC_TANGENT);if(a.diffuseMap||a.specularMap||a.glossMap||a.emissiveMap||a.normalMap||a.heightMap||a.opacityMap)m.vertex_texCoord0=pc.gfx.SEMANTIC_TEXCOORD0;a.lightMap&&(m.vertex_texCoord1=pc.gfx.SEMANTIC_TEXCOORD1);a.vertexColors&&(m.vertex_color=pc.gfx.SEMANTIC_COLOR);a.skin&&(m.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,m.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);var s=pc.gfx.programlib.getSnippet,h;h="attribute vec3 vertex_position;\n";
if(l||a.cubeMap||a.sphereMap)h+="attribute vec3 vertex_normal;\n",a.normalMap&&r&&(h+="attribute vec4 vertex_tangent;\n");if(a.diffuseMap||a.specularMap||a.glossMap||a.emissiveMap||a.normalMap||a.heightMap||a.opacityMap)h+="attribute vec2 vertex_texCoord0;\n";a.lightMap&&(h+="attribute vec2 vertex_texCoord1;\n");a.vertexColors&&(h+="attribute vec4 vertex_color;\n");a.skin&&(h+="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n");h+="\n";h+="uniform mat4 matrix_viewProjection;\n";
h+="uniform mat4 matrix_model;\n";l&&(h+="uniform mat3 matrix_normal;\n");a.skin&&(b=d.getBoneLimit(),h+="uniform mat4 matrix_pose["+b+"];\n");for(b=0;b<k;b++)if(b<e&&(h+="uniform vec3 light"+b+"_direction;\n"),b>=e&&(h+="uniform vec3 light"+b+"_position;\n"),b>=e+g&&(h+="uniform vec3 light"+b+"_spotDirection;\n"),b>=a.numDirs&&b<e||b>=e+a.numPnts&&b<e+g||b>=e+g+a.numSpts&&b<k)h+="uniform mat4 light"+b+"_shadowMatrix;\n";l&&(h+="uniform vec3 view_position;\n");a.diffuseMap&&a.diffuseMapTransform&&
(h+="uniform mat4 texture_diffuseMapTransform;\n");a.normalMap&&a.normalMapTransform&&(h+="uniform mat4 texture_normalMapTransform;\n");a.heightMap&&a.heightMapTransform&&(h+="uniform mat4 texture_heightMapTransform;\n");a.opacityMap&&a.opacityMapTransform&&(h+="uniform mat4 texture_opacityMapTransform;\n");a.specularMap&&a.specularMapTransform&&(h+="uniform mat4 texture_specularMapTransform;\n");a.glossMap&&a.glossMapTransform&&(h+="uniform mat4 texture_glossMapTransform;\n");a.emissiveMap&&a.emissiveMapTransform&&
(h+="uniform mat4 texture_emissiveMapTransform;\n");h+="\n";if(l){if(!a.normalMap||!r)h+="varying vec3 vNormalW;\n";h+="varying vec3 vViewDirW;\n";for(b=0;b<k;b++)if(h+="varying vec3 vLight"+b+"DirW;\n",b>=e+g&&(h+="varying vec3 vLight"+b+"SpotDirW;\n"),b>=a.numDirs&&b<e||b>=e+a.numPnts&&b<e+g||b>=e+g+a.numSpts&&b<k)h+="varying vec4 vLight"+b+"ShadowCoord;\n"}n&&(h+="varying vec2 vUv0;\n");a.diffuseMap&&a.diffuseMapTransform&&(h+="varying vec2 vUvDiffuseMap;\n");if(l&&(a.specularMap&&a.specularMapTransform&&
(h+="varying vec2 vUvSpecularMap;\n"),a.glossMap&&a.glossMapTransform&&(h+="varying vec2 vUvGlossMap;\n"),a.normalMap&&a.normalMapTransform||a.heightMap&&a.heightMapTransform))h+="varying vec2 vUvBumpMap;\n";a.emissiveMap&&a.emissiveMapTransform&&(h+="varying vec2 vUvEmissiveMap;\n");a.opacityMap&&a.opacityMapTransform&&(h+="varying vec2 vUvOpacityMap;\n");a.lightMap&&(h+="varying vec2 vUvLightMap;\n");a.vertexColors&&(h+="varying vec4 vVertexColor;\n");h+="\n";h+="void main(void)\n";h+="{\n";h+=
"    vec4 position = vec4(vertex_position, 1.0);\n";if(l||a.cubeMap||a.sphereMap)h+="    vec4 normal = vec4(vertex_normal, 0.0);\n",a.normalMap&&r&&(h+="    vec4 tangent = vec4(vertex_tangent.xyz, 0.0);\n");h+="\n";if(a.skin){if(h+="    mat4 model = vertex_boneWeights.x * matrix_pose[int(vertex_boneIndices.x)] +\n",h+="                 vertex_boneWeights.y * matrix_pose[int(vertex_boneIndices.y)] +\n",h+="                 vertex_boneWeights.z * matrix_pose[int(vertex_boneIndices.z)] +\n",h+="                 vertex_boneWeights.w * matrix_pose[int(vertex_boneIndices.w)];\n",
h+="    vec4 positionW = model * position;\n",l||a.cubeMap||a.sphereMap)h+="    vec3 normalW = (model * normal).xyz;\n",a.normalMap&&r&&(h+="    vec3 tangentW = (model * tangent).xyz;\n")}else{h+="    vec4 positionW = matrix_model * position;\n";if(l||a.cubeMap||a.sphereMap)h+="    vec3 normalW = matrix_normal * normal.xyz;\n",a.normalMap&&r&&(h+="    vec3 tangentW = matrix_normal * tangent.xyz;\n");h+="\n"}if(l||a.cubeMap||a.sphereMap)h+="    normalW = normalize(normalW);\n",a.normalMap&&r&&(h+=
"    tangentW  = normalize(tangentW);\n"),h+="\n";h+="    gl_Position = matrix_viewProjection * positionW;\n\n";if(l){if(a.normalMap&&r){h+="    vec3 binormalW = cross(normalW, tangentW) * vertex_tangent.w;\n";h+="    mat3 tbnMatrix = mat3(tangentW.x, binormalW.x, normalW.x,\n";h+="                          tangentW.y, binormalW.y, normalW.y,\n";h+="                          tangentW.z, binormalW.z, normalW.z);\n";h+="    vViewDirW = tbnMatrix * (view_position - positionW.xyz);\n";for(b=0;b<k;b++)b<
e&&(h+="    vLight"+b+"DirW = -(tbnMatrix * light"+b+"_direction);\n"),b>=e&&(h+="    vLight"+b+"DirW = tbnMatrix * (light"+b+"_position - positionW.xyz);\n"),b>=e+g&&(h+="    vLight"+b+"SpotDirW = tbnMatrix * light"+b+"_spotDirection;\n")}else{h+="    vNormalW = normalW;\n";h+="    vViewDirW = view_position - positionW.xyz;\n";for(b=0;b<k;b++)b<e&&(h+="    vLight"+b+"DirW = -light"+b+"_direction;\n"),b>=e&&(h+="    vLight"+b+"DirW = light"+b+"_position - positionW.xyz;\n"),b>=e+g&&(h+="    vLight"+
b+"SpotDirW = light"+b+"_spotDirection;\n")}for(b=0;b<k;b++)if(b>=a.numDirs&&b<e||b>=e+a.numPnts&&b<e+g||b>=e+g+a.numSpts&&b<k)h+="    vLight"+b+"ShadowCoord = light"+b+"_shadowMatrix * positionW;\n";h+="\n"}n&&(h+="    vUv0 = vertex_texCoord0;\n");a.diffuseMap&&a.diffuseMapTransform&&(h+="    vUvDiffuseMap = (texture_diffuseMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n");l&&(a.specularMap&a.specularMapTransform&&(h+="    vUvSpecularMap = (texture_specularMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n"),
a.glossMap&a.glossMapTransform&&(h+="    vUvGlossMap = (texture_glossMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n"),a.normalMap&&a.normalMapTransform?h+="    vUvBumpMap = (texture_normalMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n":a.heightMap&&a.heightMapTransform&&(h+="    vUvBumpMap = (texture_heightMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n"));a.opacityMap&&a.opacityMapTransform&&(h+="    vUvOpacityMap = (texture_opacityMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n");
a.emissiveMap&&a.emissiveMapTransform&&(h+="    vUvEmissiveMap = (texture_emissiveMapTransform * vec4(vertex_texCoord0, 0, 1)).st;\n");a.lightMap&&(h+="    vUvLightMap = vertex_texCoord1;\n");var u=h+="}";h=s(d,"fs_precision");if(a.normalMap&&!r||a.heightMap)h+="#extension GL_OES_standard_derivatives : enable\n\n";if(l){if(!a.normalMap||!r)h+="varying vec3 vNormalW;\n";h+="varying vec3 vViewDirW;\n";for(b=0;b<k;b++)if(h+="varying vec3 vLight"+b+"DirW;\n",b>=e+g&&(h+="varying vec3 vLight"+b+"SpotDirW;\n"),
b>=a.numDirs&&b<e||b>=e+a.numPnts&&b<e+g||b>=e+g+a.numSpts&&b<k)h+="varying vec4 vLight"+b+"ShadowCoord;\n"}n&&(h+="varying vec2 vUv0;\n");a.diffuseMap&&a.diffuseMapTransform&&(h+="varying vec2 vUvDiffuseMap;\n");if(l&&(a.specularMap&&a.specularMapTransform&&(h+="varying vec2 vUvSpecularMap;\n"),a.glossMap&&a.glossMapTransform&&(h+="varying vec2 vUvGlossMap;\n"),a.normalMap&&a.normalMapTransform||a.heightMap&&a.heightMapTransform))h+="varying vec2 vUvBumpMap;\n";a.emissiveMap&&a.emissiveMapTransform&&
(h+="varying vec2 vUvEmissiveMap;\n");a.opacityMap&&a.opacityMapTransform&&(h+="varying vec2 vUvOpacityMap;\n");a.lightMap&&(h+="varying vec2 vUvLightMap;\n");a.vertexColors&&(h+="varying vec4 vVertexColor;\n");h+="\n";a.diffuseMap?h+="uniform sampler2D texture_diffuseMap;\n":(h+="uniform vec3 material_ambient;\n",h+="uniform vec3 material_diffuse;\n");l&&(h=a.specularMap?h+"uniform sampler2D texture_specularMap;\n":h+"uniform vec3 material_specular;\n",h=a.glossMap?h+"uniform sampler2D texture_glossMap;\n":
h+"uniform float material_shininess;\n");h=a.emissiveMap?h+"uniform sampler2D texture_emissiveMap;\n":h+"uniform vec3 material_emissive;\n";a.lightMap&&(h+="uniform sampler2D texture_lightMap;\n");if(l&&(a.normalMap&&(h+="uniform sampler2D texture_normalMap;\n",h+="uniform float material_bumpMapFactor;\n"),a.heightMap&&(h+="uniform sampler2D texture_heightMap;\n"),a.cubeMap||a.sphereMap))h+="uniform float material_reflectionFactor;\n",a.sphereMap?(h+="uniform mat4 matrix_view;\n",h+="uniform sampler2D texture_sphereMap;\n"):
h+="uniform samplerCube texture_cubeMap;\n";h=a.opacityMap?h+"uniform sampler2D texture_opacityMap;\n":h+"uniform float material_opacity;\n";h+="uniform vec3 light_globalAmbient;\n";for(b=0;b<k;b++)if(h+="uniform vec3 light"+b+"_color;\n",b>=e&&(h+="uniform float light"+b+"_radius;\n",b>=e+g&&(h+="uniform float light"+b+"_innerConeAngle;\n",h+="uniform float light"+b+"_outerConeAngle;\n")),b>=a.numDirs&&b<e||b>=e+a.numPnts&&b<e+g||b>=e+g+a.numSpts&&b<k)h+="uniform vec3 light"+b+"_shadowParams;\n",
h+="uniform sampler2D light"+b+"_shadowMap;\n";switch(a.fog){case "linear":h+=s(d,"fs_fog_linear_decl");break;case "exp":h+=s(d,"fs_fog_exp_decl");break;case "exp2":h+=s(d,"fs_fog_exp2_decl")}h+=s(d,"fs_alpha_test_decl");a.normalMap?h+=s(d,"fs_normal_map_funcs"):a.heightMap&&(h+=s(d,"fs_height_map_funcs"));h+="\n";0<c&&(h+="float calculateShadowFactor(const in vec4 sc, const in vec3 sp, const in sampler2D shadowMap)\n",h+="{\n",h+="    float depth;\n",h+="    float depthBias = sp.z;\n",h+="    vec3 shadowCoord = sc.xyz / sc.w;\n",
h+="    shadowCoord.z += depthBias;\n",h+="    bvec4 containedVec = bvec4(shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0);\n",h+="    bool contained = all(bvec2(all(containedVec), shadowCoord.z <= 1.0));\n",h+="    if (contained)\n",h+="    {\n",h+="        float shadowAccum = 0.0;\n",h+="        float xoffset = 1.0 / sp[0];\n",h+="        float yoffset = 1.0 / sp[1];\n",h+="        float dx0 = -xoffset;\n",h+="        float dy0 = -yoffset;\n",h+="        float dx1 = xoffset;\n",
h+="        float dy1 = yoffset;\n",h+="        mat3 shadowKernel;\n",h+="        mat3 depthKernel;\n",h+="        const vec4 bit_shift = vec4(5.96046e-08, 1.52588e-05, 0.00390625, 1.0);\n",h+="        depthKernel[0][0] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dy0)), bit_shift);\n",h+="        shadowKernel[0][0] = (depthKernel[0][0] < shadowCoord.z) ? 0.25 : 0.0;\n",h+="        depthKernel[0][1] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)), bit_shift);\n",h+="        shadowKernel[0][1] = (depthKernel[0][1] < shadowCoord.z) ? 0.25 : 0.0;\n",
h+="        depthKernel[0][2] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dy1)), bit_shift);\n",h+="        shadowKernel[0][2] = (depthKernel[0][2] < shadowCoord.z) ? 0.25 : 0.0;\n",h+="        depthKernel[1][0] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dy0)), bit_shift);\n",h+="        shadowKernel[1][0] = (depthKernel[1][0] < shadowCoord.z) ? 0.25 : 0.0;\n",h+="        depthKernel[1][1] = dot(texture2D(shadowMap, shadowCoord.xy), bit_shift);\n",h+="        shadowKernel[1][1] = (depthKernel[1][1] < shadowCoord.z) ? 0.25 : 0.0;\n",
h+="        depthKernel[1][2] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dy1)), bit_shift);\n",h+="        shadowKernel[1][2] = (depthKernel[1][2] < shadowCoord.z) ? 0.25 : 0.0;\n",h+="        depthKernel[2][0] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dy0)), bit_shift);\n",h+="        shadowKernel[2][0] = (depthKernel[2][0] < shadowCoord.z) ? 0.25 : 0.0;\n",h+="        depthKernel[2][1] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)), bit_shift);\n",h+="        shadowKernel[2][1] = (depthKernel[2][1] < shadowCoord.z) ? 0.25 : 0.0;\n",
h+="        depthKernel[2][2] = dot(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dy1)), bit_shift);\n",h+="        shadowKernel[2][2] = (depthKernel[2][2] < shadowCoord.z) ? 0.25 : 0.0;\n",h+="        vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * sp.xy );\n",h+="        shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );\n",h+="        shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );\n",h+="        vec4 shadowValues;\n",h+="        shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );\n",
h+="        shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );\n",h+="        shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );\n",h+="        shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );\n",h+="        shadowAccum = 1.0 - dot( shadowValues, vec4( 1.0 ) );\n",h+="        return shadowAccum;\n",h+="    }\n",h+="    else\n",h+="    {\n",h+="        return 1.0;\n",h+="    }\n",h+="}\n\n");h+=s(d,"common_main_begin");
a.diffuseMap&&(h=a.diffuseMapTransform?h+"    vec2 uvDiffuseMap = vUvDiffuseMap;\n":h+"    vec2 uvDiffuseMap = vUv0;\n");if(l&&(a.specularMap&&(h=a.specularMapTransform?h+"    vec2 uvSpecularMap = vUvSpecularMap;\n":h+"    vec2 uvSpecularMap = vUv0;\n"),a.glossMap&&(h=a.glossMapTransform?h+"    vec2 uvGlossMap = vUvGlossMap;\n":h+"    vec2 uvGlossMap = vUv0;\n"),a.normalMap||a.heightMap))h=a.normalMapTransform||a.heightMapTransform?h+"    vec2 uvBumpMap = vUvBumpMap;\n":h+"    vec2 uvBumpMap = vUv0;\n";
a.opacityMap&&(h=a.opacityMapTransform?h+"    vec2 uvOpacityMap = vUvOpacityMap;\n":h+"    vec2 uvOpacityMap = vUv0;\n");a.emissiveMap&&(h=a.emissiveMapTransform?h+"    vec2 uvEmissiveMap = vUvEmissiveMap;\n":h+"    vec2 uvEmissiveMap = vUv0;\n");a.lightMap&&(h+="    vec2 uvLightMap = vUvLightMap;\n");if(l){h+="    vec3 viewDirW = normalize(vViewDirW);\n";if(!a.normalMap||!r)h+="    vec3 normalW = normalize(vNormalW);\n";a.normalMap&&a.heightMap&&(h+="    const float parallaxScale = 0.025;\n",h+=
"    const float parallaxBias = 0.01;\n",h+="    float height = texture2D(texture_heightMap, uvBumpMap).a * parallaxScale - parallaxBias;\n",h+="    uvBumpMap = uvBumpMap - min(height * viewDirW.xy, vec2(parallaxBias));\n",a.diffuseMap&&(h+="    uvDiffuseMap = uvDiffuseMap - min(height * viewDirW.xy, vec2(parallaxBias));\n"),a.specularMap&&(h+="    uvSpecularMap = uvSpecularMap - min(height * viewDirW.xy, vec2(parallaxBias));\n"));h+="\n"}a.diffuseMap?(h+="    vec3 diffuseColor = texture2D(texture_diffuseMap, uvDiffuseMap).rgb;\n",
h+="    vec3 ambientColor = diffuseColor;\n"):(h+="    vec3 ambientColor = material_ambient;\n",h+="    vec3 diffuseColor = material_diffuse;\n");l&&(h=a.specularMap?h+"    vec3 specularColor = texture2D(texture_specularMap, uvSpecularMap).rgb;\n":h+"    vec3 specularColor = material_specular;\n",h=a.glossMap?h+"    float shininess = texture2D(texture_glossMap, uvGlossMap).r * 100.0 + 0.0001;\n":h+"    float shininess = material_shininess + 0.0001;\n");h=a.emissiveMap?h+"    vec3 emissiveColor = texture2D(texture_emissiveMap, uvEmissiveMap).rgb;\n":
h+"    vec3 emissiveColor = material_emissive;\n";h=a.opacityMap?h+"    float opacity = texture2D(texture_opacityMap, uvOpacityMap).r;\n":h+"    float opacity = material_opacity;\n";h+="\n";if(l||a.lightMap)h+="    vec3 diffuseContrib = vec3(0.0);\n";if(l){h+="    vec3 specularContrib = vec3(0.0);\n";a.normalMap?r?(h+="    vec3 N = normalize(texture2D(texture_normalMap, uvBumpMap).xyz * 2.0 - 1.0);\n",h+="    N = normalize(mix(vec3(0.0, 0.0, 1.0), N, material_bumpMapFactor));\n"):h+="    vec3 N = perturb_normal(normalW, viewDirW, uvBumpMap);\n":
h+="    vec3 N = normalW;\n";h+="    vec3 L, R;\n";h+="    float diffuseLight, specularLight;\n";0<g+f&&(h+="    float d, attenuation;\n");0<f&&(h+="    float cosAngle, spotEffect;\n");0<c&&(h+="    float shadowFactor;\n");h+="\n";for(b=0;b<k;b++)c=b>=e,f=b>=e+g,n=b>=a.numDirs&&b<e||b>=e+a.numPnts&&b<e+g||b>=e+g+a.numSpts&&b<k,h+="    L = normalize(vLight"+b+"DirW);\n",h+="    diffuseLight = max(dot(N, L), 0.0);\n",h+="    R = normalize(-reflect(L, N));\n",h+="    specularLight = pow(max(dot(R, viewDirW), 0.0), shininess);\n",
c&&(h+="    d = length(vLight"+b+"DirW);\n",h+="    attenuation = max(((light"+b+"_radius - d) / light"+b+"_radius), 0.0);\n"),f&&(h+="    cosAngle = dot(-L, vLight"+b+"SpotDirW);\n",h+="    spotEffect = smoothstep(light"+b+"_outerConeAngle, light"+b+"_innerConeAngle, cosAngle);\n"),n&&(h+="    shadowFactor = calculateShadowFactor(vLight"+b+"ShadowCoord, light"+b+"_shadowParams, light"+b+"_shadowMap);\n"),h+="    diffuseContrib += light"+b+"_color * diffuseLight"+(c?" * attenuation":"")+(f?" * spotEffect":
"")+(n?" * shadowFactor":"")+";\n",h+="    if (diffuseLight <= 0.0) specularLight = 0.0;\n",h+="    specularContrib += light"+b+"_color * specularLight"+(c?" * attenuation":"")+(f?" * spotEffect":"")+(n?" * shadowFactor":"")+";\n\n"}a.lightMap&&(h+="    diffuseContrib += texture2D(texture_lightMap, uvLightMap).rgb;\n");if(l&&(a.cubeMap||a.sphereMap))h+="    vec3 reflectW = -reflect(viewDirW, N);\n",a.cubeMap?h+="    vec3 reflectionColor = textureCube(texture_cubeMap, reflectW).rgb;\n":a.sphereMap&&
(h+="    vec3 reflectE = (matrix_view * vec4(reflectW, 0.0)).xyz;\n",h+="    float m = 2.0 * sqrt( dot(reflectE.xy, reflectE.xy) + (reflectE.z+1.0)*(reflectE.z+1.0) );\n",h+="    vec2 sphereMapUv = reflectE.xy / m + 0.5;\n",h+="    vec3 reflectionColor = texture2D(texture_sphereMap, sphereMapUv).rgb;\n"),h+="    diffuseColor = mix(diffuseColor, reflectionColor, material_reflectionFactor);\n\n";h+="    vec3 ambient  = ambientColor * light_globalAmbient;\n";if(l||a.lightMap)h+="    vec3 diffuse  = diffuseColor * diffuseContrib;\n";
l&&(h+="    vec3 specular = specularColor * specularContrib;\n");h+="    vec3 emissive = emissiveColor;\n\n";h+="    gl_FragColor.rgb  = ambient;\n";if(l||a.lightMap)h+="    gl_FragColor.rgb += diffuse;\n";l&&(h+="    gl_FragColor.rgb += specular;\n");h+="    gl_FragColor.rgb += emissive;\n";h+="    gl_FragColor.a    = opacity;\n\n";h+=s(d,"fs_alpha_test");h+=s(d,"fs_clamp");switch(a.fog){case "linear":h+=s(d,"fs_fog_linear");break;case "exp":h+=s(d,"fs_fog_exp");break;case "exp2":h+=s(d,"fs_fog_exp2")}h+=
s(d,"common_main_end");return{attributes:m,vshader:u,fshader:h}}};pc.gfx.programlib.pick={generateKey:function(d,a){var b="pick";a.skin&&(b+="_skin");return b},createShaderDefinition:function(d,a){var b={vertex_position:pc.gfx.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.gfx.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.gfx.SEMANTIC_BLENDINDICES);var c=pc.gfx.programlib.getSnippet,e="",e=a.skin?e+c(d,"vs_skin_position_decl"):e+c(d,"vs_static_position_decl"),e=e+c(d,"common_main_begin"),e=a.skin?e+c(d,"vs_skin_position"):e+c(d,"vs_static_position"),g=e+=c(d,
"common_main_end"),e=c(d,"fs_precision"),e=e+c(d,"fs_flat_color_decl"),e=e+c(d,"common_main_begin"),e=e+c(d,"fs_flat_color"),e=e+c(d,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.gfx.programlib.skybox={generateKey:function(){return"skybox"},createShaderDefinition:function(d){var a=pc.gfx.programlib.getSnippet;return{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec3 aPosition;\n\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n}",
fshader:a(d,"fs_precision")+"varying vec3 vViewDir;\n\nuniform samplerCube texture_cubeMap;\n\nvoid main(void)\n{\n    gl_FragColor = textureCube(texture_cubeMap, vec3(-vViewDir.x, vViewDir.yz));\n}"}}};pc.posteffect={createFullscreenQuad:function(d){var a=new pc.gfx.VertexFormat(d,[{semantic:pc.gfx.SEMANTIC_POSITION,components:2,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),d=new pc.gfx.VertexBuffer(d,a,4),a=new pc.gfx.VertexIterator(d);a.element[pc.gfx.SEMANTIC_POSITION].set(-1,-1);a.next();a.element[pc.gfx.SEMANTIC_POSITION].set(1,-1);a.next();a.element[pc.gfx.SEMANTIC_POSITION].set(-1,1);a.next();a.element[pc.gfx.SEMANTIC_POSITION].set(1,1);a.end();return d},drawFullscreenQuad:function(d,a,b,c){d.setRenderTarget(a);
d.updateBegin();var e=null!==a?a.width:d.width,a=null!==a?a.height:d.height;d.setViewport(0,0,e,a);d.setScissor(0,0,e,a);e=d.getDepthTest();a=d.getDepthWrite();d.setDepthTest(!1);d.setDepthWrite(!1);d.setVertexBuffer(b,0);d.setShader(c);d.draw({type:pc.gfx.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});d.setDepthTest(e);d.setDepthWrite(a);d.updateEnd()}};pc.extend(pc.posteffect,function(){function d(a){this.device=a;this.shader=new pc.gfx.Shader(a,{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition.xy + 1.0) * 0.5;\n}",fshader:["precision "+a.precision+" float;","\nuniform float uMixRatio;\nuniform sampler2D uColorBuffer;\nuniform sampler2D uBlendMap;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    vec4 texel1 = texture2D(uColorBuffer, vUv0);\n    vec4 texel2 = texture2D(uBlendMap, vUv0);\n    gl_FragColor = mix(texel1, texel2, uMixRatio);\n}"].join("\n")});
this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.mixRatio=0.5;this.blendMap=new pc.gfx.Texture(a)}d.prototype={render:function(a,b){var c=this.device,e=c.scope;e.resolve("uMixRatio").setValue(this.mixRatio);e.resolve("uColorBuffer").setValue(a.colorBuffer);e.resolve("uBlendMap").setValue(this.blendMap);pc.posteffect.drawFullscreenQuad(c,b,this.vertexBuffer,this.shader)}};return{Blend:d}}());pc.extend(pc.posteffect,function(){function d(a,e,d,f,k){a[0]=1/Math.sqrt(2*Math.PI*k)*Math.exp(-0/(2*k*k));e[0]=0;e[1]=0;var l=a[0],n,r;n=0;for(r=Math.floor(b/2);n<r;n++){var m=1/Math.sqrt(2*Math.PI*k)*Math.exp(-((n+1)*(n+1))/(2*k*k));a[2*n]=m;a[2*n+1]=m;l+=2*m;m=2*n+1.5;e[4*n]=d*m;e[4*n+1]=f*m;e[4*n+2]=-d*m;e[4*n+3]=-f*m}n=0;for(r=a.length;n<r;n++)a[n]/=l}function a(a){this.device=a;var e={aPosition:pc.gfx.SEMANTIC_POSITION},d=["precision "+a.precision+" float;","\nvarying vec2 vUv0;\n\nuniform sampler2D uBaseTexture;\nuniform float uBloomThreshold;\n\nvoid main(void)\n{\n    vec4 color = texture2D(uBaseTexture, vUv0);\n\n    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);\n}"].join("\n"),
f=["precision "+a.precision+" float;","","#define SAMPLE_COUNT "+b,"\nvarying vec2 vUv0;\n\nuniform sampler2D uBloomTexture;\nuniform vec2 uBlurOffsets[SAMPLE_COUNT];\nuniform float uBlurWeights[SAMPLE_COUNT];\n\nvoid main(void)\n{\n    vec4 color = vec4(0.0);\n    for (int i = 0; i < SAMPLE_COUNT; i++)\n    {\n        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];\n    }\n\n    gl_FragColor = color;\n}"].join("\n"),k=["precision "+a.precision+" float;","\nvarying vec2 vUv0;\n\n#define uBloomIntensity uCombineParams.x\n#define uBaseIntensity uCombineParams.y\n#define uBloomSaturation uCombineParams.z\n#define uBaseSaturation uCombineParams.w\nuniform vec4 uCombineParams;\nuniform sampler2D uBaseTexture;\nuniform sampler2D uBloomTexture;\n\nvec4 adjust_saturation(vec4 color, float saturation)\n{\n    float grey = dot(color.rgb, vec3(0.3, 0.59, 0.11));\n\n    return mix(vec4(grey), color, saturation);\n}\n\nvoid main(void)\n{\n    vec4 bloom = texture2D(uBloomTexture, vUv0);\n    vec4 base = texture2D(uBaseTexture, vUv0);\n\n    bloom = adjust_saturation(bloom, uBloomSaturation) * uBloomIntensity;\n    base = adjust_saturation(base, uBaseSaturation) * uBaseIntensity;\n\n    base *= (1.0 - clamp(bloom, 0.0, 1.0));\n\n    gl_FragColor = base + bloom;\n}"].join("\n");
this.extractShader=new pc.gfx.Shader(a,{attributes:e,vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition + 1.0) * 0.5;\n}",fshader:d});this.blurShader=new pc.gfx.Shader(a,{attributes:e,vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition + 1.0) * 0.5;\n}",fshader:f});this.combineShader=new pc.gfx.Shader(a,{attributes:e,
vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition + 1.0) * 0.5;\n}",fshader:k});this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);e=a.width;d=a.height;this.targets=[];for(f=0;2>f;f++)k=new pc.gfx.Texture(a,{format:pc.gfx.PIXELFORMAT_R8_G8_B8,width:e>>1,height:d>>1}),k.minFilter=pc.gfx.FILTER_LINEAR,k.magFilter=pc.gfx.FILTER_LINEAR,k.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE,k.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE,
k=new pc.gfx.RenderTarget(a,k,{depth:!1}),this.targets.push(k);this.bloomThreshold=0.25;this.blurAmount=4;this.bloomIntensity=1.25;this.baseSaturation=this.bloomSaturation=this.baseIntensity=1;this.combineParams=new Float32Array(4);this.sampleWeights=new Float32Array(b);this.sampleOffsets=new Float32Array(2*b)}var b=15;a.prototype={render:function(a,b){var g=this.device,f=g.scope;f.resolve("uBloomThreshold").setValue(this.bloomThreshold);f.resolve("uBaseTexture").setValue(a.colorBuffer);pc.posteffect.drawFullscreenQuad(g,
this.targets[0],this.vertexBuffer,this.extractShader);d(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount);f.resolve("uBlurWeights[0]").setValue(this.sampleWeights);f.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets);f.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer);pc.posteffect.drawFullscreenQuad(g,this.targets[1],this.vertexBuffer,this.blurShader);d(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount);f.resolve("uBlurWeights[0]").setValue(this.sampleWeights);
f.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets);f.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer);pc.posteffect.drawFullscreenQuad(g,this.targets[0],this.vertexBuffer,this.blurShader);this.combineParams[0]=this.bloomIntensity;this.combineParams[1]=this.baseIntensity;this.combineParams[2]=this.bloomSaturation;this.combineParams[3]=this.baseSaturation;f.resolve("uCombineParams").setValue(this.combineParams);f.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer);f.resolve("uBaseTexture").setValue(a.colorBuffer);
pc.posteffect.drawFullscreenQuad(g,b,this.vertexBuffer,this.combineShader)}};return{Bloom:a}}());pc.extend(pc.posteffect,function(){function d(a){this.device=a;this.shader=new pc.gfx.Shader(a,{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition.xy + 1.0) * 0.5;\n}",fshader:["precision "+a.precision+" float;","\nvarying vec2 vUv0;\n\nuniform sampler2D uColorBuffer;\nuniform sampler2D uDepthMap;\n\nuniform float uMaxBlur;\nuniform float uAperture;\n\nuniform float uFocus;\nuniform float uAspect;\n\nvoid main()\n{\n    vec2 aspectCorrect = vec2( 1.0, uAspect );\n\n    vec4 depth1 = texture2D( uDepthMap, vUv0 );\n\n    float factor = depth1.x - uFocus;\n\n    vec2 dofblur = vec2 ( clamp( factor * uAperture, -uMaxBlur, uMaxBlur ) );\n\n    vec2 dofblur9 = dofblur * 0.9;\n    vec2 dofblur7 = dofblur * 0.7;\n    vec2 dofblur4 = dofblur * 0.4;\n\n    vec4 col;\n\n    col  = texture2D( uColorBuffer, vUv0 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur );\n\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur9 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur9 );\n\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur7 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur7 );\n\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.4,   0.0  ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur4 );\n    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur4 );\n\n    gl_FragColor = col / 41.0;\n    gl_FragColor.a = 1.0;\n}"].join("\n")});
this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.maxBlur=1;this.aperture=0.025;this.aspect=this.focus=1;this.depthMap=new pc.gfx.Texture(a)}d.prototype={render:function(a,b){var c=this.device,e=c.scope;e.resolve("uMaxBlur").setValue(this.maxBlur);e.resolve("uAperture").setValue(this.aperture);e.resolve("uFocus").setValue(this.focus);e.resolve("uAspect").setValue(this.aspect);e.resolve("uColorBuffer").setValue(a.colorBuffer);e.resolve("uDepthMap").setValue(this.depthMap);pc.posteffect.drawFullscreenQuad(c,
b,this.vertexBuffer,this.shader)}};return{Bokeh:d}}());pc.extend(pc.posteffect,function(){function d(a){this.device=a;this.shader=new pc.gfx.Shader(a,{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition.xy + 1.0) * 0.5;\n}",fshader:["precision "+a.precision+" float;","\nuniform sampler2D uColorBuffer;\nvarying vec2 vUv0;\nuniform vec2 uResolution;\n\nmat3 G[2];\n\nconst mat3 g0 = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );\nconst mat3 g1 = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );\n\nvoid main(void)\n{\n    mat3 I;\n    float cnv[2];\n    vec3 sample;\n\n    G[0] = g0;\n    G[1] = g1;\n\n    for (float i = 0.0; i < 3.0; i++)\n    {\n        for (float j = 0.0; j < 3.0; j++)\n        {\n            sample = texture2D(uColorBuffer, vUv0 + uResolution * vec2(i - 1.0, j - 1.0)).rgb;\n            I[int(i)][int(j)] = length(sample);\n         }\n    }\n\n    for (int i=0; i<2; i++)\n    {\n        float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);\n        cnv[i] = dp3 * dp3; \n    }\n\n    gl_FragColor = vec4(0.5 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]));\n}"].join("\n")});
this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.resolution=new Float32Array(2)}d.prototype={render:function(a,b){var c=this.device,e=c.scope;this.resolution[0]=1/a.width;this.resolution[1]=1/a.height;e.resolve("uResolution").setValue(this.resolution);e.resolve("uColorBuffer").setValue(a.colorBuffer);pc.posteffect.drawFullscreenQuad(c,b,this.vertexBuffer,this.shader)}};return{EdgeDetect:d}}());pc.extend(pc.posteffect,function(){function d(a){this.device=a;var b={aPosition:pc.gfx.SEMANTIC_POSITION},c=["precision "+a.precision+" float;","\nuniform sampler2D uColorBuffer;\nuniform vec2 uResolution;\n\n#define FXAA_REDUCE_MIN   (1.0/128.0)\n#define FXAA_REDUCE_MUL   (1.0/8.0)\n#define FXAA_SPAN_MAX     8.0\n\nvoid main()\n{\n    vec3 rgbNW = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * uResolution ).xyz;\n    vec3 rgbNE = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * uResolution ).xyz;\n    vec3 rgbSW = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * uResolution ).xyz;\n    vec3 rgbSE = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * uResolution ).xyz;\n    vec4 rgbaM  = texture2D( uColorBuffer,  gl_FragCoord.xy  * uResolution );\n    vec3 rgbM  = rgbaM.xyz;\n    float opacity  = rgbaM.w;\n\n    vec3 luma = vec3( 0.299, 0.587, 0.114 );\n\n    float lumaNW = dot( rgbNW, luma );\n    float lumaNE = dot( rgbNE, luma );\n    float lumaSW = dot( rgbSW, luma );\n    float lumaSE = dot( rgbSE, luma );\n    float lumaM  = dot( rgbM,  luma );\n    float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );\n    float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );\n\n    vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n    float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );\n\n    float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );\n    dir = min( vec2( FXAA_SPAN_MAX, FXAA_SPAN_MAX), max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * uResolution;\n\n    vec3 rgbA = 0.5 * (\n        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +\n        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );\n\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * -0.5 ).xyz +\n        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * 0.5 ).xyz );\n\n    float lumaB = dot( rgbB, luma );\n\n    if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) )\n    {\n        gl_FragColor = vec4( rgbA, opacity );\n    }\n    else\n    {\n        gl_FragColor = vec4( rgbB, opacity );\n    }\n}"].join("\n");
this.fxaaShader=new pc.gfx.Shader(a,{attributes:b,vshader:"attribute vec2 aPosition;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n}",fshader:c});this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.resolution=new Float32Array(2)}d.prototype={render:function(a,b){var c=this.device,e=c.scope;this.resolution[0]=1/a.width;this.resolution[1]=1/a.height;e.resolve("uResolution").setValue(this.resolution);e.resolve("uColorBuffer").setValue(a.colorBuffer);pc.posteffect.drawFullscreenQuad(c,
b,this.vertexBuffer,this.fxaaShader)}};return{Fxaa:d}}());pc.extend(pc.posteffect,function(){function d(a){this.device=a;this.shader=new pc.gfx.Shader(a,{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition.xy + 1.0) * 0.5;\n}",fshader:["precision "+a.precision+" float;","\nuniform sampler2D uColorBuffer;\n\nvarying vec2 vUv0;\n\nvoid main() {\nvec4 texel = texture2D(uColorBuffer, vUv0);\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat v = dot(texel.xyz, luma);\ngl_FragColor = vec4(v, v, v, texel.w);\n}"].join("\n")});
this.vertexBuffer=pc.posteffect.createFullscreenQuad(a)}d.prototype={render:function(a,b){var c=this.device;c.scope.resolve("uColorBuffer").setValue(a.colorBuffer);pc.posteffect.drawFullscreenQuad(c,b,this.vertexBuffer,this.shader)}};return{Luminosity:d}}());pc.extend(pc.posteffect,function(){function d(a){this.device=a;this.shader=new pc.gfx.Shader(a,{attributes:{aPosition:pc.gfx.SEMANTIC_POSITION},vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition.xy + 1.0) * 0.5;\n}",fshader:["precision "+a.precision+" float;","\nuniform float uAmount;\nuniform sampler2D uColorBuffer;\n\nvarying vec2 vUv0;\n\nvoid main() {\n    vec4 color = texture2D(uColorBuffer, vUv0);\n    vec3 c = color.rgb;\n\n    color.r = dot(c, vec3(1.0 - 0.607 * uAmount, 0.769 * uAmount, 0.189 * uAmount));\n    color.g = dot(c, vec3(0.349 * uAmount, 1.0 - 0.314 * uAmount, 0.168 * uAmount));\n    color.b = dot(c, vec3(0.272 * uAmount, 0.534 * uAmount, 1.0 - 0.869 * uAmount));\n\n    gl_FragColor = vec4(min(vec3(1.0), color.rgb), color.a);\n}"].join("\n")});
this.vertexBuffer=pc.posteffect.createFullscreenQuad(a);this.amount=1}d.prototype={render:function(a,b){var c=this.device,e=c.scope;e.resolve("uAmount").setValue(this.amount);e.resolve("uColorBuffer").setValue(a.colorBuffer);pc.posteffect.drawFullscreenQuad(c,b,this.vertexBuffer,this.shader)}};return{Sepia:d}}());pc.extend(pc.posteffect,function(){function d(a){this.device=a;var b={aPosition:pc.gfx.SEMANTIC_POSITION},c=["precision "+a.precision+" float;","\nuniform sampler2D uColorBuffer;\nuniform float uDarkness;\nuniform float uOffset;\n\nvarying vec2 vUv0;\n\nvoid main() {\n    vec4 texel = texture2D(uColorBuffer, vUv0);\n    vec2 uv = (vUv0 - vec2(0.5)) * vec2(uOffset);\n    gl_FragColor = vec4(mix(texel.rgb, vec3(1.0 - uDarkness), dot(uv, uv)), texel.a);\n}"].join("\n");this.vignetteShader=new pc.gfx.Shader(a,
{attributes:b,vshader:"attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vUv0 = (aPosition.xy + 1.0) * 0.5;\n}",fshader:c});this.vertexBuffer=pc.posteffect.createFullscreenQuad(a)}d.prototype={render:function(a,b){var c=this.device,e=c.scope;e.resolve("uColorBuffer").setValue(a.colorBuffer);e.resolve("uOffset").setValue(1);e.resolve("uDarkness").setValue(1);pc.posteffect.drawFullscreenQuad(c,b,this.vertexBuffer,this.vignetteShader)}};
return{Vignette:d}}());pc.scene={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:3,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2"};
pc.extend(pc.scene,function(){var d=function(){this.drawCalls=[];this.shadowCasters=[];this.fog=pc.scene.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this._models=[];this._lights=[];this._globalLights=[];this._localLights=[[],[]];this.updateShaders=!0};Object.defineProperty(d.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&(this._fog=a,this.updateShaders=!0)}});d.prototype._updateShaders=
function(a){var b,c=[],e=this.drawCalls;for(b=0;b<e.length;b++){var d=e[b];void 0!==d.material&&-1===c.indexOf(d.material)&&c.push(d.material)}for(b=0;b<c.length;b++)c[b].updateShader(a,this)};d.prototype.getModels=function(){return this._models};d.prototype.addModel=function(a){var b;if(-1===this._models.indexOf(a)){this._models.push(a);var c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=this;var e=a.meshInstances.length;for(b=0;b<e;b++)c=a.meshInstances[b],-1===this.drawCalls.indexOf(c)&&this.drawCalls.push(c),
c.castShadow&&-1===this.shadowCasters.indexOf(c)&&this.shadowCasters.push(c);a=a.getLights();b=0;for(len=a.length;b<len;b++)this.addLight(a[b])}};d.prototype.removeModel=function(a){var b,c=this._models.indexOf(a);if(-1!==c){this._models.splice(c,1);c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=null;var e,d=a.meshInstances.length;for(b=0;b<d;b++)e=a.meshInstances[b],c=this.drawCalls.indexOf(e),-1!==c&&this.drawCalls.splice(c,1),e.castShadow&&(c=this.shadowCasters.indexOf(e),-1!==c&&this.shadowCasters.splice(c,
1));a=a.getLights();b=0;for(len=a.length;b<len;b++)this.removeLight(a[b])}};d.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};d.prototype.addLight=function(a){-1!==this._lights.indexOf(a)?console.warn("pc.scene.Scene#addLight: light is already in the scene"):(this._lights.push(a),a._scene=this,this.updateShaders=!0)};d.prototype.removeLight=function(a){var b=this._lights.indexOf(a);-1===b?console.warn("pc.scene.Scene#removeLight: light is not in the scene"):(this._lights.splice(b,
1),a._scene=null,this.updateShaders=!0)};d.prototype.update=function(){for(var a=0,b=this._models.length;a<b;a++)this._models[a].getGraph().syncHierarchy()};return{Scene:d}}());pc.extend(pc.scene,function(){function d(a,b){return a.distSqr&&b.distSqr?b.distSqr-a.distSqr:b.key-a.key}function a(a,b){var c=a.getNearClip(),e=a.getFarClip(),d=a.getFov()*Math.PI/180,g=a.getAspectRatio(),f=a.getProjection(),h,k;k=f===pc.scene.Projection.PERSPECTIVE?Math.tan(d/2)*c:this._orthoHeight;h=k*g;b[0].x=h;b[0].y=-k;b[0].z=-c;b[1].x=h;b[1].y=k;b[1].z=-c;b[2].x=-h;b[2].y=k;b[2].z=-c;b[3].x=-h;b[3].y=-k;b[3].z=-c;f===pc.scene.Projection.PERSPECTIVE&&(k=Math.tan(d/2)*e,h=k*g);b[4].x=h;b[4].y=
-k;b[4].z=-e;b[5].x=h;b[5].y=k;b[5].z=-e;b[6].x=-h;b[6].y=k;b[6].z=-e;b[7].x=-h;b[7].y=-k;b[7].z=-e;return b}function b(a,b,c){b=new pc.gfx.Texture(a,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:b,height:c});b.minFilter=pc.gfx.FILTER_NEAREST;b.magFilter=pc.gfx.FILTER_NEAREST;b.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;return new pc.gfx.RenderTarget(a,b,!0)}function c(a){this.device=a;a=this.device.getProgramLibrary();this._depthProgStatic=a.getProgram("depthrgba",
{skin:!1,opacityMap:!1});this._depthProgSkin=a.getProgram("depthrgba",{skin:!0,opacityMap:!1});this._depthProgStaticOp=a.getProgram("depthrgba",{skin:!1,opacityMap:!0});this._depthProgSkinOp=a.getProgram("depthrgba",{skin:!0,opacityMap:!0});this._depthShaderStatic=a.getProgram("depth",{skin:!1});this._depthShaderSkin=a.getProgram("depth",{skin:!0});a=this.device.scope;this.projId=a.resolve("matrix_projection");this.viewId=a.resolve("matrix_view");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=
a.resolve("matrix_viewProjection");this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.alphaTestId=a.resolve("alpha_ref");this._shadowAabb=
new pc.shape.Aabb;this._sceneAabb=new pc.shape.Aabb;this._shadowState={blend:!1};this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}var e=(new pc.Mat4).setScale(0.5,0.5,0.5),g=(new pc.Mat4).setTranslate(0.5,0.5,0.5),f=(new pc.Mat4).mul2(g,e),k=(new pc.Mat4).setFromAxisAngle(pc.Vec3.RIGHT,-90),l=new pc.Mat4,n=new pc.Mat4,r=new pc.Mat4,m=new pc.Mat4,s=new pc.Mat4,h=[];for(i=0;8>i;i++)h.push(new pc.Vec3);pc.extend(c.prototype,{setCamera:function(a){var b=a.getProjectionMatrix();
this.projId.setValue(b.data);var c=a.getWorldTransform();this.viewInvId.setValue(c.data);m.copy(c).invert();this.viewId.setValue(m.data);s.mul2(b,m);this.viewProjId.setValue(s.data);this.viewPosId.setValue(a.getPosition().data);this.nearClipId.setValue(a.getNearClip());this.farClipId.setValue(a.getFarClip());a._frustum.update(b,m);var b=this.device,e=a.getRenderTarget();b.setRenderTarget(e);b.updateBegin();var c=a.getRect(),d=e?e.width:b.width,g=e?e.height:b.height,e=Math.floor(c.x*d),f=Math.floor(c.y*
g),d=Math.floor(c.width*d),c=Math.floor(c.height*g);b.setViewport(e,f,d,c);b.setScissor(e,f,d,c);b.clear(a.getClearOptions())},dispatchGlobalLights:function(a){var b=a._globalLights,c=b.length,e=this.device.scope;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;e.resolve("light_globalAmbient").setValue(this.ambientColor);for(a=0;a<c;a++){var d=b[a],g=d.getWorldTransform();light="light"+a;e.resolve(light+"_color").setValue(d._finalColor.data);
g.getY(d._direction).scale(-1);e.resolve(light+"_direction").setValue(d._direction.data);d.getCastShadows()&&(g=this.device.extDepthTexture?d._shadowCamera._renderTarget._depthTexture:d._shadowCamera._renderTarget.colorBuffer,e.resolve(light+"_shadowMap").setValue(g),e.resolve(light+"_shadowMatrix").setValue(d._shadowMatrix.data),e.resolve(light+"_shadowParams").setValue([d._shadowResolution,d._shadowResolution,d._shadowBias]))}},dispatchLocalLights:function(a){var b,c,e,d=a._localLights;e=d[pc.scene.LIGHTTYPE_POINT-
1];for(var d=d[pc.scene.LIGHTTYPE_SPOT-1],g=a._globalLights.length,f=e.length,h=d.length,k=this.device.scope,a=0;a<f;a++)c=e[a],b=c.getWorldTransform(),light="light"+(g+a),k.resolve(light+"_radius").setValue(c._attenuationEnd),k.resolve(light+"_color").setValue(c._finalColor.data),b.getTranslation(c._position),k.resolve(light+"_position").setValue(c._position.data);for(a=0;a<h;a++)e=d[a],b=e.getWorldTransform(),light="light"+(g+f+a),k.resolve(light+"_innerConeAngle").setValue(e._innerConeAngleCos),
k.resolve(light+"_outerConeAngle").setValue(e._outerConeAngleCos),k.resolve(light+"_radius").setValue(e._attenuationEnd),k.resolve(light+"_color").setValue(e._finalColor.data),b.getTranslation(e._position),k.resolve(light+"_position").setValue(e._position.data),b.getY(e._direction).scale(-1),k.resolve(light+"_spotDirection").setValue(e._direction.data),e.getCastShadows()&&(b=this.device.extDepthTexture?e._shadowCamera._renderTarget._depthTexture:e._shadowCamera._renderTarget.colorBuffer,k.resolve(light+
"_shadowMap").setValue(b),k.resolve(light+"_shadowMatrix").setValue(e._shadowMatrix.data),k.resolve(light+"_shadowParams").setValue([e._shadowResolution,e._shadowResolution,e._shadowBias]))},render:function(c,e){var g=this.device,m=g.scope;c.updateShaders&&(c._updateShaders(g),c.updateShaders=!1);pc.scene.Scene.current=c;var s=c._lights,A=c.drawCalls,B=c.shadowCasters,E,C,H,x,y,D,K=null;E=0;for(numDrawCalls=c.drawCalls.length;E<numDrawCalls;E++)x=c.drawCalls[E],x.skinInstance&&x.skinInstance.updateMatrixPalette();
c._globalLights.length=0;c._localLights[0].length=0;for(E=c._localLights[1].length=0;E<s.length;E++)x=s[E],x.getEnabled()&&(x.getType()===pc.scene.LIGHTTYPE_DIRECTIONAL?x.getCastShadows()?c._globalLights.push(x):c._globalLights.unshift(x):c._localLights[x.getType()===pc.scene.LIGHTTYPE_POINT?0:1].push(x));C=e.getPosition();E=0;for(numDrawCalls=A.length;E<numDrawCalls;E++)x=A[E],x.command||(x.material.blendType===pc.scene.BLEND_NORMAL?(x.syncAabb(),H=x.aabb.center,y=H.x-C.x,D=H.y-C.y,H=H.z-C.z,x.distSqr=
y*y+D*D+H*H):"undefined"!==typeof x.distSqr&&delete x.distSqr);A.sort(d);if(e._depthTarget){C=e.getRenderTarget();e.setRenderTarget(e._depthTarget);this.setCamera(e);D=g.getBlending();g.setBlending(!1);E=0;for(numDrawCalls=A.length;E<numDrawCalls;E++)x=A[E],!x.command&&x.layer!==pc.scene.LAYER_SKYBOX&&(y=x.mesh,this.modelMatrixId.setValue(x.node.worldTransform.data),x.skinInstance?(this.poseMatrixId.setValue(x.skinInstance.matrixPalette),g.setShader(this._depthShaderSkin)):g.setShader(this._depthShaderStatic),
x=x.renderStyle,g.setVertexBuffer(y.vertexBuffer,0),g.setIndexBuffer(y.indexBuffer[x]),g.draw(y.primitive[x])),e.setRenderTarget(C);g.setBlending(D)}for(E=0;E<s.length;E++)if(x=s[E],C=x.getType(),C!==pc.scene.LIGHTTYPE_POINT&&x.getCastShadows()&&x.getEnabled()){y=g;D=x;H=D._shadowCamera;var G=void 0;if(null===H)H=pc.gfx.CLEARFLAG_DEPTH,y.extDepthTexture||(H|=pc.gfx.CLEARFLAG_COLOR),G=new pc.scene.CameraNode,G.setClearOptions({color:[1,1,1,1],depth:1,flags:H}),H=G,G=b(y,D._shadowResolution,D._shadowResolution),
H.setRenderTarget(G),D._shadowCamera=H;else if(G=H.getRenderTarget(),G.width!==D._shadowResolution||G.height!==D._shadowResolution)G=b(y,D._shadowResolution,D._shadowResolution),H.setRenderTarget(G);y=H;if(C===pc.scene.LIGHTTYPE_DIRECTIONAL){C=e.getFrustumCentroid();y.setPosition(C);D=new pc.Vec3;x.worldTransform.getY(D);y.translate(D);y.lookAt(C);l.copy(y.getWorldTransform());a(e,h);C=l.invert();H=e.worldTransform;D=new pc.Mat4;D.mul2(C,H);for(C=0;8>C;C++)D.transformPoint(h[C],h[C]);D=1E6;H=-1E6;
var G=1E6,I=-1E6,J=1E6,L=-1E6;for(C=0;8>C;C++){var N=h[C];N.x<D&&(D=N.x);N.x>H&&(H=N.x);N.y<G&&(G=N.y);N.y>I&&(I=N.y);N.z<J&&(J=N.z);N.z>L&&(L=N.z)}y.translateLocal(0.5*-(H+D),0.5*(I+G),L+0.25*(L-J));l.copy(y.getWorldTransform());y.setProjection(pc.scene.Projection.ORTHOGRAPHIC);y.setNearClip(0);y.setFarClip(1.5*(L-J));y.setAspectRatio((H-D)/(I-G));y.setOrthoHeight(0.5*(I-G))}else C===pc.scene.LIGHTTYPE_SPOT&&(y.setProjection(pc.scene.Projection.PERSPECTIVE),y.setNearClip(x.getAttenuationEnd()/1E3),
y.setFarClip(x.getAttenuationEnd()),y.setAspectRatio(1),y.setFov(2*x.getOuterConeAngle()),l.mul2(x.worldTransform,k));n.copy(l).invert();r.mul2(y.getProjectionMatrix(),n);x._shadowMatrix.mul2(f,r);y.worldTransform.copy(l);this.setCamera(y);g.setBlending(!1);g.setColorWrite(!0,!0,!0,!0);g.setCullMode(pc.gfx.CULLFACE_BACK);g.setDepthWrite(!0);g.setDepthTest(!0);g.extDepthTexture&&g.setColorWrite(!1,!1,!1,!1);C=0;for(H=B.length;C<H;C++)x=B[C],y=x.mesh,D=x.material,this.modelMatrixId.setValue(x.node.worldTransform.data),
D.opacityMap&&m.resolve("texture_opacityMap").setValue(D.opacityMap),x.skinInstance?(this.poseMatrixId.setValue(x.skinInstance.matrixPalette),g.setShader(D.opacityMap?this._depthProgSkinOp:this._depthProgSkin)):g.setShader(D.opacityMap?this._depthProgStaticOp:this._depthProgStatic),x=x.renderStyle,g.setVertexBuffer(y.vertexBuffer,0),g.setIndexBuffer(y.indexBuffer[x]),g.draw(y.primitive[x])}this.setCamera(e);this.dispatchGlobalLights(c);this.dispatchLocalLights(c);c.fog!==pc.scene.FOG_NONE&&(this.fogColor[0]=
c.fogColor.r,this.fogColor[1]=c.fogColor.g,this.fogColor[2]=c.fogColor.b,this.fogColorId.setValue(this.fogColor),c.fog===pc.scene.FOG_LINEAR?(this.fogStartId.setValue(c.fogStart),this.fogEndId.setValue(c.fogEnd)):this.fogDensityId.setValue(c.fogDensity));E=0;for(numDrawCalls=A.length;E<numDrawCalls;E++)if(x=A[E],x.command)x.command();else{y=x.mesh;D=x.material;m=x.node.worldTransform;s=x.normalMatrix;m.invertTo3x3(s);s.transpose();this.modelMatrixId.setValue(m.data);this.normalMatrixId.setValue(s.data);
x.skinInstance&&this.poseMatrixId.setValue(x.skinInstance.matrixPalette);if(D!==K){D.shader||D.updateShader(g,c);g.setShader(D.shader);var K=D.parameters,P;for(P in K)m=K[P],m.scopeId||(m.scopeId=g.scope.resolve(P)),m.scopeId.setValue(m.data);this.alphaTestId.setValue(D.alphaTest);g.setBlending(D.blend);g.setBlendFunction(D.blendSrc,D.blendDst);g.setBlendEquation(D.blendEquation);g.setColorWrite(D.redWrite,D.greenWrite,D.blueWrite,D.alphaWrite);g.setCullMode(D.cull);g.setDepthWrite(D.depthWrite);
g.setDepthTest(D.depthTest)}g.setVertexBuffer(y.vertexBuffer,0);x=x.renderStyle;g.setIndexBuffer(y.indexBuffer[x]);g.draw(y.primitive[x]);K=D}}});return{ForwardRenderer:c}}());pc.extend(pc.scene,function(){var d=function(a){this.name=a||"Untitled";this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=new pc.Vec3(0,0,0);this.localTransform=new pc.Mat4;this.dirtyLocal=!1;this.worldTransform=new pc.Mat4;this.dirtyWorld=!1;this._right=new pc.Vec3;this._up=new pc.Vec3;this._forward=
new pc.Vec3;this._parent=null;this._children=[];this._enabledInHierarchy=this._enabled=!0};Object.defineProperty(d.prototype,"right",{get:function(){return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(d.prototype,"up",{get:function(){return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(d.prototype,"forward",{get:function(){return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(d.prototype,
"forwards",{get:function(){console.log("pc.GraphNode#forwards is DEPRECATED. Use pc.GraphNode#forward instead.");return this.forward}});Object.defineProperty(d.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,(!this._parent||this._parent.enabled)&&this._notifyHierarchyStateChanged(this,a))}});pc.extend(d.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var c=a._children,e=
0,d=c.length;e<d;e++)c[e]._enabled&&this._notifyHierarchyStateChanged(c[e],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=a},_cloneInternal:function(a){a.name=this.name;a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);
a.dirtyLocal=this.dirtyLocal;a.worldTransform.copy(this.worldTransform);a.dirtyWorld=this.dirtyWorld;a._enabled=this._enabled;a._enabledInHierarchy=this._enabledInHierarchy},clone:function(){var a=new pc.scene.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var c,e=this.getChildren(),d=e.length,f=[];this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b&&f.push(this));for(c=0;c<d;++c)f=f.concat(e[c].find(a,b));return f},findOne:function(a,b){var c,e=this.getChildren(),d=e.length,
f=null;if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<d;++c)if(f=e[c].findOne(a,b),null!==f)return f;return null},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},getRoot:function(){var a=this.getParent();if(!a)return this;for(;a.getParent();)a=a.getParent();return a},getParent:function(){return this._parent},getChildren:function(){return this._children},
getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),
this.dirtyLocal=!1,this.dirtyWorld=!0);return this.localTransform},getName:function(){return this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getWorldTransform:function(){var a=[];return function(){var b=this;for(a.length=0;null!==b;)a.push(b),b=b._parent;for(b=a.length-1;0<=b;b--)a[b].sync();return this.worldTransform}}(),reparent:function(a){var b=
this.getParent();b&&b.removeChild(this);a&&a.addChild(this)},setLocalEulerAngles:function(){var a,b,c;switch(arguments.length){case 1:a=arguments[0].x;b=arguments[0].y;c=arguments[0].z;break;case 3:a=arguments[0],b=arguments[1],c=arguments[2]}this.localRotation.setFromEulerAngles(a,b,c);this.dirtyLocal=!0},setLocalPosition:function(){1===arguments.length?this.localPosition.copy(arguments[0]):this.localPosition.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setLocalRotation:function(a){1===
arguments.length?this.localRotation.copy(arguments[0]):this.localRotation.set(arguments[0],arguments[1],arguments[2],arguments[3]);this.dirtyLocal=!0},setLocalScale:function(){1===arguments.length?this.localScale.copy(arguments[0]):this.localScale.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setName:function(a){this.name=a},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2]);
null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this.dirtyLocal=!0}}(),setRotation:function(){var a=new pc.Quat,b=new pc.Quat;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2],arguments[3]);if(null===this._parent)this.localRotation.copy(a);else{var c=this._parent.getRotation();b.copy(c).invert();this.localRotation.copy(b).mul(a)}this.dirtyLocal=!0}}(),setEulerAngles:function(){var a=
new pc.Quat;return function(){var b,c,e;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],e=arguments[2]}this.localRotation.setFromEulerAngles(b,c,e);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this.dirtyLocal=!0}}(),addChild:function(a){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.push(a);a._parent=this;a._enabledInHierarchy=
a._enabled&&this.enabled;a.dirtyWorld=!0},removeChild:function(a){var b,c=this._children.length;a._parent=null;for(b=0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete this._labels[a]},findByLabel:function(a,b){var c,e=this._children.length,b=b||[];this.hasLabel(a)&&b.push(this);for(c=0;c<e;++c)b=this._children[c].findByLabel(a,
b);return b},sync:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);if(this.dirtyWorld){null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.dirtyWorld=!1;for(var a=0,b=this._children.length;a<b;a++)this._children[a].dirtyWorld=!0}},syncHierarchy:function(){var a=function(){if(this._enabled){this.sync();for(var b=
this._children,c=0,e=b.length;c<e;c++)a.call(b[c])}};return a}(),lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,c=new pc.Vec3,e=new pc.Quat;return function(){switch(arguments.length){case 1:b.copy(arguments[0]);c.copy(pc.Vec3.UP);break;case 2:b.copy(arguments[0]);c.copy(arguments[1]);break;case 3:b.set(arguments[0],arguments[1],arguments[2]);c.copy(pc.Vec3.UP);break;case 6:b.set(arguments[0],arguments[1],arguments[2]),c.set(arguments[3],arguments[4],arguments[5])}a.setLookAt(this.getPosition(),
b,c);e.setFromMat4(a);this.setRotation(e)}}(),translate:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}a.add(this.getPosition());this.setPosition(a)}}(),translateLocal:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}this.localRotation.transformVector(a,a);this.localPosition.add(a);
this.dirtyLocal=!0}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(){var c,e,d;switch(arguments.length){case 1:c=arguments[0].x;e=arguments[0].y;d=arguments[0].z;break;case 3:c=arguments[0],e=arguments[1],d=arguments[2]}a.setFromEulerAngles(c,e,d);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),e=this._parent.getRotation(),b.copy(e).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this.dirtyLocal=!0}}(),rotateLocal:function(){var a=new pc.Quat;
return function(){var b,c,e;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],e=arguments[2]}a.setFromEulerAngles(b,c,e);this.localRotation.mul(a);this.dirtyLocal=!0}}()});return{GraphNode:d}}());pc.scene.Projection={PERSPECTIVE:0,ORTHOGRAPHIC:1};
pc.extend(pc.scene,function(){var d=function(){this._projection=pc.scene.Projection.PERSPECTIVE;this._nearClip=0.1;this._farClip=1E4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._viewMat=new pc.Mat4;this._viewProjMat=new pc.Mat4;this._rect={x:0,y:0,width:1,height:1};this._frustum=new pc.shape.Frustum(this._projMat,this._viewMat);this._renderTarget=null;this._clearOptions={color:[186/255,186/255,177/255,1],depth:1,flags:pc.gfx.CLEARFLAG_COLOR|
pc.gfx.CLEARFLAG_DEPTH}},d=pc.inherits(d,pc.scene.GraphNode);pc.extend(d.prototype,{_cloneInternal:function(a){d._super._cloneInternal.call(this,a);a.setProjection(this.getProjection());a.setNearClip(this.getNearClip());a.setFarClip(this.getFarClip());a.setFov(this.getFov());a.setAspectRatio(this.getAspectRatio());a.setRenderTarget(this.getRenderTarget());a.setClearOptions(this.getClearOptions())},clone:function(){var a=new pc.scene.CameraNode;this._cloneInternal(a);return a},getFrustumCentroid:function(){var a=
new pc.Vec3(0,0,0.5*-(this._farClip+this._nearClip));this.getWorldTransform().transformPoint(a,a);return a},worldToScreen:function(a){var b,c=this.getWorldTransform().clone().invert();pvm=new pc.Mat4;width=this._renderTarget.getWidth();height=this._renderTarget.getHeight();point2d=new pc.Vec3;b=(new pc.Mat4).setPerspective(this._fov,width/height,this._nearClip,this._farClip);pvm.mul2(b,c);pvm.transformPoint(a,point2d);point2d.x=width/2+width/2*point2d.x;point2d.y=height-(height/2+height/2*point2d.y);
point2d.z=point2d.z;return point2d},screenToWorld:function(a,b,c,e,d,f){"undefined"===typeof f&&(f=new pc.Vec3);var k=this.getProjectionMatrix(),l=this.getWorldTransform();this._viewMat.copy(l);this._viewMat.invert();this._viewProjMat.mul2(k,this._viewMat);k=this._viewProjMat.clone().invert();b=new pc.Vec3(2*(a/e)-1,2*((d-b)/d)-1,1);a=k.transformPoint(b);a.scale(1/(b.x*k.data[3]+b.y*k.data[7]+b.z*k.data[11]+k.data[15]));c/=this._farClip;f.lerp(this.getPosition(),a,c);return f},getAspectRatio:function(){return this._aspect},
getClearOptions:function(){return this._clearOptions},getFarClip:function(){return this._farClip},getFov:function(){return this._fov},getFrustum:function(){return this._frustum},getNearClip:function(){return this._nearClip},getOrthoHeight:function(){return this._orthoHeight},getProjection:function(){return this._projection},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.scene.Projection.PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,
this._farClip);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip)}this._projMatDirty=!1}return this._projMat},getRect:function(){return this._rect},getRenderTarget:function(){return this._renderTarget},setAspectRatio:function(a){this._aspect=a;this._projMatDirty=!0},setClearOptions:function(a){this._clearOptions=a},setFarClip:function(a){this._farClip=a;this._projMatDirty=!0},setFov:function(a){this._fov=a;this._projMatDirty=!0},setNearClip:function(a){this._nearClip=
a;this._projMatDirty=!0},setOrthoHeight:function(a){this._orthoHeight=a;this._projMatDirty=!0},setProjection:function(a){this._projection=a;this._projMatDirty=!0},setRect:function(a,b,c,e){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=e},setRenderTarget:function(a){this._renderTarget=a}});return{CameraNode:d}}());pc.extend(pc.scene,function(){var d=function(){this._type=pc.scene.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(0.8,0.8,0.8);this._intensity=1;this._enabled=this._castShadows=!1;this._attenuationEnd=this._attenuationStart=10;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new pc.Vec3(0.8,0.8,0.8);this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*
Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this._shadowResolution=1024;this._shadowBias=-5E-4;this._scene=null},d=pc.inherits(d,pc.scene.GraphNode);pc.extend(d.prototype,{_cloneInternal:function(a){d._super._cloneInternal.call(this,a);a.setType(this.getType());a.setColor(this.getColor());a.setIntensity(this.getIntensity());a.setCastShadows(this.getCastShadows());a.setEnabled(this.getEnabled());a.setAttenuationStart(this.getAttenuationStart());a.setAttenuationEnd(this.getAttenuationEnd());
a.setInnerConeAngle(this.getInnerConeAngle());a.setOuterConeAngle(this.getOuterConeAngle());a.setShadowBias(this.getShadowBias());a.setShadowResolution(this.getShadowResolution())},clone:function(){var a=new pc.scene.LightNode;this._cloneInternal(a);return a},getAttenuationEnd:function(){return this._attenuationEnd},getAttenuationStart:function(){return this._attenuationStart},getCastShadows:function(){return this._castShadows},getColor:function(){return this._color},getEnabled:function(){return this._enabled},
getInnerConeAngle:function(){return this._innerConeAngle},getIntensity:function(){return this._intensity},getOuterConeAngle:function(){return this._outerConeAngle},getShadowBias:function(){return this._shadowBias},getShadowResolution:function(){return this._shadowResolution},getType:function(){return this._type},setAttenuationEnd:function(a){this._attenuationEnd=a},setAttenuationStart:function(a){this._attenuationStart=a},setCastShadows:function(a){this._castShadows=a},setColor:function(){var a,b,
c;1===arguments.length?(a=arguments[0].r,b=arguments[0].g,c=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);var e=this._intensity;this._finalColor.set(a*e,b*e,c*e)},setEnabled:function(a){this._enabled!==a&&(this._enabled=a,null!==this._scene&&(this._scene.updateShaders=!0))},setInnerConeAngle:function(a){this._innerConeAngle=a;this._innerConeAngleCos=Math.cos(a*Math.PI/180)},setIntensity:function(a){this._intensity=a;var a=this._color,b=
this._intensity;this._finalColor.set(a.r*b,a.g*b,a.b*b)},setOuterConeAngle:function(a){this._outerConeAngle=a;this._outerConeAngleCos=Math.cos(a*Math.PI/180)},setShadowBias:function(a){this._shadowBias=a},setShadowResolution:function(a){this._shadowResolution=a},setType:function(a){this._type=a}});return{LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LightNode:d}}());pc.extend(pc.scene,function(){var d=0,a=function(){this.name="Untitled";this.id=d++;this.shader=null;this.parameters={};this.alphaTest=0;this.blend=!1;this.blendSrc=pc.gfx.BLENDMODE_ONE;this.blendDst=pc.gfx.BLENDMODE_ZERO;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;this.cull=pc.gfx.CULLFACE_BACK;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=this.depthWrite=this.depthTest=!0;this.meshInstances=[]};Object.defineProperty(a.prototype,"blendType",{get:function(){return!this.blend&&this.blendSrc===
pc.gfx.BLENDMODE_ONE&&this.blendDst===pc.gfx.BLENDMODE_ZERO&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_NONE:this.blend&&this.blendSrc===pc.gfx.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.gfx.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_NORMAL:this.blend&&this.blendSrc===pc.gfx.BLENDMODE_ONE&&this.blendDst===pc.gfx.BLENDMODE_ONE&&this.blendEquation===pc.gfx.BLENDEQUATION_ADD?pc.scene.BLEND_ADDITIVE:pc.scene.BLEND_NORMAL},set:function(a){switch(a){case pc.scene.BLEND_NONE:this.blend=
!1;this.blendSrc=pc.gfx.BLENDMODE_ONE;this.blendDst=pc.gfx.BLENDMODE_ZERO;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;break;case pc.scene.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.gfx.BLENDMODE_SRC_ALPHA;this.blendDst=pc.gfx.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.gfx.BLENDEQUATION_ADD;break;case pc.scene.BLEND_ADDITIVE:this.blend=!0,this.blendDst=this.blendSrc=pc.gfx.BLENDMODE_ONE,this.blendEquation=pc.gfx.BLENDEQUATION_ADD}this._updateMeshInstanceKeys()}});a.prototype._cloneInternal=
function(a){a.name=this.name;a.id=d++;a.shader=null;a.parameters={};a.alphaTest=this.alphaTest;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};a.prototype.clone=function(){var a=new pc.scene.Material;this._cloneInternal(a);return a};a.prototype._updateMeshInstanceKeys=
function(){var a,c=this.meshInstances;for(a=0;a<c.length;a++)c[a].updateKey()};a.prototype.updateShader=function(){};a.prototype.getName=function(){return this.name};a.prototype.setName=function(a){this.name=a};a.prototype.clearParameters=function(){this.parameters={}};a.prototype.getParameters=function(){return this.parameters};a.prototype.getParameter=function(a){return this.parameters[a]};a.prototype.setParameter=function(a,c){var e=this.parameters[a];e?e.data=c:this.parameters[a]={scopeId:null,
data:c}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};a.prototype.setParameters=function(){for(var a in this.parameters){var c=this.parameters[a];c.scopeId||(c.scopeId=device.scope.resolve(a));c.scopeId.setValue(c.data)}};a.prototype.getShader=function(){return this.shader};a.prototype.setShader=function(a){this.shader=a};a.prototype.update=function(){throw Error("Not Implemented in base class");};a.prototype.init=function(){throw Error("Not Implemented in base class");
};return{Material:a}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.BasicMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(a){var b=
{skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("basic",b)}});return{BasicMaterial:d}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.DepthMaterial;Material.prototype._cloneInternal.call(this,a);a.update();return a},update:function(){},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});return{DepthMaterial:d}}());pc.extend(pc.scene,function(){var d=new pc.Vec3,a=new pc.Quat,b=new pc.Vec3,c,e=function(a){if(a.data){if(a.data instanceof pc.gfx.Texture)return a.data;throw Error("PhongMaterial.init() expects textures to already be created");}return null},g=function(a){return new pc.Vec2(a.data[0],a.data[1])},f=function(a){return new pc.Vec3(a.data[0],a.data[1],a.data[2])},k=function(a){return new pc.Color(a.data[0],a.data[1],a.data[2])};c=pc.inherits(function(){this.ambient=new pc.Color(0.7,0.7,0.7);this.diffuse=
new pc.Color(0.7,0.7,0.7);this.diffuseMap=null;this.diffuseMapTiling=new pc.Vec2(1,1);this.diffuseMapOffset=new pc.Vec2(0,0);this.diffuseMapRotation=new pc.Vec3(0,0,0);this.diffuseMapTransform=null;this.specular=new pc.Color(0,0,0);this.specularMap=null;this.specularMapTiling=new pc.Vec2(1,1);this.specularMapOffset=new pc.Vec2(0,0);this.specularMapRotation=new pc.Vec3(0,0,0);this.specularMapTransform=null;this.shininess=25;this.glossMap=null;this.glossMapTiling=new pc.Vec2(1,1);this.glossMapOffset=
new pc.Vec2(0,0);this.glossMapRotation=new pc.Vec3(0,0,0);this.glossMapTransform=null;this.emissive=new pc.Color(0,0,0);this.emissiveMap=null;this.emissiveMapTiling=new pc.Vec2(1,1);this.emissiveMapOffset=new pc.Vec2(0,0);this.emissiveMapRotation=new pc.Vec3(0,0,0);this.emissiveMapTransform=null;this.opacity=1;this.opacityMap=null;this.opacityMapTiling=new pc.Vec2(1,1);this.opacityMapOffset=new pc.Vec2(0,0);this.opacityMapRotation=new pc.Vec3(0,0,0);this.normalMapTransform=this.normalMap=this.opacityMapTransform=
null;this.normalMapTiling=new pc.Vec2(1,1);this.normalMapOffset=new pc.Vec2(0,0);this.normalMapRotation=new pc.Vec3(0,0,0);this.heightMap=null;this.heightMapTiling=new pc.Vec2(1,1);this.heightMapOffset=new pc.Vec2(0,0);this.heightMapRotation=new pc.Vec3(0,0,0);this.heightMapTransform=null;this.bumpiness=1;this.sphereMap=this.cubeMap=null;this.reflectivity=1;this.lightMap=null;this.ambientUniform=new Float32Array(3);this.diffuseUniform=new Float32Array(3);this.specularUniform=new Float32Array(3);this.emissiveUniform=
new Float32Array(3);this.update()},pc.scene.Material);pc.extend(c.prototype,{clone:function(){var a=new pc.scene.PhongMaterial;pc.scene.Material.prototype._cloneInternal.call(this,a);a.ambient.copy(this.ambient);a.diffuse.copy(this.diffuse);a.diffuseMap=this.diffuseMap;a.diffuseMapTiling=this.diffuseMapTiling?this.diffuseMapTiling.clone():new pc.Vec2(1,1);a.diffuseMapOffset=this.diffuseMapOffset?this.diffuseMapOffset.clone():new pc.Vec2(0,0);a.diffuseMapRotation=this.diffuseMapRotation?this.diffuseMapRotation.clone():
new pc.Vec3;a.diffuseMapTransform=this.diffuseMapTransform?this.diffuseMapTransform.clone():null;a.specular.copy(this.specular);a.specularMap=this.specularMap;a.specularMapTiling=this.specularMapTiling?this.specularMapTiling.clone():new pc.Vec2(1,1);a.specularMapOffset=this.specularMapOffset?this.specularMapOffset.clone():new pc.Vec2(0,0);a.specularMapRotation=this.specularMapRotation?this.specularMapRotation.clone():new pc.Vec3;a.specularMapTransform=this.specularMapTransform?this.specularMapTransform.clone():
null;a.shininess=this.shininess;a.glossMap=this.glossMap;a.glossMapTiling=this.glossMapTiling?this.glossMapTiling.clone():new pc.Vec2(1,1);a.glossMapOffset=this.glossMapOffset?this.glossMapOffset.clone():new pc.Vec2(0,0);a.glossMapRotation=this.glossMapRotation?this.glossMapRotation.clone():new pc.Vec3;a.glossMapTransform=this.glossMapTransform?this.glossMapTransform.clone():null;a.emissive.copy(this.emissive);a.emissiveMap=this.emissiveMap;a.emissiveMapTiling=this.emissiveMapTiling?this.emissiveMapTiling.clone():
new pc.Vec2(1,1);a.emissiveMapOffset=this.emissiveMapOffset?this.emissiveMapOffset.clone():new pc.Vec2(0,0);a.emissiveMapRotation=this.emissiveMapRotation?this.emissiveMapRotation.clone():new pc.Vec3;a.emissiveMapTransform=this.emissiveMapTransform?this.emissiveMapTransform.clone():null;a.opacity=this.opacity;a.opacityMap=this.opacityMap;a.opacityMapTiling=this.opacityMapTiling?this.opacityMapTiling.clone():new pc.Vec2(1,1);a.opacityMapOffset=this.opacityMapOffset?this.opacityMapOffset.clone():new pc.Vec2(0,
0);a.opacityMapRotation=this.opacityMapRotation?this.opacityMapRotation.clone():new pc.Vec3;a.opacityMapTransform=this.opacityMapTransform?this.opacityMapTransform.clone():null;a.normalMap=this.normalMap;a.normalMapTransform=this.normalMapTransform?this.normalMapTransform.clone():null;a.normalMapTiling=this.normalMapTiling?this.normalMapTiling.clone():new pc.Vec2(1,1);a.normalMapOffset=this.normalMapOffset?this.normalMapOffset.clone():new pc.Vec2(0,0);a.normalMapRotation=this.normalMapRotation?this.normalMapRotation.clone():
new pc.Vec3;a.heightMap=this.heightMap;a.heightMapTransform=this.heightMapTransform?this.heightMapTransform.clone():null;a.heightMapTiling=this.heightMapTiling?this.heightMapTiling.clone():new pc.Vec2(1,1);a.heightMapOffset=this.heightMapOffset?this.heightMapOffset.clone():new pc.Vec2(0,0);a.heightMapRotation=this.heightMapRotation?this.heightMapRotation.clone():new pc.Vec3;a.bumpiness=this.bumpiness;a.cubeMap=this.cubeMap;a.sphereMap=this.sphereMap;a.reflectivity=this.reflectivity;a.lightMap=this.lightMap;
a.update();return a},init:function(a){this.name=a.name;for(var b=0;b<a.parameters.length;b++){var c=a.parameters[b];switch(c.name){case "ambient":this.ambient=k(c);break;case "diffuse":this.diffuse=k(c);break;case "diffuseMap":this.diffuseMap=e(c);break;case "diffuseMapTiling":this.diffuseMapTiling=g(c);break;case "diffuseMapOffset":this.diffuseMapOffset=g(c);break;case "diffuseMapRotation":this.diffuseMapRotation=f(c);break;case "specular":this.specular=k(c);break;case "specularMap":this.specularMap=
e(c);break;case "specularMapTiling":this.specularMapTiling=g(c);break;case "specularMapOffset":this.specularMapOffset=g(c);break;case "specularMapRotation":this.specularMapRotation=f(c);break;case "shininess":this.shininess=c.data;break;case "glossMap":this.glossMap=e(c);break;case "glossMapTiling":this.glossMapTiling=g(c);break;case "glossMapOffset":this.glossMapOffset=g(c);break;case "glossMapRotation":this.glossMapRotation=f(c);break;case "emissive":this.emissive=k(c);break;case "emissiveMap":this.emissiveMap=
e(c);break;case "emissiveMapTiling":this.emissiveMapTiling=g(c);break;case "emissiveMapOffset":this.emissiveMapOffset=g(c);break;case "emissiveMapRotation":this.emissiveMapRotation=f(c);break;case "opacity":this.opacity=c.data;break;case "opacityMap":this.opacityMap=e(c);break;case "opacityMapTiling":this.opacityMapTiling=g(c);break;case "opacityMapOffset":this.opacityMapOffset=g(c);break;case "opacityMapRotation":this.opacityMapRotation=f(c);break;case "normalMap":this.normalMap=e(c);break;case "normalMapTiling":this.normalMapTiling=
g(c);break;case "normalMapOffset":this.normalMapOffset=g(c);break;case "normalMapRotation":this.normalMapRotation=f(c);break;case "heightMap":this.heightMap=e(c);break;case "heightMapTiling":this.heightMapTiling=g(c);break;case "heightMapOffset":this.heightMapOffset=g(c);break;case "heightMapRotation":this.heightMapRotation=f(c);break;case "bumpMapFactor":this.bumpiness=c.data;break;case "cubeMap":this.cubeMap=e(c);break;case "sphereMap":this.sphereMap=e(c);break;case "reflectivity":this.reflectivity=
c.data;break;case "lightMap":this.lightMap=e(c);break;case "depthTest":this.depthTest=c.data;break;case "depthWrite":this.depthWrite=c.data;break;case "cull":this.cull=c.data;break;case "blendType":this.blendType=c.data}}this.blendType=this.opacityMap||1>this.opacity?this.blendType||pc.scene.BLEND_NORMAL:pc.scene.BLEND_NONE;this.update()},_updateMapTransform:function(c,e,g,f){e?d.set(e.x,e.y,1):d.set(1,1,1);g?b.set(g.x,g.y,0):b.set(0,0,0);f?a.setFromEulerAngles(f.x,f.y,f.z):a.copy(pc.Quat.IDENTITY);
c=c||new pc.Mat4;c.setTRS(b,a,d);return c.isIdentity()?null:c},update:function(){this.clearParameters();this.ambientUniform[0]=this.ambient.r;this.ambientUniform[1]=this.ambient.g;this.ambientUniform[2]=this.ambient.b;this.setParameter("material_ambient",this.ambientUniform);this.diffuseMap?(this.setParameter("texture_diffuseMap",this.diffuseMap),(this.diffuseMapTransform=this._updateMapTransform(this.diffuseMapTransform,this.diffuseMapTiling,this.diffuseMapOffset,this.diffuseMapRotation))&&this.setParameter("texture_diffuseMapTransform",
this.diffuseMapTransform.data)):(this.diffuseMapTransform=null,this.diffuseUniform[0]=this.diffuse.r,this.diffuseUniform[1]=this.diffuse.g,this.diffuseUniform[2]=this.diffuse.b,this.setParameter("material_diffuse",this.diffuseUniform));this.specularMap?(this.setParameter("texture_specularMap",this.specularMap),(this.specularMapTransform=this._updateMapTransform(this.specularMapTransform,this.specularMapTiling,this.specularMapOffset,this.specularMapRotation))&&this.setParameter("texture_specularMapTransform",
this.specularMapTransform.data)):(this.specularMapTransform=null,this.specularUniform[0]=this.specular.r,this.specularUniform[1]=this.specular.g,this.specularUniform[2]=this.specular.b,this.setParameter("material_specular",this.specularUniform));this.glossMap?(this.setParameter("texture_glossMap",this.glossMap),(this.glossMapTransform=this._updateMapTransform(this.glossMapTransform,this.glossMapTiling,this.glossMapOffset,this.glossMapRotation))&&this.setParameter("texture_glossMapTransform",this.glossMapTransform.data)):
(this.glossMapTransform=null,this.setParameter("material_shininess",this.shininess));this.emissiveMap?(this.setParameter("texture_emissiveMap",this.emissiveMap),(this.emissiveMapTransform=this._updateMapTransform(this.emissiveMapTransform,this.emissiveMapTiling,this.emissiveMapOffset,this.emissiveMapRotation))&&this.setParameter("texture_emissiveMapTransform",this.emissiveMapTransform.data)):(this.emissiveMapTransform=null,this.emissiveUniform[0]=this.emissive.r,this.emissiveUniform[1]=this.emissive.g,
this.emissiveUniform[2]=this.emissive.b,this.setParameter("material_emissive",this.emissiveUniform));this.opacityMap?(this.setParameter("texture_opacityMap",this.opacityMap),(this.opacityMapTransform=this._updateMapTransform(this.opacityMapTransform,this.opacityMapTiling,this.opacityMapOffset,this.opacityMapRotation))&&this.setParameter("texture_opacityMapTransform",this.opacityMapTransform.data)):(this.opacityMapTransform=null,this.setParameter("material_opacity",this.opacity));this.normalMap?(this.setParameter("texture_normalMap",
this.normalMap),(this.normalMapTransform=this._updateMapTransform(this.normalMapTransform,this.normalMapTiling,this.normalMapOffset,this.normalMapRotation))&&this.setParameter("texture_normalMapTransform",this.normalMapTransform.data)):this.normalMapTransform=null;this.heightMap?(this.setParameter("texture_heightMap",this.heightMap),(this.heightMapTransform=this._updateMapTransform(this.heightMapTransform,this.heightMapTiling,this.heightMapOffset,this.heightMapRotation))&&this.setParameter("texture_heightMapTransform",
this.heightMapTransform.data)):this.heightMapTransform=null;(this.normalMap||this.heightMap)&&this.setParameter("material_bumpMapFactor",this.bumpiness);this.cubeMap&&this.setParameter("texture_cubeMap",this.cubeMap);this.sphereMap&&this.setParameter("texture_sphereMap",this.sphereMap);(this.sphereMap||this.cubeMap)&&this.setParameter("material_reflectionFactor",this.reflectivity);this.lightMap&&this.setParameter("texture_lightMap",this.lightMap);this.shader=null},updateShader:function(a,b){for(var c=
b._lights,e=0,d=0,g=0,f=0,k=0,z=0;z<c.length;z++){var v=c[z];if(v.getEnabled())switch(v.getType()){case pc.scene.LIGHTTYPE_DIRECTIONAL:v.getCastShadows()?f++:e++;break;case pc.scene.LIGHTTYPE_POINT:d++;break;case pc.scene.LIGHTTYPE_SPOT:v.getCastShadows()?k++:g++}}c={fog:b.fog,skin:!!this.meshInstances[0].skinInstance,numDirs:e,numSDirs:f,numPnts:d,numSPnts:0,numSpts:g,numSSpts:k,diffuseMap:!!this.diffuseMap,diffuseMapTransform:!!this.diffuseMapTransform,specularMap:!!this.specularMap,specularMapTransform:!!this.specularMapTransform,
glossMap:!!this.glossMap,glossMapTransform:!!this.glossMapTransform,emissiveMap:!!this.emissiveMap,emissiveMapTransform:!!this.emissiveMapTransform,opacityMap:!!this.opacityMap,opacityMapTransform:!!this.opacityMapTransform,normalMap:!!this.normalMap,normalMapTransform:!!this.normalMapTransform,heightMap:!!this.heightMap,heightMapTransform:!!this.heightMapTransform,sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap,lightMap:!!this.lightMap};this.shader=a.getProgramLibrary().getProgram("phong",c)}});
return{PhongMaterial:c}}());pc.extend(pc.scene,function(){var d;d=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.scene.Material);pc.extend(d.prototype,{clone:function(){var a=new pc.scene.PickMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data)},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("pick",
b)}});return{PickMaterial:d}}());pc.extend(pc.scene,function(){var d=function(a,b,c){this.node=a;this.mesh=b;this.material=c;this.layer=pc.scene.LAYER_WORLD;this.renderStyle=pc.scene.RENDERSTYLE_SOLID;this.castShadow=!1;this.receiveShadow=!0;this.key=0;this.updateKey();this.skinInstance=null;this.aabb=new pc.shape.Aabb;this.normalMatrix=new pc.Mat3};Object.defineProperty(d.prototype,"material",{get:function(){return this._material},set:function(a){if(this._material){var b=this._material.meshInstances,c=b.indexOf(this);-1!==c&&b.splice(c,
1)}this._material=a;this._material.meshInstances.push(this);this.updateKey()}});Object.defineProperty(d.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});pc.extend(d.prototype,{syncAabb:function(){this.aabb.setFromTransformedAabb(this.mesh.aabb,this.node.worldTransform)},updateKey:function(){var a=this.material;this.key=(this.layer&7)<<28|(a.blendType&3)<<26|0|(a.id&33554431)<<0}});return{Command:function(a,b,c){this.key=(a&7)<<28|(b&3)<<26|33554432;
this.command=c},Mesh:function(){this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.skin=null;this.aabb=new pc.shape.Aabb},MeshInstance:d}}());pc.extend(pc.scene,function(){var d=function(a){this.skin=a;this.bones=[];this.matrixPalette=new Float32Array(16*a.inverseBindPose.length)},a=new pc.Mat4;d.prototype={updateMatrixPalette:function(){for(var b=a.data,c=this.matrixPalette,e,d=this.bones.length-1;0<=d;d--)a.mul2(this.bones[d].worldTransform,this.skin.inverseBindPose[d]),e=16*d,c[e]=b[0],c[e+1]=b[1],c[e+2]=b[2],c[e+3]=b[3],c[e+4]=b[4],c[e+5]=b[5],c[e+6]=b[6],c[e+7]=b[7],c[e+8]=b[8],c[e+9]=b[9],c[e+10]=b[10],c[e+11]=b[11],c[e+12]=b[12],
c[e+13]=b[13],c[e+14]=b[14],c[e+15]=b[15]}};return{Skin:function(a,c){this.inverseBindPose=a;this.boneNames=c},SkinInstance:d}}());pc.extend(pc.scene,function(){function d(){this.index=0;this.boneIndices=[0,0,0,0]}function a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}a.prototype={addVertex:function(a,c,e){var d=-1;if(void 0!==this.indexMap[c])d=this.indexMap[c],this.indices.push(d);else{for(d=0;4>d;d++)0!==e.blendWeight.data[4*c+d]&&(a.boneIndices[d]=this.getBoneRemap(e.blendIndices.data[4*a.index+d]));d=this.vertices.length;
this.indices.push(d);this.vertices.push(a);this.indexMap[c]=d}},addPrimitive:function(a,c,e,d){var f,k,l=[],n=0,r=a.length;for(f=0;f<r;f++)for(var m=a[f].index,s=0;4>s;s++)if(0<e.blendWeight.data[4*m+s]){var h=e.blendIndices.data[4*m+s],u=!0;for(k=0;k<n;k++)if(l[k]==h){u=!1;break}u&&(l[n]=h,k=this.getBoneRemap(h),n+=-1===k?1:0)}if(this.boneIndices.length+n>d)return!1;for(f=0;f<n;f++)this.boneIndices.push(l[f]);for(f=0;f<r;f++)this.addVertex(a[f],c[f],e);return!0},getBoneRemap:function(a){for(var c=
0;c<this.boneIndices.length;c++)if(this.boneIndices[c]===a)return c;return-1}};return{partitionSkin:function(b,c,e){var g,f,k,l=b.vertices,n=b.skins,r=b.meshes,m=b.meshInstances;for(g=0;g<r.length;g++)r[g].vertices=l[r[g].vertices],"undefined"!==typeof r[g].skin&&(r[g].skin=n[r[g].skin]);for(g=0;g<m.length;g++)m[g].mesh=r[m[g].mesh];l=b.vertices;n=b.skins;r=b.meshes;m=b.meshInstances;for(g=n.length-1;0<=g;g--)if(n[g].boneNames.length>e){var s=n.splice(g,1)[0],h=[];for(f=0;f<r.length;f++)r[f].skin===
s&&h.push(r[f]);for(f=0;f<h.length;f++){var u=r.indexOf(h[f]);-1!==u&&r.splice(u,1)}if(0===h.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var F=h[0].vertices;for(f=1;f<h.length;f++)if(h[f].vertices!==F)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var z=[],v=function(a){var b=new d;b.index=a;return b};k=[];var w=[],A=0;for(f=0;f<h.length;f++){for(var B=h[f],E=B.indices,C=B.base;C<B.base+B.count;){u=
E[C++];k[0]=v(u);w[0]=u;u=E[C++];k[1]=v(u);w[1]=u;u=E[C++];k[2]=v(u);w[2]=u;for(var H=!1,x=A;x<z.length;x++)if(u=z[x],u.addPrimitive(k,w,F,e)){H=!0;break}H||(u=new a,u.originalMesh=B,u.addPrimitive(k,w,F,e),z.push(u))}A=z.length}B=[];h=[];for(f=0;f<z.length;f++)if(u=z[f],u.vertices.length&&u.indices.length){v=B.length;k=u.vertices.length;w=h.length;A=u.indices.length;u.partition=f;u.vertexStart=v;u.vertexCount=k;u.indexStart=w;u.indexCount=A;E=0;for(C=v;E<k;)B[C++]=u.vertices[E++];E=0;for(C=w;E<A;)h[C++]=
u.indices[E++]+v}v=[];for(f=0;f<z.length;f++){u=z[f];w=[];A=[];for(k=0;k<u.boneIndices.length;k++)w.push(s.inverseBindMatrices[u.boneIndices[k]]),A.push(s.boneNames[u.boneIndices[k]]);u={inverseBindMatrices:w,boneNames:A};v.push(u);n.push(u)}var y,s={};for(y in F)s[y]={components:F[y].components,data:[],type:F[y].type};for(y in F)if("blendIndices"===y){u=s[y].data;for(f=0;f<B.length;f++)k=B[f].boneIndices,u.push(k[0],k[1],k[2],k[3])}else{f=F[y];data=f.data;components=f.components;for(f=0;f<B.length;f++){u=
B[f].index;for(k=0;k<components;k++)s[y].data.push(data[u*components+k])}}l[l.indexOf(F)]=s;for(f=0;f<z.length;f++){u=z[f];B={aabb:{min:[0,0,0],max:[0,0,0]},vertices:s,skin:v[f],indices:h.splice(0,u.indexCount),type:"triangles",base:0,count:u.indexCount};r.push(B);for(k=m.length-1;0<=k;k--)m[k].mesh===u.originalMesh&&(m.push({mesh:B,node:m[k].node}),c&&c.push({material:c[k].material}))}for(f=0;f<z.length;f++){u=z[f];for(k=m.length-1;0<=k;k--)m[k].mesh===u.originalMesh&&(m.splice(k,1),c&&c.splice(k,
1))}}c=b.vertices;e=b.skins;y=b.meshes;g=b.meshInstances;for(b=0;b<y.length;b++)y[b].vertices=c.indexOf(y[b].vertices),"undefined"!==typeof y[b].skin&&(y[b].skin=e.indexOf(y[b].skin));for(b=0;b<g.length;b++)g[b].mesh=y.indexOf(g[b].mesh)}}}());pc.extend(pc.scene,function(){var d=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.cameras=[];this.lights=[]};d.prototype.getGraph=function(){return this.graph};d.prototype.setGraph=function(a){this.graph=a};d.prototype.getCameras=function(){return this.cameras};d.prototype.setCameras=function(a){this.cameras=a};d.prototype.getLights=function(){return this.lights};d.prototype.setLights=function(a){this.lights=a};d.prototype.getTextures=function(){return this.textures};
d.prototype.getMaterials=function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a];-1===b.indexOf(c.material)&&b.push(c.material)}return b};d.prototype.clone=function(){var a,b=[],c=[],e=function(a){var d=a.clone();b.push(a);c.push(d);a instanceof pc.scene.CameraNode?s.cameras.push(d):a instanceof pc.scene.LightNode&&s.lights.push(d);for(var a=a.getChildren(),g=0;g<a.length;g++)d.addChild(e(a[g]));return d},d=e(this.graph),f=[],k=[];for(a=0;a<this.skinInstances.length;a++){var l=
this.skinInstances[a].skin,n=new pc.scene.SkinInstance(l),r=[];for(j=0;j<l.boneNames.length;j++){var m=d.findByName(l.boneNames[j]);r.push(m)}n.bones=r;k.push(n)}for(a=0;a<this.meshInstances.length;a++)l=this.meshInstances[a],n=b.indexOf(l.node),n=new pc.scene.MeshInstance(c[n],l.mesh,l.material),l.skinInstance&&(l=this.skinInstances.indexOf(l.skinInstance),n.skinInstance=k[l]),f.push(n);var s=new pc.scene.Model;s.graph=d;s.meshInstances=f;s.skinInstances=k;s.getGraph().syncHierarchy();d=s.meshInstances;
for(a=0;a<d.length;a++)d[a].syncAabb();return s};d.prototype.generateWireframe=function(){var a,b,c,e,d,f,k,l,n,r,m=[];for(a=0;a<this.meshInstances.length;a++)f=this.meshInstances[a].mesh,-1===m.indexOf(f)&&m.push(f);var s=[[0,1],[1,2],[2,0]];for(a=0;a<m.length;a++){f=m[a];k=f.primitive[pc.scene.RENDERSTYLE_SOLID].base;l=f.primitive[pc.scene.RENDERSTYLE_SOLID].count;n=f.indexBuffer[pc.scene.RENDERSTYLE_SOLID];r=new Uint16Array(n.lock());var h={},u=[];for(b=k;b<k+l;b+=3)for(c=0;3>c;c++){e=r[b+s[c][0]];
d=r[b+s[c][1]];var F=e>d?d<<16|e:e<<16|d;void 0===h[F]&&(h[F]=0,u.push(e,d))}n.unlock();b=new pc.gfx.IndexBuffer(n.device,pc.gfx.INDEXFORMAT_UINT16,u.length);c=new Uint16Array(b.lock());c.set(u);b.unlock();f.primitive[pc.scene.RENDERSTYLE_WIREFRAME]={type:pc.gfx.PRIMITIVE_LINES,base:0,count:u.length,indexed:!0};f.indexBuffer[pc.scene.RENDERSTYLE_WIREFRAME]=b}};return{Model:d}}());pc.extend(pc.scene,function(){var d=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,c=new pc.Vec4,e=[[-0.5,-0.5],[0.5,-0.5],[0.5,0.5],[-0.5,0.5]],g=function(a){return 2*(Math.random()-0.5)*a},f=function(a){var b=new pc.Vec3;b.set(g(a.x),g(a.y),g(a.z));return b},k=function(a){var b=new pc.Vec4;b.set(g(a.x),g(a.y),g(a.z),g(a.w));return b},l=function(a,b,c,e){a=new pc.gfx.Texture(a,{width:b,height:c,format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,cubemap:!1,autoMipmap:!0});a.lock().set(e);a.unlock();a.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;
a.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.gfx.FILTER_LINEAR;a.magFilter=pc.gfx.FILTER_LINEAR;return a},n=function(a,b){this.graphicsDevice=a;this.numParticles="undefined"!==typeof b.numParticles?b.numParticles:1;this.numFrames="undefined"!==typeof b.numFrames?b.numFrames:1;this.frameDuration="undefined"!==typeof b.frameDuration?b.frameDuration:1;this.frameStart="undefined"!==typeof b.frameStart?b.frameStart:0;this.frameStartRange="undefined"!==typeof b.frameStartRange?b.frameStartRange:
0;this.timeRange="undefined"!==typeof b.timeRange?b.timeRange:99999999;this.startTime="undefined"!==typeof b.startTime?b.startTime:null;this.lifeTime="undefined"!==typeof b.lifeTime?b.lifeTime:1;this.lifeTimeRange="undefined"!==typeof b.lifeTimeRange?b.lifeTimeRange:0;this.startSize="undefined"!==typeof b.startSize?b.startSize:1;this.startSizeRange="undefined"!==typeof b.startSizeRange?b.startSizeRange:0;this.endSize="undefined"!==typeof b.endSize?b.endSize:1;this.endSizeRange="undefined"!==typeof b.endSizeRange?
b.endSizeRange:0;this.position="undefined"!==typeof b.position?b.position:new pc.Vec3(0,0,0);this.positionRange="undefined"!==typeof b.positionRange?b.positionRange:new pc.Vec3(0,0,0);this.velocity="undefined"!==typeof b.velocity?b.velocity:new pc.Vec3(0,0,0);this.velocityRange="undefined"!==typeof b.velocityRange?b.velocityRange:new pc.Vec3(0,0,0);this.acceleration="undefined"!==typeof b.acceleration?b.acceleration:new pc.Vec3(0,0,0);this.accelerationRange="undefined"!==typeof b.accelerationRange?
b.accelerationRange:new pc.Vec3(0,0,0);this.spinStart="undefined"!==typeof b.spinStart?b.spinStart:0;this.spinStartRange="undefined"!==typeof b.spinStartRange?b.spinStartRange:0;this.spinSpeed="undefined"!==typeof b.spinSpeed?b.spinSpeed:0;this.spinSpeedRange="undefined"!==typeof b.spinSpeedRange?b.spinSpeedRange:0;this.colorMult="undefined"!==typeof b.colorMult?b.colorMult:new pc.Vec4(1,1,1,1);this.colorMultRange="undefined"!==typeof b.colorMultRange?b.colorMultRange:new pc.Vec4(0,0,0,0);this.worldVelocity=
"undefined"!==typeof b.worldVelocity?b.worldVelocity:new pc.Vec3(0,0,0);this.worldAcceleration="undefined"!==typeof b.worldAcceleration?b.worldAcceleration:new pc.Vec3(0,0,0);this.billboard="undefined"!==typeof b.billboard?b.billboard:!0;this.orientation="undefined"!==typeof b.orientation?b.orientation:new pc.Vec4(0,0,0,1);this.dynamic="undefined"!==typeof b.dynamic?b.dynamic:!1;this.birthIndex=0;this.maxParticles=1E3;for(var c=[],e=[0,0.2,0.7,1,1,0.7,0.2,0],d=0;8>d;d++)for(var g=0;8>g;g++){var f=
255*e[g]*e[d];c.push(f,f,f,f)}this.colorMap=l(a,8,8,c);this.opacityMap=l(a,1,1,[255,255,255,255]);this.rampMap=l(a,2,1,[255,255,255,255,255,255,255,0]);this.allocate(this.numParticles);this.generate(0,this.numParticles);c=new pc.scene.Mesh;c.vertexBuffer=this.vertexBuffer;c.indexBuffer[0]=this.indexBuffer;c.primitive[0].type=pc.gfx.PRIMITIVE_TRIANGLES;c.primitive[0].base=0;c.primitive[0].count=this.indexBuffer.getNumIndices();c.primitive[0].indexed=!0;e=new pc.scene.Material;d=this.graphicsDevice.getProgramLibrary().getProgram("particle",
{billboard:this.billboard});e.setShader(d);e.setParameter("particle_worldVelocity",this.worldVelocity.data);e.setParameter("particle_worldAcceleration",this.worldAcceleration.data);e.setParameter("particle_numFrames",this.numFrames);e.setParameter("particle_frameDuration",this.frameDuration);e.setParameter("particle_timeRange",this.timeRange);e.setParameter("particle_timeOffset",0);e.setParameter("texture_colorMap",this.colorMap);e.setParameter("texture_opacityMap",this.opacityMap);e.setParameter("texture_rampMap",
this.rampMap);e.cullMode=pc.gfx.CULLFACE_NONE;e.blend=!0;e.blendSrc=pc.gfx.BLENDMODE_SRC_ALPHA;e.blendDst=pc.gfx.BLENDMODE_ONE;e.depthWrite=!1;this.meshInstance=new pc.scene.MeshInstance(null,c,e);this.meshInstance.layer=pc.scene.LAYER_FX;this.meshInstance.updateKey();this.time=0};n.prototype={allocate:function(a){if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==4*a){var b=[{semantic:pc.gfx.SEMANTIC_ATTR0,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR1,
components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR2,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR3,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR4,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32},{semantic:pc.gfx.SEMANTIC_ATTR5,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32}];this.billboard||b.push({semantic:pc.gfx.SEMANTIC_ATTR6,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32});b=new pc.gfx.VertexFormat(this.graphicsDevice,
b);this.vertexBuffer=new pc.gfx.VertexBuffer(this.graphicsDevice,b,4*a,pc.gfx.BUFFER_DYNAMIC);this.indexBuffer=new pc.gfx.IndexBuffer(this.graphicsDevice,pc.gfx.INDEXFORMAT_UINT16,6*a);for(var b=0,c=new Uint16Array(this.indexBuffer.lock()),e=0;e<a;e++){var d=4*e;c[b++]=d;c[b++]=d+1;c[b++]=d+2;c[b++]=d;c[b++]=d+2;c[b++]=d+3}this.indexBuffer.unlock()}},generate:function(l,n){for(var s=new Float32Array(this.vertexBuffer.lock()),h=this.billboard?24:28,u=l;u<n;u++){var F=this.lifeTime,z=u*F/n,v=this.frameStart+
g(this.frameStartRange);d.add2(this.position,f(this.positionRange));a.add2(this.velocity,f(this.velocityRange));b.add2(this.acceleration,f(this.accelerationRange));c.add2(this.colorMult,k(this.colorMultRange));for(var w=this.spinStart+g(this.spinStartRange),A=this.spinSpeed+g(this.spinSpeedRange),B=this.startSize+g(this.startSizeRange),E=this.endSize+g(this.endSizeRange),C=this.orientation,H=0;4>H;H++){var x=(4*u+H)*h;s[x+0]=e[H][0];s[x+1]=e[H][1];s[x+2]=F;s[x+3]=v;s[x+4]=d.x;s[x+5]=d.y;s[x+6]=d.z;
s[x+7]=z;s[x+8]=a.x;s[x+9]=a.y;s[x+10]=a.z;s[x+11]=B;s[x+12]=b.x;s[x+13]=b.y;s[x+14]=b.z;s[x+15]=E;s[x+16]=w;s[x+17]=A;s[x+18]=0;s[x+19]=0;s[x+20]=c.x;s[x+21]=c.y;s[x+22]=c.z;s[x+23]=c.w;this.billboard||(s[x+24]=C.x,s[x+25]=C.y,s[x+26]=C.z,s[x+27]=C.w)}}this.vertexBuffer.unlock()},addTime:function(a){this.time+=a;this.meshInstance.material.setParameter("particle_time",this.time);this.dynamic&&(this.generate(this.birthIndex+this.numParticles,this.numParticles),this.birthIndex+=this.numParticles)},
setColorRamp:function(a){for(var b=0;b<a.length;b++)a[b]=Math.floor(255*a[b]);this.rampMap=l(this.graphicsDevice,a.length/4,1,a);this.meshInstance.material.setParameter("texture_rampMap",this.rampMap)},setColorMap:function(a){this.colorMap=a;this.meshInstance.material.setParameter("texture_colorMap",this.colorMap)},setOpacityMap:function(a){this.opacityMap=a;this.meshInstance.material.setParameter("texture_opacityMap",this.opacityMap)}};return{ParticleEmitter:n}}());pc.extend(pc.scene,function(){var d=function(a,b,c){this.device=a;a=a.getProgramLibrary();this.pickProgStatic=a.getProgram("pick",{skin:!1});this.pickProgSkin=a.getProgram("pick",{skin:!0});this.pickColor=new Float32Array(4);this.scene=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.gfx.CLEARFLAG_COLOR|pc.gfx.CLEARFLAG_DEPTH};this.resize(b,c)};d.prototype.getSelection=function(a){a.width=a.width||1;a.height=a.height||1;this._pickBufferTarget.bind();var b=new ArrayBuffer(4*a.width*a.height),
c=new Uint8Array(b),e=this.device.gl;e.readPixels(a.x,a.y,a.width,a.height,e.RGBA,e.UNSIGNED_BYTE,c);c=[];for(e=0;e<a.width*a.height;e++){var d=new Uint8Array(b,4*e,4),d=d[0]<<16|d[1]<<8|d[2];16777215!==d&&(d=this.scene.drawCalls[d],-1===c.indexOf(d)&&c.push(d))}return c};d.prototype.prepare=function(a,b){this.scene=b;var c=this.device,e=c.getRenderTarget();c.setRenderTarget(this._pickBufferTarget);c.updateBegin();c.setViewport(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);c.setScissor(0,
0,this._pickBufferTarget.width,this._pickBufferTarget.height);c.clear(this.clearOptions);var d,f,k,l,n=b.drawCalls,r=n.length,c=this.device;f=c.scope;var m=f.resolve("matrix_model"),s=f.resolve("matrix_pose[0]"),h=f.resolve("uColor");d=f.resolve("matrix_projection");f=f.resolve("matrix_viewProjection");l=a.getWorldTransform();k=a.getProjectionMatrix();l=l.clone().invert();var u=new pc.Mat4;u.mul2(k,l);d.setValue(k.data);f.setValue(u.data);for(d=0;d<r;d++)if(!n[d].command&&(k=n[d],f=k.mesh,l=f.primitive[pc.scene.RENDERSTYLE_SOLID].type,
l===pc.gfx.PRIMITIVE_TRIANGLES||l===pc.gfx.PRIMITIVE_TRISTRIP))m.setValue(k.node.worldTransform.data),k.skinInstance&&s.setValue(k.skinInstance.matrixPalette),this.pickColor[0]=(d>>16&255)/255,this.pickColor[1]=(d>>8&255)/255,this.pickColor[2]=(d&255)/255,this.pickColor[3]=1,h.setValue(this.pickColor),c.setShader(f.skin?this.pickProgSkin:this.pickProgStatic),c.setVertexBuffer(f.vertexBuffer,0),c.setIndexBuffer(f.indexBuffer[pc.scene.RENDERSTYLE_SOLID]),c.draw(f.primitive[pc.scene.RENDERSTYLE_SOLID]);
c.setViewport(0,0,c.width,c.height);c.setScissor(0,0,c.width,c.height);c.updateEnd();c.setRenderTarget(e)};d.prototype.resize=function(a,b){var c=new pc.gfx.Texture(this.device,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8,width:a,height:b});c.minFilter=pc.gfx.FILTER_NEAREST;c.magFilter=pc.gfx.FILTER_NEAREST;c.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;this._pickBufferTarget=new pc.gfx.RenderTarget(this.device,c,{depth:!0})};Object.defineProperty(d.prototype,"renderTarget",
{get:function(){return this._pickBufferTarget}});Object.defineProperty(d.prototype,"width",{get:function(){return this._pickBufferTarget.width}});Object.defineProperty(d.prototype,"height",{get:function(){return this._pickBufferTarget.height}});return{Picker:d}}());pc.scene.procedural={};
pc.scene.procedural.calculateTangents=function(d,a,b,c){var e=c.length/3,g=d.length/3,f,k,l,n,r,m,s,h,u,F,z,v,w,A,B=new pc.Vec3,E=new pc.Vec3,C=new pc.Vec3,H=new pc.Vec3,x=new pc.Vec3,y=new pc.Vec2,D=new pc.Vec2,K=new pc.Vec2,G,I=new Float32Array(3*g),J=new Float32Array(3*g),L=[];for(G=0;G<e;G++)f=c[3*G],k=c[3*G+1],l=c[3*G+2],C.set(d[3*f],d[3*f+1],d[3*f+2]),H.set(d[3*k],d[3*k+1],d[3*k+2]),x.set(d[3*l],d[3*l+1],d[3*l+2]),y.set(b[2*f],b[2*f+1]),D.set(b[2*k],b[2*k+1]),K.set(b[2*l],b[2*l+1]),n=H.x-C.x,
r=x.x-C.x,m=H.y-C.y,s=x.y-C.y,h=H.z-C.z,u=x.z-C.z,F=D.x-y.x,z=K.x-y.x,v=D.y-y.y,w=K.y-y.y,A=1/(F*w-z*v),B.set((w*n-v*r)*A,(w*m-v*s)*A,(w*h-v*u)*A),E.set((F*r-z*n)*A,(F*s-z*m)*A,(F*u-z*h)*A),I[3*f+0]+=B.x,I[3*f+1]+=B.y,I[3*f+2]+=B.z,I[3*k+0]+=B.x,I[3*k+1]+=B.y,I[3*k+2]+=B.z,I[3*l+0]+=B.x,I[3*l+1]+=B.y,I[3*l+2]+=B.z,J[3*f+0]+=E.x,J[3*f+1]+=E.y,J[3*f+2]+=E.z,J[3*k+0]+=E.x,J[3*k+1]+=E.y,J[3*k+2]+=E.z,J[3*l+0]+=E.x,J[3*l+1]+=E.y,J[3*l+2]+=E.z;v=new pc.Vec3;w=new pc.Vec3;d=new pc.Vec3;b=new pc.Vec3;for(G=
0;G<g;G++)d.set(a[3*G],a[3*G+1],a[3*G+2]),v.set(I[3*G],I[3*G+1],I[3*G+2]),w.set(J[3*G],J[3*G+1],J[3*G+2]),c=d.dot(v),b.copy(d).scale(c),b.sub2(v,b).normalize(),L[4*G]=b.x,L[4*G+1]=b.y,L[4*G+2]=b.z,b.cross(d,v),L[4*G+3]=0>b.dot(w)?-1:1;return L};
pc.scene.procedural.createMesh=function(d,a,b){var c=b&&void 0!==b.normals?b.normals:null,e=b&&void 0!==b.tangents?b.tangents:null,g=b&&void 0!==b.uvs?b.uvs:null,b=b&&void 0!==b.indices?b.indices:null,f=[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}];null!==c&&f.push({semantic:pc.gfx.SEMANTIC_NORMAL,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32});null!==e&&f.push({semantic:pc.gfx.SEMANTIC_TANGENT,components:4,type:pc.gfx.ELEMENTTYPE_FLOAT32});null!==g&&f.push({semantic:pc.gfx.SEMANTIC_TEXCOORD0,
components:2,type:pc.gfx.ELEMENTTYPE_FLOAT32});for(var k=new pc.gfx.VertexFormat(d,f),f=a.length/3,k=new pc.gfx.VertexBuffer(d,k,f),l=new pc.gfx.VertexIterator(k),n=0;n<f;n++)l.element[pc.gfx.SEMANTIC_POSITION].set(a[3*n],a[3*n+1],a[3*n+2]),null!==c&&l.element[pc.gfx.SEMANTIC_NORMAL].set(c[3*n],c[3*n+1],c[3*n+2]),null!==e&&l.element[pc.gfx.SEMANTIC_TANGENT].set(e[4*n],e[4*n+1],e[4*n+2],e[4*n+3]),null!==g&&l.element[pc.gfx.SEMANTIC_TEXCOORD0].set(g[2*n],g[2*n+1]),l.next();l.end();c=null;if(e=null!==
b)c=new pc.gfx.IndexBuffer(d,pc.gfx.INDEXFORMAT_UINT16,b.length),(new Uint16Array(c.lock())).set(b),c.unlock();d=new pc.shape.Aabb;d.compute(a);a=new pc.scene.Mesh;a.vertexBuffer=k;a.indexBuffer[0]=c;a.primitive[0].type=pc.gfx.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=e?b.length:f;a.primitive[0].indexed=e;a.aabb=d;return a};
pc.scene.procedural.createTorus=function(d,a){var b=a&&void 0!==a.tubeRadius?a.tubeRadius:0.2,c=a&&void 0!==a.ringRadius?a.ringRadius:0.3,e=a&&void 0!==a.segments?a.segments:30,g=a&&void 0!==a.sides?a.sides:20,f,k,l,n,r,m,s,h,u,F,z=[],v=[],w=[],A=[];for(f=0;f<=g;f++)for(k=0;k<=e;k++)l=Math.cos(2*Math.PI*k/e)*(c+b*Math.cos(2*Math.PI*f/g)),n=Math.sin(2*Math.PI*f/g)*b,r=Math.sin(2*Math.PI*k/e)*(c+b*Math.cos(2*Math.PI*f/g)),m=Math.cos(2*Math.PI*k/e)*Math.cos(2*Math.PI*f/g),s=Math.sin(2*Math.PI*f/g),h=
Math.sin(2*Math.PI*k/e)*Math.cos(2*Math.PI*f/g),u=f/g,F=1-k/e,z.push(l,n,r),v.push(m,s,h),w.push(u,F),f<g&&k<e&&(l=f*(e+1)+k,n=(f+1)*(e+1)+k,r=f*(e+1)+(k+1),m=(f+1)*(e+1)+(k+1),A.push(l,n,r),A.push(n,m,r));b={normals:v,uvs:w,indices:A};pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(z,v,w,A));return pc.scene.procedural.createMesh(d,z,b)};
pc.scene.procedural._createConeData=function(d,a,b,c,e,g){var f,k,l,n,r,m=new pc.Vec3;l=new pc.Vec3;n=new pc.Vec3;var s,h,u=[],F=[],z=[],v=[],w;if(0<b)for(f=0;f<=c;f++)for(k=0;k<=e;k++)theta=2*(k/e)*Math.PI-Math.PI,w=Math.sin(theta),h=Math.cos(theta),s=new pc.Vec3(w*d,-b/2,h*d),r=new pc.Vec3(w*a,b/2,h*a),m.lerp(s,r,f/c),l.sub2(r,s).normalize(),h=new pc.Vec3(h,0,-w),n.cross(h,l).normalize(),u.push(m.x,m.y,m.z),F.push(n.x,n.y,n.z),z.push(k/e,f/c),f<c&&k<e&&(h=f*(e+1)+k,w=f*(e+1)+(k+1),r=(f+1)*(e+1)+
k,s=(f+1)*(e+1)+(k+1),v.push(h,w,r),v.push(w,s,r));if(g){d=Math.floor(e/2);m=b/2;for(b=0;b<=d;b++){theta=0.5*b*Math.PI/d;w=Math.sin(theta);h=Math.cos(theta);for(f=0;f<=e;f++)phi=2*f*Math.PI/e-Math.PI/2,l=Math.sin(phi),g=Math.cos(phi),g*=w,k=h,l*=w,n=1-f/e,r=1-b/d,u.push(g*a,k*a+m,l*a),F.push(g,k,l),z.push(n,r)}s=(c+1)*(e+1);for(b=0;b<d;++b)for(f=0;f<e;++f)h=b*(e+1)+f,w=h+e+1,v.push(s+h+1,s+w,s+h),v.push(s+h+1,s+w+1,s+w);for(b=0;b<=d;b++){theta=0.5*Math.PI+0.5*b*Math.PI/d;w=Math.sin(theta);h=Math.cos(theta);
for(f=0;f<=e;f++)phi=2*f*Math.PI/e-Math.PI/2,l=Math.sin(phi),g=Math.cos(phi),g*=w,k=h,l*=w,n=1-f/e,r=1-b/d,u.push(g*a,k*a-m,l*a),F.push(g,k,l),z.push(n,r)}s=(c+1)*(e+1)+(e+1)*(d+1);for(b=0;b<d;++b)for(f=0;f<e;++f)h=b*(e+1)+f,w=h+e+1,v.push(s+h+1,s+w,s+h),v.push(s+h+1,s+w+1,s+w)}else{s=(c+1)*(e+1);if(0<d)for(f=0;f<e;f++)theta=2*(f/e)*Math.PI,g=Math.sin(theta),k=-b/2,l=Math.cos(theta),n=1-(g+1)/2,r=(l+1)/2,u.push(g*d,k,l*d),F.push(0,-1,0),z.push(n,r),1<f&&v.push(s,s+f,s+f-1);s+=e;if(0<a)for(f=0;f<e;f++)theta=
2*(f/e)*Math.PI,g=Math.sin(theta),k=b/2,l=Math.cos(theta),n=1-(g+1)/2,r=(l+1)/2,u.push(g*a,k,l*a),F.push(0,1,0),z.push(n,r),1<f&&v.push(s,s+f-1,s+f)}return{positions:u,normals:F,uvs:z,indices:v}};
pc.scene.procedural.createCylinder=function(d,a){var b=a&&void 0!==a.baseRadius?a.baseRadius:0.5,b=pc.scene.procedural._createConeData(b,b,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:20,!1);pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createCapsule=function(d,a){var b=a&&void 0!==a.radius?a.radius:0.3,b=pc.scene.procedural._createConeData(b,b,(a&&void 0!==a.height?a.height:1)-2*b,a&&void 0!==a.heightSegments?a.heightSegments:1,a&&void 0!==a.sides?a.sides:20,!0);pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createCone=function(d,a){var b=pc.scene.procedural._createConeData(a&&void 0!==a.baseRadius?a.baseRadius:0.5,a&&void 0!==a.peakRadius?a.peakRadius:0,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:18,!1);pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.scene.procedural.createMesh(d,b.positions,b)};
pc.scene.procedural.createSphere=function(d,a){var b=a&&void 0!==a.radius?a.radius:0.5,c=a&&void 0!==a.latitudeBands?a.latitudeBands:16,e=a&&void 0!==a.longitudeBands?a.longitudeBands:16,g,f,k,l,n,r,m,s,h,u=[],F=[],z=[],v=[];for(f=0;f<=c;f++){g=f*Math.PI/c;k=Math.sin(g);l=Math.cos(g);for(g=0;g<=e;g++)n=2*g*Math.PI/e-Math.PI/2,r=Math.sin(n),n=Math.cos(n),n*=k,m=l,r*=k,s=1-g/e,h=1-f/c,u.push(n*b,m*b,r*b),F.push(n,m,r),z.push(s,h)}for(f=0;f<c;++f)for(g=0;g<e;++g)b=f*(e+1)+g,k=b+e+1,v.push(b+1,k,b),v.push(b+
1,k+1,k);c={normals:F,uvs:z,indices:v};pc.gfx.precalculatedTangents&&(c.tangents=pc.scene.procedural.calculateTangents(u,F,z,v));return pc.scene.procedural.createMesh(d,u,c)};
pc.scene.procedural.createPlane=function(d,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec2(0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:5,e=a&&void 0!==a.lengthSegments?a.lengthSegments:5,g,f,k,l,n,r,m=[],s=[],h=[],u=[];for(g=0;g<=c;g++)for(f=0;f<=e;f++)k=-b.x+2*b.x*g/c,l=-(-b.y+2*b.y*f/e),n=g/c,r=f/e,m.push(k,0,l),s.push(0,1,0),h.push(n,r),g<c&&f<e&&(u.push(f+g*(c+1),f+(g+1)*(c+1),f+g*(c+1)+1),u.push(f+(g+1)*(c+1),f+(g+1)*(c+1)+1,f+g*(c+1)+1));b={normals:s,uvs:h,indices:u};
pc.gfx.precalculatedTangents&&(b.tangents=pc.scene.procedural.calculateTangents(m,s,h,u));return pc.scene.procedural.createMesh(d,m,b)};
pc.scene.procedural.createBox=function(d,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec3(0.5,0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:1,e=a&&void 0!==a.lengthSegments?a.lengthSegments:1,g=a&&void 0!==a.heightSegments?a.heightSegments:1,f=[new pc.Vec3(-b.x,-b.y,b.z),new pc.Vec3(b.x,-b.y,b.z),new pc.Vec3(b.x,b.y,b.z),new pc.Vec3(-b.x,b.y,b.z),new pc.Vec3(b.x,-b.y,-b.z),new pc.Vec3(-b.x,-b.y,-b.z),new pc.Vec3(-b.x,b.y,-b.z),new pc.Vec3(b.x,b.y,-b.z)],k=[[0,1,3],[4,5,7],[3,
2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],n=[],r=[],m=[],s=[],b=function(a,b,c){var e,d,g,A,B=n.length/3;for(g=0;g<=b;g++)for(A=0;A<=c;A++){e=new pc.Vec3;d=new pc.Vec3;var E=new pc.Vec3,C=new pc.Vec3;e.lerp(f[k[a][0]],f[k[a][1]],g/b);d.lerp(f[k[a][0]],f[k[a][2]],A/c);E.sub2(d,f[k[a][0]]);C.add2(e,E);e=g/b;d=A/c;n.push(C.x,C.y,C.z);r.push(l[a][0],l[a][1],l[a][2]);m.push(e,d);g<b&&A<c&&(s.push(B+A+g*(b+1),B+A+(g+1)*(b+1),B+A+g*(b+1)+1),s.push(B+A+(g+1)*(b+
1),B+A+(g+1)*(b+1)+1,B+A+g*(b+1)+1))}};b(0,c,g);b(1,c,g);b(2,c,e);b(3,c,e);b(4,e,g);b(5,e,g);c={normals:r,uvs:m,indices:s};pc.gfx.precalculatedTangents&&(c.tangents=pc.scene.procedural.calculateTangents(n,r,m,s));return pc.scene.procedural.createMesh(d,n,c)};pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new RSVP.Promise(function(c,e){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){e()}})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="json";a.prototype.Type=Object;return{JsonResourceHandler:d,JsonRequest:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a){return new RSVP.Promise(function(c,e){var d=new Image;d.onload=function(){c(d)};d.onerror=function(a){e(pc.string.format("Error loading Image from: '{0}'",a.srcElement.src))};d.src=a.canonical})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="image";a.prototype.Type=Image;return{ImageResourceHandler:d,
ImageRequest:a}}());pc.extend(pc.resources,function(){var d=function(a){this._device=a},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a,c){var e=a.canonical;return new RSVP.Promise(function(a,b){var d=pc.path.getExtension(e).toLowerCase();if(".dds"===d||".crn"===d)c=c||{},c.binary=!0,c.directory=pc.path.getDirectory(e),c.crn=".crn"===d,pc.net.http.get(e,function(b){a(b)},{cache:!1});else if(".jpg"===d||".jpeg"===d||".gif"===d||".png"===d){var l=new Image;l.onload=function(){a(l)};l.onerror=
function(a){b(pc.string.format("Error loading Texture from: '{0}'",a.srcElement.src))};l.src=e}})};d.prototype.open=function(a,c,e){var d;if(a instanceof Image)d=c.result?c.result:new pc.gfx.Texture(this._device,{width:a.width,height:a.height,format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8}),d.setSource(a);else if(a instanceof ArrayBuffer){if(e.crn){c=a.byteLength;d=new Uint8Array(a);a=Module._malloc(c);e=Module.HEAPU8;dst32Offset=a/4;for(var f=c%4,k=new Uint32Array(d.buffer,0,(c-f)/4),l=new Uint32Array(e.buffer),
n=0;n<k.length;n++)l[dst32Offset+n]=k[n];for(n=c-f;n<c;n++)e[a+n]=d[n];d=Module._crn_decompress_get_data(a,c);c=Module._crn_decompress_get_size(a,c);a=Module.HEAPU8.buffer.slice(d,d+c)}d=loadDDS(a)}return d};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="texture";a.prototype.Type=pc.gfx.Texture;return{TextureResourceHandler:d,TextureRequest:a}}());pc.extend(pc.resources,function(){var d={points:pc.gfx.PRIMITIVE_POINTS,lines:pc.gfx.PRIMITIVE_LINES,linestrip:pc.gfx.PRIMITIVE_LINESTRIP,triangles:pc.gfx.PRIMITIVE_TRIANGLES,trianglestrip:pc.gfx.PRIMITIVE_TRISTRIP},a={int8:pc.gfx.ELEMENTTYPE_INT8,uint8:pc.gfx.ELEMENTTYPE_UINT8,int16:pc.gfx.ELEMENTTYPE_INT16,uint16:pc.gfx.ELEMENTTYPE_UINT16,int32:pc.gfx.ELEMENTTYPE_INT32,uint32:pc.gfx.ELEMENTTYPE_UINT32,float32:pc.gfx.ELEMENTTYPE_FLOAT32},b=function(a,b){this._device=a;this._assets=b;this.materialLoader=
new pc.resources.MaterialResourceLoader(a,b)},b=pc.inherits(b,pc.resources.ResourceHandler);b.prototype.load=function(a,b){return new RSVP.Promise(function(c,d){var l=a.canonical;b=b||{};b.directory=pc.path.getDirectory(l);var n=new pc.URI(l);pc.path.getExtension(n.path);pc.net.http.get(l,function(a){c(a)}.bind(this),{cache:b.cache,error:function(a){d(pc.string.format("Error loading model: {0} [{1}]",l,a))}})})};b.prototype.open=function(a,b,c){c=c||{};c.directory=c.directory||"";c.parent=b;var d=
null;1>=a.model.version?logERROR(pc.string.format("Asset: {0}, is an old model format. Upload source assets to re-import.",b.canonical)):d=this._loadModelJson(a,b.data,c);return d};b.prototype.clone=function(a){return a.clone()};b.prototype._loadModelJson=function(b,c){var f=b.model,k,l,n=[];for(k=0;k<f.nodes.length;k++){var r=f.nodes[k],m=new pc.scene.GraphNode;m.setName(r.name);m.setLocalPosition(r.position[0],r.position[1],r.position[2]);m.setLocalEulerAngles(r.rotation[0],r.rotation[1],r.rotation[2]);
m.setLocalScale(r.scale[0],r.scale[1],r.scale[2]);n.push(m)}for(k=1;k<f.parents.length;k++)n[f.parents[k]].addChild(n[k]);0<f.skins.length&&(k=this._device.getBoneLimit(),pc.scene.partitionSkin(f,c,k));var s=[],r=[];for(k=0;k<f.skins.length;k++){var h=f.skins[k],m=[];for(l=0;l<h.inverseBindMatrices.length;l++){var u=h.inverseBindMatrices[l];m[l]=new pc.Mat4(u[0],u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9],u[10],u[11],u[12],u[13],u[14],u[15])}h=new pc.scene.Skin(m,h.boneNames);s.push(h);m=new pc.scene.SkinInstance(h);
u=[];for(l=0;l<h.boneNames.length;l++){var F=n[0].findByName(h.boneNames[l]);u.push(F)}m.bones=u;r.push(m)}var h=[],z,m={position:pc.gfx.SEMANTIC_POSITION,normal:pc.gfx.SEMANTIC_NORMAL,tangent:pc.gfx.SEMANTIC_TANGENT,blendWeight:pc.gfx.SEMANTIC_BLENDWEIGHT,blendIndices:pc.gfx.SEMANTIC_BLENDINDICES,color:pc.gfx.SEMANTIC_COLOR,texCoord0:pc.gfx.SEMANTIC_TEXCOORD0,texCoord1:pc.gfx.SEMANTIC_TEXCOORD1,texCoord2:pc.gfx.SEMANTIC_TEXCOORD2,texCoord3:pc.gfx.SEMANTIC_TEXCOORD3,texCoord4:pc.gfx.SEMANTIC_TEXCOORD4,
texCoord5:pc.gfx.SEMANTIC_TEXCOORD5,texCoord6:pc.gfx.SEMANTIC_TEXCOORD6,texCoord7:pc.gfx.SEMANTIC_TEXCOORD7};for(k=0;k<f.vertices.length;k++){u=f.vertices[k];if(u.position&&u.normal&&u.texCoord0){F=[];for(l=0;l<f.meshes.length;l++)f.meshes[l].vertices===k&&(F=F.concat(f.meshes[l].indices));tangents=pc.scene.procedural.calculateTangents(u.position.data,u.normal.data,u.texCoord0.data,F);u.tangent={type:"float32",components:4,data:tangents}}l=[];for(z in u){var F=u[z],v=F.type;this._device.supportsUnsignedByte||
("uint8"===v&&(v="float32"),"int8"===v&&(v="float32"));l.push({semantic:m[z],components:F.components,type:a[v],normalize:!1})}l=new pc.gfx.VertexFormat(this._device,l);var v=u.position.data.length/u.position.components,w=new pc.gfx.VertexBuffer(this._device,l,v),A=new pc.gfx.VertexIterator(w);for(l=0;l<v;l++){for(z in u)switch(F=u[z],F.components){case 1:A.element[m[z]].set(F.data[l]);break;case 2:A.element[m[z]].set(F.data[2*l],F.data[2*l+1]);break;case 3:A.element[m[z]].set(F.data[3*l],F.data[3*
l+1],F.data[3*l+2]);break;case 4:A.element[m[z]].set(F.data[4*l],F.data[4*l+1],F.data[4*l+2],F.data[4*l+3])}A.next()}A.end();h.push(w)}for(k=m=0;k<f.meshes.length;k++)u=f.meshes[k],"undefined"!==typeof u.indices&&(m+=u.indices.length);v=F=null;w=0;0<m&&(F=new pc.gfx.IndexBuffer(this._device,pc.gfx.INDEXFORMAT_UINT16,m),v=new Uint16Array(F.lock()));z=[];for(k=0;k<f.meshes.length;k++){u=f.meshes[k];l=u.aabb.min;var A=u.aabb.max,A=new pc.shape.Aabb(new pc.Vec3(0.5*(A[0]+l[0]),0.5*(A[1]+l[1]),0.5*(A[2]+
l[2])),new pc.Vec3(0.5*(A[0]-l[0]),0.5*(A[1]-l[1]),0.5*(A[2]-l[2]))),B="undefined"!==typeof u.indices;l=new pc.scene.Mesh;l.vertexBuffer=h[u.vertices];l.indexBuffer[0]=B?F:null;l.primitive[0].type=d[u.type];l.primitive[0].base=B?u.base+w:u.base;l.primitive[0].count=u.count;l.primitive[0].indexed=B;l.skin="undefined"!==typeof u.skin?s[u.skin]:null;l.aabb=A;B&&(v.set(u.indices,w),w+=u.indices.length);z.push(l)}0<m&&F.unlock();h=[];u=new pc.scene.PhongMaterial;for(k=0;k<f.meshInstances.length;k++){l=
f.meshInstances[k];m=n[l.node];l=z[l.mesh];F=c&&c[k].material?this.materialLoader.load(c[k].material):u;m=new pc.scene.MeshInstance(m,l,F);if(l.skin){l=s.indexOf(l.skin);if(-1===l)throw Error("Mesh's skin does not appear in skin array.");m.skinInstance=r[l]}h.push(m)}f=new pc.scene.Model;f.graph=n[0];f.meshInstances=h;f.skinInstances=r;f.getGraph().syncHierarchy();h=f.meshInstances;for(k=0;k<h.length;k++)h[k].syncAabb();return f};var c;c=pc.inherits(function(){},pc.resources.ResourceRequest);c.prototype.type=
"model";c.prototype.Type=pc.scene.Model;return{ModelResourceHandler:b,ModelRequest:c}}());pc.extend(pc.resources,function(){var d={repeat:pc.gfx.ADDRESS_REPEAT,clamp:pc.gfx.ADDRESS_CLAMP_TO_EDGE,mirror:pc.gfx.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.gfx.FILTER_NEAREST,linear:pc.gfx.FILTER_LINEAR,nearest_mip_nearest:pc.gfx.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.gfx.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.gfx.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR},b={},c=function(a,b){this._device=a;this._assets=b};c.prototype.load=function(a){if(!b[a]){var c=
new pc.scene.PhongMaterial,d=this._assets.getAssetByResourceId(a);d&&(this._updatePhongMaterial(c,d.data),d.on("change",function(a,b,e){"data"===b&&this._updatePhongMaterial(c,e)},this));b[a]=c}return b[a]};c.prototype._updatePhongMaterial=function(a,b){for(var c=0;c<b.parameters.length;c++){var d=b.parameters[c];"texture"===d.type&&(d.data&&!(d.data instanceof pc.gfx.Texture))&&(d.data=this._loadTexture(d.data))}a.init(b)};c.prototype._loadTexture=function(b){b=this._assets.getAssetByResourceId(b);
if(!b)return null;var c=b.getFileUrl();if(!c)return null;var f=b.data,c=this._assets.loader.getFromCache(c);c||(c=new pc.gfx.Texture(this._device,{format:pc.gfx.PIXELFORMAT_R8_G8_B8_A8}),c.name=f.name,c.addressU=d[f.addressu],c.addressV=d[f.addressv],c.magFilter=a[f.magfilter],c.minFilter=a[f.minfilter]);this._assets.load([b],[c],{});return c};return{MaterialResourceLoader:c}}());pc.anim={};pc.anim.Key=function(d,a,b,c){this.time=d;this.position=a;this.rotation=b;this.scale=c};pc.anim.Node=function(){this._name="";this._keys=[]};
pc.extend(pc.anim,function(){var d=function(){this._name="";this._duration=0;this._nodes=[];this._nodeDict={}};d.prototype.getDuration=function(){return this._duration};d.prototype.getName=function(){return this._name};d.prototype.getNode=function(a){return this._nodeDict[a]};d.prototype.getNodes=function(){return this._nodes};d.prototype.setDuration=function(a){this._duration=a};d.prototype.setName=function(a){this._name=a};d.prototype.addNode=function(a){this._nodes.push(a);this._nodeDict[a._name]=
a};return{Animation:d}}());pc.extend(pc.anim,function(){function d(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}d.prototype={getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}};var a=function(a){function c(a){var b=a.getName(),k=new d;k._name=b;e._interpolatedKeys.push(k);e._interpolatedKeyDict[b]=k;e._currKeyIndices[b]=0;a=a.getChildren();for(b=0;b<a.length;b++)c(a[b])}this._animation=null;
this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var e=this;c(a)};a.prototype.addTime=function(a){if(null!==this._animation&&(this._time!==n||this.looping)){var c,e,d,f,k,l=this._animation.getNodes();this._time+=a;var n=this._animation.getDuration();if(this._time>n){this._time=this.looping?0:n;for(a=0;a<l.length;a++)c=l[a],n=c._name,this._currKeyIndices[n]=0}for(a=0;a<l.length;a++)if(c=l[a],n=c._name,c=c._keys,e=this._interpolatedKeyDict[n],
1===c.length)e._pos.copy(c[0].position),e._quat.copy(c[0].rotation),e._scale(c[0].scale);else for(var r=this._currKeyIndices[n];r<c.length-1;r++)d=c[r],f=c[r+1],d.time<=this._time&&f.time>=this._time&&(k=(this._time-d.time)/(f.time-d.time),e._pos.lerp(d.position,f.position,k),e._quat.slerp(d.rotation,f.rotation,k),e._scale.lerp(d.scale,f.scale,k),e._written=!0,this._currKeyIndices[n]=r)}};a.prototype.blend=function(a,c,e){for(var d=this._interpolatedKeys.length,f=0;f<d;f++){var k=a._interpolatedKeys[f],
l=c._interpolatedKeys[f],n=this._interpolatedKeys[f];k._written&&l._written?(n._quat.slerp(k._quat,c._interpolatedKeys[f]._quat,e),n._pos.lerp(k._pos,c._interpolatedKeys[f]._pos,e),n._scale.lerp(k._scale,l._scale,e),n._written=!0):k._written?(n._quat.copy(k._quat),n._pos.copy(k._pos),n._scale.copy(k._scale),n._written=!0):l._written&&(n._quat.copy(l._quat),n._pos.copy(l._pos),n._scale.copy(l._scale),n._written=!0)}};a.prototype.getAnimation=function(){return this._animation};a.prototype.getCurrentTime=
function(){return this._time};a.prototype.setCurrentTime=function(a){this._time=a;for(var a=this._interpolatedKeys.length,c=0;c<a;c++)this._currKeyIndices[this._interpolatedKeys[c]._name]=0;this.addTime(0);this.updateGraph()};a.prototype.getNumNodes=function(){return this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this._animation=a;this.setCurrentTime(0)};a.prototype.setGraph=function(a){var c;if(this.graph=a)for(c=0;c<this._interpolatedKeys.length;c++){var e=a.findByName(this._interpolatedKeys[c]._name);
this._interpolatedKeys[c].setTarget(e)}else for(c=0;c<this._interpolatedKeys.length;c++)this._interpolatedKeys[c].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var c=this._interpolatedKeys[a];if(c._written){var e=c.getTarget();e.localPosition.copy(c._pos);e.localRotation.copy(c._quat);e.localScale.copy(c._scale);e.dirtyLocal=!0;c._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=function(){return this.looping};
return{Skeleton:a}}());pc.extend(pc.resources,function(){var d;d=pc.inherits(function(){},pc.resources.ResourceHandler);d.prototype.load=function(a,c){return new RSVP.Promise(function(e,d){var f=a.canonical;pc.path.getDirectory(f);pc.net.http.get(f,function(a){try{e(a)}catch(b){d(pc.string.format("An error occured while loading animation from: '{0}'",f))}}.bind(this),{cache:c.cache,error:function(a){d(a)}})})};d.prototype.open=function(a){return this["_loadAnimationV"+a.animation.version](a)};d.prototype._loadAnimationV3=
function(a){var a=a.animation,c=new pc.anim.Animation;c.setName(a.name);c.setDuration(a.duration);for(var e=0;e<a.nodes.length;e++){var d=new pc.anim.Node,f=a.nodes[e];d._name=f.name;for(var k=0;k<f.keys.length;k++){var l=f.keys[k],n=l.time,r=l.pos,m=l.rot,l=l.scale,r=new pc.Vec3(r[0],r[1],r[2]),m=(new pc.Quat).setFromEulerAngles(m[0],m[1],m[2]),l=new pc.Vec3(l[0],l[1],l[2]),n=new pc.anim.Key(n,r,m,l);d._keys.push(n)}c.addNode(d)}return c};d.prototype._loadAnimationV4=function(a){var a=a.animation,
c=new pc.anim.Animation;c.setName(a.name);c.setDuration(a.duration);for(var e=0;e<a.nodes.length;e++){var d=new pc.anim.Node,f=a.nodes[e];d._name=f.name;for(var k=f.defaults.p,l=f.defaults.r,n=f.defaults.s,r=0;r<f.keys.length;r++){var m=f.keys[r],s=m.t,h=k?k:m.p,u=l?l:m.r,m=n?n:m.s,h=new pc.Vec3(h[0],h[1],h[2]),u=(new pc.Quat).setFromEulerAngles(u[0],u[1],u[2]),m=new pc.Vec3(m[0],m[1],m[2]),s=new pc.anim.Key(s,h,u,m);d._keys.push(s)}c.addNode(d)}return c};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);
a.prototype.type="animation";a.prototype.Type=pc.anim.Animation;return{AnimationResourceHandler:d,AnimationRequest:a}}());pc.audio=function(){var d=function(){pc.audio.hasAudioContext()&&("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext));this.listener=new pc.audio.Listener(this);this.volume=1;this.suspended=!1;pc.events.attach(this)};d.prototype={createSound:function(a,b,c){var e=null;pc.audio.Sound?e=new pc.audio.Sound(this,a,b,c):c();return e},playSound:function(a,b){var b=b||{},c=null;pc.audio.Channel&&(c=new pc.audio.Channel(this,
a,b),c.play());return c},playSound3d:function(a,b,c){var c=c||{},e=null;pc.audio.Channel3d&&(e=new pc.audio.Channel3d(this,a,c),e.setPosition(b),c.volume&&e.setVolume(c.volume),c.loop&&e.setLoop(c.loop),c.maxDistance&&e.setMaxDistance(c.maxDistance),c.minDistance&&e.setMinDistance(c.minDistance),c.rollOffFactor&&e.setRollOffFactor(c.rollOffFactor),e.play());return e},getListener:function(){return this.listener},getVolume:function(){return this.volume},setVolume:function(a){this.volume=a;this.fire("volumechange",
a)},suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")}};return{AudioManager:d,hasAudio:function(){return"undefined"!==typeof Audio},hasAudioContext:function(){return!!("undefined"!==typeof AudioContext||"undefined"!==typeof webkitAudioContext)},isSupported:function(a,b){var c={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav"},e=pc.path.getExtension(a);return c[e]?(b||(b=new Audio),""!==b.canPlayType(c[e])):!1}}}();pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?d=function(a,b,c,e){this.buffer=null;this.isLoaded=!1;pc.audio.isSupported(b,this.audio)?a.context&&pc.net.http.get(b,function(b){a.context.decodeAudioData(b,function(a){this.buffer=a;this.isLoaded=!0;c(this)}.bind(this),e)}.bind(this),{error:e}):setTimeout(function(){e(pc.string.format("Audio format for {0} not supported",b))},0)}:pc.audio.hasAudio()&&(d=function(a,b,c,e){this.isLoaded=!1;this.audio=new Audio;pc.audio.isSupported(b,this.audio)?
(this.audio.addEventListener("stalled",function(){logDEBUG("stalled: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("suspend",function(){logDEBUG("suspend: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("abort",function(){logDEBUG("abort: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("pause",function(){logDEBUG("pause: "+this.audio.src)}.bind(this),!1),this.audio.addEventListener("canplay",function(){logDEBUG("canplay: "+this.audio.src)}.bind(this),!1),
this.audio.addEventListener("progress",function(){logDEBUG("progress "+b)}.bind(this)),this.audio.addEventListener("loadstart",function(){logDEBUG("loadstart: "+this.audio.src);this.isLoaded||(this.isLoaded=!0,c(this))}.bind(this),!1),this.audio.addEventListener("canplaythrough",function(){logDEBUG("canplaythrough: "+this.audio.src);this.isLoaded||(this.isLoaded=!0,c(this))}.bind(this),!1),this.audio.addEventListener("loadeddata",function(){logDEBUG("loadeddata: "+b);this.isLoaded||(this.isLoaded=
!0,c(this))}.bind(this),!1),this.audio.addEventListener("error",function(){logERROR("error loading: "+b);e(pc.string.format("Error loading Sound from: '{0}'",b))}.bind(this),!1),this.audio.src=b,logDEBUG("loading: "+b)):(setTimeout(function(){e(pc.string.format("Audio format for {0} not supported",b))},0),this.audio=null)});return{Sound:d}}());pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?(d=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;this.listener=a.context.listener},d.prototype.getPosition=function(){return this.position},d.prototype.setPosition=function(a){this.position.copy(a);this.listener.setPosition(a.x,a.y,a.z)},d.prototype.getVelocity=function(){return this.velocity},d.prototype.setVelocity=function(a){this.velocity.copy(a);this.listener.setPosition(a.x,a.y,a.z)},
d.prototype.setOrientation=function(a){this.orientation.copy(a);this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])}):(d=function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4},d.prototype.getPosition=function(){return this.position},d.prototype.setPosition=function(a){this.position.copy(a)},d.prototype.getVelocity=function(){return this.velocity},d.prototype.setVelocity=function(a){this.velocity.copy(a)},d.prototype.setOrientation=
function(a){this.orientation.copy(a)});d.prototype.getOrientation=function(){return this.orientation};return{Listener:d}}());pc.extend(pc.audio,function(){var d;pc.audio.hasAudioContext()?(d=function(a,b,c){c=c||{};this.volume="undefined"===typeof c.volume?1:c.volume;this.loop="undefined"===typeof c.loop?!1:c.loop;this.pitch="undefined"===typeof c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},d.prototype={play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();this.setVolume(this.volume);
this.setLoop(this.loop);this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){if(this.source||
!this.paused)throw Error("Call pause() before unpausing.");this._createSource();this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.paused=!1},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",
this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a;this.gain&&(this.gain.gain.value=a*this.manager.getVolume())},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var a=this.manager.context;this.source=
a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.gain);this.gain.connect(a.destination)}}):pc.audio.hasAudio()?(d=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch="undefined"!==typeof c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;this.source=b.audio.cloneNode(!1);this.source.pause()},d.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),
this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&(this.source.pause(),this.source.currentTime=0);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,
this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=a;this.source&&(this.source.volume=a*this.manager.getVolume())},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=a)},getDuration:function(){if(this.source){var a=this.source.duration;if(a===a)return a}return 0},isPlaying:function(){return!this.source.paused}}):(console.warn("No support for 2D audio found"),d=function(){});
pc.extend(d.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:d}}());pc.extend(pc.audio,function(){var d;if(pc.audio.hasAudioContext())d=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()},d=pc.inherits(d,pc.audio.Channel),d.prototype=pc.extend(d.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},
setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination)}});
else if(pc.audio.hasAudio()){var a=new pc.Vec3,b;d=pc.inherits(function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1},pc.audio.Channel);d.prototype=pc.extend(d.prototype,{getPosition:function(){return this.position},setPosition:function(c){this.position.copy(c);if(this.source){var e=this.manager.getListener().getPosition();var c=this.minDistance,d=this.maxDistance,f=this.rollOffFactor;a=a.sub2(e,this.position);b=a.length();b<c?c=
1:b>d?c=0:(e=c+f*(b-c),c=0!==e?c/e:1);e=this.getVolume();this.source.volume=e*c}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rolloffFactor},setRollOffFactor:function(a){this.rolloffFactor=a}})}else console.warn("No support for 3D audio found"),
d=function(){};return{Channel3d:d}}());pc.extend(pc.resources,function(){var d=function(a){this.manager=a},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a){var c=this;return new RSVP.Promise(function(e){var d=c.manager.createSound(a.canonical,function(a){e(a)},function(a){logERROR(a);e(d)})})};d.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="audio";a.prototype.Type=pc.audio.Sound;return{AudioResourceHandler:d,AudioRequest:a}}());pc.input={};pc.extend(pc.input,function(){var d=function(a,b){var c={x:0,y:0};if(b){if(b instanceof d)throw Error("Expected MouseEvent");c=pc.input.getTargetCoords(b)}else b={};this.x=c.x;this.y=c.y;this.wheel=b.detail?-1*b.detail:b.wheelDelta?b.wheelDelta/120:0;pc.input.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?
b.button:pc.input.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._contextMenuHandler=
function(a){a.preventDefault()};this._element=null;a&&this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!!document.pointerLockElement};a.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("mouseup",this._upHandler,!1);this._element.addEventListener("mousedown",this._downHandler,!1);this._element.addEventListener("mousemove",this._moveHandler,!1);this._element.addEventListener("mousewheel",this._wheelHandler,!1);this._element.addEventListener("DOMMouseScroll",
this._wheelHandler,!1)},detach:function(){this._element.removeEventListener("mouseup",this._upHandler);this._element.removeEventListener("mousedown",this._downHandler);this._element.removeEventListener("mousemove",this._moveHandler);this._element.removeEventListener("mousewheel",this._wheelHandler);this._element.removeEventListener("DOMMouseScroll",this._wheelHandler);this._element=null},disableContextMenu:function(){this._element.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._element.removeEventListener("contextmenu",
this._contextMenuHandler)},enablePointerLock:function(a,b){var c=function(){a();document.removeEventListener("pointerlockchange",c)},d=function(){b();document.removeEventListener("pointerlockerror",d)};a&&document.addEventListener("pointerlockchange",c,!1);b&&document.addEventListener("pointerlockerror",d,!1);this._element.requestPointerLock()},disablePointerLock:function(a){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",
b,!1);document.exitPointerLock()},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;this.fire(pc.input.EVENT_MOUSEUP,new d(this,a))},_handleDown:function(a){this._buttons[a.button]=
!0;this.fire(pc.input.EVENT_MOUSEDOWN,new d(this,a))},_handleMove:function(a){a=new d(this,a);this.fire(pc.input.EVENT_MOUSEMOVE,a);this._lastX=a.x;this._lastY=a.y},_handleWheel:function(a){this.fire(pc.input.EVENT_MOUSEWHEEL,new d(this,a))}};if(!("undefined"===typeof navigator||"undefined"===typeof document)){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);
document.dispatchEvent(a)},c=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",b,!1);document.addEventListener("webkitpointerlocklost",b,!1);document.addEventListener("mozpointerlockchange",b,!1);document.addEventListener("mozpointerlocklost",b,!1);document.addEventListener("webkitpointerlockerror",c,!1);document.addEventListener("mozpointerlockerror",c,!1);document.pointerLockElement||
Object.defineProperty(document,"pointerLockElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitPointerLockElement||document.mozPointerLockElement}});Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=
function(){document.pointerLockElement=this;navigator.pointer.lock(this,b,c)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}return{Mouse:a,MouseEvent:d,EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,
MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,getTargetCoords:function(a){for(var b={x:0,y:0},c=a.currentTarget,d=0,l=0;c.offsetParent;)d+=c.offsetLeft,l+=c.offsetTop,c=c.offsetParent;b.x=a.pageX-d;b.y=a.pageY-l;return b}}}());pc.extend(pc.input,function(){function d(a){return"string"==typeof a?a.toUpperCase().charCodeAt(0):a}var a=function(a,b){this.key=b.keyCode;this.element=b.target;this.event=b},b={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},c=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);
pc.events.attach(this);this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};c.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};c.prototype.detach=function(){this._element.removeEventListener("keydown",
this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};c.prototype.toKeyIdentifier=function(a){var a=d(a),c,f;if(c=b[a.toString()])return c;c=a.toString(16).toUpperCase();f=c.length;for(a=0;a<4-f;a++)c="0"+c;return"U+"+c};c.prototype._handleKeyDown=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);this._keymap[c]=!0;this.fire("keydown",new a(this,b));
this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyUp=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);delete this._keymap[c];this.fire("keyup",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyPress=function(b){var c=b.keyCode||b.charCode;b.keyIdentifier||this.toKeyIdentifier(c);this.fire("keypress",new a(this,b));this.preventDefault&&b.preventDefault();
this.stopPropagation&&b.stopPropagation()};c.prototype.update=function(){var a;this._lastmap={};for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};c.prototype.isPressed=function(a){a=d(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};c.prototype.wasPressed=function(a){a=d(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};c.prototype.wasReleased=function(a){a=d(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};
return{Keyboard:c,EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:14,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,
KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,
KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224}}());pc.extend(pc.input,function(){var d=function(){this.gamepadsSupported=!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=0.25},a={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},b={"Product: 0268":"PS3"};d.prototype={update:function(){var a=this.poll(),b,d=a.length;for(b=0;b<d;b++)this.previous[b]=this.current[b],this.current[b]=a[b]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.webkitGetGamepads(),d,f=b.length;for(d=0;d<f;d++)b[d]&&a.push({map:this.getMap(b[d]),pad:b[d]})}return a},getMap:function(c){for(var e in b)if(0<=c.id.indexOf(e))return a[b[e]];return a.DEFAULT},isPressed:function(a,
b){return!this.current[a]?!1:this.current[a].pad.buttons[pc.input[this.current[a].map.buttons[b]]]},wasPressed:function(a,b){if(!this.current[a])return!1;var d=pc.input[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[d]&&!this.previous[a].pad.buttons[d]},getAxis:function(a,b){if(!this.current[a])return!1;var d=this.current[a].pad.axes[pc.input[this.current[a].map.axes[b]]];Math.abs(d)<this.deadZone&&(d=0);return d}};return{PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,
PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,GamePads:d}}());pc.extend(pc.input,function(){var d=function(b,e){this.element=e.target;this.event=e;this.touches=[];this.changedTouches=[];if(e){var d,f=e.touches.length;for(d=0;d<f;d++)this.touches.push(new a(e.touches[d]));f=e.changedTouches.length;for(d=0;d<f;d++)this.changedTouches.push(new a(e.changedTouches[d]))}};d.prototype={getTouchById:function(a,b){var d,f=b.length;for(d=0;d<f;d++)if(b[d].id===a)return b[d];return null}};var a=function(a){var b=pc.input.getTouchTargetCoords(a);this.id=a.identifier;this.x=
b.x;this.y=b.y;this.target=a.target;this.touch=a},b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,
!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",
new d(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new d(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new d(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new d(this,a))}};return{EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",getTouchTargetCoords:function(a){for(var b=0,d=0,f=a.target;!(f instanceof HTMLElement);)f=f.parentNode;do b+=f.offsetLeft-f.scrollLeft,d+=
f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-b,y:a.pageY-d}},TouchDevice:b}}());pc.extend(pc.input,function(){var d=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};d.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};d.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};d.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};d.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};d.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};d.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error(pc.string.format("Action: {0} already registered",
a));if("undefined"===typeof b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.input.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.input.ACTION_KEYBOARD,keys:b}]};d.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if("undefined"===typeof b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.input.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.input.ACTION_MOUSE,button:-b}]};d.prototype.registerPadButton=
function(a,b,c){if("undefined"===typeof c)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.input.ACTION_GAMEPAD,button:c,pad:b}):this._actions[a]=[{type:pc.input.ACTION_GAMEPAD,button:c,pad:b}]};d.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b),a=a||{};a.pad=a.pad||pc.input.PAD_1;var e=function(e,d,k,l){switch(d){case "mousex":e._mouse.on(pc.input.EVENT_MOUSEMOVE,function(a){e._axesValues[b][c]=a.dx/10});break;
case "mousey":e._mouse.on(pc.input.EVENT_MOUSEMOVE,function(a){e._axesValues[b][c]=a.dy/10});break;case "key":e._axes[b].push(function(){return e._keyboard.isPressed(l)?k:0});break;case "padrx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_R_STICK_X)});break;case "padry":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_R_STICK_Y)});break;case "padlx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.input.PAD_L_STICK_X)});break;case "padly":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,
pc.input.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");}};e(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&e(this,a.negative,-1,a.negativeKey)};d.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var b,c=0,e=this._actions[a].length,c=0;c<e;++c)switch(b=this._actions[a][c],b.type){case pc.input.ACTION_KEYBOARD:if(this._keyboard){var d,f=b.keys.length;for(d=0;d<f;d++)if(this._keyboard.isPressed(b.keys[d]))return!0}break;case pc.input.ACTION_MOUSE:if(this._mouse&&
this._mouse.isPressed(b.button))return!0;break;case pc.input.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.isPressed(b.pad,b.button))return!0}return!1};d.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var b=0,c=this._actions[a].length,b=0;b<c;++b){var e=this._actions[a][b];switch(e.type){case pc.input.ACTION_KEYBOARD:if(this._keyboard){var d,f=e.keys.length;for(d=0;d<f;d++)if(this._keyboard.wasPressed(e.keys[d]))return!0}break;case pc.input.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(e.button))return!0;
break;case pc.input.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(e.pad,e.button))return!0}}return!1};d.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,e=this._axes[a].length;for(c=0;c<e;c++)if("function"===pc.type(this._axes[a][c])){var d=this._axes[a][c]();Math.abs(d)>Math.abs(b)&&(b=d)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};d.prototype._enableMouse=function(){this._mouse=new pc.input.Mouse;if(!this._element)throw Error("Controller must be attached to a DOMElement");
this._mouse.attach(this._element)};d.prototype._enableKeyboard=function(){this._keyboard=new pc.input.Keyboard;if(!this._element)throw Error("Controller must be attached to a DOMElement");this._keyboard.attach(this._element)};return{ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",Controller:d}}());pc.net=function(){return{}}();pc.extend(pc.net,function(){var d=function(){};d.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",BIN:"application/octet-stream"};d.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"};d.binaryExtensions=[".model",".wav",".ogg",".mp3"];d.prototype={ContentType:d.ContentType,ResponseType:d.ResponseType,
binaryExtensions:d.binaryExtensions,get:function(a,b,c,e){c=c||{};c.success=b;return this.request("GET",a,c,e)},post:function(a,b,c,e,d){e=e||{};e.success=b;e.postdata=c;return this.request("POST",a,e,d)},put:function(a,b,c,e,d){e=e||{};e.success=b;e.postdata=c;return this.request("PUT",a,e,d)},del:function(a,b,c,e){c=c||{};c.success=b;return this.request("DELETE",a,c,e)},request:function(a,b,c,e){var g,f,k,l=!1,c=c||{};null==c.success&&(c.success=function(){});null==c.error&&(c.error=function(){});
null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)k=c.postdata;else if(c.postdata instanceof FormData)k=c.postdata;else if(c.postdata instanceof Object)switch(k=c.headers["Content-Type"],pc.isDefined(k)||(c.headers["Content-Type"]=d.ContentType.FORM_URLENCODED,k=c.headers["Content-Type"]),k){case d.ContentType.FORM_URLENCODED:k="";f=!0;for(g in c.postdata)c.postdata.hasOwnProperty(g)&&(f?f=!1:k+="&",k+=escape(g)+"="+escape(c.postdata[g]));
break;default:null==k&&(c.headers["Content-Type"]=d.ContentType.JSON),k=JSON.stringify(c.postdata)}else k=c.postdata;e||(e=new XMLHttpRequest);!1===c.cache&&(f=pc.time.now(),g=new pc.URI(b),g.query=g.query?g.query+"&ts="+f:"ts="+f,b=g.toString());c.query&&(g=new pc.URI(b),f=pc.extend(g.getQuery(),c.query),g.setQuery(f),b=g.toString());e.open(a,b,c.async);e.withCredentials=!0;e.responseType=c.responseType||this.guessResponseType(b);for(var n in c.headers)c.headers.hasOwnProperty(n)&&e.setRequestHeader(n,
c.headers[n]);e.onreadystatechange=function(){this.onReadyStateChange(a,b,c,e)}.bind(this);e.onerror=function(){this.onError(a,b,c,e);l=!0}.bind(this);try{e.send(k)}catch(r){l||c.error(e.status,e,r)}return e},guessResponseType:function(a){a=new pc.URI(a);a=pc.path.getExtension(a.path);return 0<=d.binaryExtensions.indexOf(a)?d.ResponseType.ARRAY_BUFFER:d.ResponseType.TEXT},isBinaryContentType:function(a){return 0<=[d.ContentType.WAV,d.ContentType.OGG,d.ContentType.MP3,d.ContentType.BIN].indexOf(a)?
!0:!1},onReadyStateChange:function(a,b,c,e){if(4===e.readyState)switch(e.status){case 0:break;case 200:case 201:case 206:case 304:this.onSuccess(a,b,c,e);break;default:this.onError(a,b,c,e)}},onSuccess:function(a,b,c,e){var g;if(a=e.getResponseHeader("Content-Type"))a=a.split(";"),g=a[0].trim(),a[1]&&a[1].trim();g===this.ContentType.JSON||pc.string.endsWith(b,".json")?b=JSON.parse(e.responseText):this.isBinaryContentType(g)?b=e.response:e.responseType===d.ResponseType.ARRAY_BUFFER?(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",
d.ResponseType.ARRAY_BUFFER,g)),b=e.response):b=e.responseType===d.ResponseType.DOCUMENT||g===this.ContentType.XML?e.responseXML:e.responseText;c.success(b,e.status,e)},onError:function(a,b,c,e){c.error(e.status,e,null)}};d.prototype.delete_=d.prototype.del;return{Http:d,http:new d}}());pc.extend(pc.net,function(){var d=0,a=function(a,c,e,d,f){this.clientId=d;this.endpoint=a;this.redirectUrl=c;this.origin=e;this.scope=f;this.responseType="token";this.accessToken=null;this.OAUTH_IFRAME_ID_BASE="pc-oauth-access-token-"},a=pc.inherits(a,pc.net.Http);a.prototype.refreshAccessToken=function(a){var c=this.OAUTH_IFRAME_ID_BASE+d++,e=function(d){if(d.origin===this.origin){if(d.data.access_token){var g=document.getElementById(c);g&&g.parentNode.removeChild(g);this.accessToken=d.data.access_token;
a(d.data.access_token)}else d.data.error?logERROR(d.data.error):logWARNING("Invalid message posted to Corazon API");window.removeEventListener("message",e)}}.bind(this);window.addEventListener("message",e,!1);var g={client_id:this.clientId,redirect_url:this.redirectUrl,scope:this.scope,response_type:this.responseType},f=new pc.URI(this.endpoint);f.setQuery(g);if(g=document.getElementById(c))throw Error("accessToken request already in progress");g=document.createElement("iframe");g.src=f.toString();
g.id=c;g.style.display="none";document.body.appendChild(g)};a.prototype.request=function(a,c,e,d){e.query=e.query||{};e.query=pc.extend(e.query,{access_token:this.accessToken});return pc.net.OAuth._super.request.call(this,a,c,e,d)};a.prototype.onError=function(a,c,e,d){401==d.status?this.refreshAccessToken(function(f){e.query.access_token=f;this.request(a,c,e,d)}.bind(this)):e.error(d.status,d,null)};return{OAuth:a,oauth:new a}}());pc.extend(pc.net,function(){var d=function(a){this._ws=new WebSocket(a);this._ws.onopen=this._handleOpen.bind(this);this._ws.onerror=this._handleError.bind(this);this._ws.onmessage=this._handleMessage.bind(this);this._ws.onclose=this._handleClose.bind(this)};d.prototype={onopen:null,onerror:null,onmessage:null,get binaryType(){return this._ws.binaryType},set binaryType(a){this._ws.binaryType=a},get readyState(){return this._ws.readyState},get bufferedAmount(){return this._ws.bufferedAmount},get extensions(){return this._ws.extensions},
get protocol(){return this._ws.protocol},_handleOpen:function(){if(this.onopen)this.onopen()},_handleError:function(a){if(this.onerror)this.onerror(a)},_handleMessage:function(a){if(this.onmessage)this.onmessage(a)},_handleClose:function(){if(this.onclose)this.onclose()},send:function(a){this._ws.send(a)}};return{Socket:d}}());pc.script=function(){var d=null,a=null,b={main:function(a){if(d)throw Error("'main' Object already registered");d=a},setLoader:function(b){if(b&&a)throw Error("pc.script already has loader object.");a=b},create:function(a,b){"undefined"===typeof b&&(b=attributes);this.fire("created",a,b)},attribute:function(){},start:function(){d()}};pc.events.attach(b);return b}();pc.extend(pc.resources,function(){var d=function(a,c){this._context=a;this._prefix=c||"";this._queue=[];this._pending=[];this._loaded={};this._loading=null;pc.script.on("created",this._onScriptCreated,this)},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a,c){c=c||{};c.timeout=c.timeout||6E4;c.cache=!0;return new RSVP.Promise(function(e,d){var f=a.canonical;c.cache||(f=this._appendTimestampToUrl(f));var k=new pc.URI(f);k.path=pc.path.join(this._prefix,k.path);k=k.toString();
this._loaded[k]?!0!==this._loaded[k]?e(this._loaded[k]):e(null):this._loading?this._queue.push({url:k.toString(),success:e,error:d}):this._addScriptTag(k.toString(),e,d);c.timeout&&setTimeout(function(){this._loaded[k]||d(pc.string.format("Loading script {0} timed out after {1}s",k,c.timeout/1E3))}.bind(this),c.timeout)}.bind(this))};d.prototype.open=function(a){return a};d.prototype._appendTimestampToUrl=function(a){timestamp=pc.time.now();uri=new pc.URI(a);uri.query=uri.query?uri.query+"&ts="+timestamp:
"ts="+timestamp;return a=uri.toString()};d.prototype._onScriptCreated=function(a,c){this._pending.push({name:a,callback:c})};d.prototype._addScriptTag=function(a,c,e){var d=this,f=document.getElementsByTagName("head")[0],k=document.createElement("script");this._loading=k;k.addEventListener("error",function(a){e(pc.string.format("Error loading script from '{0}'",a.target.src))});var l=!1;k.onload=k.onreadystatechange=function(){if(!l&&(!this.readyState||"loaded"==this.readyState||"complete"==this.readyState)){l=
!0;var e=d._pending.shift();if(e){var f=e.callback(d._context);if(f._pcScriptName)throw Error("Attribute _pcScriptName is reserved on ScriptTypes for ResourceLoader use");f._pcScriptName=e.name;d._loaded[a]=f;c(f)}else d._loaded[a]=!0,c(null);d._loading=null;d._queue.length&&(e=d._queue.shift(),d._addScriptTag(e.url,e.success,e.error))}};k.src=a;f.appendChild(k)};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="script";return{ScriptResourceHandler:d,ScriptRequest:a}}());pc.fw={};var editor=editor||{};pc.extend(editor,function(){var d=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};d.prototype={addComponentType:function(){},expose:function(){},add:function(){},scriptexpose:function(){}};return{LinkInterface:d,link:new d}}());pc.extend(editor,function(){var d=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};d.prototype.addComponentType=function(a){var b=a.id,c,e=this.systems,d=e.length,f=!1;for(c=0;c<d;c++)if(e[c].name===b){f=!0;break}f||this.systems.push({name:b,description:a.description});this.exposed[b]||(this.exposed[b]={})};d.prototype.expose=function(a,b){if(!b.name)throw Error("Missing option 'name'");b.options=b.options||{};"vector"===b.type&&(b.array=!0,b.RuntimeType=pc.Vec3);if("rgb"===
b.type||"rgba"===b.type)b.array=!0,b.RuntimeType=pc.Color;this.exposed[a][b.name]||(this.exposed[a][b.name]={});this.exposed[a][b.name]=b};d.prototype.add=function(a){logASSERT(a.system,"Missing option: 'system'");logASSERT(a.variable,"Missing option: 'variable'");this.added[a.system]||(this.added[a.system]={});this.added[a.system][a.variable]||(this.added[a.system][a.variable]={});this.added[a.system][a.variable]=a};d.prototype.scriptexpose=function(a){this.scripts[a.script]=a};return{LinkInterface:d,
link:new d}}());pc.extend(pc.fw,function(){return{ContentFile:function(d){this.packs=d.packs||{};this.appProperties=d.application_properties||{};this.toc=d.toc||{}}}}());pc.extend(pc.fw,function(){var d=function(a){this.hierarchy=a.hierarchy;this.settings=a.settings};d.prototype={};return{Pack:d}}());pc.extend(pc.fw,function(){return{ApplicationContext:function(d,a,b,c,e){this.loader=d;this.scene=a;this.graphicsDevice=b;this.root=new pc.fw.Entity;d=e.depot?e.depot.assets.getServer().getBaseUrl():null;this.assets=new pc.asset.AssetRegistry(this.loader,d);this.systems=c;e=e||{};this.controller=e.controller;this.keyboard=e.keyboard;this.mouse=e.mouse;this.touch=e.touch;this.gamepads=e.gamepads}}}());pc.extend(pc.fw,function(){var d,a=function(b,c){this._inTools=!1;pc.events.attach(this);this.content=c.content;this.canvas=b;this.fillMode=pc.fw.FillMode.KEEP_ASPECT;this.resolutionMode=pc.fw.ResolutionMode.FIXED;this.librariesLoaded=!1;this._link=new pc.fw.LiveLink("application");this._link.addDestinationWindow(window);this._link.listen(this._handleMessage.bind(this));pc.log.open();this.graphicsDevice=new pc.gfx.Device(b);this.graphicsDevice.enableValidation(!1);var e=new pc.fw.ComponentSystemRegistry;
this.audioManager=new pc.audio.AudioManager;var d=new pc.resources.ResourceLoader;!1===c.cache&&(d.cache=!1);c.displayLoader&&new pc.resources.ResourceLoaderDisplay(document.body,d);this.context=new pc.fw.ApplicationContext(d,new pc.scene.Scene,this.graphicsDevice,e,c);new pc.resources.TextureCache(d);d.registerHandler(pc.resources.JsonRequest,new pc.resources.JsonResourceHandler);d.registerHandler(pc.resources.ImageRequest,new pc.resources.ImageResourceHandler);d.registerHandler(pc.resources.TextureRequest,
new pc.resources.TextureResourceHandler(this.graphicsDevice));d.registerHandler(pc.resources.ModelRequest,new pc.resources.ModelResourceHandler(this.graphicsDevice,this.context.assets));d.registerHandler(pc.resources.AnimationRequest,new pc.resources.AnimationResourceHandler);d.registerHandler(pc.resources.PackRequest,new pc.resources.PackResourceHandler(e,c.depot));d.registerHandler(pc.resources.AudioRequest,new pc.resources.AudioResourceHandler(this.audioManager));this.renderer=new pc.scene.ForwardRenderer(this.graphicsDevice);
d.registerHandler(pc.resources.ScriptRequest,new pc.resources.ScriptResourceHandler(this.context,c.scriptPrefix));new pc.fw.RigidBodyComponentSystem(this.context);new pc.fw.CollisionComponentSystem(this.context);new pc.fw.BallSocketJointComponentSystem(this.context);new pc.fw.AnimationComponentSystem(this.context);new pc.fw.ModelComponentSystem(this.context);new pc.fw.CameraComponentSystem(this.context);new pc.fw.CubeMapComponentSystem(this.context);new pc.fw.StaticCubeMapComponentSystem(this.context);
new pc.fw.LightComponentSystem(this.context);new pc.fw.PackComponentSystem(this.context);new pc.fw.SkyboxComponentSystem(this.context);new pc.fw.ScriptComponentSystem(this.context);new pc.fw.PickComponentSystem(this.context);new pc.fw.AudioSourceComponentSystem(this.context,this.audioManager);new pc.fw.AudioListenerComponentSystem(this.context,this.audioManager);new pc.fw.DesignerComponentSystem(this.context);this.on("librariesloaded",this.onLibrariesLoaded,this);c.libraries&&c.libraries.length?(e=
c.libraries.map(function(a){return new pc.resources.ScriptRequest(a)}),d.request(e).then(function(){this.fire("librariesloaded",this);this.librariesLoaded=!0}.bind(this))):(this.fire("librariesloaded",this),this.librariesLoaded=!0);"undefined"!==typeof document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this),!1)):"undefined"!==typeof document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this.onVisibilityChange.bind(this),
!1)):"undefined"!==typeof document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this.onVisibilityChange.bind(this),!1)):"undefined"!==typeof document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this.onVisibilityChange.bind(this),!1));a._applications[this.canvas.id]=this};a._applications={};a.getApplication=function(b){return a._applications[b]};a.prototype={loadFromToc:function(a,c,e,d){this.content||e("No content");
var f=this.content.toc[a],c=c||function(){},e=e||function(){},d=d||function(){};this.context.assets.update(f);var k=function(){guid=f.packs[0];this.context.loader.request(new pc.resources.PackRequest(guid)).then(function(a){a=a[0];this.context.root.addChild(a.hierarchy);pc.fw.ComponentSystem.initialize(a.hierarchy);pc.fw.ComponentSystem.postInitialize(a.hierarchy);if(this.context.systems.rigidbody&&"undefined"!==typeof Ammo){var b=a.settings.physics.gravity;this.context.systems.rigidbody.setGravity(b[0],
b[1],b[2])}b=a.settings.render.global_ambient;this.context.scene.ambientLight=new pc.Color(b[0],b[1],b[2]);this.context.scene.fog=a.settings.render.fog;b=a.settings.render.fog_color;this.context.scene.fogColor=new pc.Color(b[0],b[1],b[2]);this.context.scene.fogStart=a.settings.render.fog_start;this.context.scene.fogEnd=a.settings.render.fog_end;this.context.scene.fogDensity=a.settings.render.fog_density;c(a);this.context.loader.off("progress",d)}.bind(this),function(a){e(a)}).then(null,function(a){setTimeout(function(){throw a;
},0)})}.bind(this),l=function(){var a=this.context.assets.all();this.context.loader.on("progress",d);a.length?this.context.assets.load(a).then(function(a){k(a)}):setTimeout(function(){k([])},0)}.bind(this);if(this.librariesLoaded)l();else this.on("librariesloaded",function(){l()})},start:function(){if(this.librariesLoaded)this.tick();else this.on("librariesloaded",function(){this.tick()},this)},update:function(a){var c=this.context;pc.fw.ComponentSystem.fixedUpdate(1/60,c,this._inTools);pc.fw.ComponentSystem.update(a,
c,this._inTools);pc.fw.ComponentSystem.postUpdate(a,c,this._inTools);this.fire("update",a);c.controller&&c.controller.update(a);c.mouse&&c.mouse.update(a);c.keyboard&&c.keyboard.update(a);c.gamepads&&c.gamepads.update(a)},render:function(){var a=this.context;a.root.syncHierarchy();var c=a.systems.camera.current;c&&(a.systems.camera.frameBegin(),this.renderer.render(a.scene,c.camera.camera),a.systems.camera.frameEnd())},tick:function(){requestAnimationFrame(this.tick.bind(this),this.canvas);var a=
window.performance&&window.performance.now?performance.now():Date.now(),c=(a-(d||a))/1E3;d=a;c=pc.math.clamp(c,0,0.1);this.update(c);this.render()},setCanvasFillMode:function(a,c,e){this.fillMode=a;this.resizeCanvas(c,e)},setCanvasResolution:function(a,c,e){this.resolutionMode=a;a===pc.fw.ResolutionMode.AUTO&&(c=this.canvas.clientWidth,e=this.canvas.clientHeight);this.canvas.width=c;this.canvas.height=e},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(a,c,e){var a=
a||this.canvas,d=function(){c();document.removeEventListener("fullscreenchange",d)},f=function(){e();document.removeEventListener("fullscreenerror",f)};c&&document.addEventListener("fullscreenchange",d,!1);e&&document.addEventListener("fullscreenerror",f,!1);a.requestFullscreen()},disableFullscreen:function(a){var c=function(){a();document.removeEventListener("fullscreenchange",c)};a&&document.addEventListener("fullscreenchange",c,!1);document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},
onVisibilityChange:function(){this.isHidden()?this.audioManager.suspend():this.audioManager.resume()},resizeCanvas:function(a,c){var e=window.innerWidth,d=window.innerHeight;if(navigator.isCocoonJS)a=e,c=d,e=window.devicePixelRatio,this.canvas.width=a*e,this.canvas.height=c*e;else{if(this.fillMode===pc.fw.FillMode.KEEP_ASPECT){var f=this.canvas.width/this.canvas.height;f>e/d?(a=e,c=a/f):(c=d,a=c*f)}else this.fillMode===pc.fw.FillMode.FILL_WINDOW&&(a=e,c=d);this.canvas.style.width=a+"px";this.canvas.style.height=
c+"px";this.resolutionMode===pc.fw.ResolutionMode.AUTO&&this.setCanvasResolution(pc.fw.ResolutionMode.AUTO)}return{width:a,height:c}},onLibrariesLoaded:function(){this.context.systems.rigidbody.onLibraryLoaded();this.context.systems.collision.onLibraryLoaded()},_handleMessage:function(a){var c;switch(a.type){case pc.fw.LiveLinkMessageType.UPDATE_COMPONENT:this._linkUpdateComponent(a.content.id,a.content.component,a.content.attribute,a.content.value);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY:this._linkUpdateEntity(a.content.id,
a.content.components);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM:this._linkUpdateEntityTransform(a.content.id,a.content.position,a.content.rotation,a.content.scale);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_NAME:c=this.context.root.findOne("getGuid",a.content.id);c.setName(a.content.name);break;case pc.fw.LiveLinkMessageType.UPDATE_ENTITY_ENABLED:c=this.context.root.findOne("getGuid",a.content.id);c.enabled=a.content.enabled;break;case pc.fw.LiveLinkMessageType.REPARENT_ENTITY:this._linkReparentEntity(a.content.id,
a.content.newParentId,a.content.index);break;case pc.fw.LiveLinkMessageType.CLOSE_ENTITY:if(c=this.context.root.findOne("getGuid",a.content.id))logDEBUG(pc.string.format("RT: Removed '{0}' from parent {1}",a.content.id,c.getParent().getGuid())),c.destroy();break;case pc.fw.LiveLinkMessageType.OPEN_PACK:c=this.context.loader.open(pc.resources.PackRequest,a.content.pack);c=c.hierarchy;c.__parent?(a=this.context.root.findByGuid(c.__parent),a.addChild(c)):this.context.root.addChild(c);break;case pc.fw.LiveLinkMessageType.OPEN_ENTITY:a.content.entity&&
(c={application_data:{},hierarchy:a.content.entity},c=this.context.loader.open(pc.resources.PackRequest,c),c=c.hierarchy,c.__parent?(a=this.context.root.findByGuid(c.__parent),a.addChild(c)):this.context.root.addChild(c));break;case pc.fw.LiveLinkMessageType.UPDATE_ASSET:this._linkUpdateAsset(a.content.id,a.content.attribute,a.content.value);break;case pc.fw.LiveLinkMessageType.UPDATE_PACK_SETTINGS:this._linkUpdatePackSettings(a.content.settings)}},_linkUpdateComponent:function(a,c,e,d){var a=this.context.root.findOne("getGuid",
a),f;a&&(c?a[c]?(f=editor.link.exposed[c][e],a[c][e]=editor&&f?f.RuntimeType?f.RuntimeType===pc.Vec3?new f.RuntimeType(d[0],d[1],d[2]):f.RuntimeType===pc.Color?3===d.length?new f.RuntimeType(d[0],d[1],d[2]):new f.RuntimeType(d[0],d[1],d[2],d[3]):new f.RuntimeType(d):d:d):logWARNING(pc.string.format("No component system called '{0}' exists",c)):a[e]=d)},_linkUpdateEntityTransform:function(a,c,e,d){if(a=this.context.root.findByGuid(a))a.setLocalPosition(c[0],c[1],c[2]),a.setLocalEulerAngles(e[0],e[1],
e[2]),a.setLocalScale(d[0],d[1],d[2]),a.fire("livelink:updatetransform",c,e,d)},_linkReparentEntity:function(a,c){var e=this.context.root.findByGuid(a),d=this.context.root.findByGuid(c);e.reparent(d)},_linkUpdateEntity:function(a,c){var e,d=this.context.root.findOne("getGuid",a);if(d){var f=this.context.systems.getComponentSystemOrder(),k,l=f.length;for(k=0;k<l;k++)e=f[k],c.hasOwnProperty(e)&&this.context.systems.hasOwnProperty(e)&&(d[e]||this.context.systems[e].addComponent(d,{}));for(e in this.context.systems)"gizmo"===
e||"pick"===e||this.context.systems.hasOwnProperty(e)&&!c.hasOwnProperty(e)&&d[e]&&this.context.systems[e].removeComponent(d)}},_linkUpdateAsset:function(a,c,e){if(a=this.context.assets.getAssetByResourceId(a))a[c]=e,a.fire("change",a,c,e)},_linkUpdatePackSettings:function(a){var c=a.render.global_ambient;this.context.scene.ambientLight.set(c[0],c[1],c[2]);this.context.systems.rigidbody&&"undefined"!==typeof Ammo&&(c=a.physics.gravity,this.context.systems.rigidbody.setGravity(c[0],c[1],c[2]));this.context.scene.fog=
a.render.fog;this.context.scene.fogStart=a.render.fog_start;this.context.scene.fogEnd=a.render.fog_end;c=a.render.fog_color;this.context.scene.fogColor=new pc.Color(c[0],c[1],c[2]);this.context.scene.fogDensity=a.render.fog_density}};return{FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"},Application:a}}());pc.extend(pc.resources,function(){var d=function(a,c){this._registry=a;this._depot=c},d=pc.inherits(d,pc.resources.ResourceHandler);d.prototype.load=function(a){return new RSVP.Promise(function(c,e){var d=a.canonical;d in pc.content.packs?setTimeout(function(){c(pc.content.packs[d])},0):this._depot.packs.getOne(d,function(a){c(a)}.bind(this),function(a){e(a)})}.bind(this))};d.prototype.open=function(a,c){return this.openPack(a,c)};d.prototype.openPack=function(a,c){var e=pc.extend({},a);e.hierarchy=
this.openEntity(e.hierarchy,c);return new pc.fw.Pack(e)};d.prototype.openEntity=function(a,c){var e;e=this.openEntityHierarchy(a,c);e.syncHierarchy();return e=this.openComponentData(e,a,c)};d.prototype.openEntityHierarchy=function(a,c){var e=new pc.fw.Entity,d=a.position,f=a.rotation,k=a.scale;e.setName(a.name);e.setGuid(a.resource_id);e.setLocalPosition(d[0],d[1],d[2]);e.setLocalEulerAngles(f[0],f[1],f[2]);e.setLocalScale(k[0],k[1],k[2]);e._enabled=void 0!==a.enabled?a.enabled:!0;e._enabledInHierarchy=
e._enabled;a.labels&&a.labels.forEach(function(a){e.addLabel(a)});e.__parent=a.parent;e.__children=a.children;e.name=a.name;e.template=a.template;k=a.children.length;for(d=0;d<k;d++)f=this.openEntityHierarchy(a.children[d],c),e.addChild(f);return e};d.prototype.openComponentData=function(a,c,e){a.setRequest(e);var d=this._registry.list(),f,k=d.length;for(f=0;f<k;f++){var l=c.components[d[f].id];l&&this._registry[d[f].id].addComponent(a,l)}a.setRequest(null);d=c.children.length;k=a.getChildren();for(f=
0;f<d;f++)k[f]=this.openComponentData(k[f],c.children[f],e);return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="pack";a.prototype.Type=pc.fw.Pack;return{PackResourceHandler:d,PackRequest:a}}());pc.extend(pc.fw,function(){var d=function(){};d.prototype={add:function(a,b){if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",a));delete this[a]},list:function(){var a=Object.keys(this),b={collisionrect:0.5,collisioncircle:0.5};a.sort(function(a,e){var d=b[a]||1,f=b[e]||1;return d<f?-1:d>f?1:0});return a.map(function(a){return this[a]},
this)},getComponentSystemOrder:function(){var a,b=Object.keys(this);a=b.indexOf("collisionrect");b.splice(a,1);b.unshift("collisionrect");a=b.indexOf("collisioncircle");b.splice(a,1);b.unshift("collisioncircle");return b}};return{ComponentSystemRegistry:d}}());pc.extend(pc.fw,function(){var d=function(a){this.context=a;this.dataStore={};this.schema=[];pc.events.attach(this)};pc.extend(d,{initialize:function(a){d.fire("initialize",a)},postInitialize:function(a){d.fire("postInitialize",a)},update:function(a,b,c){c?d.fire("toolsUpdate",a):d.fire("update",a)},fixedUpdate:function(a){d.fire("fixedUpdate",a)},postUpdate:function(a){d.fire("postUpdate",a)}});d.prototype={get store(){return this.dataStore},addComponent:function(a,b){var c=new this.ComponentType(this,
a),e=new this.DataType,b=b||{};this.dataStore[a.getGuid()]={entity:a,data:e};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.dataStore[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.dataStore[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()];return this.addComponent(b,c.data)},initializeComponentData:function(a,
b,c){b=b||{};c.forEach(function(c){a[c]="undefined"!==typeof b[c]?b[c]:a.data[c]},this)},exposeProperties:function(){editor.link.addComponentType(this);this.schema.forEach(function(a){!1!==a.exposed&&editor.link.expose(this.id,a)}.bind(this))}};pc.events.attach(d);return{ComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.buildAccessors(this.system.schema);this.on("set",function(a,b,d){this.fire("set_"+a,a,b,d)});this.on("set_enabled",this.onSetEnabled,this)};d.prototype={get data(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null},buildAccessors:function(a){a.forEach(function(a){a.readOnly?Object.defineProperty(this,a.name,{get:function(){return this.data[a.name]},configurable:!0}):Object.defineProperty(this,
a.name,{get:function(){return this.data[a.name]},set:function(c){var e=this.data,d=e[a.name];e[a.name]=c;this.fire("set",a.name,d,c)},configurable:!0})}.bind(this))},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){}};return{Component:d}}());pc.extend(pc.fw,function(){return{ComponentData:function(){}}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{play:function(a,b){if(this.data.animations[a]){if(this.enabled&&this.entity.enabled){var b=b||0,c=this.data;c.prevAnim=c.currAnim;c.currAnim=a;c.model&&(c.blending=0<b,c.blending?(c.blendTime=b,c.blendTimeRemaining=b,c.fromSkel.setAnimation(c.animations[c.prevAnim]),
c.fromSkel.addTime(c.skeleton.getCurrentTime()),c.toSkel.setAnimation(c.animations[c.currAnim])):c.skeleton.setAnimation(c.animations[c.currAnim]));c.playing=!0}}else console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist",a))},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;if(a){var c=a.getGraph();b.fromSkel=new pc.anim.Skeleton(c);b.toSkel=new pc.anim.Skeleton(c);b.skeleton=new pc.anim.Skeleton(c);b.skeleton.setLooping(b.loop);
b.skeleton.setGraph(c)}b.model=a;b.animations&&(b.currAnim&&b.animations[b.currAnim])&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){var b={parent:this.entity.getRequest()},c=[],e=a.map(function(a){return this.system.context.assets.getAssetByResourceId(a)},this).map(function(b){if(b)return c.push(b.name),new pc.resources.AnimationRequest(b.getFileUrl());logERROR(pc.string.format("Trying to load animation component before assets {0} are loaded",a))});this.system.context.loader.request(e,
b).then(function(a){for(var b={},d=0;d<e.length;d++)b[c[d]]=a[d];this.animations=b}.bind(this))}},onSetAnimations:function(){var a=this.data,b=this.entity.model;b&&(b=b.model)&&this.entity.animation.setModel(b);for(var c in a.animations){a.activate&&(a.enabled&&this.entity.enabled)&&this.play(c,0);break}},onSetAssets:function(a,b,c){this.loadAnimationAssets(c)},onSetLoop:function(){this.data.skeleton&&this.data.skeleton.setLooping(this.data.loop)},onSetCurrentTime:function(a,b,c){this.data.skeleton.setCurrentTime(c);
this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){d._super.onEnable.call(this);if(this.data.activate&&!this.data.currAnim)for(var a in this.data.animations){this.play(a,0);break}}});Object.defineProperties(d.prototype,{currentTime:{get:function(){return this.data.skeleton.getCurrentTime()},set:function(a){this.data.skeleton.setCurrentTime(a);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},duration:{get:function(){return this.data.animations[this.data.currAnim].getDuration()}}});
return{AnimationComponent:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AnimationComponent;this.DataType=pc.fw.AnimationComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled animation components do not play any animations",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Asset",description:"Animation Asset",
type:"asset",options:{max:100,type:"animation"},defaultValue:[]},{name:"speed",displayName:"Speed Factor",description:"Scale the animation playback speed",type:"number",options:{min:0,step:0.1},defaultValue:1},{name:"loop",displayName:"Loop",description:"Loop the animation back to the start on completion",type:"boolean",defaultValue:!0},{name:"activate",displayName:"Activate",description:"Play the configured animation on load",type:"boolean",defaultValue:!0},{name:"animations",exposed:!1},{name:"skeleton",
exposed:!1,readOnly:!0},{name:"model",exposed:!1,readOnly:!0},{name:"prevAnim",exposed:!1,readOnly:!0},{name:"currAnim",exposed:!1,readOnly:!0},{name:"fromSkel",exposed:!1,readOnly:!0},{name:"toSkel",exposed:!1,readOnly:!0},{name:"blending",exposed:!1,readOnly:!0},{name:"blendTime",exposed:!1,readOnly:!0},{name:"blendTimeRemaining",exposed:!1,readOnly:!0},{name:"playing",exposed:!1,readOnly:!0}];this.exposeProperties();this.on("remove",this.onRemove,this);this.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["activate","loop","speed","assets","enabled"];d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{});b.animation.data.assets=pc.extend([],a.animation.assets);b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;
b.animation.animations=pc.extend({},a.animation.animations)},onRemove:function(a,b){delete b.animation;delete b.skeleton;delete b.fromSkel;delete b.toSkel},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var e=b[c],d=e.data;d.enabled&&(d.playing&&e.entity.enabled)&&(e=d.skeleton,null!==e&&null!==d.model&&(d.blending?(d.blendTimeRemaining-=a,0>d.blendTimeRemaining&&(d.blendTimeRemaining=0),e.blend(d.fromSkel,d.toSkel,1-d.blendTimeRemaining/d.blendTime)):(e.addTime(a*d.speed),
e.getCurrentTime()===e.getAnimation().getDuration()&&!d.loop&&(d.playing=!1)),d.blending&&0===d.blendTimeRemaining&&(d.blending=!1,e.setAnimation(d.toSkel.getAnimation())),e.updateGraph()))}}});return{AnimationComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=this.animations=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.fw.ComponentData);return{AnimationComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="model";this.description="Renders a 3D model at the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ModelComponent;this.DataType=pc.fw.ModelComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable rendering of the Model",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"Type of model",type:"enumeration",options:{enumerations:[{name:"Asset",value:"asset"},
{name:"Box",value:"box"},{name:"Capsule",value:"capsule"},{name:"Sphere",value:"sphere"},{name:"Cylinder",value:"cylinder"},{name:"Cone",value:"cone"}]},defaultValue:"asset"},{name:"asset",displayName:"Asset",description:"Model Asset to render",type:"asset",options:{max:1,type:"model"},defaultValue:null,filter:{type:"asset"}},{name:"materialAsset",displayName:"Material",description:"The material of the model",type:"asset",options:{max:1,type:"material"},defaultValue:null,filter:{type:function(){return!1}}},
{name:"castShadows",displayName:"Cast shadows",description:"Occlude light from shadow casting lights",type:"boolean",defaultValue:!1},{name:"receiveShadows",displayName:"Receive shadows",description:"Receive shadows cast from occluders",type:"boolean",defaultValue:!0},{name:"material",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();a=a.graphicsDevice;this.box=pc.scene.procedural.createBox(a,{halfExtents:new pc.Vec3(0.5,0.5,0.5)});this.capsule=pc.scene.procedural.createCapsule(a,{radius:0.5,
height:2});this.sphere=pc.scene.procedural.createSphere(a,{radius:0.5});this.cone=pc.scene.procedural.createCone(a,{baseRadius:0.5,peakRadius:0,height:1});this.cylinder=pc.scene.procedural.createCylinder(a,{radius:0.5,height:1});this.defaultMaterial=new pc.scene.PhongMaterial},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b.material=this.defaultMaterial;c="material materialAsset asset castShadows receiveShadows type enabled".split(" ");d._super.initializeComponentData.call(this,
a,b,c)},removeComponent:function(a){var b=a.model.data;a.model.asset=null;"asset"!==b.type&&b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null);d._super.removeComponent.call(this,a)},cloneComponent:function(a,b){this.addComponent(b,{});b.model.data.type=a.model.type;b.model.data.materialAsset=a.model.materialAsset;b.model.data.asset=a.model.asset;b.model.data.castShadows=a.model.castShadows;b.model.data.receiveShadows=a.model.receiveShadows;b.model.data.material=
a.model.material;b.model.data.enabled=a.model.enabled;a.model.model&&(b.model.model=a.model.model.clone())}});return{ModelComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a){this.on("set_type",this.onSetType,this);this.on("set_asset",this.onSetAsset,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_model",this.onSetModel,this);this.on("set_receiveShadows",this.onSetReceiveShadows,this);Object.defineProperty(this,"materialAsset",{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)});this.materialLoader=new pc.resources.MaterialResourceLoader(a.context.graphicsDevice,a.context.assets)},
d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");this.enabled=a},loadModelAsset:function(a){var b={parent:this.entity.getRequest()},c=this.system.context.assets.getAssetByResourceId(a);c?this.system.context.assets.load(c,[],b).then(function(a){a=a[0];this.system.context.designer&&(a.generateWireframe(),c.on("change",this.onAssetChange,this));"asset"===this.data.type&&(this.model=
a)}.bind(this)):logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",a))},onSetType:function(a,b,c){a=this.data;if(c)if(b=null,"asset"===c)this.data.asset?this.loadModelAsset(this.data.asset):this.model=null;else{switch(c){case "box":b=this.system.box;break;case "capsule":b=this.system.capsule;break;case "sphere":b=this.system.sphere;break;case "cone":b=this.system.cone;break;case "cylinder":b=this.system.cylinder;break;default:throw Error("Invalid model type: "+c);}var c=
new pc.scene.GraphNode,e=new pc.scene.Model;e.graph=c;e.meshInstances=[new pc.scene.MeshInstance(c,b,a.material)];this.system.context.designer&&e.generateWireframe();this.model=e}},onSetAsset:function(a,b,c){b&&(a=this.system.context.assets.getAssetByResourceId(b))&&a.off("change",this.onAssetChange,this);"asset"===this.data.type&&(c?this.loadModelAsset(c):this.model=null)},onSetCastShadows:function(a,b,c){if(a=this.data.model){var b=this.system.context.scene,e=b.containsModel(a);e&&b.removeModel(a);
for(var d=a.meshInstances,f=0;f<d.length;f++)d[f].castShadow=c;e&&b.addModel(a)}},onSetModel:function(a,b,c){b&&(this.system.context.scene.removeModel(b),this.entity.removeChild(b.getGraph()),delete b._entity);if(c){for(var a=this.data,b=c.meshInstances,e=0;e<b.length;e++)b[e].castShadow=a.castShadows,b[e].receiveShadow=a.receiveShadows;this.enabled&&this.entity.enabled&&(this.entity.addChild(c.graph),this.system.context.scene.addModel(c));c._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(c)}},
setMaterialAsset:function(a){material=(a="string"===typeof a||!a?a:a.resourceId)?this.materialLoader.load(a):this.system.defaultMaterial;this.data.material=material;if(this.data.model&&"asset"!==this.data.type)for(var b=this.data.model.meshInstances,c=0;c<b.length;c++)b[c].material=material;b=this.data.materialAsset;this.data.materialAsset=a;this.fire("set","materialAsset",b,a)},getMaterialAsset:function(){return this.system.context.assets.getAssetByResourceId(this.data.materialAsset)},onSetReceiveShadows:function(a,
b,c){if(void 0!==c&&(a=this.data,a.model)){a=a.model.meshInstances;for(b=0;b<a.length;b++)a[b].receiveShadow=c}},onEnable:function(){d._super.onEnable.call(this);this.data.model&&(this.system.context.scene.containsModel(this.data.model)||this.system.context.scene.addModel(this.data.model))},onDisable:function(){d._super.onDisable.call(this);this.data.model&&this.system.context.scene.containsModel(this.data.model)&&this.system.context.scene.removeModel(this.data.model)},onAssetChange:function(a){this.system.context.loader.removeFromCache(a.getFileUrl());
this.asset=null;this.asset=a.resourceId}});return{ModelComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.type="asset";this.asset=null;this.castShadows=!1;this.receiveShadows=!0;this.model=this.material=this.materialAsset=null},pc.fw.ComponentData);return{ModelComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="skybox";this.description="Renders a skybox in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.fw.SkyboxComponent;this.DataType=pc.fw.SkyboxComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},
{name:"negx",displayName:"NEGX",description:"URL of the negative X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of skybox cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"model",exposed:!1,readOnly:!0},{name:"assets",exposed:!1,readOnly:!0}];this.exposeProperties();this.on("remove",this.onRemove,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz".split(" ");
d._super.initializeComponentData.call(this,a,b,c)},onRemove:function(a,b){b.model&&(this.context.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{SkyboxComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set",this.onSet,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{onSet:function(b,c,e){function d(b,c){if(c){var e=a.indexOf(b),f=this.entity.skybox.assets;this.data.model=null;if(c)if(f[e]=this.system.context.assets.getAssetByResourceId(c),f[e]){if(this.data.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5]){var g=f.map(function(a){return a.getFileUrl()}),e=this.data,s=this.entity,h=this.system.context,f=h.graphicsDevice,u=new pc.gfx.Texture(f,
{format:pc.gfx.PIXELFORMAT_R8_G8_B8,cubemap:!0});u.minFilter=pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR;u.magFilter=pc.gfx.FILTER_LINEAR;u.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;u.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;s={parent:s.getRequest()};g=g.map(function(a){return new pc.resources.ImageRequest(a)});h.loader.request(g,s).then(function(a){u.setSource(a)});h=f.getProgramLibrary().getProgram("skybox");g=new pc.scene.Material;g.setShader(h);g.setParameter("texture_cubeMap",u);g.cull=pc.gfx.CULLFACE_NONE;
h=new pc.scene.GraphNode;f=pc.scene.procedural.createBox(f);f=new pc.scene.MeshInstance(h,f,g);g=new pc.scene.Model;g.graph=h;g.meshInstances=[f];e.model=g;this.enabled&&this.entity.enabled&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))}}else logERROR(pc.string.format("Trying to load skybox component before asset {0} has loaded",c));else delete f[e]}}var f={posx:function(a,b,c,e){d.call(this,b,e)},negx:function(a,b,c,e){d.call(this,b,e)},posy:function(a,
b,c,e){d.call(this,b,e)},negy:function(a,b,c,e){d.call(this,b,e)},posz:function(a,b,c,e){d.call(this,b,e)},negz:function(a,b,c,e){d.call(this,b,e)}};f[b]&&f[b].call(this,this.entity,b,c,e)},onEnable:function(){d._super.onEnable.call(this);this.data.model&&!this.system.context.scene.containsModel(this.data.model)&&(this.system.context.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))},onDisable:function(){d._super.onDisable.call(this);this.data.model&&this.system.context.scene.containsModel(this.data.model)&&
(this.entity.removeChild(this.data.model.graph),this.system.context.scene.removeModel(this.data.model))}});var a="posx negx posy negy posz negz".split(" ");return{SkyboxComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.model=null},pc.fw.ComponentData);return{SkyboxComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="camera";this.description="Renders the scene from the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.CameraComponent;this.DataType=pc.fw.CameraComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled cameras do not render anything",type:"boolean",defaultValue:!0},{name:"clearColor",displayName:"Clear Color",description:"Clear Color",type:"rgba",defaultValue:[0.7294117647058823,0.7294117647058823,
0.6941176470588235,1]},{name:"projection",displayName:"Projection",description:"Projection type of camera",type:"enumeration",options:{enumerations:[{name:"Perspective",value:0},{name:"Orthographic",value:1}]},defaultValue:0},{name:"fov",displayName:"Field of View",description:"Field of view in Y axis",type:"number",defaultValue:45,options:{min:0,max:90},filter:{projection:0}},{name:"orthoHeight",displayName:"Ortho Height",description:"View window half extent of camera in Y axis",type:"number",defaultValue:100,
filter:{projection:1}},{name:"nearClip",displayName:"Near Clip",description:"Near clipping distance",type:"number",defaultValue:0.3,options:{min:0}},{name:"farClip",displayName:"Far Clip",description:"Far clipping distance",type:"number",defaultValue:1E3,options:{min:0}},{name:"camera",exposed:!1},{name:"aspectRatio",exposed:!1},{name:"model",exposed:!1},{name:"renderTarget",exposed:!1}];this.exposeProperties();this._currentNode=this._currentEntity=null;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("toolsUpdate",
this.toolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);Object.defineProperty(d.prototype,"current",{get:function(){return this._currentEntity},set:function(a){if(null===a)this._currentNode=this._currentEntity=null;else{if(!a.camera)throw Error("Entity must have camera Component");this._currentEntity=a;this._currentNode=a.camera.data.camera}}});pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b=b||{};b.clearColor&&"array"===pc.type(b.clearColor)&&(c=b.clearColor,b.clearColor=
new pc.Color(c[0],c[1],c[2],c[3]));b.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),b.enabled=b.activate);b.camera=new pc.scene.CameraNode;if(this.context.designer&&this.displayInTools(a.entity)){c=new pc.scene.BasicMaterial;c.color=new pc.Color(1,1,0,1);c.update();var e=new pc.gfx.IndexBuffer(this.context.graphicsDevice,pc.gfx.INDEXFORMAT_UINT8,24);(new Uint8Array(e.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);e.unlock();var g=
new pc.gfx.VertexFormat(this.context.graphicsDevice,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),f=new pc.gfx.VertexBuffer(this.context.graphicsDevice,g,8,pc.gfx.BUFFER_DYNAMIC),g=new pc.scene.Mesh;g.vertexBuffer=f;g.indexBuffer[0]=e;g.primitive[0].type=pc.gfx.PRIMITIVE_LINES;g.primitive[0].base=0;g.primitive[0].count=e.getNumIndices();g.primitive[0].indexed=!0;e=new pc.scene.Model;e.graph=b.camera;e.meshInstances=[new pc.scene.MeshInstance(e.graph,g,c)];this.context.scene.addModel(e);
b.model=e}c="enabled model camera aspectRatio renderTarget clearColor fov orthoHeight nearClip farClip projection".split(" ");d._super.initializeComponentData.call(this,a,b,c);!window.pc.apps.designer&&(a.enabled&&!a.entity.hasLabel("pc:designer"))&&(this.current=a.entity)},frameBegin:function(){var a=this._currentNode;if(a){var b=this.context.graphicsDevice,b=b.width/b.height;b!==a.getAspectRatio()&&a.setAspectRatio(b)}},frameEnd:function(){},onRemove:function(a,b){this._currentEntity===a&&(this.current=
null);this.context.designer&&this.displayInTools(a)&&this.context.scene.containsModel(b.model)&&this.context.scene.removeModel(b.model);a.removeChild(b.camera);b.camera=null},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].entity;this.displayInTools(c)&&this._updateGfx(c.camera)}},_updateGfx:function(a){if(a.model&&a.model.meshInstances.length){var b=a.model.meshInstances[0].mesh.vertexBuffer,c=a.camera.getAspectRatio(),e=this.isToolsCamera(a.entity)?0.5:a.nearClip,
d=this.isToolsCamera(a.entity)?2:a.farClip,f=a.fov*Math.PI/180,k=a.projection,l;l=k===pc.scene.Projection.PERSPECTIVE?Math.tan(f/2)*e:a.camera.getOrthoHeight();var a=l*c,n=new Float32Array(b.lock());n[0]=a;n[1]=-l;n[2]=-e;n[3]=a;n[4]=l;n[5]=-e;n[6]=-a;n[7]=l;n[8]=-e;n[9]=-a;n[10]=-l;n[11]=-e;k===pc.scene.Projection.PERSPECTIVE&&(l=Math.tan(f/2)*d,a=l*c);n[12]=a;n[13]=-l;n[14]=-d;n[15]=a;n[16]=l;n[17]=-d;n[18]=-a;n[19]=l;n[20]=-d;n[21]=-a;n[22]=-l;n[23]=-d;b.unlock()}},onCameraDisabled:function(){var a=
this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].entity;if(a[b].data.enabled){this.current=c;break}}},isToolsCamera:function(a){return a.hasLabel("pc:designer")},displayInTools:function(a){return!this.isToolsCamera(a)||"Perspective"===a.getName()}});return{CameraComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_renderTarget",this.onSetRenderTarget,this)},d=pc.inherits(d,
pc.fw.Component);Object.defineProperty(d.prototype,"activate",{get:function(){console.warn("WARNING: activate: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: activate: Property is deprecated. Set enabled property instead.");this.enabled=a}});pc.extend(d.prototype,{screenToWorld:function(a,b,c,e){var d=this.system.context.graphicsDevice,f=parseInt(d.canvas.style.width),d=parseInt(d.canvas.style.height);return this.data.camera.screenToWorld(a,
b,c,f,d,e)},onSetAspectRatio:function(a,b,c){this.data.camera.setAspectRatio(c)},onSetCamera:function(a,b,c){b&&this.entity.removeChild(b);this.entity.addChild(c)},onSetClearColor:function(a,b,c){a=this.data.camera.getClearOptions();a.color[0]=c.r;a.color[1]=c.g;a.color[2]=c.b},onSetFov:function(a,b,c){this.data.camera.setFov(c)},onSetOrthoHeight:function(a,b,c){this.data.camera.setOrthoHeight(c)},onSetNearClip:function(a,b,c){this.data.camera.setNearClip(c)},onSetFarClip:function(a,b,c){this.data.camera.setFarClip(c)},
onSetProjection:function(a,b,c){this.data.camera.setProjection(c)},onSetRenderTarget:function(a,b,c){this.data.camera.setRenderTarget(c)},onEnable:function(){d._super.onEnable.call(this);this.system.current=this.entity},onDisable:function(){d._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null,this.system.onCameraDisabled(this))}});return{CameraComponent:d}}());pc.extend(pc.fw,function(){CameraComponentData=function(){this.clearColor=new pc.Color(0.729411780834198,0.729411780834198,0.6941176652908325,1);this.nearClip=0.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.scene.Projection.PERSPECTIVE;this.enabled=!0;this.camera=null;this.aspectRatio=16/9;this.renderTarget=null};CameraComponentData=pc.inherits(CameraComponentData,pc.fw.ComponentData);return{CameraComponentData:CameraComponentData}}());pc.extend(pc.fw,function(){var d=function(a){this.id="cubemap";a.systems.add(this.id,this);this.ComponentType=pc.fw.CubeMapComponent;this.DataType=pc.fw.CubeMapComponentData;this.schema=[{name:"enabled",type:"boolean",defaultValue:!0},{name:"cubemap",exposed:!1},{name:"camera",exposed:!1},{name:"targets",exposed:!1}];this.exposeProperties();pc.fw.ComponentSystem.on("update",this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b){var c=
new pc.gfx.Texture(this.context.graphicsDevice,{format:pc.gfx.PIXELFORMAT_R8_G8_B8,width:256,height:256,cubemap:!0});c.minFilter=pc.gfx.FILTER_LINEAR;c.magFilter=pc.gfx.FILTER_LINEAR;c.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;for(var e=[],g=0;6>g;g++){var f=new pc.gfx.RenderTarget(this.context.graphicsDevice,c,{face:g,depth:!0});e.push(f)}g=new pc.scene.CameraNode;g.setNearClip(0.01);g.setFarClip(1E4);g.setAspectRatio(1);b.cubemap=c;b.targets=e;b.camera=g;d._super.initializeComponentData.call(this,
a,b,["enabled","targets","cubemap","camera"])},onUpdate:function(){var a,b,c,e=this.store;for(a in e)if(e.hasOwnProperty(a)){b=e[a].entity;c=e[a].data;var d;b.model&&(d=b.model.model);if(d){var f=this.context.scene;f.removeModel(d);var k=[{target:[1,0,0],up:[0,-1,0]},{target:[-1,0,0],up:[0,-1,0]},{target:[0,1,0],up:[0,0,1]},{target:[0,-1,0],up:[0,0,-1]},{target:[0,0,1],up:[0,-1,0]},{target:[0,0,-1],up:[0,-1,0]}];b=b.getPosition();for(var l=c.camera,n=0;6>n;n++)l.setRenderTarget(c.targets[n]),l.setPosition(b),
l.lookAt(k[n].target,k[n].up),l.syncHierarchy(),f.render(l,this.context.graphicsDevice);f.addModel(d)}}}});return{CubeMapComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);return{CubeMapComponent:d}}());pc.extend(pc.fw,function(){CubeMapComponentData=function(){this.camera=null;this.nearClip=1;this.farClip=1E5;this.height=this.width=256;this.enabled=!0};CubeMapComponentData=pc.inherits(CubeMapComponentData,pc.fw.ComponentData);return{CubeMapComponentData:CubeMapComponentData}}());pc.extend(pc.fw,function(){var d=function(a){this.id="staticcubemap";a.systems.add(this.id,this);this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negx",displayName:"NEGX",description:"URL of the negative X face of cubemap",type:"asset",options:{max:1,type:"texture"},
defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"assets",exposed:!1},{name:"cubemap",exposed:!1}];this.exposeProperties();this.ComponentType=pc.fw.StaticCubeMapComponent;this.DataType=pc.fw.StaticCubeMapComponentData},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz".split(" ");d._super.initializeComponentData.call(this,a,b,c)}});return{StaticCubeMapComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set",this.onSet,this)},pc.fw.Component);pc.extend(d.prototype,{onSet:function(b,c,e){function d(b,c){if(c){var e=a.indexOf(b),f=this.assets;this.cubemap=null;if(c){if(f[e]=this.system.context.assets.getAssetByResourceId(c),this.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5]){var g=f.map(function(a){return a.getFileUrl()}),f=this.entity,e=this.system.context,s=new pc.gfx.Texture(e.graphicsDevice,{format:pc.gfx.PIXELFORMAT_R8_G8_B8,cubemap:!0});
s.minFilter=pc.gfx.FILTER_LINEAR_MIPMAP_LINEAR;s.magFilter=pc.gfx.FILTER_LINEAR;s.addressU=pc.gfx.ADDRESS_CLAMP_TO_EDGE;s.addressV=pc.gfx.ADDRESS_CLAMP_TO_EDGE;g=g.map(function(a){return new pc.resources.ImageRequest(a)});f={parent:f.getRequest()};e.loader.request(g,f).then(function(a){s.setSource(a)});this.cubemap=s}}else delete f[e]}}var f={posx:function(a,b,c){d.call(this,a,c)},negx:function(a,b,c){d.call(this,a,c)},posy:function(a,b,c){d.call(this,a,c)},negy:function(a,b,c){d.call(this,a,c)},
posz:function(a,b,c){d.call(this,a,c)},negz:function(a,b,c){d.call(this,a,c)}};f[b]&&f[b].call(this,b,c,e)}});var a="posx negx posy negy posz negz".split(" ");return{StaticCubeMapComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.cubemap=null},pc.fw.ComponentData);return{StaticCubeMapComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="light";this.description="Enables the Entity to emit light.";a.systems.add(this.id,this);this.ComponentType=pc.fw.LightComponent;this.DataType=pc.fw.LightComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the light",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the light",type:"enumeration",options:{enumerations:[{name:"Directional",value:"directional"},{name:"Point",
value:"point"},{name:"Spot",value:"spot"}]},defaultValue:"directional"},{name:"color",displayName:"Color",description:"Light Color",type:"rgb",defaultValue:[1,1,1]},{name:"intensity",displayName:"Intensity",description:"Factors the light color",type:"number",defaultValue:1,options:{min:0,max:10,step:0.05}},{name:"castShadows",displayName:"Cast Shadows",description:"Cast shadows from this light",type:"boolean",defaultValue:!1,filter:{type:["directional","spot"]}},{name:"shadowResolution",displayName:"Shadow Resolution",
description:"Resolution of shadowmap generated by this light",type:"enumeration",options:{enumerations:[{name:"256",value:256},{name:"512",value:512},{name:"1024",value:1024},{name:"2048",value:2048}]},defaultValue:1024,filter:{type:["directional","spot"]}},{name:"range",displayName:"Range",description:"The distance from the light where its contribution falls to zero",type:"number",defaultValue:10,options:{min:0},filter:{type:["point","spot"]}},{name:"innerConeAngle",displayName:"Inner Cone Angle",
description:"Spotlight inner cone angle",type:"number",defaultValue:40,options:{min:0,max:90},filter:{type:"spot"}},{name:"outerConeAngle",displayName:"Outer Cone Angle",description:"Spotlight outer cone angle",type:"number",defaultValue:45,options:{min:0,max:90},filter:{type:"spot"}},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,
{initializeComponentData:function(a,b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.color&&"array"===pc.type(b.color)&&(b.color=new pc.Color(b.color[0],b.color[1],b.color[2]));b.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),b.enabled=b.enable);this._createImplementation(b.type).initialize(a,b);c="type model enabled color intensity range innerConeAngle outerConeAngle castShadows shadowResolution".split(" ");d._super.initializeComponentData.call(this,
a,b,c);if(a.enabled&&a.entity.enabled)a.onEnable()},_createImplementation:function(a){var b=this.implementations[a];if(!b){switch(a){case "directional":b=new DirectionalLightImplementation(this);break;case "point":b=new PointLightImplementation(this);break;case "spot":b=new SpotLightImplementation(this);break;default:throw Error("Invalid light type: "+a);}this.implementations[a]=b}return b},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},cloneComponent:function(a,b){this.addComponent(b,
{type:a.light.type,enabled:a.light.enabled,color:[a.light.color.r,a.light.color.g,a.light.color.b],intensity:a.light.intensity,range:a.light.range,innerConeAngle:a.light.innerConeAngle,outerConeAngle:a.light.outerConeAngle,castShadows:a.light.castShadows,shadowResolution:a.light.shadowResolution})},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].data,e=this.implementations[c.type];e&&e.toolsUpdate(c)}},changeType:function(a,b,c){this.implementations[b].remove(a.entity,
a.data);this._createImplementation(c).initialize(a,a.data)}});LightComponentImplementation=function(a){this.system=a};LightComponentImplementation.prototype={initialize:function(a,b){var c=this._createLightNode(a,b);this._createDebugShape(a,b,c)},_createLightNode:function(a,b){var c=new pc.scene.LightNode;c.setName(b.type+"light");c.setType(this._getLightType());return c},_getLightType:function(){},_createDebugShape:function(a,b,c){var e=this.system.context,d=new pc.scene.Model;d.graph=c;d.lights=
[c];e.designer&&(this.mesh=this._createDebugMesh(),this.material||(this.material=this._createDebugMaterial()),d.meshInstances=[new pc.scene.MeshInstance(c,this.mesh,this.material)]);e.scene.addModel(d);a.entity.addChild(c);b=b||{};b.model=d},_createDebugMesh:function(){},_createDebugMaterial:function(){},remove:function(a,b){var c=this.system.context;a.removeChild(b.model.graph);c.scene.removeModel(b.model);delete b.model},toolsUpdate:function(){}};DirectionalLightImplementation=function(){};DirectionalLightImplementation=
pc.inherits(DirectionalLightImplementation,LightComponentImplementation);DirectionalLightImplementation.prototype=pc.extend(DirectionalLightImplementation.prototype,{_getLightType:function(){return pc.scene.LIGHTTYPE_DIRECTIONAL},_createDebugMesh:function(){if(this.mesh)return this.mesh;var a=this.system.context,b=new pc.gfx.VertexFormat(a.graphicsDevice,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]);vertexData=[0,0,0,0,-8,0,-0.5,-8,0,0.5,-8,0,0.5,-8,0,0,-10,0,
0,-10,0,-0.5,-8,0,0,0,-2,0,-8,-2,-0.25,-8,-2,0.25,-8,-2,0.25,-8,-2,0,-10,-2,0,-10,-2,-0.25,-8,-2];var c=(new pc.Mat4).setFromAxisAngle(pc.Vec3.UP,120),e;for(e=0;16>e;e++){var d=new pc.Vec3(vertexData[3*(e+8)],vertexData[3*(e+8)+1],vertexData[3*(e+8)+2]),d=c.transformPoint(d,d);vertexData[3*(e+16)]=d[0];vertexData[3*(e+16)+1]=d[1];vertexData[3*(e+16)+2]=d[2]}a=new pc.gfx.VertexBuffer(a.graphicsDevice,b,32);b=new Float32Array(a.lock());for(e=0;e<vertexData.length;e++)b[e]=vertexData[e];a.unlock();e=
new pc.scene.Mesh;e.vertexBuffer=a;e.indexBuffer[0]=null;e.primitive[0].type=pc.gfx.PRIMITIVE_LINES;e.primitive[0].base=0;e.primitive[0].count=a.getNumVertices();e.primitive[0].indexed=!1;return e},_createDebugMaterial:function(){var a=new pc.scene.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});PointLightImplementation=function(){};PointLightImplementation=pc.inherits(PointLightImplementation,LightComponentImplementation);PointLightImplementation.prototype=pc.extend(PointLightImplementation.prototype,
{_getLightType:function(){return pc.scene.LIGHTTYPE_POINT},_createDebugMesh:function(){return this.mesh?this.mesh:pc.scene.procedural.createSphere(this.system.context.graphicsDevice,{radius:0.1})},_createDebugMaterial:function(){var a=new pc.scene.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});SpotLightImplementation=function(){};SpotLightImplementation=pc.inherits(SpotLightImplementation,LightComponentImplementation);SpotLightImplementation.prototype=pc.extend(SpotLightImplementation.prototype,
{_getLightType:function(){return pc.scene.LIGHTTYPE_SPOT},_createDebugMesh:function(){var a=this.system.context,b=this.indexBuffer;if(!b){var b=new pc.gfx.IndexBuffer(a.graphicsDevice,pc.gfx.INDEXFORMAT_UINT8,88),c=new Uint8Array(b.lock());c[0]=0;c[1]=1;c[2]=0;c[3]=11;c[4]=0;c[5]=21;c[6]=0;c[7]=31;for(var e=0;40>e;e++)c[2*e+8]=e+1,c[2*e+9]=e+2;b.unlock();this.indexBuffer=b}c=new pc.gfx.VertexFormat(a.graphicsDevice,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]);
a=new pc.gfx.VertexBuffer(a.graphicsDevice,c,42,pc.gfx.BUFFER_DYNAMIC);c=new pc.scene.Mesh;c.vertexBuffer=a;c.indexBuffer[0]=b;c.primitive[0].type=pc.gfx.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumIndices();c.primitive[0].indexed=!0;return c},_createDebugMaterial:function(){return new pc.scene.BasicMaterial},toolsUpdate:function(a){var b=a.model.meshInstances[0].mesh.vertexBuffer,c=Math.PI*a.outerConeAngle/180,e=a.range,a=-e*Math.cos(c),c=e*Math.sin(c),e=new Float32Array(b.lock());
e[0]=0;e[1]=0;e[2]=0;for(var d=b.getNumVertices(),f=0;f<d-1;f++){var k=2*Math.PI*(f/(d-2)),l=c*Math.cos(k),k=c*Math.sin(k);e[3*(f+1)+0]=l;e[3*(f+1)+1]=a;e[3*(f+1)+2]=k}b.unlock()}});return{LightComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_type",this.onSetType,this);this.on("set_color",this.onSetColor,this);this.on("set_intensity",this.onSetIntensity,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_shadowResolution",this.onSetShadowResolution,this);this.on("set_range",this.onSetRange,this);this.on("set_innerConeAngle",this.onSetInnerConeAngle,this);this.on("set_outerConeAngle",this.onSetOuterConeAngle,this)},d=pc.inherits(d,pc.fw.Component);Object.defineProperty(d.prototype,
"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");this.enabled=a}});pc.extend(d.prototype,{onSetType:function(a,b,c){b!==c&&(this.system.changeType(this,b,c),this.refreshProperties())},refreshProperties:function(){this.onSetCastShadows("castShadows",this.castShadows,this.castShadows);this.onSetColor("color",this.color,
this.color);this.onSetIntensity("intensity",this.intensity,this.intensity);this.onSetShadowResolution("shadowResolution",this.shadowResolution,this.shadowResolution);this.onSetRange("range",this.range,this.range);this.onSetInnerConeAngle("innerConeAngle",this.innerConeAngle,this.innerConeAngle);this.onSetOuterConeAngle("outerConeAngle",this.outerConeAngle,this.outerConeAngle);if(this.enabled&&this.entity.enabled)this.onEnable()},onSetCastShadows:function(a,b,c){("directional"===this.data.type||"spot"===
this.data.type)&&this.data.model.lights[0].setCastShadows(c)},onSetColor:function(a,b,c){this.data.model.lights[0].setColor(c)},onSetIntensity:function(a,b,c){this.data.model.lights[0].setIntensity(c)},onSetShadowResolution:function(a,b,c){("directional"===this.data.type||"spot"===this.data.type)&&this.data.model.lights[0].setShadowResolution(c)},onSetRange:function(a,b,c){("point"===this.data.type||"spot"===this.data.type)&&this.data.model.lights[0].setAttenuationEnd(c)},onSetInnerConeAngle:function(a,
b,c){"spot"===this.data.type&&this.data.model.lights[0].setInnerConeAngle(c)},onSetOuterConeAngle:function(a,b,c){"spot"===this.data.type&&this.data.model.lights[0].setOuterConeAngle(c)},onEnable:function(){d._super.onEnable.call(this);this.data.model.lights[0].setEnabled(!0)},onDisable:function(){d._super.onDisable.call(this);this.data.model.lights[0].setEnabled(!1)}});return{LightComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.type="directional";this.enabled=!0;this.color=new pc.Color(1,1,1);this.intensity=1;this.castShadows=!1;this.shadowResolution=1024;this.range=10;this.innerConeAngle=40;this.outerConeAngle=45;this.model=null},pc.fw.ComponentData);return{LightComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";a.systems.add(this.id,this);this.ComponentType=pc.fw.ScriptComponent;this.DataType=pc.fw.ScriptComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled components are not updated",type:"boolean",defaultValue:!0},{name:"scripts",displayName:"URLs",description:"Attach scripts to this Entity",type:"script",defaultValue:[]},
{name:"instances",exposed:!1},{name:"runInTools",description:"Allows scripts to be loaded and executed while in the tools",defaultValue:!1,exposed:!1}];this.exposeProperties();this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("initialize",this.onInitialize,this);pc.fw.ComponentSystem.on("postInitialize",this.onPostInitialize,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("fixedUpdate",this.onFixedUpdate,this);pc.fw.ComponentSystem.on("postUpdate",this.onPostUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["runInTools","enabled","scripts"];d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()],c={runInTools:c.data.runInTools,scripts:pc.extend([],
c.data.scripts),enabled:c.data.enabled};return this.addComponent(b,c)},onRemove:function(a,b){var c,e=b.instances,d;for(d in e)if(e.hasOwnProperty(d)){var f=e[d].instance;f.destroy&&f.destroy();f.update&&(c=this.instancesWithUpdate.indexOf(f),0<=c&&this.instancesWithUpdate.splice(c,1));f.fixedUpdate&&(c=this.instancesWithFixedUpdate.indexOf(f),0<=c&&this.instancesWithFixedUpdate.splice(c,1));f.postUpdate&&(c=this.instancesWithPostUpdate.indexOf(f),0<=c&&this.instancesWithPostUpdate.splice(c,1));f.toolsUpdate&&
(c=this.instancesWithToolsUpdate.indexOf(f),0<=c&&this.instancesWithToolsUpdate.splice(c,1));delete b.instances[d]}},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);var a=a.getChildren(),b,
c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){var c=a.data.instances,e;for(e in c)if(c.hasOwnProperty(e)){var d=c[e].instance;d[b]&&d[b].call(d)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,
"onDisable")},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,b,c){for(var e,d=0,f=b.length;d<f;d++)e=b[d],e.entity.script.enabled&&e.entity.enabled&&e[a].call(e,c)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,
a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){var c=pc.makeArray(arguments).slice(2),e,d,f,k=this.store;for(e in k)k.hasOwnProperty(e)&&(d=k[e].data,d.instances[a]&&(f=d.instances[a].instance[b])&&f.apply(d.instances[a].instance,c))},_preRegisterInstance:function(a,b,c,e){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[c])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",
c,b,a.script.data._instances[c].url,a.getGuid()));a.script.data._instances[c]={url:b,name:c,instance:e};e.update&&this.instancesWithUpdate.push(e);e.fixedUpdate&&this.instancesWithFixedUpdate.push(e);e.postUpdate&&this.instancesWithPostUpdate.push(e);e.toolsUpdate&&this.instancesWithToolsUpdate.push(e)}},_registerInstances:function(a){var b,c;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(c in a.script.instances){b=a.script.instances[c];pc.events.attach(b.instance);
a.script.scripts&&this._createAccessors(a,b);if(a.script[c])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",c));a.script[c]=b.instance}delete a.script.data._instances}a=a.getChildren();c=a.length;for(b=0;b<c;b++)a[b]instanceof pc.fw.Entity&&this._registerInstances(a[b])},_createAccessors:function(a,b){var c=this,e,d=a.script.scripts.length,f=b.url;for(e=0;e<d;e++){var k=a.script.scripts[e];if(k.url===f){e=k.attributes;k.name&&e&&(a.script.data.attributes[k.name]=
pc.extend([],e),e.forEach(function(a){c._createAccessor(a,b)}));break}}},_createAccessor:function(a,b){var c=this;c._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(e){var d=a.value;a.value=e;c._convertAttributeValue(a);b.instance.fire("set",a.name,d,a.value)},configurable:!0})},_updateAccessors:function(a,b){var c=this,e,d,f;f=a.script.scripts.length;var k=b.url,l,n,r,m;for(e=0;e<f;e++)if(l=a.script,d=l.scripts[e],d.url===k){e=d.name;
k=d.attributes;if(e){k&&k.forEach(function(a){c._createAccessor(a,b)});if(n=l.data.attributes[e])for(d=n.length;d--;){r=n[d];m=null;for(f=k.length;f--;)if(r.name===k[f].name){m=k[f];break}if(m){if(r.value!==m.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(r.name,r.value,m.value)}else delete b.instance[r.name]}k?l.data.attributes[e]=pc.extend([],k):delete l.data.attributes[e]}break}},_convertAttributeValue:function(a){if(("rgb"===a.type||"rgba"===a.type)&&"array"===pc.type(a.value))a.value=
3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3])}});return{ScriptComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_scripts",this.onSetScripts,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{send:function(a,b){var c=pc.makeArray(arguments).slice(2),e=this.entity.script.instances,d;if(e&&e[a]&&(d=e[a].instance[b]))return d.apply(e[a].instance,c)},onEnable:function(){d._super.onEnable.call(this);this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this);this.data.postInitialized||this.system._postInitializeScriptComponent(this)},
onDisable:function(){d._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){if(!this.system._inTools||this.runInTools){a=!0;if(b.length!==c.length)a=!1;else{var e;len=c.length;for(e=0;e<len;e++)if(b[e].url!==c[e].url){a=!1;break}}if(a)for(var d in this.instances)this.instances.hasOwnProperty(d)&&this.system._updateAccessors(this.entity,this.instances[d]);else{var f=c.map(function(a){return a.url}),b=f.map(function(a){return new pc.resources.ScriptRequest(a)}),
k={parent:this.entity.getRequest()};this.system.context.loader.request(b,k).then(function(a){a.forEach(function(a,b){if(a&&this.entity.script&&!this.entity.script.instances[a._pcScriptName]){var c=new a(this.entity);this.system._preRegisterInstance(this.entity,f[b],a._pcScriptName,c)}},this);k.parent||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity))}.bind(this)).then(null,function(a){setTimeout(function(){throw a;})})}}}});return{ScriptComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._scripts=[];this.runInTools=!1;this.attributes={};this.postInitialized=this.initialized=!1},pc.fw.ComponentData);return{ScriptComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="pack";a.systems.add(this.id,this);this.ComponentType=pc.fw.PackComponent;this.DataType=pc.fw.PackComponentData;this.schema=[]},d=pc.inherits(d,pc.fw.ComponentSystem);return{PackComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);return{PackComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.ComponentData);return{PackComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="pick";a.systems.add(this.id,this);this.ComponentType=pc.fw.PickComponent;this.DataType=pc.fw.PickComponentData;this.schema=[{name:"layer",exposed:!1},{name:"shapes",exposed:!1},{name:"material",exposed:!1}];this.layers={"default":[]};this.display=!1;this.on("remove",this.onRemove,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){b.material=new pc.scene.PhongMaterial;c=["material"];d._super.initializeComponentData.call(this,
a,b,c)},onRemove:function(a,b){this.deleteShapes(b.layer,b.shapes)},addShape:function(a,b){void 0===this.layers[a]&&(this.layers[a]=[]);this.layers[a].push(b.model);this.display&&this.context.scene.addModel(b.model)},deleteShapes:function(a,b){for(var c=this.layers[a],e=0;e<b.length;e++){var d=b[e].model,f=c.indexOf(d);-1!==f&&c.splice(f,1);this.display&&this.context.scene.removeModel(d)}},getLayerModels:function(a){return this.layers[a]}});return{PickComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){},pc.fw.Component);pc.extend(d.prototype,{addShape:function(a,b){var c=this.data.material,e=null;switch(a.type){case pc.shape.Type.BOX:e=pc.scene.procedural.createBox(this.system.context.graphicsDevice,{halfExtents:a.halfExtents});break;case pc.shape.Type.SPHERE:e=pc.scene.procedural.createSphere(this.system.context.graphicsDevice,{radius:a.radius});break;case pc.shape.Type.TORUS:e=pc.scene.procedural.createTorus(this.system.context.graphicsDevice,
{tubeRadius:a.iradius,ringRadius:a.oradius})}var d=new pc.scene.GraphNode,c=new pc.scene.MeshInstance(d,e,c);c._entity=this.entity;e=new pc.scene.Model;e.graph=d;e.meshInstances=[c];a={shape:a,shapeName:b,model:e};this.data.shapes.push(a);this.system.addShape(this.data.layer,a)},deleteShapes:function(){this.system.deleteShapes(this.data.layer,this.data.shapes);this.data.shapes=[]}});return{PickComponent:d}}());pc.extend(pc.fw,function(){function d(){this.layer="default";this.shapes=[];this.material=null}d=pc.inherits(d,pc.fw.ComponentData);return{PickComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AudioSourceComponent;this.DataType=pc.fw.AudioSourceComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audiosource components do not play any sounds",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Assets",description:"Audio assets",type:"asset",
options:{max:100,type:"audio"},defaultValue:[]},{name:"volume",displayName:"Volume",description:"The sound volume",type:"number",options:{max:1,min:0,step:0.1},defaultValue:1},{name:"pitch",displayName:"Pitch",description:"The sound pitch",type:"number",defaultValue:1,options:{min:0.01,step:0.01}},{name:"loop",displayName:"Loop",description:"Set whether sound loops or not",type:"boolean",defaultValue:!1},{name:"activate",displayName:"Activate",description:"Play first audio sample when scene loads",
type:"boolean",defaultValue:!0},{name:"3d",displayName:"3d",description:"3d sounds are positioned in space, and their sound is dependent on listener position/orientation. Non-3d sounds are uniform aross space",type:"boolean",defaultValue:!0},{name:"minDistance",displayName:"Min Distance",description:"Distance from listener under which the sound is at full volume",type:"number",defaultValue:1,options:{min:0}},{name:"maxDistance",displayName:"Max Distance",description:"Distance from listener over which the sound cannot be heard",
type:"number",defaultValue:1E4,options:{min:0}},{name:"rollOffFactor",displayName:"Roll-off factor",description:"Strength of the roll off",type:"number",defaultValue:1,options:{min:0}},{name:"sources",exposed:!1,readOnly:!0},{name:"currentSource",exposed:!1,readOnly:!0},{name:"channel",exposed:!1,readOnly:!0}];this.exposeProperties();this.manager=b;pc.fw.ComponentSystem.on("initialize",this.onInitialize,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);
pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor".split(" ");d._super.initializeComponentData.call(this,a,b,c);a.paused=!(a.enabled&&b.activate)},onInitialize:function(a){a.audiosource&&(a.enabled&&a.audiosource.enabled&&a.audiosource.activate)&&a.audiosource.play(a.audiosource.currentSource);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.fw.Entity)this.onInitialize(a[b])},
onUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b],e=c.entity,c=c.data;c.enabled&&(e.enabled&&c.channel instanceof pc.audio.Channel3d)&&(e=e.getPosition(),c.channel.setPosition(e))}},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&
this.stop();var b,c=this.data;c.sources[a]&&(c.sources[a].isLoaded?(c["3d"]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(c.sources[a],b,c)):b=this.system.manager.playSound(c.sources[a],c),c.currentSource=a,c.channel=b):logWARNING(pc.string.format("Audio asset '{0}' is not loaded (probably an unsupported format) and will not be played",a)))}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&
(this.channel.stop(),this.channel=null)},onSetAssets:function(a,b,c){var a=[],e,d=c.length;if(d)for(e=0;e<d;e++)0>b.indexOf(c[e])&&a.push(c[e]);!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onSetLoop:function(a,b,c){b!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,b,c){b!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&
this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(a,b,c){b!=c&&this.channel instanceof pc.audio.Channel3d&&this.channel.setRollOffFactor(c)},onEnable:function(){d._super.onEnable.call(this);this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause()},onDisable:function(){d._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var b={parent:this.entity.getRequest()},
c=[],e=[];a.map(function(a){return this.system.context.assets.getAssetByResourceId(a)},this).forEach(function(b){b?(c.push(new pc.resources.AudioRequest(b.getFileUrl())),e.push(b.name)):logERROR(pc.string.format("Trying to load audiosource component before assets {0} are loaded",a))});this.system.context.loader.request(c,b).then(function(a){for(var d={},k=0;k<c.length;k++)d[e[k]]=a[k];e.length&&(this.data.currentSource=e[0]);this.data.sources=d;!b.parent&&this.activate&&this.play(e[0])}.bind(this))}});
return{AudioSourceComponent:d}}());pc.fw.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc.fw,function(){var d=function(a,b){this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";a.systems.add(this.id,this);this.ComponentType=pc.fw.AudioListenerComponent;this.DataType=pc.fw.AudioListenerComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audio listener components do not affect audiosources",type:"boolean",defaultValue:!0}];this.exposeProperties();this.manager=b;this.current=null;pc.fw.ComponentSystem.on("update",
this.onUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);pc.extend(d.prototype,{initializeComponentData:function(a,b,c){c=["enabled"];d._super.initializeComponentData.call(this,a,b,c);a.setCurrentListener()},onUpdate:function(){if(this.current){var a=this.current.getPosition();this.manager.listener.setPosition(a);a=this.current.getWorldTransform();this.manager.listener.setOrientation(a)}}});return{AudioListenerComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(){},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){d._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){d._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});
return{AudioListenerComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0},pc.fw.ComponentData);return{AudioListenerComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){a.systems.add("designer",this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype.createComponent=function(a,b){var c=new pc.fw.DesignerComponentData;this.initializeComponent(a,c,b,["fillWindow","width","height"]);return c};return{DesignerComponentSystem:d}}());pc.extend(pc.fw,function(){DesignerComponentData=function(){this.fillWindow=!0;this.width=800;this.height=450};DesignerComponentData=pc.inherits(DesignerComponentData,pc.fw.ComponentData);return{DesignerComponentData:DesignerComponentData}}());pc.extend(pc.fw,function(){var d=new pc.Vec3,a=new pc.Vec3,b,c,e,g,f,k=function(a){"undefined"!==typeof Box2D&&!c&&(c=Box2D.Dynamics.b2World,e=Box2D.Common.Math.b2Vec2,g=Box2D.Dynamics.b2Body,f=Box2D.Dynamics.b2BodyDef,b=new e);this.id="body2d";a.systems.add(this.id,this);this.ComponentType=pc.fw.Body2dComponent;this.DataType=pc.fw.Body2dComponentData;this.schema=[{name:"static",displayName:"Static",description:"Static bodies are immovable and do not collide with other static bodies.",type:"boolean",
defaultValue:!0},{name:"body",exposed:!1,readOnly:!0},{name:"bodyDef",exposed:!1,readOnly:!0}];this.exposeProperties();this._rayStart=new pc.Vec3;this._rayEnd=new pc.Vec3;this.time=0;this.step=1/60;this.xi=0;this.yi=2;this.ri=1;c&&(this.b2World=new c(new e(0,0),!0),pc.fw.ComponentSystem.on("update",this.onUpdate,this));this.on("remove",this.onRemove,this)},k=pc.inherits(k,pc.fw.ComponentSystem);pc.extend(k.prototype,{initializeComponentData:function(a,b,c){c=["static"];k._super.initializeComponentData.call(this,
a,b,c);"undefined"!==typeof Box2D&&this.createBody(a)},createBody:function(b){if(b.entity.collisionrect||b.entity.collisioncircle){var c=new f;d.copy(b.entity.getPosition());a.copy(b.entity.getEulerAngles());c.type=b.static?g.b2_staticBody:g.b2_dynamicBody;c.position.Set(d.data[this.xi],d.data[this.yi]);var e=b._eulersToAngle(a);c.angle=-e*pc.math.DEG_TO_RAD;c.userData=b.entity;b.data.bodyDef=c}b.data.body&&this.removeBody(b.entity,b.data.body);b.data.body=b.entity.collisionrect?this.addBody(b.bodyDef,
b.entity.collisionrect.fixtureDef):b.entity.collisioncircle?this.addBody(b.bodyDef,b.entity.collisioncircle.fixtureDef):null},onRemove:function(a,b){b.body&&this.removeBody(a,b.body);b.body=null},to2d:function(a,b){b=b||new e;return b.Set(a[this.xi],a[this.yi])},addBody:function(a,b){var c=this.b2World.CreateBody(a);c.CreateFixture(b);return c},removeBody:function(a,b){this.b2World.DestroyBody(b);a.body2d.body&&(a.body2d.data.body=null)},setGravity:function(a,c){b.Set(a,c);this.b2World.SetGravity(b)},
raycast:function(a,b,c){var d=new e,f=new e;this.to2d(b,d);this.to2d(c,f);this._rayStart.vec3.copy(b);this._rayEnd.vec3.copy(c);this.b2World.RayCast(a,d,f)},raycastFirst:function(a,b,c){var e,d=1;this.raycast(function(a,b,f,g){a=a.GetUserData();a!==c&&g<d&&(e=a,d=g);return 1},a,b);return e},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var e=b[c].entity,d=b[c].data;d.body&&!d.static&&e.body2d.updateTransform(d.body)}for(this.time+=a;this.time>this.step;)this.b2World.Step(this.step,
6,2),this.time-=this.step}});return{Body2dComponentSystem:k}}());pc.extend(pc.fw,function(){new pc.Mat4;var d=new pc.Vec3,a=new pc.Vec3,b=function(a,b){this.on("set_static",this.onSetStatic,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this)},b=pc.inherits(b,pc.fw.Component);pc.extend(b.prototype,{applyForce:function(a,b){var g=this.entity.body2d.body;g&&(b||(b=d,b[this.system.xi]=g.GetPosition().x,b[this.system.yi]=g.GetPosition().y),g.ApplyForce({x:a[this.system.xi],y:a[this.system.yi]},{x:b[this.system.xi],y:b[this.system.yi]}))},applyImpulse:function(a,
b){var g=this.entity.body2d.body;g&&(b||(b=d,b[this.system.xi]=g.GetPosition().x,b[this.system.yi]=g.GetPosition().y),g.ApplyImpulse({x:a[this.system.xi],y:a[this.system.yi]},{x:b[this.system.xi],y:b[this.system.yi]}))},setLinearVelocity:function(a,b){var d=this.entity.body2d.body;if(d){var f=d.GetLinearVelocity();f.x=a;f.y=b;d.SetLinearVelocity(f)}},setAngularVelocity:function(a){var b=this.entity.body2d.body;b&&b.SetAngularVelocity(a)},setTransform:function(b){b.getTranslation(d);b.getEulerAngles(a);
b=this._eulersToAngle(a);this.setPositionAndAngle(d.data[this.system.xi],d.data[this.system.yi],-b)},setPosition:function(a,b){var d=this.entity.body2d.body;if(d){d.SetAwake(!0);var f=d.GetPosition();f.x=a;f.y=b;d.SetPosition(f);this.updateTransform(d)}},setAngle:function(a){var b=this.entity.body2d.body;b&&(b.SetAwake(!0),b.SetAngle(a*pc.math.DEG_TO_RAD),this.updateTransform(b))},setPositionAndAngle:function(a,b,d){var f=this.entity.body2d.body;if(f){f.SetAwake(!0);var k=f.GetPosition();k.x=a;k.y=
b;f.SetPositionAndAngle(k,d*pc.math.DEG_TO_RAD);this.updateTransform(f)}},getAngle:function(){return this.entity.body2d.body.GetAngle()*pc.math.RAD_TO_DEG},setLinearDamping:function(a,b){var d=this.entity.body2d.body;d&&d.SetLinearDamping(b)},updateTransform:function(b){var e=this.entity.getPosition();this.entity.getLocalEulerAngles();var g=b.GetPosition();d.data[this.system.xi]=g.x;d.data[this.system.ri]=e.y;d.data[this.system.yi]=g.y;a.data[this.system.xi]=0;a.data[this.system.ri]=-b.GetAngle()*
pc.math.RAD_TO_DEG;a.data[this.system.yi]=0;this.entity.setPosition(d);this.entity.setEulerAngles(a)},onSetStatic:function(a,b,d){(a=this.entity.body2d.body)&&(d?a.SetType((void 0).b2_staticBody):a.SetType((void 0).b2_dynamicBody))},onLiveLinkUpdateTransform:function(){this.setTransform(this.entity.getWorldTransform());this.setLinearVelocity(0,0);this.setAngularVelocity(0)},_eulersToAngle:function(a){var b=a[this.system.ri];179.9<a[this.system.xi]&&179.9<a[this.system.yi]&&(b=180-a[this.system.ri]);
return b}});return{Body2dComponent:b}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.static=!0;this.shape=pc.shape.Type.RECT;this.body=this.bodyDef=null},pc.fw.ComponentData);return{Body2dComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b,c=function(c){"undefined"!==typeof Box2D&&!d&&(d=Box2D.Dynamics.b2World,a=Box2D.Dynamics.b2FixtureDef,b=Box2D.Collision.Shapes.b2PolygonShape);this.id="collisionrect";c.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionRectComponent;this.DataType=pc.fw.CollisionRectComponentData;this.schema=[{name:"density",displayName:"Density",description:"The density of the body, this determine the mass",type:"number",options:{min:0,step:0.01},defaultValue:1},{name:"friction",
displayName:"Friction",description:"The friction when the body slides along another body",type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"x",displayName:"Size: X",description:"The size of the Rect in the x-axis",type:"number",options:{min:0,
step:0.1},defaultValue:0.5},{name:"y",displayName:"Size: Y",description:"The size of the Rect in the y-axis",type:"number",options:{min:0,step:0.1},defaultValue:0.5},{name:"model",expose:!1}];this.exposeProperties();var c=c.graphicsDevice,g=new pc.gfx.VertexFormat(c,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),g=new pc.gfx.VertexBuffer(c,g,4);(new Float32Array(g.lock())).set([-0.5,0,-0.5,-0.5,0,0.5,0.5,0,0.5,0.5,0,-0.5]);g.unlock();c=new pc.gfx.IndexBuffer(c,
pc.gfx.INDEXFORMAT_UINT8,8);(new Uint8Array(c.lock())).set([0,1,1,2,2,3,3,0]);c.unlock();this.mesh=new pc.scene.Mesh;this.mesh.vertexBuffer=g;this.mesh.indexBuffer[0]=c;this.mesh.primitive[0].type=pc.gfx.PRIMITIVE_LINES;this.mesh.primitive[0].base=0;this.mesh.primitive[0].count=c.getNumIndices();this.mesh.primitive[0].indexed=!0;this.material=new pc.scene.BasicMaterial;this.material.color=new pc.Color(0,0,1,1);this.material.update();this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},c=pc.inherits(c,pc.fw.ComponentSystem);c.prototype=pc.extend(c.prototype,{initializeComponentData:function(a,b,d){b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[new pc.scene.MeshInstance(b.model.graph,this.mesh,this.material)];d="density friction restitution x y model".split(" ");c._super.initializeComponentData.call(this,a,b,d);"undefined"!==typeof Box2D&&(a.fixtureDef=this.createFixtureDef(a.entity,
a),a.entity.body2d&&this.context.systems.body2d.createBody(a.entity.body2d))},createFixtureDef:function(c,d){var f=new a;f.density=d.density;f.friction=d.friction;f.restitution=d.restitution;f.shape=new b;f.shape.SetAsBox(d.x,d.y);f.userData=c;return f},onRemove:function(a,b){a.body2d&&a.body2d.body&&this.context.systems.body2d.removeBody(a,a.body2d.body);this.context.scene.containsModel(b.model)&&(this.context.scene.removeModel(b.model),this.context.root.removeChild(b.model.graph))},setDebugRender:function(a){this.debugRender=
a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b=this.context.systems.body2d.xi,c=this.context.systems.body2d.yi,d=this.context.systems.body2d.ri,l;for(l in a){var n=a[l].entity,r=a[l].data;this.context.scene.containsModel(r.model)||(this.context.scene.addModel(r.model),this.context.root.addChild(r.model.graph));var m=[];m[b]=2*r.x;m[c]=2*r.y;m[d]=1;r=r.model.graph;r.setPosition(n.getPosition());
r.setRotation(n.getRotation());r.setLocalScale(m[0],m[1],m[2])}}});return{CollisionRectComponentSystem:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_density",this.onSetDensity,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_x",this.onSetX,this);this.on("set_y",this.onSetY,this)},pc.fw.Component);pc.extend(d.prototype,{onSetDensity:function(a,b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetDensity(c),this.entity.body2d.body.ResetMassData())},onSetFriction:function(a,
b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetFriction(c),this.entity.body2d.body.ResetMassData())},onSetRestitution:function(a,b,c){this.entity.body2d&&this.entity.body2d.body&&(this.entity.body2d.body.GetFixtureList().SetRestitution(c),this.entity.body2d.body.ResetMassData())},onSetX:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().GetShape().SetAsBox(c,this.y),a.SetAwake(!0)},onSetY:function(a,b,c){if(this.entity.body2d&&
(a=this.entity.body2d.body))a.GetFixtureList().GetShape().SetAsBox(this.x,c),a.SetAwake(!0)}});return{CollisionRectComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.y=this.x=0.5},pc.fw.ComponentData);return{CollisionRectComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b,c=function(c){"undefined"!==typeof Box2D&&!d&&(d=Box2D.Dynamics.b2World,a=Box2D.Dynamics.b2FixtureDef,b=Box2D.Collision.Shapes.b2CircleShape);this.id="collisioncircle";c.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionCircleComponent;this.DataType=pc.fw.CollisionCircleComponentData;this.schema=[{name:"density",displayName:"Density",description:"The density of the body, this determine the mass",type:"number",options:{min:0,step:0.01},defaultValue:1},
{name:"friction",displayName:"Friction",description:"The friction when the body slides along another body",type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"radius",displayName:"Radius",description:"The size of the Rect in the x-axis",
type:"number",options:{min:0,step:0.1},defaultValue:1},{name:"model",exposed:!1}];this.exposeProperties();var g=c.graphicsDevice,c=new pc.gfx.VertexFormat(g,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(g,c,41),f=new Float32Array(c.lock()),k,l=c.getNumVertices();for(k=0;k<l-1;k++){var n=2*Math.PI*(k/(l-2)),r=0.5*Math.cos(n),n=0.5*Math.sin(n);f[3*k+0]=r;f[3*k+1]=0;f[3*k+2]=n}c.unlock();g=new pc.gfx.IndexBuffer(g,pc.gfx.INDEXFORMAT_UINT8,
80);f=new Uint8Array(g.lock());for(k=0;40>k;k++)f[2*k+0]=k,f[2*k+1]=k+1;g.unlock();this.mesh=new pc.scene.Mesh;this.mesh.vertexBuffer=c;this.mesh.indexBuffer[0]=g;this.mesh.primitive[0].type=pc.gfx.PRIMITIVE_LINES;this.mesh.primitive[0].base=0;this.mesh.primitive[0].count=g.getNumIndices();this.mesh.primitive[0].indexed=!0;this.material=new pc.scene.BasicMaterial;this.material.color=pc.Color(0,0,1,1);this.material.update();this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",
this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},c=pc.inherits(c,pc.fw.ComponentSystem);pc.extend(c.prototype,{initializeComponentData:function(a,b,d){b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[new pc.scene.MeshInstance(b.model.graph,this.mesh,this.material)];d=["density","friction","restitution","radius","model"];c._super.initializeComponentData.call(this,a,b,d);"undefined"!==typeof Box2D&&(a.fixtureDef=this.createFixtureDef(a.entity,
a),a.entity.body2d&&this.context.systems.body2d.createBody(a.entity.body2d))},createFixtureDef:function(c,d){var f=new a;f.density=d.density;f.friction=d.friction;f.restitution=d.restitution;f.shape=new b;f.shape.SetRadius(d.radius);f.userData=c;return f},onRemove:function(a,b){a.body2d&&a.body2d.body&&this.context.systems.body2d.removeBody(a,a.body2d.body);this.context.scene.containsModel(b.model)&&(this.context.scene.removeModel(b.model),this.context.root.removeChild(b.model.graph))},setDebugRender:function(a){this.debugRender=
a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a){var c=a[b].entity,d=a[b].data;this.context.scene.containsModel(d.model)||(this.context.scene.addModel(d.model),this.context.root.addChild(d.model.graph));var l=d.radius,d=d.model.graph;d.setPosition(c.getPosition());d.setRotation(c.getRotation());d.setLocalScale(l/0.5,l/0.5,l/0.5)}}});return{CollisionCircleComponentSystem:c}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_density",this.onSetDensity,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_radius",this.onSetRadius,this)},pc.fw.Component);pc.extend(d.prototype,{onSetDensity:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetDensity(c),a.ResetMassData()},onSetFriction:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetFriction(c),
a.ResetMassData()},onSetRestitution:function(a,b,c){if(this.entity.body2d&&(a=this.entity.body2d.body))a.GetFixtureList().SetRestitution(c),a.ResetMassData()},onSetRadius:function(){if(this.entity.body2d){var a=this.entity.body2d.body;a&&(a.GetFixtureList().GetShape().SetRadius(this.radius),a.SetAwake(!0))}}});return{CollisionCircleComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.density=1;this.friction=0.5;this.restitution=0;this.radius=1},pc.fw.ComponentData);return{CollisionCircleComponentData:d}}());pc.extend(pc.fw,function(){new pc.Mat4;new pc.Mat4;new pc.Vec3;new pc.Vec3;new pc.Vec3;var d,a,b={},c={},e=[],g=[],f=[[0,39,0],[39,39,24],[0,24,0]],k=function(a,b,c){this.entity=a;this.point=b;this.normal=c},l=function(a,b,c){this.a=a;this.b=b;this.localPointA=c.localPoint;this.localPointB=c.localPointOther;this.pointA=c.point;this.pointB=c.pointOther;this.normal=c.normal},n=function(a,b,c,d,e){this.localPoint=a;this.localPointOther=b;this.point=c;this.pointOther=d;this.normal=e},r=function(a,b){this.other=
a;this.contacts=b},m=function(a){this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";a.systems.add(this.id,this);this.ComponentType=pc.fw.RigidBodyComponent;this.DataType=pc.fw.RigidBodyComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the rigid body",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of body determines how it moves and collides with other bodies. Dynamic is a normal body. Static will never move. Kinematic can be moved in code, but will not respond to collisions.",
type:"enumeration",options:{enumerations:[{name:"Static",value:pc.fw.RIGIDBODY_TYPE_STATIC},{name:"Dynamic",value:pc.fw.RIGIDBODY_TYPE_DYNAMIC},{name:"Kinematic",value:pc.fw.RIGIDBODY_TYPE_KINEMATIC}]},defaultValue:pc.fw.RIGIDBODY_TYPE_STATIC},{name:"mass",displayName:"Mass",description:"The mass of the body",type:"number",options:{min:0,step:1},defaultValue:1,filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"linearDamping",displayName:"Linear Damping",description:"The linear damping applied to the body",
type:"number",options:{min:0,step:1},defaultValue:0,filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"angularDamping",displayName:"Angular Damping",description:"The angular damping applied to the body",type:"number",options:{min:0,step:1},defaultValue:0,filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"linearFactor",displayName:"Linear Factor",description:"The linear factor applied to the linear motion of the body, used to contrain linear movement in each axis",
type:"vector",options:{min:0,step:0.1},defaultValue:[1,1,1],filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"angularFactor",displayName:"Angular Factor",description:"The angular factor applied to the angular motion of the body, used to contrain angular movement in each axis",type:"vector",options:{min:0,step:0.1},defaultValue:[1,1,1],filter:{type:[pc.fw.RIGIDBODY_TYPE_DYNAMIC,pc.fw.RIGIDBODY_TYPE_KINEMATIC]}},{name:"friction",displayName:"Friction",description:"The friction when the body slides along another body",
type:"number",options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object doesn't bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"body",exposed:!1}];this.exposeProperties();this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this)},m=
pc.inherits(m,pc.fw.ComponentSystem);pc.extend(m.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){var b=new Ammo.btDefaultCollisionConfiguration,c=new Ammo.btCollisionDispatcher(b),e=new Ammo.btDbvtBroadphase,f=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(c,e,f,b);this._ammoGravity=new Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);d=new Ammo.btVector3;a=new Ammo.btVector3}else pc.fw.ComponentSystem.off("update",
this.onUpdate,this)},initializeComponentData:function(a,b,c){b.bodyType&&(b.type=b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));b.linearFactor&&"array"===pc.type(b.linearFactor)&&(b.linearFactor=new pc.Vec3(b.linearFactor[0],b.linearFactor[1],b.linearFactor[2]));b.angularFactor&&"array"===pc.type(b.angularFactor)&&(b.angularFactor=new pc.Vec3(b.angularFactor[0],b.angularFactor[1],b.angularFactor[2]));c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type".split(" ");
m._super.initializeComponentData.call(this,a,b,c);a.createBody()},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,
type:a.rigidbody.type})},onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a){this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var a,b,c;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,c=arguments[0].z):(a=arguments[0],
b=arguments[1],c=arguments[2]);this._ammoGravity.setValue(a,b,c);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,c,e){d.setValue(b.x,b.y,b.z);a.setValue(c.x,c.y,c.z);b=new Ammo.ClosestRayResultCallback(d,a);this.dynamicsWorld.rayTest(d,a,b);if(b.hasHit()){var c=b.get_m_collisionObject(),c=Ammo.wrapPointer(c,Ammo.btCollisionObject),c=btRigidBody.prototype.upcast(c),f=b.get_m_hitPointWorld(),g=b.get_m_hitNormalWorld();c&&e(new k(c.entity,new pc.Vec3(f.x(),f.y(),f.z()),new pc.Vec3(g.x(),
g.y(),g.z())))}Ammo.destroy(b)},_storeCollision:function(a,d){var e=!1,f=a.getGuid();b[f]=b[f]||{others:[],entity:a};0>b[f].others.indexOf(d)&&(b[f].others.push(d),e=!0);c[f]=c[f]||{others:[],entity:a};c[f].others.push(d);return e},_handleEntityCollision:function(a,b,c,d){var e;d&1&&(e=new r(b,c),a.collision.fire("contact",e));if((d&2||d&8)&&this._storeCollision(a,b))d&2&&(e=e||new r(b,c),a.collision.fire("collisionstart",e)),d&8&&a.collision.fire("triggerenter",b)},_createContactPointFromAmmo:function(a){var b=
new pc.Vec3(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z()),c=new pc.Vec3(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z()),d=new pc.Vec3(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z()),e=new pc.Vec3(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z()),a=new pc.Vec3(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return new n(b,c,
d,e,a)},_createReverseContactPointFromAmmo:function(a){var b=new pc.Vec3(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z()),c=new pc.Vec3(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z()),d=new pc.Vec3(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z()),e=new pc.Vec3(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z()),a=new pc.Vec3(-a.get_m_normalWorldOnB().x(),-a.get_m_normalWorldOnB().y(),
-a.get_m_normalWorldOnB().z());return new n(c,b,e,d,a)},_cleanOldCollisions:function(){for(var a in b)if(b.hasOwnProperty(a)){for(var d=b[a].entity,e=d.collision,f=b[a].others,k=f.length;k--;){var g=f[k];if(!c[a]||0>c[a].others.indexOf(g))if(f.splice(k,1),e&&g.collision){var l=this._getCollisionFlags(d,g);l&4&&e.fire("collisionend",g);l&16&&e.fire("triggerleave",g)}}0===f.length&&delete b[a]}},_getCollisionFlags:function(a,b){var c=a.rigidbody,d=b.rigidbody,e=!c,k=!d;if(e&&k)return 0;var g=this.store,
c=c&&g[a.getGuid()].data.type!==pc.fw.RIGIDBODY_TYPE_STATIC,d=d&&g[b.getGuid()].data.type!==pc.fw.RIGIDBODY_TYPE_STATIC,l=g=0;c?g=1:e&&(g=2);d?l=1:k&&(l=2);if(e=f[g][l])k=a.collision,this.hasEvent("contact")||(e&=-33),k.hasEvent("contact")||(e&=-2),k.hasEvent("collisionstart")||(e&=-3),k.hasEvent("collisionend")||(e&=-5),k.hasEvent("triggerenter")||(e&=-9),k.hasEvent("triggerleave")||(e&=-17);return e},onUpdate:function(a){this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var b=
this.store,d;for(d in b)if(b.hasOwnProperty(d)){var f=b[d].entity,k=b[d].data;k.body&&(k.body.isActive()&&k.enabled&&f.enabled)&&(k.type===pc.fw.RIGIDBODY_TYPE_DYNAMIC?f.rigidbody.syncBodyToEntity():k.type===pc.fw.RIGIDBODY_TYPE_KINEMATIC&&f.rigidbody.updateKinematic(a))}var a=this.dynamicsWorld.getDispatcher(),b=a.getNumManifolds(),m;c={};for(d=0;d<b;d++){f=a.getManifoldByIndexInternal(d);m=f.getBody0();k=f.getBody1();m=btRigidBody.prototype.upcast(m);var n=btRigidBody.prototype.upcast(k),k=m.entity,
n=n.entity;if(k&&n){var r=this._getCollisionFlags(k,n),B=this._getCollisionFlags(n,k);if(r||B){var E=f.getNumContacts();if(0<E){var C,H=r&2||r&1,x=B&2||B&1;e.length=0;for(m=g.length=0;m<E;m++){var y=f.getContactPoint(m);r&32&&(C=this._createContactPointFromAmmo(y),this.fire("contact",new l(k,n,C)));H&&(C=C||this._createContactPointFromAmmo(y),e.push(C));x&&g.push(this._createReverseContactPointFromAmmo(y))}this._handleEntityCollision(k,n,e,r);this._handleEntityCollision(n,k,g,B)}}}}this._cleanOldCollisions()}});
return{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:m}}());pc.extend(pc.fw,function(){var d,a,b,c,e,g=function(f,k){"undefined"!==typeof Ammo&&!d&&(d=new Ammo.btTransform,a=new Ammo.btVector3,b=new Ammo.btVector3,c=new Ammo.btQuaternion,e=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",
this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_body",this.onSetBody,this);k.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);this.system.on("beforeremove",this.onBeforeRemove,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)},g=pc.inherits(g,pc.fw.Component);Object.defineProperty(g.prototype,"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");
return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(g.prototype,"linearVelocity",{get:function(){if(this.isKinematic())return this._linearVelocity;if(this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z());return this._linearVelocity}},set:function(b){this.activate();if(this.isKinematic())this._linearVelocity.copy(b);else{var c=this.body;c&&(a.setValue(b.x,b.y,
b.z),c.setLinearVelocity(a))}}});Object.defineProperty(g.prototype,"angularVelocity",{get:function(){if(this.isKinematic())return this._angularVelocity;if(this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z());return this._angularVelocity}},set:function(b){this.activate();if(this.isKinematic())this._angularVelocity.copy(b);else{var c=this.body;c&&(a.setValue(b.x,b.y,b.z),c.setAngularVelocity(a))}}});pc.extend(g.prototype,{createBody:function(){var b=this.entity,
d;b.collision&&(d=b.collision.shape);if(d){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var e=this.isStaticOrKinematic(),g=e?0:this.mass,r=new Ammo.btVector3(0,0,0);e||d.calculateLocalInertia(g,r);var e=b.getPosition(),m=b.getRotation();c.setValue(m.x,m.y,m.z,m.w);m=new Ammo.btTransform;m.setIdentity();m.getOrigin().setValue(e.x,e.y,e.z);m.setRotation(c);e=new Ammo.btDefaultMotionState(m);d=new Ammo.btRigidBodyConstructionInfo(g,e,d,r);d=new Ammo.btRigidBody(d);d.setRestitution(this.restitution);
d.setFriction(this.friction);d.setDamping(this.linearDamping,this.angularDamping);g=this.linearFactor;a.setValue(g.x,g.y,g.z);d.setLinearFactor(a);g=this.angularFactor;a.setValue(g.x,g.y,g.z);d.setAngularFactor(a);d.entity=b;this.isKinematic()&&(d.setCollisionFlags(d.getCollisionFlags()|pc.fw.RIGIDBODY_CF_KINEMATIC_OBJECT),d.setActivationState(pc.fw.RIGIDBODY_DISABLE_DEACTIVATION));b.rigidbody.body=d;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){return this.body?
this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled){var a=this.body;a&&(this.system.addBody(a),this.isKinematic()?a.forceActivationState(pc.fw.RIGIDBODY_DISABLE_DEACTIVATION):a.forceActivationState(pc.fw.RIGIDBODY_ACTIVE_TAG),a.activate())}},disableSimulation:function(){var a=this.body;a&&(this.system.removeBody(a),a.forceActivationState(pc.fw.RIGIDBODY_DISABLE_SIMULATION))},applyForce:function(){var c,
d,g,n,r,m;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;n=arguments[1].x;r=arguments[1].y;m=arguments[1].z;break;case 3:c=arguments[0];d=arguments[1];g=arguments[2];break;case 6:c=arguments[0],d=arguments[1],g=arguments[2],n=arguments[0],r=arguments[1],m=arguments[2]}var s=this.body;s&&(s.activate(),a.setValue(c,d,g),"undefined"!==typeof n?(b.setValue(n,r,m),s.applyForce(a,b)):s.applyForce(a,e))},
applyTorque:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:console.error("ERROR: applyTorque: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,c,d),e.applyTorque(a))},applyImpulse:function(){var c,d,g,n,r,m;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;d=arguments[0].y;
g=arguments[0].z;n=arguments[1].x;r=arguments[1].y;m=arguments[1].z;break;case 3:c=arguments[0];d=arguments[1];g=arguments[2];break;case 6:c=arguments[0],d=arguments[1],g=arguments[2],n=arguments[0],r=arguments[1],m=arguments[2]}var s=this.body;s&&(s.activate(),a.setValue(c,d,g),"undefined"!==typeof n?(b.setValue(n,r,m),s.applyImpulse(a,b)):s.applyImpulse(a,e))},applyTorqueImpulse:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=
arguments[0];c=arguments[1];d=arguments[2];break;default:console.error("ERROR: applyTorqueImpulse: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,c,d),e.applyTorqueImpulse(a))},isStatic:function(){return this.type===pc.fw.RIGIDBODY_TYPE_STATIC},isStaticOrKinematic:function(){return this.type===pc.fw.RIGIDBODY_TYPE_STATIC||this.type===pc.fw.RIGIDBODY_TYPE_KINEMATIC},isKinematic:function(){return this.type===pc.fw.RIGIDBODY_TYPE_KINEMATIC},syncEntityToBody:function(){var a=
this.body;if(a){var b=this.entity.getPosition(),d=this.entity.getRotation(),e=a.getWorldTransform();e.getOrigin().setValue(b.x,b.y,b.z);c.setValue(d.x,d.y,d.z,d.w);e.setRotation(c);a.activate()}},syncBodyToEntity:function(){var a=this.body;if(a.isActive()&&a.getMotionState()){a.getMotionState().getWorldTransform(d);var a=d.getOrigin(),b=d.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);
this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){var a=this.entity.getPosition(),b=this.entity.getRotation();d.getOrigin().setValue(a.x,a.y,a.z);c.setValue(b.x,b.y,b.z,b.w);d.setRotation(c);this.body.getMotionState().setWorldTransform(d)}},onEnable:function(){g._super.onEnable.call(this);this.enableSimulation()},onDisable:function(){g._super.onDisable.call(this);
this.disableSimulation()},onSetMass:function(a,b,c){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var d=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(c,d);a.setMassProps(c,d);a.updateInertiaTensor();b&&this.enableSimulation()}},onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,c)},onSetLinearFactor:function(b,
c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setAngularFactor(a)},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&this.createBody()},onSetBody:function(){this.body&&this.body.activate()},onLiveLinkUpdateTransform:function(){this.syncEntityToBody();this.angularVelocity=
this.linearVelocity=pc.Vec3.ZERO},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{RigidBodyComponent:g}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=0.5;this.restitution=0;this.type=pc.fw.RIGIDBODY_TYPE_STATIC;this.body=null},pc.fw.ComponentData);return{RigidBodyComponentData:d}}());pc.extend(pc.fw,function(){var d,a,b=function(b,e,g){this.entity=e.entity;this.component=e;this.context=b;"undefined"!==typeof Ammo&&(d=new Ammo.btVector3,a=new Ammo.btQuaternion);this.initialize(g)};b.prototype={initialize:function(b){var e=this.entity;if((b=b.shape)&&"undefined"!==typeof Ammo){e.trigger&&e.trigger.destroy();var g=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,g);var f=e.getPosition(),k=e.getRotation();a.setValue(k.x,k.y,k.z,k.w);k=new Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(f.x,
f.y,f.z);k.setRotation(a);f=new Ammo.btDefaultMotionState(k);b=new Ammo.btRigidBodyConstructionInfo(1,f,b,g);this.body=b=new Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);d.setValue(0,0,0);b.setLinearFactor(d);b.setAngularFactor(d);b.setCollisionFlags(b.getCollisionFlags()|pc.fw.RIGIDBODY_CF_NORESPONSE_OBJECT);b.entity=e;this.component.enabled&&e.enabled&&this.enable()}},destroy:function(){this.body&&this.context.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var b=
this.body;if(b){var d=this.entity.getPosition(),g=this.entity.getRotation(),f=b.getWorldTransform();f.getOrigin().setValue(d.x,d.y,d.z);a.setValue(g.x,g.y,g.z,g.w);f.setRotation(a);b.activate()}},enable:function(){var a=this.body;this.context.systems.rigidbody.addBody(a);a.forceActivationState(pc.fw.RIGIDBODY_ACTIVE_TAG);a.activate()},disable:function(){var a=this.body;this.context.systems.rigidbody.removeBody(a);a.forceActivationState(pc.fw.RIGIDBODY_DISABLE_SIMULATION)}};return{Trigger:b}}());pc.extend(pc.fw,function(){var d=function(a){this.id="collision";this.description="Specifies a collision volume.";a.systems.add(this.id,this);this.ComponentType=pc.fw.CollisionComponent;this.DataType=pc.fw.CollisionComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the collision",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the collision volume",type:"enumeration",options:{enumerations:[{name:"Box",value:"box"},
{name:"Sphere",value:"sphere"},{name:"Capsule",value:"capsule"},{name:"Cylinder",value:"cylinder"},{name:"Mesh",value:"mesh"}]},defaultValue:"box"},{name:"halfExtents",displayName:"Half Extents",description:"The half-extents of the box",type:"vector",options:{min:0,step:0.1},defaultValue:[0.5,0.5,0.5],filter:{type:"box"}},{name:"radius",displayName:"Radius",description:"The radius of the collision volume",type:"number",options:{min:0,step:0.1},defaultValue:0.5,filter:{type:["sphere","capsule","cylinder"]}},
{name:"axis",displayName:"Axis",description:"Major axis of the volume",type:"enumeration",options:{enumerations:[{name:"X",value:0},{name:"Y",value:1},{name:"Z",value:2}]},defaultValue:1,filter:{type:["capsule","cylinder"]}},{name:"height",displayName:"Height",description:"Height of the volume",type:"number",options:{min:0,step:0.1},defaultValue:2,filter:{type:["capsule","cylinder"]}},{name:"asset",displayName:"Asset",description:"Collision mesh asset",type:"asset",options:{max:1,type:"model"},defaultValue:null,
filter:{type:"mesh"}},{name:"shape",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype=pc.extend(d.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,
b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.halfExtents&&"array"===pc.type(b.halfExtents)&&(b.halfExtents=new pc.Vec3(b.halfExtents[0],b.halfExtents[1],b.halfExtents[2]));var e=this._createImplementation(b.type);e.beforeInitialize(a,b);c="type halfExtents radius axis height shape model asset enabled".split(" ");d._super.initializeComponentData.call(this.system,a,b,c);e.afterInitialize(a,b)},_createImplementation:function(a){if("undefined"===typeof this.implementations[a]){var b;switch(a){case "box":b=
new CollisionBoxSystemImpl(this);break;case "sphere":b=new CollisionSphereSystemImpl(this);break;case "capsule":b=new CollisionCapsuleSystemImpl(this);break;case "cylinder":b=new CollisionCylinderSystemImpl(this);break;case "mesh":b=new CollisionMeshSystemImpl(this);break;default:throw"Invalid collision system type: "+a;}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,
b)},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(){var a,b,c,d=this.store;for(a in d)b=d[a].entity,c=d[a].data,c.enabled&&b.enabled&&(b.rigidbody||b.trigger.syncEntityToBody()),this.debugRender&&this.updateDebugShape(b,c,this._getImplementation(b))},updateDebugShape:function(a,b,c){var d=this.context;if("undefined"!==typeof c&&c.hasDebugShape){if(b.model)if(d.scene.containsModel(b.model)){if(!b.enabled||!a.enabled)d.root.removeChild(b.model.graph),d.scene.removeModel(b.model)}else a.enabled&&
b.enabled&&(d.scene.addModel(b.model),d.root.addChild(b.model.graph));b.enabled&&a.enabled&&c.updateDebugShape(a,b)}},onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},onToolsUpdate:function(){var a,b,c=this.store;for(a in c)b=c[a].entity,this.updateDebugShape(b,c[a].data,this._getImplementation(b))},setDebugRender:function(a){this.debugRender=a},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,
a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});CollisionSystemImpl=function(a){this.system=a;this.hasDebugShape=!0};CollisionSystemImpl.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new pc.scene.Model;b.model.graph=new pc.scene.GraphNode;b.model.meshInstances=[this.createDebugMesh(b)]},afterInitialize:function(a){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,
b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;"undefined"!==typeof Ammo&&(c.shape=this.createPhysicalShape(a.entity,c),b.rigidbody?b.rigidbody.createBody():(b.trigger||(b.trigger=new pc.fw.Trigger(this.system.context,a,c)),b.trigger.initialize(c)))},createDebugMesh:function(){},createPhysicalShape:function(){},updateDebugShape:function(){},updateTransform:function(a){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},remove:function(a,b){var c=this.system.context;
a.rigidbody&&a.rigidbody.body&&c.systems.rigidbody.removeBody(a.rigidbody.body);a.trigger&&a.trigger.destroy();c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){var c=this.system.dataStore[a.getGuid()];return this.system.addComponent(b,{enabled:c.data.enabled,type:c.data.type,halfExtents:[c.data.halfExtents.x,c.data.halfExtents.y,c.data.halfExtents.z],radius:c.data.radius,axis:c.data.axis,height:c.data.height,asset:c.data.asset,model:c.data.model})}};
CollisionBoxSystemImpl=function(){};CollisionBoxSystemImpl=pc.inherits(CollisionBoxSystemImpl,CollisionSystemImpl);CollisionBoxSystemImpl.prototype=pc.extend(CollisionBoxSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(b,c,8);(new Float32Array(c.lock())).set([-0.5,-0.5,-0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,
-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,-0.5]);c.unlock();b=new pc.gfx.IndexBuffer(b,pc.gfx.INDEXFORMAT_UINT8,24);(new Uint8Array(b.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);b.unlock();var d=new pc.scene.Mesh;d.vertexBuffer=c;d.indexBuffer[0]=b;d.primitive[0].type=pc.gfx.PRIMITIVE_LINES;d.primitive[0].base=0;d.primitive[0].count=b.getNumIndices();d.primitive[0].indexed=!0;this.mesh=d}this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,0,1,1),
c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo){var c=b.halfExtents,c=new Ammo.btVector3(c.x,c.y,c.z);return new Ammo.btBoxShape(c)}},updateDebugShape:function(a,b){var c=b.halfExtents,d=c.x,g=c.y,c=c.z,f=b.model.graph;f.setPosition(a.getPosition());f.setRotation(a.getRotation());f.setLocalScale(2*d,2*g,2*c)}});CollisionSphereSystemImpl=function(){};CollisionSphereSystemImpl=pc.inherits(CollisionSphereSystemImpl,
CollisionSystemImpl);CollisionSphereSystemImpl.prototype=pc.extend(CollisionSphereSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){for(var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),b=new pc.gfx.VertexBuffer(b,c,240),c=new Float32Array(b.lock()),d,g=0,f,k=0;3>k;k++){var l=0,n=1,r=2;1===k?(l=1,n=0,r=2):2===k&&(l=0,n=2,r=1);for(d=0;40>d;d++)f=2*Math.PI*(d/40),c[g+l]=0.5*Math.cos(f),
c[g+n]=0,c[g+r]=0.5*Math.sin(f),g+=3,f=2*Math.PI*((d+1)/40),c[g+l]=0.5*Math.cos(f),c[g+n]=0,c[g+r]=0.5*Math.sin(f),g+=3}b.unlock();c=new pc.scene.Mesh;c.vertexBuffer=b;c.primitive[0].type=pc.gfx.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumVertices();c.primitive[0].indexed=!1;this.mesh=c}this.material||(b=new pc.scene.BasicMaterial,b.color=new pc.Color(0,0,1,1),b.update(),this.material=b);return new pc.scene.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,
b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());var d=2*b.radius;c.setLocalScale(d,d,d)}});CollisionCapsuleSystemImpl=function(){};CollisionCapsuleSystemImpl=pc.inherits(CollisionCapsuleSystemImpl,CollisionSystemImpl);CollisionCapsuleSystemImpl.prototype=pc.extend(CollisionCapsuleSystemImpl.prototype,{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&
a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(b,c,328,pc.gfx.BUFFER_DYNAMIC);this.updateCapsuleShape(a,c);b=new pc.scene.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.gfx.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=!1;this.mesh=b;this.material||(c=new pc.scene.BasicMaterial,
c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,b,this.material)},updateCapsuleShape:function(a,b){var c="undefined"!==typeof a.axis?a.axis:1,d=a.radius||0.5,g=Math.max((a.height||2)-2*d,0),f=new Float32Array(b.lock()),k=0,l=1,n=2;0===c?(k=1,l=0,n=2):2===c&&(k=0,l=2,n=1);var r=0,m;for(cap=-1;2>cap;cap+=2){for(c=0;40>c;c++)m=2*Math.PI*(c/40),f[r+k]=d*Math.cos(m),f[r+l]=0.5*cap*g,f[r+n]=d*Math.sin(m),r+=3,m=2*Math.PI*((c+1)/40),f[r+k]=d*Math.cos(m),
f[r+l]=0.5*cap*g,f[r+n]=d*Math.sin(m),r+=3;for(c=0;20>c;c++)m=Math.PI*(c/20)+1.5*Math.PI,f[r+k]=0,f[r+l]=cap*(0.5*g+d*Math.cos(m)),f[r+n]=cap*d*Math.sin(m),r+=3,m=Math.PI*((c+1)/20)+1.5*Math.PI,f[r+k]=0,f[r+l]=cap*(0.5*g+d*Math.cos(m)),f[r+n]=cap*d*Math.sin(m),r+=3;for(c=0;20>c;c++)m=Math.PI*(c/20)+1.5*Math.PI,f[r+k]=cap*d*Math.sin(m),f[r+l]=cap*(0.5*g+d*Math.cos(m)),f[r+n]=0,r+=3,m=Math.PI*((c+1)/20)+1.5*Math.PI,f[r+k]=cap*d*Math.sin(m),f[r+l]=cap*(0.5*g+d*Math.cos(m)),f[r+n]=0,r+=3}for(c=0;4>c;c++)m=
2*Math.PI*(c/4),f[r+k]=d*Math.cos(m),f[r+l]=0.5*g,f[r+n]=d*Math.sin(m),r+=3,m=2*Math.PI*(c/4),f[r+k]=d*Math.cos(m),f[r+l]=0.5*-g,f[r+n]=d*Math.sin(m),r+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,d="undefined"!==typeof b.axis?b.axis:1,g=b.radius||0.5,f=Math.max((b.height||2)-2*g,0);if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btCapsuleShapeX(g,f);break;case 1:c=new Ammo.btCapsuleShape(g,f);break;case 2:c=new Ammo.btCapsuleShapeZ(g,f)}return c},updateDebugShape:function(a,
b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCapsuleShape(a.data,b);CollisionCapsuleSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionCylinderSystemImpl=function(){};CollisionCylinderSystemImpl=pc.inherits(CollisionCylinderSystemImpl,CollisionSystemImpl);CollisionCylinderSystemImpl.prototype=pc.extend(CollisionCylinderSystemImpl.prototype,
{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.context.graphicsDevice,c=new pc.gfx.VertexFormat(b,[{semantic:pc.gfx.SEMANTIC_POSITION,components:3,type:pc.gfx.ELEMENTTYPE_FLOAT32}]),c=new pc.gfx.VertexBuffer(b,c,168,pc.gfx.BUFFER_DYNAMIC);this.updateCylinderShape(a,c);b=new pc.scene.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.gfx.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();
b.primitive[0].indexed=!1;this.material||(c=new pc.scene.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.scene.MeshInstance(a.model.graph,b,this.material)},updateCylinderShape:function(a,b){var c="undefined"!==typeof a.axis?a.axis:1,d="undefined"!==typeof a.radius?a.radius:0.5,g="undefined"!==typeof a.height?a.height:1,f=new Float32Array(b.lock()),k=0,l=1,n=2;0===c?(k=1,l=0,n=2):2===c&&(k=0,l=2,n=1);var r=0,m;for(cap=-1;2>cap;cap+=2)for(c=0;40>c;c++)m=2*Math.PI*
(c/40),f[r+k]=d*Math.cos(m),f[r+l]=0.5*cap*g,f[r+n]=d*Math.sin(m),r+=3,m=2*Math.PI*((c+1)/40),f[r+k]=d*Math.cos(m),f[r+l]=0.5*cap*g,f[r+n]=d*Math.sin(m),r+=3;for(c=0;4>c;c++)m=2*Math.PI*(c/4),f[r+k]=d*Math.cos(m),f[r+l]=0.5*g,f[r+n]=d*Math.sin(m),r+=3,m=2*Math.PI*(c/4),f[r+k]=d*Math.cos(m),f[r+l]=0.5*-g,f[r+n]=d*Math.sin(m),r+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,c=null,d="undefined"!==typeof b.axis?b.axis:1,g="undefined"!==typeof b.radius?b.radius:0.5,f="undefined"!==typeof b.height?
b.height:1;if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btVector3(0.5*f,g,g);c=new Ammo.btCylinderShapeX(c);break;case 1:c=new Ammo.btVector3(g,0.5*f,g);c=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(g,g,0.5*f),c=new Ammo.btCylinderShapeZ(c)}return c},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=this.createDebugMesh(a.data).mesh.vertexBuffer;
this.updateCylinderShape(a.data,b);CollisionCylinderSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionMeshSystemImpl=function(){this.hasDebugShape=!1};CollisionMeshSystemImpl=pc.inherits(CollisionMeshSystemImpl,CollisionSystemImpl);CollisionMeshSystemImpl.prototype=pc.extend(CollisionMeshSystemImpl.prototype,{beforeInitialize:function(){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model,d=new Ammo.btCompoundShape,g,f;for(g=0;g<c.meshInstances.length;g++){var k=
c.meshInstances[g],l=k.mesh,n=l.indexBuffer[pc.scene.RENDERSTYLE_SOLID],r=l.vertexBuffer,m=r.getFormat(),s=m.size/4,h;for(f=0;f<m.elements.length;f++){var u=m.elements[f];u.name===pc.gfx.SEMANTIC_POSITION&&(h=new Float32Array(r.lock(),u.offset))}var n=new Uint16Array(n.lock()),r=l.primitive[0].count/3,m=new Ammo.btVector3,u=new Ammo.btVector3,F=new Ammo.btVector3,z,v,w=l.primitive[0].base,A=new Ammo.btTriangleMesh;for(f=0;f<r;f++)l=n[w+3*f]*s,z=n[w+3*f+1]*s,v=n[w+3*f+2]*s,m.setValue(h[l],h[l+1],h[l+
2]),u.setValue(h[z],h[z+1],h[z+2]),F.setValue(h[v],h[v+1],h[v+2]),A.addTriangle(m,u,F,!0);f=new Ammo.btBvhTriangleMeshShape(A,!0);s=k.node.getWorldTransform().getScale();f.setLocalScaling(new Ammo.btVector3(s.x,s.y,s.z));s=k.node.getPosition();k=k.node.getRotation();n=new Ammo.btTransform;n.setIdentity();n.getOrigin().setValue(s.x,s.y,s.z);s=new Ammo.btQuaternion;s.setValue(k.x,k.y,k.z,k.w);n.setRotation(s);d.addChildShape(n,f)}c=a.getWorldTransform().getScale();g=new Ammo.btVector3;g.setValue(c.x,
c.y,c.z);d.setLocalScaling(g);return d}},recreatePhysicalShapes:function(a){var b=a.data;b.asset?this.loadModelAsset(a):(b.model=null,this.doRecreatePhysicalShape(a))},loadModelAsset:function(a){var b=a.data.asset,c=a.data,d={parent:a.entity.getRequest()},g=this.system.context.assets.getAssetByResourceId(b);g?this.system.context.assets.load(g,[],d).then(function(b){c.model=b[0];this.doRecreatePhysicalShape(a)}.bind(this)):logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",
b))},doRecreatePhysicalShape:function(a){var b=a.entity,c=a.data;c.model?(c.shape&&Ammo.destroy(c.shape),c.shape=this.createPhysicalShape(b,c),b.rigidbody?b.rigidbody.createBody():(b.trigger||(b.trigger=new pc.fw.Trigger(this.system.context,a,c)),b.trigger.initialize(c))):this.remove(b,c)},updateTransform:function(a,b,c,d){if(a.shape){var g=a.entity.getWorldTransform().getScale(),f=a.shape.getLocalScaling();(g.x!==f.x()||g.y!==f.y()||g.z!==f.z())&&this.doRecreatePhysicalShape(a)}CollisionMeshSystemImpl._super.updateTransform.call(this,
a,b,c,d)}});return{CollisionComponentSystem:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);a.on("beforeremove",this.onBeforeRemove,this)},d=pc.inherits(d,pc.fw.Component);pc.extend(d.prototype,{onSetType:function(a,
b,c){b!==c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(){this.data.initialized&&"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(){this.data.initialized&&("sphere"===this.data.type||"capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetHeight:function(){this.data.initialized&&("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAxis:function(){this.data.initialized&&
("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAsset:function(){this.data.initialized&&"mesh"===this.data.type&&this.system.recreatePhysicalShapes(this)},onEnable:function(){d._super.onEnable.call(this);this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){d._super.onDisable.call(this);this.entity.trigger?this.entity.trigger.disable():
this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()},onLiveLinkUpdateTransform:function(a,b,c){if(this.enabled&&this.entity.enabled)this.system.onTransformChanged(this,a,b,c)},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{CollisionComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(0.5,0.5,0.5);this.radius=0.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.fw.ComponentData);return{CollisionComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this.id="ballsocketjoint";a.systems.add(this.id,this);this.ComponentType=pc.fw.BallSocketJointComponent;this.DataType=pc.fw.BallSocketJointComponentData;this.schema=[{name:"pivot",displayName:"Pivot",description:"Local space pivot",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"position",displayName:"Position",description:"World space joint position",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"tau",displayName:"Tau",
description:"TBD",type:"number",defaultValue:0.001,options:{min:0,max:1}},{name:"damping",displayName:"Damping",description:"Damping",type:"number",defaultValue:1,options:{min:0,max:1}},{name:"impulseClamp",displayName:"Impulse Clamp",description:"Impulse Clamp",type:"number",defaultValue:0,options:{min:0,max:100}},{name:"constraint",exposed:!1}];this.debugRender=!1;this.on("remove",this.onRemove,this);pc.fw.ComponentSystem.on("update",this.onUpdate,this);pc.fw.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,
this)},d=pc.inherits(d,pc.fw.ComponentSystem);d.prototype=pc.extend(d.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.fw.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){"undefined"!==typeof Ammo&&a.entity.rigidbody&&(b.pivot&&"array"===pc.type(b.pivot)&&(b.pivot=new pc.Vec3(b.pivot[0],b.pivot[1],b.pivot[2])),b.position&&"array"===pc.type(b.position)&&(b.position=new pc.Vec3(b.position[0],b.position[1],b.position[2])),c=new Ammo.btVector3(b.pivot.x,
b.pivot.y,b.pivot.z),b.constraint=new Ammo.btPoint2PointConstraint(a.entity.rigidbody.body,c),c=b.constraint.getPivotInB(),b.position=[c.x(),c.y(),c.z()],this.context.systems.rigidbody.addConstraint(b.constraint));c="constraint pivot position tau damping impulseClamp".split(" ");d._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){return this.addComponent(b,{pivot:[a.ballsocketjoint.pivot.x,a.ballsocketjoint.pivot.y,a.ballsocketjoint.pivot.z],position:[a.ballsocketjoint.position.x,
a.ballsocketjoint.position.y,a.ballsocketjoint.position.z],tau:a.ballsocketjoint.tau,damping:a.ballsocketjoint.damping,impulseClamp:a.ballsocketjoint.impulseClamp})},onRemove:function(a,b){b.constraint&&this.context.systems.rigidbody.removeConstraint(b.constraint)},setDebugRender:function(a){this.debugRender=a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a);}});return{BallSocketJointComponentSystem:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.on("set_pivot",this.onSetPivot,this);this.on("set_position",this.onSetPosition,this);this.on("set_tau",this.onSetTau,this);this.on("set_damping",this.onSetDamping,this);this.on("set_impulseClamp",this.onSetImpulseClamp,this)},pc.fw.Component);pc.extend(d.prototype,{onSetPivot:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotA(a))},onSetPosition:function(a,
b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotB(a))},onSetTau:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_tau(c)},onSetDamping:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_damping(c)},onSetImpulseClamp:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_impulseClamp(c)}});
return{BallSocketJointComponent:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this.pivot=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.tau=0.3;this.damping=1;this.impulseClamp=0;this.constraint=null},pc.fw.ComponentData);return{BallSocketJointComponentData:d}}());pc.extend(pc.fw,function(){var d=function(a){this._destinations=[];this._callbacks={};this._linkid=(a||"")+"-"+pc.guid.create();this._listener=null;this._handler=this._handleMessage.bind(this);window.addEventListener("message",this._handler,!1);pc.livelinks||(pc.livelinks=[]);pc.livelinks.push(this)};d.prototype.detach=function(){this._listener=null;window.removeEventListener("message",this._handler,!1)};d.prototype.addDestinationWindow=function(a){this._destinations.push(a)};d.prototype.removeDestinationWindow=
function(a){var b;for(b=0;b<this._destinations.length;++b)if(this._destinations[b]==a){this._destinations.splice(b,1);break}};d.prototype.send=function(a,b){var b=b||function(){},c,d=this._destinations.length,g=[];for(c=0;c<d;c++){var f=this._destinations[c];f.closed?g.push(f):this._send(a,b,f,f.location.protocol+"//"+f.location.host)}d=g.length;for(c=0;c<d;c++)this.removeDestinationWindow(g[c])};d.prototype._send=function(a,b,c,d){a.senderid=this._linkid;this._callbacks[a.id]?this._callbacks[a.id].count++:
this._callbacks[a.id]={count:1,callback:b?b.bind(this):function(){}};var g=pc.fw.LiveLinkMessage.serialize(a);c===window?pc.livelinks.forEach(function(a){a._handleMessage({source:window,data:g})}):c.postMessage(g,d)};d.prototype.listen=function(a){if(this._listener)throw Error("LiveLink already listening");this._listener=a};d.prototype._handleMessage=function(a){var b,c;if(b=pc.fw.LiveLinkMessage.deserialize(a.data))b=new pc.fw.LiveLinkMessage(b,a.source),this._linkid!==b.senderid&&(b.type==pc.fw.LiveLinkMessageType.RECEIVED?
b.content.received_from==this._linkid&&(this._callbacks[b.content.id].count--,0===this._callbacks[b.content.id].count&&(this._callbacks[b.content.id].callback(),delete this._callbacks[b.content.id])):this._listener&&(this._listener(b),c=new pc.fw.LiveLinkMessage,c.type=pc.fw.LiveLinkMessageType.RECEIVED,c.content={id:b.id,received_from:b.senderid},this._send(c,null,a.source,a.origin)))};return{LiveLink:d}}());pc.extend(pc.fw,function(){var d=function(a,b){a=a||{};this.type=a.type||pc.fw.LiveLinkMessageType.NO_TYPE;this.content=a.content||{};this.id=a.id||pc.guid.create();this.senderid=a.senderid||null;this.source=b||null};d.register=function(a){pc.fw.LiveLinkMessageType[a]=a};d.serialize=function(a){return JSON.stringify({type:a.type,content:a.content,id:a.id,senderid:a.senderid},function(a){return this[a]instanceof Float32Array?pc.makeArray(this[a]):this[a]})};d.deserialize=function(a){try{return JSON.parse(a)}catch(b){return null}};
return{LiveLinkMessage:d,LiveLinkMessageRegister:{},LiveLinkMessageType:{NO_TYPE:"NO_TYPE",RECEIVED:"RECEIVED"}}}());pc.extend(pc.fw,function(){var d=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.UPDATE_COMPONENT;this.content={id:a,component:b,attribute:c,value:d}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_COMPONENT");return{LiveLinkUpdateComponentMessage:d}}());pc.extend(pc.fw,function(){var d=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY;this.content={id:a,components:b}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY");var a=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM;this.content={id:a,position:b,rotation:c,scale:d}},a=pc.inherits(a,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_TRANSFORM");var b=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_NAME;
this.content={id:a,name:b}},b=pc.inherits(b,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_NAME");var c=function(a,b){this.type=pc.fw.LiveLinkMessageType.UPDATE_ENTITY_ENABLED;this.content={id:a,enabled:b}},c=pc.inherits(c,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ENTITY_ENABLED");var e=function(a,b,c,d){this.type=pc.fw.LiveLinkMessageType.REPARENT_ENTITY;this.content={id:a,oldParentId:b,newParentId:c,index:d}},e=pc.inherits(e,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("REPARENT_ENTITY");
return{LiveLinkUpdateEntityMessage:d,LiveLinkUpdateEntityNameMessage:b,LiveLinkUpdateEntityEnabledMessage:c,LiveLinkUpdateEntityTransformMessage:a,LiveLinkReparentEntityMessage:e}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.CLOSE_ENTITY;this.content={id:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("CLOSE_ENTITY");return{LiveLinkCloseEntityMessage:d}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.OPEN_ENTITY;this.content={entity:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("OPEN_ENTITY");var a=function(a,c){this.type=pc.fw.LiveLinkMessageType.OPEN_PACK;this.content={pack:pc.extend({},c.getData())};this.content.pack.hierarchy=PCD.model.Entity.toData(a)},a=pc.inherits(a,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("OPEN_PACK");return{LiveLinkOpenEntityMessage:d,LiveLinkOpenPackMessage:a}}());pc.extend(pc.fw,function(){var d=function(a,b,c){this.type=pc.fw.LiveLinkMessageType.UPDATE_ASSET;this.content={id:a,attribute:b,value:c}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_ASSET");return{LiveLinkUpdateAssetMessage:d}}());pc.extend(pc.fw,function(){var d=function(a){this.type=pc.fw.LiveLinkMessageType.UPDATE_PACK_SETTINGS;this.content={settings:a}},d=pc.inherits(d,pc.fw.LiveLinkMessage);pc.fw.LiveLinkMessage.register("UPDATE_PACK_SETTINGS");return{LiveLinkUpdatePackSettings:d}}());pc.extend(pc.fw,function(){var d;d=pc.inherits(function(){this._guid=pc.guid.create();this._batchHandle=null;this.c={};pc.events.attach(this)},pc.scene.GraphNode);d.prototype.getGuid=function(){return this._guid};d.prototype.setGuid=function(a){this._guid=a};d.prototype._onHierarchyStateChanged=function(a){pc.fw.Entity._super._onHierarchyStateChanged.call(this,a);var b,c=this.c;for(type in c)if(c.hasOwnProperty(type)&&(b=c[type],b.enabled))if(a)b.onEnable();else b.onDisable()};d.prototype.setRequest=
function(a){this._request=a};d.prototype.getRequest=function(){return this._request};d.prototype.addChild=function(a){if(a instanceof pc.fw.Entity&&this.getRoot().findOne("getGuid",a.getGuid()))throw Error("GUID already exists in graph");pc.scene.GraphNode.prototype.addChild.call(this,a)};d.prototype.findByGuid=function(a){if(this._guid===a)return this;for(var b=0;b<this._children.length;b++)if(this._children[b].findByGuid){var c=this._children[b].findByGuid(a);if(null!==c)return c}return null};d.prototype.destroy=
function(){var a=this.getParent(),b;for(b in this.c)this.c[b].system.removeComponent(this);a&&a.removeChild(this);a=this.getChildren();for(b=a.shift();b;)b instanceof pc.fw.Entity&&b.destroy(),b=a.shift()};d.prototype.clone=function(){var a,b=new pc.fw.Entity;pc.fw.Entity._super._cloneInternal.call(this,b);for(a in this.c)this.c[a].system.cloneComponent(this,b);for(a=0;a<this.getChildren().length;a++){var c=this.getChildren()[a];c instanceof pc.fw.Entity&&b.addChild(c.clone())}return b};d.deserialize=
function(a){var b=pc.json.parse(a.template),c=pc.json.parse(a.parent),d=pc.json.parse(a.children),g=pc.json.parse(a.transform),f=pc.json.parse(a.components),k=pc.json.parse(a.labels);return{_id:a._id,resource_id:a.resource_id,_rev:a._rev,name:a.name,enabled:a.enabled,labels:k,template:b,parent:c,children:d,transform:g,components:f}};d.serialize=function(a){var b={_id:a._id,resource_id:a.resource_id,name:a.name,enabled:a.enabled,labels:pc.json.stringify(a.labels),template:pc.json.stringify(a.template),
parent:pc.json.stringify(a.parent),children:pc.json.stringify(a.children),transform:pc.json.stringify(a.transform),components:pc.json.stringify(a.components)};a._rev&&(b._rev=a._rev);return b};return{Entity:d}}());pc.asset={};
pc.extend(pc.asset,function(){var d=function(a,b,c,d,g){this.resourceId=pc.guid.create();this.name=a;this.type=b;this.file=c?{filename:c.filename,size:c.size,hash:c.hash,url:c.url}:null;this.data=d||{};this.prefix=g||"";pc.events.attach(this)};d.prototype={getFileUrl:function(){if(!this.file)return null;var a=this.file.url,b="";this.prefix&&(b=this.prefix);return pc.path.join(b,a)}};return{Asset:d,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",
ASSET_TEXT:"text",ASSET_TEXTURE:"texture"}}());pc.extend(pc.asset,function(){var d=function(a,b){if(!a)throw Error("Must provide a ResourceLoader instance for AssetRegistry");this.loader=a;this._prefix=b||"";this._cache={};this._names={}};d.prototype={update:function(a){for(var b in a.assets){var c=this.getAssetByResourceId(b);c?pc.extend(c,a.assets[b]):(c=a.assets[b],c=new pc.asset.Asset(c.name,c.type,c.file,c.data,this._prefix),c.resourceId=b,this.addAsset(c),c.file&&this.loader.registerHash(c.file.hash,c.getFileUrl()))}},all:function(){return Object.keys(this._cache).map(function(a){return this.getAssetByResourceId(a)},
this)},addAsset:function(a){this._cache[a.resourceId]=a;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(a.resourceId)},findAll:function(a,b){var c=this,d=this._names[a];return d?(d=d.map(function(a){return c._cache[a]}),b?d.filter(function(a){return a.type===b}):d):[]},find:function(a,b){var c=this.findAll(a,b);return c?c[0]:null},getAssetByResourceId:function(a){return this._cache[a]},getAssetByName:function(a){console.warn("WARNING: getAssetByName: Function is deprecated. Use find() or findAll() instead.");
return this.find(a)},load:function(a,b,c){a.length||(a=[a]);"undefined"===typeof c&&(c=b,b=[]);var d=[];a.forEach(function(a,c){this.getAssetByResourceId(a.resourceId)||this.addAsset(a);switch(a.type){case pc.asset.ASSET_MODEL:d.push(this._createModelRequest(a));break;case pc.asset.ASSET_TEXTURE:d.push(this._createTextureRequest(a,b[c]));break;default:d.push(this._createAssetRequest(a))}},this);return this.loader.request(d.filter(function(a){return null!==a}),c).then(null,function(a){setTimeout(function(){throw a;
},0)})},_createAssetRequest:function(a){var b=a.getFileUrl();return b?this.loader.createFileRequest(b,a.type):null},_createModelRequest:function(a){var b=a.getFileUrl();return new pc.resources.ModelRequest(b,a.data&&a.data.mapping?a.data.mapping:[])},_createTextureRequest:function(a,b){return new pc.resources.TextureRequest(a.getFileUrl(),null,b)}};return{AssetRegistry:d}}());(function(){var d,a,b={},c={};d=function(a,c,d){b[a]={deps:c,callback:d}};a=function(d){if(c[d])return c[d];c[d]={};for(var g=b[d],f=g.deps,g=g.callback,k=[],l,n=0,r=f.length;n<r;n++)"exports"===f[n]?k.push(l={}):k.push(a(f[n]));f=g.apply(this,k);return c[d]=l||f};d("rsvp","rsvp/events rsvp/promise rsvp/node rsvp/all rsvp/hash rsvp/defer rsvp/config rsvp/resolve exports".split(" "),function(a,b,c,d,l,n,r,m,s){var a=a.EventTarget,c=c.denodeify,d=d.all,l=l.hash,n=n.defer,h=r.config,r=m.resolve;s.Promise=
b.Promise;s.EventTarget=a;s.all=d;s.hash=l;s.defer=n;s.denodeify=c;s.configure=function(a,b){h[a]=b};s.resolve=r});d("rsvp/async",["exports"],function(a){var b="undefined"!==typeof window?window:{},b=b.MutationObserver||b.WebKitMutationObserver;if("undefined"!==typeof process&&"[object process]"==={}.toString.call(process))b=function(a,b){process.nextTick(function(){a.call(b)})};else if(b){var c=[],d=new b(function(){var a=c.slice();c=[];a.forEach(function(a){a[0].call(a[1])})}),l=document.createElement("div");
d.observe(l,{attributes:!0});b=function(a,b){c.push([a,b]);l.setAttribute("drainQueue","drainQueue")}}else b=function(a,b){setTimeout(function(){a.call(b)},1)};a.async=b});d("rsvp/hash",["rsvp/defer","exports"],function(a,b){var c=a.defer;b.hash=function(a){var b={},d=c(),e,g=0,s;for(s in a)g++;e=g;0===e&&d.resolve({});g=function(a){return function(c){b[a]=c;0===--e&&d.resolve(b)}};s=function(a){d.reject(a)};for(var h in a)a[h]&&
"function"===typeof a[h].then?a[h].then(g(h),s):(b[h]=a[h],0===--e&&d.resolve(b));return d.promise}});d("rsvp/node",["rsvp/promise","rsvp/all","exports"],function(a,b,c){function d(a,b){return function(c,d){c?b(c):2<arguments.length?a(Array.prototype.slice.call(arguments,1)):a(d)}}var l=a.Promise,n=b.all;c.denodeify=function(a){return function(){var b=Array.prototype.slice.call(arguments),c,e,f=new l(function(a,b){c=a;e=b});n(b).then(function(b){b.push(d(c,e));try{a.apply(this,b)}catch(f){e(f)}});
return f}}});d("rsvp/defer",["rsvp/promise","exports"],function(a,b){var c=a.Promise;b.defer=function(){var a={},b=new c(function(b,c){a.resolve=b;a.reject=c});a.promise=b;return a}});d("rsvp/config",["rsvp/async","exports"],function(a,b){var c={};c.async=a.async;b.config=c});d("rsvp/all",["rsvp/defer","exports"],function(a,b){var c=a.defer;b.all=function(a){var b=[],d=c(),e=a.length;0===e&&d.resolve([]);for(var g=function(a){return function(c){b[a]=c;0===--e&&d.resolve(b)}},s=function(a){d.reject(a)},
h=0;h<a.length;h++)a[h]&&"function"===typeof a[h].then?a[h].then(g(h),s):(b[h]=a[h],0===--e&&d.resolve(b));return d.promise}});d("rsvp/resolve",["rsvp/promise","exports"],function(a,b){var c=a.Promise;b.resolve=function(a){return new c(function(b,c){var d;try{"function"===typeof a||"object"===typeof a&&null!==a?(d=a.then,"function"===typeof d?d.call(a,b,c):b(a)):b(a)}catch(e){c(e)}})}});d("rsvp/promise",["rsvp/config","rsvp/events","exports"],function(a,b,c){function d(a){return"function"===typeof a}
function l(a,b){a===b?n(a,b):(d(b)||"object"===typeof b&&null!==b)&&d(b.then)?b.then(function(c){b!==c?l(a,c):n(a,c)},function(b){r(a,b)}):n(a,b)}function n(a,b){m.async(function(){a.trigger("promise:resolved",{detail:b});a.isFulfilled=!0;a.fulfillmentValue=b})}function r(a,b){m.async(function(){a.trigger("promise:failed",{detail:b});a.isRejected=!0;a.rejectedReason=b})}var m=a.config,a=b.EventTarget,s=function(a){var b=this,c=!1;if("function"!==typeof a)throw new TypeError("You must pass a resolver function as the sole argument to the promise constructor");
if(!(b instanceof s))return new s(a);this.on("promise:resolved",function(a){this.trigger("success",{detail:a.detail})},this);this.on("promise:failed",function(a){this.trigger("error",{detail:a.detail})},this);a(function(a){c||(c=!0,l(b,a))},function(a){c||(c=!0,r(b,a))})},h=function(a,b,c,e){var f=d(c),g,h,m,n;if(f)try{g=c(e.detail),m=!0}catch(s){n=!0,h=s}else g=e.detail,m=!0;(d(g)||"object"===typeof g&&null!==g)&&d(g.then)?g.then(function(a){l(b,a)},function(a){r(b,a)}):f&&m?l(b,g):n?r(b,h):"resolve"===
a?l(b,g):"reject"===a&&r(b,g)};s.prototype={constructor:s,then:function(a,b){var c=new s(function(){});this.isFulfilled&&m.async(function(){h("resolve",c,a,{detail:this.fulfillmentValue})},this);this.isRejected&&m.async(function(){h("reject",c,b,{detail:this.rejectedReason})},this);this.on("promise:resolved",function(b){h("resolve",c,a,b)});this.on("promise:failed",function(a){h("reject",c,b,a)});return c}};a.mixin(s.prototype);c.Promise=s});d("rsvp/events",["exports"],function(a){var b=function(a,
b){this.type=a;for(var c in b)b.hasOwnProperty(c)&&(this[c]=b[c])},c=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c][0]===b)return c;return-1},d=function(a){var b=a._promiseCallbacks;b||(b=a._promiseCallbacks={});return b};a.EventTarget={mixin:function(a){a.on=this.on;a.off=this.off;a.trigger=this.trigger;return a},on:function(a,b,e){for(var g=d(this),s,h,a=a.split(/\s+/),e=e||this;h=a.shift();)(s=g[h])||(s=g[h]=[]),-1===c(s,b)&&s.push([b,e])},off:function(a,b){for(var e=d(this),g,s,a=a.split(/\s+/);g=
a.shift();)b?(g=e[g],s=c(g,b),-1!==s&&g.splice(s,1)):e[g]=[]},trigger:function(a,c){var e,f,s,h;if(e=d(this)[a])for(var u=0;u<e.length;u++)f=e[u],s=f[0],f=f[1],"object"!==typeof c&&(c={detail:c}),h=new b(a,c),s.call(f,h)}}});window.RSVP=a("rsvp")})();
