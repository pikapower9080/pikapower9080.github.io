/*

        ______                       _____                _              
        | ___ \                     |  ___|              (_)             
        | |_/ / _   _  _ __   ___   | |__   _ __    __ _  _  _ __    ___ 
        |  __/ | | | || '__| / _ \  |  __| | '_ \  / _` || || '_ \  / _ \
        | |    | |_| || |   | (_) | | |___ | | | || (_| || || | | ||  __/
        \_|     \__, ||_|    \___/  \____/ |_| |_| \__, ||_||_| |_| \___|
                 __/ |                              __/ |                
                |___/                              |___/                 
                
                                                    Â© Smashplug LLC 2013
            
            Shannon Poole and Brian Poole @ Smashplug LLC 2013 - 2014
            
    A vector based game engine designed to be extremely efficient in JavaScript.
    
    
    
    * Notice *
      This file contains works from many authors under various (but compatible)
      licenses. Please visit http://example.com/notices for more information.
  
        * box2djs
        * glmatrix
  
*/

var Pyro=function(){function w(){return{fetchCache:function(){for(var p=0;100>p;p++);}}}var L={pyro:"Smashplug Pyro Engine version 0.9.2"};(function(){var p;"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(p={},define(function(){return p})):p=window:p=exports;(function(a){if(!m)var m=1E-6;if(!h)var h="undefined"!=typeof Float32Array?Float32Array:Array;var f={setMatrixArrayType:function(b){h=b}};"undefined"!=typeof a&&(a.glMatrix=f);var q={create:function(){var b=
new h(2);return b[0]=0,b[1]=0,b},clone:function(b){var c=new h(2);return c[0]=b[0],c[1]=b[1],c},fromValues:function(b,c){var k=new h(2);return k[0]=b,k[1]=c,k},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b},set:function(b,c,k){return b[0]=c,b[1]=k,b},add:function(b,c,k){return b[0]=c[0]+k[0],b[1]=c[1]+k[1],b},subtract:function(b,c,k){return b[0]=c[0]-k[0],b[1]=c[1]-k[1],b}};q.sub=q.subtract;q.multiply=function(b,c,k){return b[0]=c[0]*k[0],b[1]=c[1]*k[1],b};q.mul=q.multiply;q.divide=function(b,c,
k){return b[0]=c[0]/k[0],b[1]=c[1]/k[1],b};q.div=q.divide;q.min=function(b,c,k){return b[0]=Math.min(c[0],k[0]),b[1]=Math.min(c[1],k[1]),b};q.max=function(b,c,k){return b[0]=Math.max(c[0],k[0]),b[1]=Math.max(c[1],k[1]),b};q.scale=function(b,c,k){return b[0]=c[0]*k,b[1]=c[1]*k,b};q.distance=function(b,c){var k=c[0]-b[0],g=c[1]-b[1];return Math.sqrt(k*k+g*g)};q.dist=q.distance;q.squaredDistance=function(b,c){var k=c[0]-b[0],g=c[1]-b[1];return k*k+g*g};q.sqrDist=q.squaredDistance;q.length=function(b){var c=
b[0];b=b[1];return Math.sqrt(c*c+b*b)};q.len=q.length;q.squaredLength=function(b){var c=b[0];b=b[1];return c*c+b*b};q.sqrLen=q.squaredLength;q.negate=function(b,c){return b[0]=-c[0],b[1]=-c[1],b};q.normalize=function(b,c){var k=c[0],g=c[1],k=k*k+g*g;return 0<k&&(k=1/Math.sqrt(k),b[0]=c[0]*k,b[1]=c[1]*k),b};q.dot=function(b,c){return b[0]*c[0]+b[1]*c[1]};q.cross=function(b,c,k){c=c[0]*k[1]-c[1]*k[0];return b[0]=b[1]=0,b[2]=c,b};q.lerp=function(b,c,k,g){var d=c[0];c=c[1];return b[0]=d+g*(k[0]-d),b[1]=
c+g*(k[1]-c),b};q.rotate=function(b,c,k){var g=Math.sin(k);k=Math.cos(k);var d=c[0];c=c[1];return b[0]=k*d+-g*c,b[1]=g*d+k*c,b};q.rotateAround=function(b,c,k,g){var d=Math.sin(g);g=Math.cos(g);var a=c[0]-k[0];c=c[1]-k[1];return b[0]=g*a+-d*c+k[0],b[1]=d*a+g*c+k[1],b};q.transformMat2=function(b,c,k){var g=c[0];c=c[1];return b[0]=k[0]*g+k[2]*c,b[1]=k[1]*g+k[3]*c,b};q.transformMat2d=function(b,c,k){var g=c[0];c=c[1];return b[0]=k[0]*g+k[2]*c+k[4],b[1]=k[1]*g+k[3]*c+k[5],b};q.transformMat3=function(b,
c,k){var g=c[0];c=c[1];return b[0]=k[0]*g+k[3]*c+k[6],b[1]=k[1]*g+k[4]*c+k[7],b};q.transformMat4=function(b,c,k){var g=c[0];c=c[1];return b[0]=k[0]*g+k[4]*c+k[12],b[1]=k[1]*g+k[5]*c+k[13],b};q.forEach=function(){var b=q.create();return function(c,k,g,d,a,f){var h;k||(k=2);g||(g=0);for(d?h=Math.min(d*k+g,c.length):h=c.length;g<h;g+=k)b[0]=c[g],b[1]=c[g+1],a(b,b,f),c[g]=b[0],c[g+1]=b[1];return c}}();q.str=function(b){return"vec2("+b[0]+", "+b[1]+")"};"undefined"!=typeof a&&(a.vec2=q);var d={create:function(){var b=
new h(3);return b[0]=0,b[1]=0,b[2]=0,b},clone:function(b){var c=new h(3);return c[0]=b[0],c[1]=b[1],c[2]=b[2],c},fromValues:function(b,c,k){var g=new h(3);return g[0]=b,g[1]=c,g[2]=k,g},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b},set:function(b,c,k,g){return b[0]=c,b[1]=k,b[2]=g,b},add:function(b,c,k){return b[0]=c[0]+k[0],b[1]=c[1]+k[1],b[2]=c[2]+k[2],b},subtract:function(b,c,k){return b[0]=c[0]-k[0],b[1]=c[1]-k[1],b[2]=c[2]-k[2],b}};d.sub=d.subtract;d.multiply=function(b,c,k){return b[0]=
c[0]*k[0],b[1]=c[1]*k[1],b[2]=c[2]*k[2],b};d.mul=d.multiply;d.divide=function(b,c,k){return b[0]=c[0]/k[0],b[1]=c[1]/k[1],b[2]=c[2]/k[2],b};d.div=d.divide;d.min=function(b,c,k){return b[0]=Math.min(c[0],k[0]),b[1]=Math.min(c[1],k[1]),b[2]=Math.min(c[2],k[2]),b};d.max=function(b,c,k){return b[0]=Math.max(c[0],k[0]),b[1]=Math.max(c[1],k[1]),b[2]=Math.max(c[2],k[2]),b};d.scale=function(b,c,k){return b[0]=c[0]*k,b[1]=c[1]*k,b[2]=c[2]*k,b};d.distance=function(b,c){var k=c[0]-b[0],g=c[1]-b[1],d=c[2]-b[2];
return Math.sqrt(k*k+g*g+d*d)};d.dist=d.distance;d.squaredDistance=function(b,c){var k=c[0]-b[0],g=c[1]-b[1],d=c[2]-b[2];return k*k+g*g+d*d};d.sqrDist=d.squaredDistance;d.length=function(b){var c=b[0],k=b[1];b=b[2];return Math.sqrt(c*c+k*k+b*b)};d.len=d.length;d.squaredLength=function(b){var c=b[0],k=b[1];b=b[2];return c*c+k*k+b*b};d.sqrLen=d.squaredLength;d.negate=function(b,c){return b[0]=-c[0],b[1]=-c[1],b[2]=-c[2],b};d.normalize=function(b,c){var k=c[0],g=c[1],d=c[2],k=k*k+g*g+d*d;return 0<k&&
(k=1/Math.sqrt(k),b[0]=c[0]*k,b[1]=c[1]*k,b[2]=c[2]*k),b};d.dot=function(b,c){return b[0]*c[0]+b[1]*c[1]+b[2]*c[2]};d.cross=function(b,c,k){var g=c[0],d=c[1];c=c[2];var a=k[0],f=k[1];k=k[2];return b[0]=d*k-c*f,b[1]=c*a-g*k,b[2]=g*f-d*a,b};d.lerp=function(b,c,k,g){var d=c[0],a=c[1];c=c[2];return b[0]=d+g*(k[0]-d),b[1]=a+g*(k[1]-a),b[2]=c+g*(k[2]-c),b};d.transformMat4=function(b,c,k){var g=c[0],d=c[1];c=c[2];return b[0]=k[0]*g+k[4]*d+k[8]*c+k[12],b[1]=k[1]*g+k[5]*d+k[9]*c+k[13],b[2]=k[2]*g+k[6]*d+k[10]*
c+k[14],b};d.transformQuat=function(b,c,k){var g=c[0],d=c[1],a=c[2];c=k[0];var f=k[1],h=k[2];k=k[3];var s=k*g+f*a-h*d,q=k*d+h*g-c*a,m=k*a+c*d-f*g,g=-c*g-f*d-h*a;return b[0]=s*k+g*-c+q*-h-m*-f,b[1]=q*k+g*-f+m*-c-s*-h,b[2]=m*k+g*-h+s*-f-q*-c,b};d.forEach=function(){var b=d.create();return function(c,k,g,d,a,f){var h;k||(k=3);g||(g=0);for(d?h=Math.min(d*k+g,c.length):h=c.length;g<h;g+=k)b[0]=c[g],b[1]=c[g+1],b[2]=c[g+2],a(b,b,f),c[g]=b[0],c[g+1]=b[1],c[g+2]=b[2];return c}}();d.str=function(b){return"vec3("+
b[0]+", "+b[1]+", "+b[2]+")"};"undefined"!=typeof a&&(a.vec3=d);var s={create:function(){var b=new h(4);return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b},clone:function(b){var c=new h(4);return c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c},fromValues:function(b,c,k,g){var d=new h(4);return d[0]=b,d[1]=c,d[2]=k,d[3]=g,d},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b},set:function(b,c,k,g,d){return b[0]=c,b[1]=k,b[2]=g,b[3]=d,b},add:function(b,c,k){return b[0]=c[0]+k[0],b[1]=c[1]+k[1],b[2]=c[2]+
k[2],b[3]=c[3]+k[3],b},subtract:function(b,c,k){return b[0]=c[0]-k[0],b[1]=c[1]-k[1],b[2]=c[2]-k[2],b[3]=c[3]-k[3],b}};s.sub=s.subtract;s.multiply=function(b,c,k){return b[0]=c[0]*k[0],b[1]=c[1]*k[1],b[2]=c[2]*k[2],b[3]=c[3]*k[3],b};s.mul=s.multiply;s.divide=function(b,c,k){return b[0]=c[0]/k[0],b[1]=c[1]/k[1],b[2]=c[2]/k[2],b[3]=c[3]/k[3],b};s.div=s.divide;s.min=function(b,c,k){return b[0]=Math.min(c[0],k[0]),b[1]=Math.min(c[1],k[1]),b[2]=Math.min(c[2],k[2]),b[3]=Math.min(c[3],k[3]),b};s.max=function(b,
c,k){return b[0]=Math.max(c[0],k[0]),b[1]=Math.max(c[1],k[1]),b[2]=Math.max(c[2],k[2]),b[3]=Math.max(c[3],k[3]),b};s.scale=function(b,c,k){return b[0]=c[0]*k,b[1]=c[1]*k,b[2]=c[2]*k,b[3]=c[3]*k,b};s.distance=function(b,c){var k=c[0]-b[0],g=c[1]-b[1],d=c[2]-b[2],a=c[3]-b[3];return Math.sqrt(k*k+g*g+d*d+a*a)};s.dist=s.distance;s.squaredDistance=function(b,c){var k=c[0]-b[0],g=c[1]-b[1],d=c[2]-b[2],a=c[3]-b[3];return k*k+g*g+d*d+a*a};s.sqrDist=s.squaredDistance;s.length=function(b){var c=b[0],k=b[1],
g=b[2];b=b[3];return Math.sqrt(c*c+k*k+g*g+b*b)};s.len=s.length;s.squaredLength=function(b){var c=b[0],k=b[1],g=b[2];b=b[3];return c*c+k*k+g*g+b*b};s.sqrLen=s.squaredLength;s.negate=function(b,c){return b[0]=-c[0],b[1]=-c[1],b[2]=-c[2],b[3]=-c[3],b};s.normalize=function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],k=k*k+g*g+d*d+a*a;return 0<k&&(k=1/Math.sqrt(k),b[0]=c[0]*k,b[1]=c[1]*k,b[2]=c[2]*k,b[3]=c[3]*k),b};s.dot=function(b,c){return b[0]*c[0]+b[1]*c[1]+b[2]*c[2]+b[3]*c[3]};s.lerp=function(b,c,k,g){var d=
c[0],a=c[1],f=c[2];c=c[3];return b[0]=d+g*(k[0]-d),b[1]=a+g*(k[1]-a),b[2]=f+g*(k[2]-f),b[3]=c+g*(k[3]-c),b};s.transformMat4=function(b,c,k){var g=c[0],d=c[1],a=c[2];c=c[3];return b[0]=k[0]*g+k[4]*d+k[8]*a+k[12]*c,b[1]=k[1]*g+k[5]*d+k[9]*a+k[13]*c,b[2]=k[2]*g+k[6]*d+k[10]*a+k[14]*c,b[3]=k[3]*g+k[7]*d+k[11]*a+k[15]*c,b};s.transformQuat=function(b,c,k){var g=c[0],d=c[1],a=c[2];c=k[0];var f=k[1],h=k[2];k=k[3];var s=k*g+f*a-h*d,q=k*d+h*g-c*a,m=k*a+c*d-f*g,g=-c*g-f*d-h*a;return b[0]=s*k+g*-c+q*-h-m*-f,
b[1]=q*k+g*-f+m*-c-s*-h,b[2]=m*k+g*-h+s*-f-q*-c,b};s.forEach=function(){var b=s.create();return function(c,k,g,d,a,f){var h;k||(k=4);g||(g=0);for(d?h=Math.min(d*k+g,c.length):h=c.length;g<h;g+=k)b[0]=c[g],b[1]=c[g+1],b[2]=c[g+2],b[3]=c[g+3],a(b,b,f),c[g]=b[0],c[g+1]=b[1],c[g+2]=b[2],c[g+3]=b[3];return c}}();s.str=function(b){return"vec4("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+")"};"undefined"!=typeof a&&(a.vec4=s);f={create:function(){var b=new h(4);return b[0]=1,b[1]=0,b[2]=0,b[3]=1,b},clone:function(b){var c=
new h(4);return c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b},identity:function(b){return b[0]=1,b[1]=0,b[2]=0,b[3]=1,b},transpose:function(b,c){if(b===c){var k=c[1];b[1]=c[2];b[2]=k}else b[0]=c[0],b[1]=c[2],b[2]=c[1],b[3]=c[3];return b},invert:function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],f=k*a-d*g;return f?(f=1/f,b[0]=a*f,b[1]=-g*f,b[2]=-d*f,b[3]=k*f,b):null},adjoint:function(b,c){var k=c[0];return b[0]=c[3],b[1]=-c[1],b[2]=-c[2],
b[3]=k,b},determinant:function(b){return b[0]*b[3]-b[2]*b[1]},multiply:function(b,c,k){var g=c[0],d=c[1],a=c[2];c=c[3];var f=k[0],h=k[1],s=k[2];k=k[3];return b[0]=g*f+d*s,b[1]=g*h+d*k,b[2]=a*f+c*s,b[3]=a*h+c*k,b}};f.mul=f.multiply;f.rotate=function(b,c,k){var g=c[0],d=c[1],a=c[2];c=c[3];var f=Math.sin(k);k=Math.cos(k);return b[0]=g*k+d*f,b[1]=g*-f+d*k,b[2]=a*k+c*f,b[3]=a*-f+c*k,b};f.scale=function(b,c,k){var g=c[1],d=c[2],a=c[3],f=k[0];k=k[1];return b[0]=c[0]*f,b[1]=g*k,b[2]=d*f,b[3]=a*k,b};f.str=
function(b){return"mat2("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+")"};"undefined"!=typeof a&&(a.mat2=f);f={create:function(){var b=new h(6);return b[0]=1,b[1]=0,b[2]=0,b[3]=1,b[4]=0,b[5]=0,b},clone:function(b){var c=new h(6);return c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c[4]=b[4],c[5]=b[5],c},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b[4]=c[4],b[5]=c[5],b},identity:function(b){return b[0]=1,b[1]=0,b[2]=0,b[3]=1,b[4]=0,b[5]=0,b},invert:function(b,c){var k=c[0],g=c[1],d=c[2],a=
c[3],f=c[4],h=c[5],s=k*a-g*d;return s?(s=1/s,b[0]=a*s,b[1]=-g*s,b[2]=-d*s,b[3]=k*s,b[4]=(d*h-a*f)*s,b[5]=(g*f-k*h)*s,b):null},determinant:function(b){return b[0]*b[3]-b[1]*b[2]},multiply:function(b,c,k){var g=c[0],d=c[1],a=c[2],f=c[3],h=c[4];c=c[5];var s=k[0],q=k[1],m=k[2],p=k[3],u=k[4];k=k[5];return b[0]=g*s+d*m,b[1]=g*q+d*p,b[2]=a*s+f*m,b[3]=a*q+f*p,b[4]=s*h+m*c+u,b[5]=q*h+p*c+k,b}};f.mul=f.multiply;f.rotate=function(b,c,k){var g=c[0],d=c[1],a=c[2],f=c[3],h=c[4];c=c[5];var s=Math.sin(k);k=Math.cos(k);
return b[0]=g*k+d*s,b[1]=-g*s+d*k,b[2]=a*k+f*s,b[3]=-a*s+k*f,b[4]=k*h+s*c,b[5]=k*c-s*h,b};f.scale=function(b,c,k){var g=k[0];k=k[1];return b[0]=c[0]*g,b[1]=c[1]*k,b[2]=c[2]*g,b[3]=c[3]*k,b[4]=c[4]*g,b[5]=c[5]*k,b};f.translate=function(b,c,k){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b[4]=c[4]+k[0],b[5]=c[5]+k[1],b};f.str=function(b){return"mat2d("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+")"};"undefined"!=typeof a&&(a.mat2d=f);f={create:function(){var b=new h(9);return b[0]=1,b[1]=
0,b[2]=0,b[3]=0,b[4]=1,b[5]=0,b[6]=0,b[7]=0,b[8]=1,b},fromMat4:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[4],b[4]=c[5],b[5]=c[6],b[6]=c[8],b[7]=c[9],b[8]=c[10],b},clone:function(b){var c=new h(9);return c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c[4]=b[4],c[5]=b[5],c[6]=b[6],c[7]=b[7],c[8]=b[8],c},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b[4]=c[4],b[5]=c[5],b[6]=c[6],b[7]=c[7],b[8]=c[8],b},identity:function(b){return b[0]=1,b[1]=0,b[2]=0,b[3]=0,b[4]=1,b[5]=0,b[6]=
0,b[7]=0,b[8]=1,b},transpose:function(b,c){if(b===c){var k=c[1],g=c[2],d=c[5];b[1]=c[3];b[2]=c[6];b[3]=k;b[5]=c[7];b[6]=g;b[7]=d}else b[0]=c[0],b[1]=c[3],b[2]=c[6],b[3]=c[1],b[4]=c[4],b[5]=c[7],b[6]=c[2],b[7]=c[5],b[8]=c[8];return b},invert:function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],f=c[4],h=c[5],s=c[6],q=c[7],m=c[8],p=m*f-h*q,u=-m*a+h*s,B=q*a-f*s,A=k*p+g*u+d*B;return A?(A=1/A,b[0]=p*A,b[1]=(-m*g+d*q)*A,b[2]=(h*g-d*f)*A,b[3]=u*A,b[4]=(m*k-d*s)*A,b[5]=(-h*k+d*a)*A,b[6]=B*A,b[7]=(-q*k+g*s)*A,b[8]=
(f*k-g*a)*A,b):null},adjoint:function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],f=c[4],h=c[5],s=c[6],q=c[7],m=c[8];return b[0]=f*m-h*q,b[1]=d*q-g*m,b[2]=g*h-d*f,b[3]=h*s-a*m,b[4]=k*m-d*s,b[5]=d*a-k*h,b[6]=a*q-f*s,b[7]=g*s-k*q,b[8]=k*f-g*a,b},determinant:function(b){var c=b[3],k=b[4],g=b[5],d=b[6],a=b[7],f=b[8];return b[0]*(f*k-g*a)+b[1]*(-f*c+g*d)+b[2]*(a*c-k*d)},multiply:function(b,c,k){var g=c[0],d=c[1],a=c[2],f=c[3],h=c[4],s=c[5],q=c[6],m=c[7];c=c[8];var p=k[0],u=k[1],B=k[2],A=k[3],O=k[4],v=k[5],F=
k[6],G=k[7];k=k[8];return b[0]=p*g+u*f+B*q,b[1]=p*d+u*h+B*m,b[2]=p*a+u*s+B*c,b[3]=A*g+O*f+v*q,b[4]=A*d+O*h+v*m,b[5]=A*a+O*s+v*c,b[6]=F*g+G*f+k*q,b[7]=F*d+G*h+k*m,b[8]=F*a+G*s+k*c,b}};f.mul=f.multiply;f.translate=function(b,c,k){var g=c[0],d=c[1],a=c[2],f=c[3],h=c[4],s=c[5],q=c[6],m=c[7];c=c[8];var p=k[0];k=k[1];return b[0]=g,b[1]=d,b[2]=a,b[3]=f,b[4]=h,b[5]=s,b[6]=p*g+k*f+q,b[7]=p*d+k*h+m,b[8]=p*a+k*s+c,b};f.rotate=function(b,c,k){var g=c[0],d=c[1],a=c[2],f=c[3],h=c[4],s=c[5],q=c[6],m=c[7];c=c[8];
var p=Math.sin(k);k=Math.cos(k);return b[0]=k*g+p*f,b[1]=k*d+p*h,b[2]=k*a+p*s,b[3]=k*f-p*g,b[4]=k*h-p*d,b[5]=k*s-p*a,b[6]=q,b[7]=m,b[8]=c,b};f.scale=function(b,c,k){var g=k[0];k=k[2];return b[0]=g*c[0],b[1]=g*c[1],b[2]=g*c[2],b[3]=k*c[3],b[4]=k*c[4],b[5]=k*c[5],b[6]=c[6],b[7]=c[7],b[8]=c[8],b};f.fromMat2d=function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=0,b[3]=c[2],b[4]=c[3],b[5]=0,b[6]=c[4],b[7]=c[5],b[8]=1,b};f.fromQuat=function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],f=k+k,h=g+g,s=d+d,q=k*f,m=k*h,k=
k*s,p=g*h,g=g*s,d=d*s,f=a*f,h=a*h,a=a*s;return b[0]=1-(p+d),b[1]=m+a,b[2]=k-h,b[3]=m-a,b[4]=1-(q+d),b[5]=g+f,b[6]=k+h,b[7]=g-f,b[8]=1-(q+p),b};f.str=function(b){return"mat3("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+", "+b[6]+", "+b[7]+", "+b[8]+")"};"undefined"!=typeof a&&(a.mat3=f);var g={create:function(){var b=new h(16);return b[0]=1,b[1]=0,b[2]=0,b[3]=0,b[4]=0,b[5]=1,b[6]=0,b[7]=0,b[8]=0,b[9]=0,b[10]=1,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},clone:function(b){var c=new h(16);
return c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c[4]=b[4],c[5]=b[5],c[6]=b[6],c[7]=b[7],c[8]=b[8],c[9]=b[9],c[10]=b[10],c[11]=b[11],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15],c},copy:function(b,c){return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b[4]=c[4],b[5]=c[5],b[6]=c[6],b[7]=c[7],b[8]=c[8],b[9]=c[9],b[10]=c[10],b[11]=c[11],b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15],b},identity:function(b){return b[0]=1,b[1]=0,b[2]=0,b[3]=0,b[4]=0,b[5]=1,b[6]=0,b[7]=0,b[8]=0,b[9]=0,b[10]=1,b[11]=0,b[12]=
0,b[13]=0,b[14]=0,b[15]=1,b},transpose:function(b,c){if(b===c){var k=c[1],g=c[2],d=c[3],a=c[6],f=c[7],h=c[11];b[1]=c[4];b[2]=c[8];b[3]=c[12];b[4]=k;b[6]=c[9];b[7]=c[13];b[8]=g;b[9]=a;b[11]=c[14];b[12]=d;b[13]=f;b[14]=h}else b[0]=c[0],b[1]=c[4],b[2]=c[8],b[3]=c[12],b[4]=c[1],b[5]=c[5],b[6]=c[9],b[7]=c[13],b[8]=c[2],b[9]=c[6],b[10]=c[10],b[11]=c[14],b[12]=c[3],b[13]=c[7],b[14]=c[11],b[15]=c[15];return b},invert:function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],f=c[4],h=c[5],s=c[6],q=c[7],m=c[8],p=c[9],
u=c[10],B=c[11],A=c[12],O=c[13],v=c[14],F=c[15],G=k*h-g*f,J=k*s-d*f,ja=k*q-a*f,K=g*s-d*h,w=g*q-a*h,C=d*q-a*s,x=m*O-p*A,E=m*v-u*A,D=m*F-B*A,I=p*v-u*O,N=p*F-B*O,L=u*F-B*v,M=G*L-J*N+ja*I+K*D-w*E+C*x;return M?(M=1/M,b[0]=(h*L-s*N+q*I)*M,b[1]=(d*N-g*L-a*I)*M,b[2]=(O*C-v*w+F*K)*M,b[3]=(u*w-p*C-B*K)*M,b[4]=(s*D-f*L-q*E)*M,b[5]=(k*L-d*D+a*E)*M,b[6]=(v*ja-A*C-F*J)*M,b[7]=(m*C-u*ja+B*J)*M,b[8]=(f*N-h*D+q*x)*M,b[9]=(g*D-k*N-a*x)*M,b[10]=(A*w-O*ja+F*G)*M,b[11]=(p*ja-m*w-B*G)*M,b[12]=(h*E-f*I-s*x)*M,b[13]=(k*
I-g*E+d*x)*M,b[14]=(O*J-A*K-v*G)*M,b[15]=(m*K-p*J+u*G)*M,b):null},adjoint:function(b,c){var k=c[0],g=c[1],d=c[2],a=c[3],f=c[4],h=c[5],s=c[6],q=c[7],m=c[8],p=c[9],u=c[10],B=c[11],A=c[12],v=c[13],H=c[14],F=c[15];return b[0]=h*(u*F-B*H)-p*(s*F-q*H)+v*(s*B-q*u),b[1]=-(g*(u*F-B*H)-p*(d*F-a*H)+v*(d*B-a*u)),b[2]=g*(s*F-q*H)-h*(d*F-a*H)+v*(d*q-a*s),b[3]=-(g*(s*B-q*u)-h*(d*B-a*u)+p*(d*q-a*s)),b[4]=-(f*(u*F-B*H)-m*(s*F-q*H)+A*(s*B-q*u)),b[5]=k*(u*F-B*H)-m*(d*F-a*H)+A*(d*B-a*u),b[6]=-(k*(s*F-q*H)-f*(d*F-a*H)+
A*(d*q-a*s)),b[7]=k*(s*B-q*u)-f*(d*B-a*u)+m*(d*q-a*s),b[8]=f*(p*F-B*v)-m*(h*F-q*v)+A*(h*B-q*p),b[9]=-(k*(p*F-B*v)-m*(g*F-a*v)+A*(g*B-a*p)),b[10]=k*(h*F-q*v)-f*(g*F-a*v)+A*(g*q-a*h),b[11]=-(k*(h*B-q*p)-f*(g*B-a*p)+m*(g*q-a*h)),b[12]=-(f*(p*H-u*v)-m*(h*H-s*v)+A*(h*u-s*p)),b[13]=k*(p*H-u*v)-m*(g*H-d*v)+A*(g*u-d*p),b[14]=-(k*(h*H-s*v)-f*(g*H-d*v)+A*(g*s-d*h)),b[15]=k*(h*u-s*p)-f*(g*u-d*p)+m*(g*s-d*h),b},determinant:function(b){var c=b[0],k=b[1],g=b[2],d=b[3],a=b[4],f=b[5],h=b[6],s=b[7],q=b[8],m=b[9],
p=b[10],u=b[11],v=b[12],A=b[13],O=b[14];b=b[15];return(c*f-k*a)*(p*b-u*O)-(c*h-g*a)*(m*b-u*A)+(c*s-d*a)*(m*O-p*A)+(k*h-g*f)*(q*b-u*v)-(k*s-d*f)*(q*O-p*v)+(g*s-d*h)*(q*A-m*v)},multiply:function(b,c,k){var g=c[0],d=c[1],a=c[2],f=c[3],h=c[4],s=c[5],q=c[6],m=c[7],p=c[8],u=c[9],v=c[10],A=c[11],O=c[12],H=c[13],F=c[14];c=c[15];var G=k[0],J=k[1],w=k[2],K=k[3];return b[0]=G*g+J*h+w*p+K*O,b[1]=G*d+J*s+w*u+K*H,b[2]=G*a+J*q+w*v+K*F,b[3]=G*f+J*m+w*A+K*c,G=k[4],J=k[5],w=k[6],K=k[7],b[4]=G*g+J*h+w*p+K*O,b[5]=G*
d+J*s+w*u+K*H,b[6]=G*a+J*q+w*v+K*F,b[7]=G*f+J*m+w*A+K*c,G=k[8],J=k[9],w=k[10],K=k[11],b[8]=G*g+J*h+w*p+K*O,b[9]=G*d+J*s+w*u+K*H,b[10]=G*a+J*q+w*v+K*F,b[11]=G*f+J*m+w*A+K*c,G=k[12],J=k[13],w=k[14],K=k[15],b[12]=G*g+J*h+w*p+K*O,b[13]=G*d+J*s+w*u+K*H,b[14]=G*a+J*q+w*v+K*F,b[15]=G*f+J*m+w*A+K*c,b}};g.mul=g.multiply;g.translate=function(b,c,k){var g=k[0],d=k[1];k=k[2];var a,f,h,s,q,m,p,u,v,A,w,H;return c===b?(b[12]=c[0]*g+c[4]*d+c[8]*k+c[12],b[13]=c[1]*g+c[5]*d+c[9]*k+c[13],b[14]=c[2]*g+c[6]*d+c[10]*k+
c[14],b[15]=c[3]*g+c[7]*d+c[11]*k+c[15]):(a=c[0],f=c[1],h=c[2],s=c[3],q=c[4],m=c[5],p=c[6],u=c[7],v=c[8],A=c[9],w=c[10],H=c[11],b[0]=a,b[1]=f,b[2]=h,b[3]=s,b[4]=q,b[5]=m,b[6]=p,b[7]=u,b[8]=v,b[9]=A,b[10]=w,b[11]=H,b[12]=a*g+q*d+v*k+c[12],b[13]=f*g+m*d+A*k+c[13],b[14]=h*g+p*d+w*k+c[14],b[15]=s*g+u*d+H*k+c[15]),b};g.scale=function(b,c,k){var g=k[0],d=k[1];k=k[2];return b[0]=c[0]*g,b[1]=c[1]*g,b[2]=c[2]*g,b[3]=c[3]*g,b[4]=c[4]*d,b[5]=c[5]*d,b[6]=c[6]*d,b[7]=c[7]*d,b[8]=c[8]*k,b[9]=c[9]*k,b[10]=c[10]*
k,b[11]=c[11]*k,b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15],b};g.rotate=function(b,c,k,g){var d=g[0],a=g[1];g=g[2];var f=Math.sqrt(d*d+a*a+g*g),h,s,q,p,u,v,B,A,w,H,F,G,J,C,K,x,E,D,I,N,L,P,Q,M;return Math.abs(f)<m?null:(f=1/f,d*=f,a*=f,g*=f,h=Math.sin(k),s=Math.cos(k),q=1-s,p=c[0],u=c[1],v=c[2],B=c[3],A=c[4],w=c[5],H=c[6],F=c[7],G=c[8],J=c[9],C=c[10],K=c[11],x=d*d*q+s,E=a*d*q+g*h,D=g*d*q-a*h,I=d*a*q-g*h,N=a*a*q+s,L=g*a*q+d*h,P=d*g*q+a*h,Q=a*g*q-d*h,M=g*g*q+s,b[0]=p*x+A*E+G*D,b[1]=u*x+w*E+J*D,b[2]=
v*x+H*E+C*D,b[3]=B*x+F*E+K*D,b[4]=p*I+A*N+G*L,b[5]=u*I+w*N+J*L,b[6]=v*I+H*N+C*L,b[7]=B*I+F*N+K*L,b[8]=p*P+A*Q+G*M,b[9]=u*P+w*Q+J*M,b[10]=v*P+H*Q+C*M,b[11]=B*P+F*Q+K*M,c!==b&&(b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15]),b)};g.rotateX=function(b,c,k){var g=Math.sin(k);k=Math.cos(k);var d=c[4],a=c[5],f=c[6],h=c[7],s=c[8],q=c[9],m=c[10],p=c[11];return c!==b&&(b[0]=c[0],b[1]=c[1],b[2]=c[2],b[3]=c[3],b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15]),b[4]=d*k+s*g,b[5]=a*k+q*g,b[6]=f*k+m*g,b[7]=h*k+p*
g,b[8]=s*k-d*g,b[9]=q*k-a*g,b[10]=m*k-f*g,b[11]=p*k-h*g,b};g.rotateY=function(b,c,g){var d=Math.sin(g);g=Math.cos(g);var a=c[0],f=c[1],h=c[2],s=c[3],q=c[8],m=c[9],p=c[10],u=c[11];return c!==b&&(b[4]=c[4],b[5]=c[5],b[6]=c[6],b[7]=c[7],b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15]),b[0]=a*g-q*d,b[1]=f*g-m*d,b[2]=h*g-p*d,b[3]=s*g-u*d,b[8]=a*d+q*g,b[9]=f*d+m*g,b[10]=h*d+p*g,b[11]=s*d+u*g,b};g.rotateZ=function(b,c,g){var d=Math.sin(g);g=Math.cos(g);var a=c[0],f=c[1],h=c[2],s=c[3],q=c[4],m=c[5],p=c[6],
u=c[7];return c!==b&&(b[8]=c[8],b[9]=c[9],b[10]=c[10],b[11]=c[11],b[12]=c[12],b[13]=c[13],b[14]=c[14],b[15]=c[15]),b[0]=a*g+q*d,b[1]=f*g+m*d,b[2]=h*g+p*d,b[3]=s*g+u*d,b[4]=q*g-a*d,b[5]=m*g-f*d,b[6]=p*g-h*d,b[7]=u*g-s*d,b};g.fromRotationTranslation=function(b,c,g){var d=c[0],a=c[1],f=c[2],h=c[3],s=d+d,q=a+a,m=f+f;c=d*s;var p=d*q,d=d*m,u=a*q,a=a*m,f=f*m,s=h*s,q=h*q,h=h*m;return b[0]=1-(u+f),b[1]=p+h,b[2]=d-q,b[3]=0,b[4]=p-h,b[5]=1-(c+f),b[6]=a+s,b[7]=0,b[8]=d+q,b[9]=a-s,b[10]=1-(c+u),b[11]=0,b[12]=
g[0],b[13]=g[1],b[14]=g[2],b[15]=1,b};g.fromQuat=function(b,c){var g=c[0],d=c[1],a=c[2],f=c[3],h=g+g,s=d+d,q=a+a,m=g*h,p=g*s,g=g*q,u=d*s,d=d*q,a=a*q,h=f*h,s=f*s,f=f*q;return b[0]=1-(u+a),b[1]=p+f,b[2]=g-s,b[3]=0,b[4]=p-f,b[5]=1-(m+a),b[6]=d+h,b[7]=0,b[8]=g+s,b[9]=d-h,b[10]=1-(m+u),b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b};g.frustum=function(b,c,g,d,a,f,h){var s=1/(g-c),q=1/(a-d),m=1/(f-h);return b[0]=2*f*s,b[1]=0,b[2]=0,b[3]=0,b[4]=0,b[5]=2*f*q,b[6]=0,b[7]=0,b[8]=(g+c)*s,b[9]=(a+d)*q,b[10]=(h+f)*
m,b[11]=-1,b[12]=0,b[13]=0,b[14]=h*f*2*m,b[15]=0,b};g.perspective=function(b,c,g,d,a){c=1/Math.tan(c/2);var f=1/(d-a);return b[0]=c/g,b[1]=0,b[2]=0,b[3]=0,b[4]=0,b[5]=c,b[6]=0,b[7]=0,b[8]=0,b[9]=0,b[10]=(a+d)*f,b[11]=-1,b[12]=0,b[13]=0,b[14]=2*a*d*f,b[15]=0,b};g.ortho=function(b,c,g,d,a,f,h){var s=1/(c-g),q=1/(d-a),m=1/(f-h);return b[0]=-2*s,b[1]=0,b[2]=0,b[3]=0,b[4]=0,b[5]=-2*q,b[6]=0,b[7]=0,b[8]=0,b[9]=0,b[10]=2*m,b[11]=0,b[12]=(c+g)*s,b[13]=(a+d)*q,b[14]=(h+f)*m,b[15]=1,b};g.lookAt=function(b,
c,k,d){var a,f,h,s,q,p,u,v,w,B,A=c[0],x=c[1];c=c[2];var H=d[0],F=d[1];d=d[2];var G=k[0],C=k[1];k=k[2];return Math.abs(A-G)<m&&Math.abs(x-C)<m&&Math.abs(c-k)<m?g.identity(b):(u=A-G,v=x-C,w=c-k,B=1/Math.sqrt(u*u+v*v+w*w),u*=B,v*=B,w*=B,a=F*w-d*v,f=d*u-H*w,h=H*v-F*u,B=Math.sqrt(a*a+f*f+h*h),B?(B=1/B,a*=B,f*=B,h*=B):(a=0,f=0,h=0),s=v*h-w*f,q=w*a-u*h,p=u*f-v*a,B=Math.sqrt(s*s+q*q+p*p),B?(B=1/B,s*=B,q*=B,p*=B):(s=0,q=0,p=0),b[0]=a,b[1]=s,b[2]=u,b[3]=0,b[4]=f,b[5]=q,b[6]=v,b[7]=0,b[8]=h,b[9]=p,b[10]=w,b[11]=
0,b[12]=-(a*A+f*x+h*c),b[13]=-(s*A+q*x+p*c),b[14]=-(u*A+v*x+w*c),b[15]=1,b)};g.str=function(b){return"mat4("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+", "+b[6]+", "+b[7]+", "+b[8]+", "+b[9]+", "+b[10]+", "+b[11]+", "+b[12]+", "+b[13]+", "+b[14]+", "+b[15]+")"};"undefined"!=typeof a&&(a.mat4=g);f={create:function(){var b=new h(4);return b[0]=0,b[1]=0,b[2]=0,b[3]=1,b}};f.clone=s.clone;f.fromValues=s.fromValues;f.copy=s.copy;f.set=s.set;f.identity=function(b){return b[0]=0,b[1]=0,b[2]=
0,b[3]=1,b};f.setAxisAngle=function(b,c,g){g*=.5;var d=Math.sin(g);return b[0]=d*c[0],b[1]=d*c[1],b[2]=d*c[2],b[3]=Math.cos(g),b};f.add=s.add;f.multiply=function(b,c,g){var d=c[0],a=c[1],f=c[2];c=c[3];var h=g[0],s=g[1],q=g[2];g=g[3];return b[0]=d*g+c*h+a*q-f*s,b[1]=a*g+c*s+f*h-d*q,b[2]=f*g+c*q+d*s-a*h,b[3]=c*g-d*h-a*s-f*q,b};f.mul=f.multiply;f.scale=s.scale;f.rotateX=function(b,c,g){g*=.5;var d=c[0],a=c[1],f=c[2];c=c[3];var h=Math.sin(g);g=Math.cos(g);return b[0]=d*g+c*h,b[1]=a*g+f*h,b[2]=f*g-a*h,
b[3]=c*g-d*h,b};f.rotateY=function(b,c,g){g*=.5;var d=c[0],a=c[1],f=c[2];c=c[3];var h=Math.sin(g);g=Math.cos(g);return b[0]=d*g-f*h,b[1]=a*g+c*h,b[2]=f*g+d*h,b[3]=c*g-a*h,b};f.rotateZ=function(b,c,g){g*=.5;var d=c[0],a=c[1],f=c[2];c=c[3];var h=Math.sin(g);g=Math.cos(g);return b[0]=d*g+a*h,b[1]=a*g-d*h,b[2]=f*g+c*h,b[3]=c*g-f*h,b};f.calculateW=function(b,c){var g=c[0],d=c[1],a=c[2];return b[0]=g,b[1]=d,b[2]=a,b[3]=-Math.sqrt(Math.abs(1-g*g-d*d-a*a)),b};f.dot=s.dot;f.lerp=s.lerp;f.slerp=function(b,
c,g,d){var a=c[0],f=c[1],h=c[2],s=c[3],q=g[0],m=g[1],p=g[2];g=g[3];var u=a*q+f*m+h*p+s*g,v,w,A,x;return 1<=Math.abs(u)?(b!==c&&(b[0]=a,b[1]=f,b[2]=h,b[3]=s),b):(v=Math.acos(u),w=Math.sqrt(1-u*u),.001>Math.abs(w)?(b[0]=.5*a+.5*q,b[1]=.5*f+.5*m,b[2]=.5*h+.5*p,b[3]=.5*s+.5*g,b):(A=Math.sin((1-d)*v)/w,x=Math.sin(d*v)/w,b[0]=a*A+q*x,b[1]=f*A+m*x,b[2]=h*A+p*x,b[3]=s*A+g*x,b))};f.invert=function(b,c){var g=c[0],d=c[1],a=c[2],f=c[3],h=g*g+d*d+a*a+f*f,h=h?1/h:0;return b[0]=-g*h,b[1]=-d*h,b[2]=-a*h,b[3]=f*
h,b};f.conjugate=function(b,c){return b[0]=-c[0],b[1]=-c[1],b[2]=-c[2],b[3]=c[3],b};f.length=s.length;f.len=f.length;f.squaredLength=s.squaredLength;f.sqrLen=f.squaredLength;f.normalize=s.normalize;f.fromMat3=function(){var b=[1,2,0];return function(c,g){var d=g[0]+g[4]+g[8];if(0<d)d=Math.sqrt(d+1),c[3]=.5*d,d=.5/d,c[0]=(g[7]-g[5])*d,c[1]=(g[2]-g[6])*d,c[2]=(g[3]-g[1])*d;else{var a=0;g[4]>g[0]&&(a=1);g[8]>g[3*a+a]&&(a=2);var f=b[a],h=b[f],d=Math.sqrt(g[3*a+a]-g[3*f+f]-g[3*h+h]+1);c[a]=.5*d;d=.5/d;
c[3]=(g[3*h+f]-g[3*f+h])*d;c[f]=(g[3*f+a]+g[3*a+f])*d;c[h]=(g[3*h+a]+g[3*a+h])*d}return c}}();f.str=function(b){return"quat("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+")"};"undefined"!=typeof a&&(a.quat=f)})(p)})();var R=!0,wa=!1,$=[],D=[],P=[],fa={};new w;var xa=null,ka=null,aa=0,ga=0,la=0,X=0,E="",ma=null,I=null,na=null,T=1,Ra=function(p,a,m,h,f){E=p;ma=new Na;xa=h;ga=f;this.gameTitle=p;this.gameVersion=a;this.stats=ma;this.network=new w;this.themeManager=new Oa;this.legacyLoader=new Ga;I=this.cache=
new Pa;na=this._pools=new Qa;this._pools.preAllocate("World",5);window.addEventListener("resize",qa,!1);window.addEventListener("orientationchange",qa,!1);window.addEventListener("blur",function(){R&&(R=!1,window.clearInterval(ka),ka=null)});window.addEventListener("focus",function(){R||(R=!0,la=performance.now()/(100*ga),ka||(ka=setInterval(Ha,1E3/ga,"JScript")))});console.log("Getting audio context");try{new webkitAudioContext}catch(q){console.log("Couldn't get audio context.")}m&&m();la||(la=performance.now()/
(100*ga));ka=setInterval(Ha,1E3/ga,"JScript")},Ha=function(){if(R&&!wa){wa=!0;newTime=performance.now();frameTime=(newTime-la)/(1E3/ga*100);.25<frameTime&&(frameTime=.25);la=newTime;X+=frameTime;for(aa=.01;X>=aa;){xa&&xa(1);for(var p=0,a=P.length;p<a;p++)P[p].update(X-aa<aa?!0:!1);X-=aa;ma.cyclesThisSecond++;X>=aa&&ma.droppedFramesThisSecond++}ma.update();wa=!1;window.requestAnimationFrame(function(){Ia(X/aa)})}},Ia=function(p){for(var a=0,m=D.length;a<m;a++)D[a].render(p)},ra=function(p){for(var a=
0,m=D.length;a<m;a++)if(D[a].id==p)return D[a];void 0!=p&&console.warn("Viewport "+p+" not found.")},qa=function(){for(var p=0,a=D.length;p<a;p++)D[p].evaluate()},za=function(p){p=p||{};return $[$.push(new ya(p.x||0,p.y||0,p.z||0,void 0==p.parallaxOffset?!0:p.parallaxOffset,p.id||null))-1]},Ja=function(p){for(var a=0,m=$.length;a<m;a++)if($[a].id==p)return $[a];void 0!=p&&console.warn("Camera "+p+" not found.")},L=function(){this.Memory=Aa;this.Color=x;this.Vector=u;this.Vertex=v;this.Bone=sa;this.Polygon=
N;this.Text=U;this.Box=C;this.Line=Y;this.Tile=ba;this.Entity=V;this.Timeline=ta;this.Animation=Ba;this.Frame=Ca;this.Transform=Da;this.tween=Ka;this.World=Ea;this.Body=S;this.Shape=ha;this.Joint=oa;this.Material=ca;this.Filter=da;this.Action=Q;this.Sequence=Fa;this.LegacyLoader=Ga;this.Emitter=ea;this.Trigger=ia;this.SpawnPoint=ua;this.LayerJoint=Z};L.prototype={init:function(p){Ra.call(this,p.gameTitle||"GAME",p.gameVersion||"0.0.0",p.onReady||null,p.onUpdate||null,p.targetFrameRate||30)},render:Ia,
createViewport:function(p){var a=new Sa;a.init(p.id||null,p.divElement||null,p.clearColor||"#FFF",p.styleClass||"");D.push(a);return D[D.length-1]},getViewport:ra,getViewports:function(){return D},evaluateViewports:qa,createStage:function(p){p=p||{};p.camera?(camera=Ja(p.camera))||(camera=za({id:p.camera})):camera=za({id:"Camera "+$.length});newStage=P[P.push(new va(p.x||0,p.y||0,p.z||0,p.id||null,camera,p.onCreate||null,p.onReady||null,p.onStop||null,p.onPause||null,p.onResume||null,p.onUpdate||
null,p.actions||null,p.sequences||null,void 0==p.alpha?1:p.alpha,void 0==p.physicsEnabled?!0:p.physicsEnabled,p.hasAudio))-1];if(p.viewport)if(p.viewport instanceof Array)for(var a=0,m=p.viewport.length;a<m;a++)ra(p.viewport[a])&&ra(p.viewport[a]).addStage(newStage);else ra(p.viewport).addStage(newStage);!1!==p.enabled&&newStage.start();p.paused&&newStage.pause();return newStage},getStage:function(p){for(var a=0,m=P.length;a<m;a++)if(P[a].id==p)return P[a];void 0!=p&&console.warn("Stage "+p+" not found.")},
getStages:function(){return P},createCamera:za,getCamera:Ja,getCameras:function(){return $},addEntityClass:function(p,a){a=a||{};return fa[p]=new La(p,a.memory,a.actions,a.onSpawn,a.onDestroy,a.beginContact,a.endContact,a.preSolve,a.postSolve,a.update,a.onEmit)},getEntityClasses:function(){return fa},setGraphicsScale:function(p){T=p;qa()},getGraphicsScale:function(){return T}};var Ka=function(){var p,a=function(a,d,f,g){return f*a/g+d},m=function(a,d,f,g){a/=g;return f*a*a+d},h=function(a,d,f,g){a/=
g;return-f*a*(a-2)+d},f=function(a,d,f,g){a/=g/2;if(1>a)return f/2*a*a+d;a--;return-f/2*(a*(a-2)-1)+d};return function(q,d,s,g,b,c){p=b&&c?f:b?m:c?h:a;s>g&&(s=g);q instanceof v&&(q.matrix[0]=p(s,q.matrix[0],d.matrix[0],g),q.matrix[1]=p(s,q.matrix[1],d.matrix[1],g),q.orientation=p(s,q.orientation,d.orientation,g));q instanceof u?(q.matrix[0]=p(s,q.matrix[0],d.matrix[0],g),q.matrix[1]=p(s,q.matrix[1],d.matrix[1],g)):q instanceof x?(q.red=p(s,q.red,d.red,g),q.green=p(s,q.green,d.green,g),q.blue=p(s,
q.blue,d.blue,g),q.alpha=p(s,q.alpha,d.alpha,g)):"number"===typeof q&&p(s,q,d,g)}}(),u=function(){var p=vec3.create(),a=function(a,h,f){this.matrix=a instanceof Array?vec3.fromValues(a[0]||0,a[1]||0,a[2]||0):"object"===typeof a?vec3.clone(a.matrix):vec3.fromValues(a||0,h||0,f||0)};a.prototype={get x(){return this.matrix[0]},get y(){return this.matrix[1]},get z(){return this.matrix[2]},set x(a){this.matrix[0]=a},set y(a){this.matrix[1]=a},set z(a){this.matrix[2]=a}};a.prototype.set=function(a,h,f){"object"===
typeof a?vec3.copy(this.matrix,a.matrix):vec3.set(this.matrix,a||0,h||0,f||0);return this};a.prototype.add=function(a,h,f){"object"===typeof a?vec3.add(this.matrix,this.matrix,a.matrix):vec3.add(this.matrix,this.matrix,vec3.set(p,a||0,h||0,f||0));return this};a.prototype.sub=function(a,h,f){"object"===typeof a?vec3.sub(this.matrix,this.matrix,a.matrix):vec3.sub(this.matrix,this.matrix,vec3.set(p,a||0,h||0,f||0));return this};a.prototype.mul=function(a,h,f){"object"===typeof a?vec3.mul(this.matrix,
this.matrix,a.matrix):vec3.mul(this.matrix,this.matrix,vec3.set(p,a||1,h||1,f||1));return this};a.prototype.div=function(a,h,f){"object"===typeof a?vec3.div(this.matrix,this.matrix,a.matrix):vec3.div(this.matrix,this.matrix,vec3.set(p,a||1,h||1,f||1));return this};a.prototype.scale=function(a){vec3.scale(this.matrix,this.matrix,a);return this};a.prototype.rotate2D=function(a,h){"object"===typeof a?h?(vec3.sub(p,this.matrix,h.matrix),vec2.transformMat2(p,p,a),vec3.add(this.matrix,p,h.matrix)):vec2.transformMat2(this.matrix,
this.matrix,a):h?vec2.rotateAround(this.matrix,this.matrix,h.matrix,a):vec2.rotate(this.matrix,this.matrix,a);return this};a.prototype.dot2D=function(a){return vec2.dot(this.matrix,a.matrix)};a.prototype.normalize=function(){vec3.normalize(this.matrix,this.matrix);return this};a.prototype.length=function(){return vec3.len(this.matrix)};a.prototype.distance=function(a){return vec3.distance(this.matrix,a.matrix)};a.prototype.clone=function(){return new u(this)};a.prototype.angleBetween2d=function(a){return Math.atan2(a.matrix[1]-
this.matrix[1],a.matrix[0]-this.matrix[0])};return a}(),x=function(){var p=0,a,m,h=function(a,h,d,s){this.id=p++;this.set(a,h,d,s);this.isThemeColor=!1};h.prototype.clone=function(){return new x(this.red,this.green,this.blue,this.alpha)};h.prototype.toString=function(){return void 0==this.alpha?"rgb("+this.red+","+this.green+","+this.blue+")":"rgba("+this.red+","+this.green+","+this.blue+","+this.alpha+")"};h.prototype.toRGB=function(){return"rgb("+this.red+","+this.green+","+this.blue+")"};h.prototype.toHex=
function(){return"#"+(16777216+(this.red<<16)+(this.green<<8)+this.blue).toString(16).slice(1,7)};h.prototype.set=function(a,q,d,s){void 0==s&&(s=1);if("string"==typeof a){if("#"==a.charAt(0))m=this.hexToRgb(a);else if("rgb"===a.substring(0,3))m=this.stringToRgb(a);else{this.green=this.red=255;this.blue=0;this.alpha=1;return}this.red=m.red;this.green=m.green;this.blue=m.blue;this.alpha=void 0!==m.alpha?m.alpha:1}else a instanceof h?(this.red=a.red,this.green=a.green,this.blue=a.blue,this.alpha=void 0!==
a.alpha?a.alpha:1):a instanceof Array?(this.red=a[0],this.green=a[1],this.blue=a[2],this.alpha=a[3]):(this.red=a,this.green=q,this.blue=d,this.alpha=s);return this};h.prototype.adjustHSL=function(f,h,d){a=this.rgbToHsl();a[0]+=(f||0)/100;a[1]+=(h||0)/100;a[2]+=(d||0)/100;0>a[0]&&(a[0]=0);0>a[1]&&(a[1]=0);0>a[2]&&(a[2]=0);1<a[0]&&(a[0]=1);1<a[1]&&(a[1]=1);1<a[2]&&(a[2]=1);a=this.hslToRgb(a[0],a[1],a[2]);this.set(a[0],a[1],a[2],this.alpha);return this};h.prototype.adjustHue=function(f){a=this.rgbToHsl();
a[0]+=(f||0)/100;a=this.hslToRgb(a[0],a[1],a[2]);this.set(a[0],a[1],a[2],this.alpha);return this};h.prototype.adjustSaturation=function(f){a=this.rgbToHsl();a[1]+=(f||0)/100;a=this.hslToRgb(a[0],a[1],a[2]);this.set(a[0],a[1],a[2],this.alpha);return this};h.prototype.adjustLightness=function(f){a=this.rgbToHsl();a[2]+=(f||0)/100;a=this.hslToRgb(a[0],a[1],a[2]);this.set(a[0],a[1],a[2],this.alpha);return this};h.prototype.rgbToHsl=function(a,h,d){void 0==a&&(a=this.red,h=this.green,d=this.blue);a/=255;
h/=255;d/=255;var s=Math.max(a,h,d),g=Math.min(a,h,d),b,c=(s+g)/2;if(s==g)b=g=0;else{var k=s-g,g=.5<c?k/(2-s-g):k/(s+g);switch(s){case a:b=(h-d)/k+(h<d?6:0);break;case h:b=(d-a)/k+2;break;case d:b=(a-h)/k+4}b/=6}return[b,g,c]};h.prototype.hslToRgb=function(a,h,d){if(void 0==a)return[this.red,this.green,this.blue];if(0==h)d=h=a=d;else{var s=.5>d?d*(1+h):d+h-d*h,g=2*d-s;d=this.hue2rgb(g,s,a+1/3);h=this.hue2rgb(g,s,a);a=this.hue2rgb(g,s,a-1/3)}return[Math.round(255*d),Math.round(255*h),Math.round(255*
a)]};h.prototype.hue2rgb=function(a,h,d){0>d&&(d+=1);1<d&&(d-=1);return d<1/6?a+6*(h-a)*d:.5>d?h:d<2/3?a+(h-a)*(2/3-d)*6:a};h.prototype.hexToRgb=function(a){a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,d,f,g){return d+d+f+f+g+g});return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{red:parseInt(a[1],16),green:parseInt(a[2],16),blue:parseInt(a[3],16)}:null};h.prototype.stringToRgb=function(a){return"a"==a.charAt(3)?(a=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?|\.[0-9]+)\s*\)/i.exec(a))?
{red:a[1]|0,green:a[2]|0,blue:a[3]|0,alpha:1*a[4]}:null:(a=/rgb\((\d+),(\d+),(\d+)\)/i.exec(a))?{red:a[1]|0,green:a[2]|0,blue:a[3]|0}:null};return h}(),Ta=function(){var p=0,a=function(a,h){p++;this.id=h||p;this.manager=a;this.colors=[]};a.prototype.addColor=function(a){this.manager.addColor(a)};return a}(),Oa=function(){var p=0,a,m,h,f,q=function(a){p++;this.id=a||p;this.currentTheme=null;this.themes=[];this.colors=[]};q.prototype.addColor=function(a,s,g){this.colors.push(new x(a,s,g));this.colors[this.colors.length-
1].isThemeColor=!0;h=0;for(f=this.themes.length;h<f;h++)this.themes[h].colors.push(new x(a,s,g)),this.themes[h].colors[this.themes[h].colors.length-1].isThemeColor=!0};q.prototype.addTheme=function(d,f){var g=new Ta(this,d||this.id+":"+this.themes.length);this.themes.push(g);a=0;for(m=this.colors.length;a<m;a++)g.addColor(this.colors[a]);a=0;for(m=f.length;a<m;a++)this.colors[a]?g.colors[a].set(f[a]).isThemeColor=!0:this.addColor(f[a]);this.currentTheme||(this.currentTheme=g);return g};q.prototype.getTheme=
function(d){a=0;for(m=this.themes.length;a<m;a++)if(this.themes[a].id==d)return this.themes[a]};q.prototype.getThemes=function(d){_themes=[];a=0;for(m=this.themes.length;a<m;a++)_themes.push(this.themes[a]);return _themes};q.prototype.setTheme=function(d,s,g,b){if(!this.currentTheme||this.currentTheme.id!=d)for(a=0,m=this.themes.length;a<m;a++)if(this.themes[a].id==d){h=0;for(f=this.colors.length;h<f;h++)this.colors[h].set(this.themes[a].colors[h]);this.currentTheme=this.themes[a]}};return q}(),Aa=
function(){var p=0,a,m,h=function(f,h,d){p++;this.id=f||p;this.onSyncChange=d;this.ROM=h.ROM;this.RAM=h.RAM;this.originalRAM={};for(a in h.RAM)this.originalRAM[a]=h.RAM[a];if(f){this.HDD={};for(a in h.HDD)this.HDD[a]=h.HDD[a];this.load()}else h.HDD&&console.warn("Unable to create HDD, no ID specified");if(window.chrome&&chrome.storage){var s=this;chrome.storage.onChanged.addListener(function(g,b){for(a in g)s.HDD&&s.HDD[a]&&(s.HDD[a]=g[a].newValue)})}};h.prototype.reset=function(){for(a in this.originalRAM)this.RAM[a]=
this.originalRAM[a]};h.prototype.save=function(){window.chrome&&chrome.storage?(m={},m[E+"_HDD_1_"+this.id]=this.HDD,chrome.storage.sync.set(m),chrome.storage.local.set(m)):window.localStorage&&window.localStorage.setObject&&window.localStorage.setObject(E+"_HDD_1_"+this.id,this.HDD)};h.prototype.load=function(){if(window.chrome&&chrome.storage){var f=this;chrome.storage.local.get(E+"_HDD_1_"+this.id,function(h){for(a in h[E+"_HDD_1_"+f.id])f.HDD[a]=h[E+"_HDD_1_"+f.id][a];f.onSyncChange&&f.onSyncChange.call(f)});
chrome.storage.sync.get(E+"_HDD_1_"+this.id,function(h){for(a in h[E+"_HDD_1_"+f.id])f.HDD[a]=h[E+"_HDD_1_"+f.id][a];f.onSyncChange&&f.onSyncChange.call(f)})}else if(window.localStorage&&window.localStorage.getObject&&window.localStorage.getObject(E+"_HDD_1_"+this.id)){m=window.localStorage.getObject(E+"_HDD_1_"+this.id);for(a in m)this.HDD[a]=m[a];this.onSyncChange&&this.onSyncChange.call(this)}};h.prototype.saveState=function(){window.chrome&&chrome.storage?(m={},m[E+"_RAM_1_"+this.id]=this.RAM,
chrome.storage.local.set(m)):window.localStorage&&window.localStorage.setObject&&window.localStorage.setObject(E+"_RAM_1_"+this.id,this.RAM)};h.prototype.loadState=function(){if(window.chrome&&chrome.storage)chrome.storage.local.get(E+"_RAM_1_"+this.id,function(f){for(a in f[E+"_RAM_1_"+self.id])self.RAM[a]=f[E+"_RAM_1_"+self.id][a]});else if(window.localStorage&&window.localStorage.getObject&&window.localStorage.getObject(E+"_RAM_1_"+this.id))for(a in m=window.localStorage.getObject(E+"_RAM_1_"+
this.id),m)this.RAM[a]=m[a]};return h}(),v=function(){var p,a=0,m=function(h,f,q,d){this.id=a++;this.origin=new u(h,f,q);this.vector=new u(h,f,q);this.originalOrientation=this.orientation=(h instanceof Array?h[3]:d)||0;this.matrix=this.vector.matrix};m.prototype.clone=function(){p=new v(this.origin,null,null,this.orientation);p.vector.set(this.vector);return p};m.prototype.normalize=function(){this.origin.set(this.vector);this.originalOrientation=this.orientation;return this};m.prototype.reset=function(){this.vector.set(this.origin);
this.orientation=this.originalOrientation;return this};m.prototype.scale=function(a){this.vector.scale(a);return this};m.prototype.set=function(a,f,q,d){this.vector.set(a,f,q);this.orientation=void 0!=d?d:a.orientation||0;return this};m.prototype.add=function(a,f,q,d){this.vector.add(a,f,q);if(void 0!=d||a.orientation)this.orientation+=d||a.orientation;return this};m.prototype.sub=function(a,f,q,d){this.vector.sub(a,f,q);if(void 0!=d||a.orientation)this.orientation-=d||a.orientation;return this};
m.prototype.angleBetween2d=function(a){return this.vector.angleBetween2d(a)};return m}(),Y=function(){var p=0,a,m=function(a,f,q,d){this.id=p++;this.point=a;this.anchor1=f;this.anchor2=q;this.type=d||"line";this.refresh()};m.prototype.save=function(){a={};this.point&&(a.p=[this.point.matrix[0],this.point.matrix[1],this.point.matrix[2],this.point.orientation]);this.anchor1&&(a.a1=[this.anchor1.matrix[0],this.anchor1.matrix[1],this.anchor1.matrix[2],this.anchor1.orientation]);this.anchor2&&(a.a2=[this.anchor2.matrix[0],
this.anchor2.matrix[1],this.anchor2.matrix[2],this.anchor2.orientation]);a.t=this.type;return a};m.prototype.load=function(a){a.p&&(this.point=new v(a.p[0],a.p[1],a.p[2],a.p[3]));a.a1&&(this.anchor1=new v(a.a1[0],a.a1[1],a.a1[2],a.a1[3]));a.a2&&(this.anchor2=new v(a.a2[0],a.a2[1],a.a2[2],a.a2[3]));this.type=a.t;return this};m.prototype.clone=function(){return new Y(this.point.clone(),this.anchor1?this.anchor1.clone():null,this.anchor2?this.anchor2.clone():null,this.type)};m.prototype.reset=function(){this.point&&
this.point.reset();this.anchor1&&this.anchor1.reset();this.anchor2&&this.anchor2.reset()};m.prototype.scale=function(a){this.point&&this.point.scale(a);this.anchor1&&this.anchor1.scale(a);this.anchor2&&this.anchor2.scale(a)};m.prototype.refresh=function(){switch(this.type){case "arc":this.draw=this.drawArc;break;case "arcTo":this.draw=this.drawArcTo;break;case "move":this.draw=this.drawMove;break;default:this.draw=this.drawLine}};m.prototype.drawMove=function(a){a.moveTo(this.point.matrix[0],this.point.matrix[1])};
m.prototype.drawLine=function(a){this.anchor2&&this.anchor1?a.bezierCurveTo(this.anchor1.matrix[0],this.anchor1.matrix[1],this.anchor2.matrix[0],this.anchor2.matrix[1],this.point.matrix[0],this.point.matrix[1]):this.anchor2?a.quadraticCurveTo(this.anchor2.matrix[0],this.anchor2.matrix[1],this.point.matrix[0],this.point.matrix[1]):this.anchor1?a.quadraticCurveTo(this.anchor1.matrix[0],this.anchor1.matrix[1],this.point.matrix[0],this.point.matrix[1]):a.lineTo(this.point.matrix[0],this.point.matrix[1])};
m.prototype.drawArc=function(a){a.arc(this.point.matrix[0],this.point.matrix[1],this.anchor1.matrix[0],this.anchor1.orientation,this.anchor2.orientation,this.anchor2.matrix[0])};m.prototype.drawArcTo=function(a){a.arc(this.point.matrix[0],this.point.matrix[1],this.anchor1.matrix[0],this.anchor1.matrix[1],this.anchor2.matrix[0])};return m}(),N=function(){var p=0,a,m,h=new u,f,q,d=function(a,g,b){this.id=p++;this.lines=a||[];this.fill=g||new x(255,0,255,1);this.stroke=b||new x(0,255,0,1);this.lineWidth=
1;this.lineDash="";this.lineDashOffset=2;this.scaleStrokeWhenScaling=this.closePath=!1;this.alpha=1;this.inputMouseEvents=[];this.center=new u;this.box=new C;this.effects={};this.polygonClass;this.debugFlags=0;this.visible=!0;this.static=!1};d.prototype.save=function(){a={};a.f=[this.fill.red,this.fill.green,this.fill.blue,this.fill.alpha];a.s=[this.stroke.red,this.stroke.green,this.stroke.blue,this.stroke.alpha];a.w=this.lineWidth;a.ss=this.scaleStrokeWhenScaling;a.d=this.lineDash;a.df=this.lineDashOffset;
a.cp=this.closePath;a.a=this.alpha;a.c=[this.center.matrix[0],this.center.matrix[1]];a.b=[this.box.left,this.box.top,this.box.right,this.box.bottom];a.cl=this.polygonClass;a.li=[];for(f in this.lines)a.li[f]=this.lines[f].save();return a};d.prototype.load=function(a){this.fill.set(a.f[0],a.f[1],a.f[2],a.f[3]);this.stroke.set(a.s[0],a.s[1],a.s[2],a.s[3]);this.lineWidth=a.w;this.scaleStrokeWhenScaling=a.ss;this.lineDash=a.d;this.lineDashOffset=a.df;this.closePath=a.cp;this.alpha=a.a;this.center.set(a.c[0],
a.c[1]);this.box.set(a.b[0],a.b[1],a.b[2],a.b[3]);this.polygonClass=a.cl;for(f in a.li)this.lines[f]=(new Y).load(a.li[f]),this.lines[f].refresh();return this};d.prototype.addLine=function(a,g,b){a&&(a=new v(a));g&&(g=new v(g));b&&(b=new v(b));this.lines.push(new Y(a,g,b))};d.prototype.addMove=function(a){a=new v(a);this.lines.push(new Y(a,null,null,"move"))};d.prototype.addArc=function(a,g,b){a=new v(a);g&&(g=new v(g));b&&(b=new v(b));this.lines.push(new Y(a,g,b,"arc"))};d.prototype.addArcTo=function(a,
g,b){a=new v(a);g&&(g=new v(g));b&&(b=new v(b));this.lines.push(new Y(a,g,b,"arcTo"))};d.prototype.addRectangle=function(a,g,b,c){a=new v(a);g=g||1;b=b||1;var d=a.matrix[0]-g/2,f=a.matrix[1]-b/2;g=a.matrix[0]+g/2;a=a.matrix[1]+b/2;c?(this.addLine([d,f+c]),this.addArc([d+c,f+c],[c,0,0,3.14],[0,0,0,-1.57079633]),this.addLine([g-c,f]),this.addArc([g-c,f+c],[c,0,0,4.71],[0,0,0,0]),this.addLine([g,a-c]),this.addArc([g-c,a-c],[c,0,0,0],[0,0,0,1.57]),this.addLine([d+c,a]),this.addArc([d+c,a-c],[c,0,0,1.57],
[0,0,0,3.14]),this.addLine([d,f+c])):(this.addMove([d,f]),this.addLine([g,f]),this.addLine([g,a]),this.addLine([d,a]),this.addLine([d,f]))};d.prototype.union=function(a){};d.prototype.clone=function(){a=new N;a.fill=this.fill.isThemeColor?this.fill:new x(this.fill);a.stroke=this.stroke.isThemeColor?this.stroke:new x(this.stroke);a.lineWidth=this.lineWidth;a.lineDash=this.lineDash;a.lineDashOffset=this.lineDashOffset;a.closePath=this.closePath;a.alpha=this.alpha;a.scaleStrokeWhenScaling=this.scaleStrokeWhenScaling;
f=0;for(q=this.lines.length;f<q;f++)a.lines[f]=this.lines[f].clone();return a};d.prototype.reset=function(){f=0;for(q=this.lines.length;f<q;f++)this.lines[f].reset()};d.prototype.scale=function(a,g){f=0;for(q=this.lines.length;f<q;f++)g&&this.lines[f].reset(),this.lines[f].scale(a)};d.prototype.setPosition=function(a,g,b,c){h.set(a,g,b,g).sub(this.center.vector);f=0;for(q=this.lines.length;f<q;f++)this.lines[f].point.add(h),this.lines[f].anchor1&&this.lines[f].anchor1.add(h),this.lines[f].anchor2&&
this.lines[f].anchor2.add(h);this.normalize();this.relatedBody&&this.relatedBody.translate(h)};d.prototype.translate=function(a,g,b,c){h.set(a,g,b,c);f=0;for(q=this.lines.length;f<q;f++)this.lines[f].point.add(h),this.lines[f].anchor1&&this.lines[f].anchor1.add(h),this.lines[f].anchor2&&this.lines[f].anchor2.add(h);this.normalize();this.relatedBody&&this.relatedBody.translate(h)};d.prototype.draw=function(a,g,b,c){if(this.visible){a.save();a.globalAlpha*=this.alpha;a.fillStyle=g&&g.HSL?this.fill.clone().adjustHSL(g.HSL[0],
g.HSL[1],g.HSL[2]).toString():this.effects&&this.effects.HSL?this.fill.clone().adjustHSL(this.effects.HSL[0],this.effects.HSL[1],this.effects.HSL[2]).toString():this.fill.toString();a.beginPath();f=0;for(q=this.lines.length;f<q;f++)0==f&&1<this.lines.length?this.closePath?(a.moveTo(this.lines[this.lines.length-1].point.matrix[0],this.lines[this.lines.length-1].point.matrix[1]),this.lines[f].draw(a)):a.moveTo(this.lines[f].point.matrix[0],this.lines[f].point.matrix[1]):this.lines[f].draw(a);this.closePath&&
a.closePath();if(b&&c&&c.inputMouseEvents&&0<c.inputMouseEvents.length&&a.isPointInPath&&a.isPointInPath(b.input.mouseAbosluteX,b.input.mouseAbosluteY))for(f=0,q=c.inputMouseEvents.length;f<q;f++)c.inputMouseEvents[f].mouseHitPass||(c.inputMouseEvents[f].mouseHitPass={entity:c,polygons:[],objects:[]}),c.inputMouseEvents[f].mouseHitPass.objects.push(c),c.inputMouseEvents[f].mouseHitPass.polygons.push(this);if(b&&0<this.inputMouseEvents.length&&a.isPointInPath&&a.isPointInPath(b.input.mouseAbosluteX,
b.input.mouseAbosluteY))for(f=0,q=this.inputMouseEvents.length;f<q;f++)this.inputMouseEvents[f].mouseHitPass||(this.inputMouseEvents[f].mouseHitPass={polygons:[]}),this.inputMouseEvents[f].mouseHitPass.polygons.push(this);this.effects&&this.effects.outline&&(a.closePath(),a.strokeStyle=this.effects.outline.toString(),a.lineWidth=8,c&&(a.lineWidth/=c.scale.matrix[0]),a.stroke());g&&g.outline?(a.closePath(),a.strokeStyle=g.outline.toString(),a.lineWidth=8,c&&(a.lineWidth/=c.scale.matrix[0]),a.stroke()):
(this.fill&&a.fill(),0<this.lineWidth&&(a.strokeStyle=g&&g.HSL?this.stroke.clone().adjustHSL(g.HSL[0],g.HSL[1],g.HSL[2]).toString():this.effects&&this.effects.HSL?this.stroke.clone().adjustHSL(this.effects.HSL[0],this.effects.HSL[1],this.effects.HSL[2]).toString():this.stroke.toString(),a.lineWidth=this.lineWidth,c&&!this.scaleStrokeWhenScaling&&(a.lineWidth/=c.scale.matrix[0]),this.lineDash&&a.setLineDash&&(a.setLineDash(this.lineDash.split(",").map(function(b){return 1*b})),a.lineDashOffset=this.lineDashOffset),
a.stroke()));m=(c&&c.debugFlags)|this.debugFlags;if(m&1){a.save();a.setLineDash([0]);a.globalAlpha=1;f=0;for(q=this.lines.length;f<q;f++)a.beginPath(),a.strokeStyle="#00FFFF",a.lineWidth=1,a.arc(this.lines[f].point.matrix[0],this.lines[f].point.matrix[1],5,0,2*Math.PI),this.closePath||0!=f&&f!=this.lines.length-1||a.arc(this.lines[f].point.matrix[0],this.lines[f].point.matrix[1],2.5,0,2*Math.PI),a.stroke(),m&2&&(a.strokeStyle="#FF00FF",a.lineWidth=1,this.lines[f].anchor1&&(a.beginPath(),a.arc(this.lines[f].anchor1.matrix[0],
this.lines[f].anchor1.matrix[1],5,0,2*Math.PI),a.moveTo(this.lines[(0==f?this.lines.length:f)-1].point.matrix[0],this.lines[(0==f?this.lines.length:f)-1].point.matrix[1]),a.lineTo(this.lines[f].anchor1.matrix[0],this.lines[f].anchor1.matrix[1]),a.stroke()),this.lines[f].anchor2&&(a.beginPath(),a.arc(this.lines[f].anchor2.matrix[0],this.lines[f].anchor2.matrix[1],5,0,2*Math.PI),a.moveTo(this.lines[f].point.matrix[0],this.lines[f].point.matrix[1]),a.lineTo(this.lines[f].anchor2.matrix[0],this.lines[f].anchor2.matrix[1]),
a.stroke()),this.lines[f].anchor3&&(a.beginPath(),a.arc(this.lines[f].anchor3.matrix[0],this.lines[f].anchor3.matrix[1],5,0,2*Math.PI),a.moveTo(this.lines[f].point.matrix[0],this.lines[f].point.matrix[1]),a.lineTo(this.lines[f].anchor3.matrix[0],this.lines[f].anchor3.matrix[1]),a.stroke()));a.restore()}m&32&&(a.save(),a.beginPath(),a.strokeStyle="#FF00FF",a.rect(this.box.left,this.box.top,this.box.getWidth(),this.box.getHeight()),a.stroke(),a.restore());a.restore()}};d.prototype.toSVG=function(a,
g,b,c){b='<path d="';f=0;for(q=this.lines.length;f<q;f++){var d=this.lines[f];0==f&&(b+="M "+(d.point.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.point.matrix[1]*g.matrix[1]+a.matrix[1])+" ");switch(d.type){case "move":b+="M "+(d.point.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.point.matrix[1]*g.matrix[1]+a.matrix[1]);break;case "line":b=d.anchor2&&d.anchor1?b+("C "+(d.anchor1.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.anchor1.matrix[1]*g.matrix[1]+a.matrix[1])+" "+(d.anchor2.matrix[0]*g.matrix[0]+a.matrix[0])+
" "+(d.anchor2.matrix[1]*g.matrix[1]+a.matrix[1])+" "+(d.point.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.point.matrix[1]*g.matrix[1]+a.matrix[1])):d.anchor2?b+("Q "+(d.anchor2.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.anchor2.matrix[1]*g.matrix[1]+a.matrix[1])+" "+(d.point.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.point.matrix[1]*g.matrix[1]+a.matrix[1])):d.anchor1?b+("Q "+(d.anchor1.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.anchor1.matrix[1]*g.matrix[1]+a.matrix[1])+" "+(d.point.matrix[0]*g.matrix[0]+
a.matrix[0])+" "+(d.point.matrix[1]*g.matrix[1]+a.matrix[1])):b+("L "+(d.point.matrix[0]*g.matrix[0]+a.matrix[0])+" "+(d.point.matrix[1]*g.matrix[1]+a.matrix[1]))}b+=" "}this.closePath&&(b+="Z");return b+'" fill="'+this.fill.toHex()+'" stroke="'+this.stroke.toHex()+'" stroke-width="'+this.lineWidth+'" opacity="'+(this.alpha||1)*(c||1)+'" />'};d.prototype.pointMap=function(a,g,b){a.beginPath();this.lines.length&&this.closePath&&a.moveTo(this.lines[this.lines.length-1].point.matrix[0],this.lines[this.lines.length-
1].point.matrix[1]);f=0;for(q=this.lines.length;f<q;f++)this.lines[f].draw(a);this.closePath&&a.closePath();return a.isPointInPath(g,b)};d.prototype.fromArray=function(a){f=this.lines.length=0;for(q=a.length;f<q;f++)this.lines.push(new Y(a[f]));return this};d.prototype.normalize=function(){this.getBox();this.getCenter();this.normalizeCenter();this.normalizeDirection();return this};d.prototype.getCenter=function(){this.center.set(this.box.left,this.box.top).add((this.box.right-this.box.left)/2,(this.box.bottom-
this.box.top)/2);return this.center};d.prototype.getDirection=function(){f=0;for(q=this.lines.length;f<q;f++)this.lines[f].point.origin.sub(this.center),this.lines[f].point.vector.sub(this.center)};d.prototype.normalizeCenter=function(){f=0;for(q=this.lines.length;f<q;f++)this.lines[f].point.origin.sub(this.center),this.lines[f].point.vector.sub(this.center);return this};d.prototype.normalizeDirection=function(){return this};d.prototype.getBox=function(){if(this.static&&this.box.isSet())return this.box;
var a=Infinity,g=Infinity,b=-Infinity,c=-Infinity;f=0;for(q=this.lines.length;f<q;f++)a=Math.min(a,this.lines[f].point.matrix[0]),g=Math.min(g,this.lines[f].point.matrix[1]),b=Math.max(b,this.lines[f].point.matrix[0]),c=Math.max(c,this.lines[f].point.matrix[1]);return this.box=new C(a,g,b,c)};d.prototype.getBoxPixel=function(){var a=document.createElement("canvas"),g=a.getContext("2d");a.width=1E3;a.height=1E3;g.translate(a.width/2,a.height/2);g.scale(.5,.5);this.draw(g);for(var g=g.getImageData(0,
0,a.width,a.height),b=Infinity,c=Infinity,d=-Infinity,f=-Infinity,h,q,m,p,v,w=0;w<a.height;w++){v=w*a.width;for(var x=0;x<a.width;x++)if(p=4*(v+x),h=g.data[p],q=g.data[p+1],m=g.data[p+2],p=g.data[p+3],h||q||m||p)b=Math.min(b,x+1),c=Math.min(c,w+1),d=Math.max(d,x),f=Math.max(f,w)}b-=a.width/2;c-=a.height/2;d-=a.width/2;f-=a.height/2;return this.box=this.getBox().combine((new C(b,c,d,f)).scale(new u(2,2)))};return d}(),U=function(){var p=0,a;new u;var m=document.createElement("canvas").getContext("2d"),
h,f,q=function(a,f,g,b,c,k){this.id=p++;this.position=new v(f);this.scale=new u(1,1);this.text=a;this.fill=g||new x(0,0,0,1);this.stroke=b||"";this.lineWidth=1;this.closePath=!1;this.alpha=1;this.font=c||"sans-serif";this.size=k||8;this.textAlign="Center";this.textBaseline="Bottom";this.inputMouseEvents=[];this.box=new C;this.effects={};this.textClass;this.debugFlags=0};q.prototype.save=function(){a={};a.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];
this.fill&&(a.f=[this.fill.red,this.fill.green,this.fill.blue,this.fill.alpha]);this.stroke&&(a.s=[this.stroke.red,this.stroke.green,this.stroke.blue,this.stroke.alpha]);a.w=this.lineWidth;a.cp=this.closePath;a.a=this.alpha;a.b=[this.box.left,this.box.top,this.box.right,this.box.bottom];a.cl=this.textClass;a.ft=this.font;a.sz=this.size;a.ta=this.textAlign;a.tb=this.textBaseLine;a.t=this.text;return a};q.prototype.load=function(a){this.position.set(a.p[0],a.p[1],a.p[2],a.p[3]).normalize();a.f&&this.fill.set(a.f[0],
a.f[1],a.f[2],a.f[3]);a.s&&(this.stroke=new x(a.s[0],a.s[1],a.s[2],a.s[3]));this.lineWidth=a.w;this.closePath=a.cp;this.alpha=a.a;this.box.set(a.b[0],a.b[1],a.b[2],a.b[3]);this.textClass=a.cl;this.font=a.ft;this.size=a.sz;this.textAlign=a.ta;this.textBaseLine=a.tb;this.text=a.t;return this};q.prototype.clone=function(){a=new U;a.fill=this.fill.isThemeColor?this.fill:new x(this.fill);a.stroke=this.stroke.isThemeColor?this.stroke:new x(this.stroke);a.lineWidth=this.lineWidth;a.closePath=this.closePath;
a.alpha=this.alpha;a.text=this.text;a.font=this.font;a.size=this.size;a.textAlign=this.textAlign;a.textBaseLine=this.textBaseLine;return a};q.prototype.reset=function(){h=0;for(f=this.lines.length;h<f;h++)this.lines[h].reset()};q.prototype.scale=function(a,f){this.position.set(vectorOrX,y,z,t)};q.prototype.setPosition=function(a,f,g,b){this.position.set(a,f,g,b)};q.prototype.translate=function(a,f,g,b){this.position.add(a,f,g,b)};q.prototype.setScale=function(a,f){this.scale.set(a,f)};q.prototype.pointMap=
function(a,f,g){return!1};q.prototype.draw=function(a,q,g,b){if(!(0>=this.alpha)){a.save();a.translate(this.position.matrix[0],this.position.matrix[1]);a.rotate(this.position.orientation);a.scale(this.scale.matrix[0],this.scale.matrix[1]);a.globalAlpha*=this.alpha;a.font=this.size+"px "+this.font;a.textAlign=this.textAlign.toLowerCase();a.textBaseline=this.textBaseline.toLowerCase();this.stroke&&(a.strokeStyle=this.stroke.toString(),a.lineWidth=this.lineWidth,a.strokeText(this.text,0,0));this.fill&&
(a.fillStyle=this.fill.toString(),a.fillText(this.text,0,0));a.beginPath();a.moveTo(this.box.left,this.box.top);a.lineTo(this.box.right,this.box.top);a.lineTo(this.box.right,this.box.bottom);a.lineTo(this.box.left,this.box.bottom);a.closePath();if(g&&0<this.inputMouseEvents.length&&a.isPointInPath&&a.isPointInPath(g.input.mouseAbosluteX,g.input.mouseAbosluteY))for(h=0,f=this.inputMouseEvents.length;h<f;h++)this.inputMouseEvents[h].mouseHitPass||(this.inputMouseEvents[h].mouseHitPass={entity:this,
polygons:[],objects:[]}),this.inputMouseEvents[h].mouseHitPass.objects.push(this),this.inputMouseEvents[h].mouseHitPass.polygons.push(this);this.effects&&this.effects.outline&&(a.strokeStyle=this.effects.outline,a.fillStyle="",a.lineWidth=2,a.stroke());a.restore()}};q.prototype.getCenter=function(){this.center.set(this.box.left,this.box.top).add((this.box.right-this.box.left)/2,(this.box.bottom-this.box.top)/2);return this.center};q.prototype.getTextDimensionsM=function(){m.font=this.size+"px "+this.font;
m.textAlign=this.textAlign.toLowerCase();m.textBaseline=this.textBaseline.toLowerCase();return{width:m.measureText(this.text).width,height:m.measureText("iM").width}};q.prototype.getTextDimensionsDOM=function(){var a=document.getElementsByTagName("body")[0],f=document.createElement("div"),g=document.createTextNode(q),b={width:0,height:0};f.appendChild(g);f.setAttribute("style","font-family: "+this.font+"; font-size: "+this.size+"px; display: table-cell;");a.appendChild(f);b.width=f.offsetWidth;b.height=
f.offsetHeight;a.removeChild(f);return b};q.prototype.getBox=function(){return this.box};q.prototype.getBoxPixel=function(){var a=this.getTextDimensionsM();this.box=new C(-(a.width/2),-(a.height/2),a.width/2,a.height/2);"top"==this.textBaseline.toLowerCase()&&this.box.translate(new u(0,a.height/2));"bottom"==this.textBaseline.toLowerCase()&&this.box.translate(new u(0,-a.height/2));"left"==this.textAlign.toLowerCase()&&this.box.translate(new u(a.width/2,0));"right"==this.textAlign.toLowerCase()&&this.box.translate(new u(-a.width/
2,0));return this.box};q.prototype.update=function(){h=0;for(f=this.entities.length;h<f;h++)this.entities[h].update(dt)};return q}(),ba=function(){var p,a=new u,m,h,f,q={},d=function(a,g,b,c){this.position=new v(a,g,b,c);this.scale=new u(1,1);this.alpha=1;this.polygons=[];this.texts=[];this.bodies=[];this.box=new C;this.modelName;this.matrix=this.position.matrix;this.inputMouseEvents=[];this.physicsEnabled=!1;this.effects={outline:!1};this.flipY=this.flipX=!1};d.prototype.save=function(){p={};p.p=
[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];p.s=[this.scale.matrix[0],this.scale.matrix[1]];p.a=this.alpha;p.c=this.tileClass;p.py=[];for(var a in this.polygons)p.py[a]=this.polygons[a].save();p.tx=[];for(a in this.texts)p.tx[a]=this.texts[a].save();p.bd=[];for(a in this.bodies)p.bd[a]=this.bodies[a].save();p.ph=this.physicsEnabled;p.ef=this.effects;return p};d.prototype.load=function(a){if("string"===typeof a){if(!I.models[a])return;f=a;a=I.models[a];
a.modelName=f}this.position.set(a.p[0],a.p[1],a.p[2],a.p[3]).normalize();this.scale.set(a.s[0],a.s[1]);this.alpha=a.a;this.tileClass=a.c;for(var g in a.py)this.polygons[g]=(new N).load(a.py[g]);for(g in a.tx)this.polygons[g]=(new N).load(a.tx[g]);for(g in a.bd)this.bodies[g]=(new S).load(a.bd[g]);for(g in a.ef)this.effects[g]=a.ef[g];this.physicsEnabled=a.ph;return this};d.prototype.saveOptions=function(){return{m:this.modelName,p:[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],
this.position.orientation],s:[this.scale.matrix[0],this.scale.matrix[1]],a:this.alpha,c:this.tileClass,pe:this.physicsEnabled,fx:this.flipX,fy:this.flipY,ef:this.effects}};d.prototype.loadOptions=function(a){if(!a)return this;a.tileClass&&(this.tileClass=a.tileClass);a.flipX&&(this.flipX=a.flipX);a.flipY&&(this.flipY=a.flipY);if(a.flipX||a.flipY)for(var g=0,b=this.bodies.length;g<b;g++)for(var c=0,d=this.bodies[g].shapes.length;c<d;c++)this.bodies[g].shapes[c].flip(this.flipX,this.flipY);a.scale&&
this.setScale(a.scale[0],a.scale[1]);void 0!==a.alpha&&(this.alpha=a.alpha);void 0!==a.physicsEnabled&&(this.physicsEnabled=a.physicsEnabled);return this};d.prototype.clear=function(){this.tileClass="";this.position.set(0,0,0,0).normalize();this.scale.set(1,1);this.alpha=1;this.polygons.length=0;for(var a in this.bodies)this.bodies[a].removeFromWorld();this.bodies.length=0;this.effects={outline:!1};return this};d.prototype.instance=function(){p=new ba;p.modelName=this.modelName;p.scale=new u(this.scale);
p.alpha=this.alpha;p.tileClass=this.tileClass;for(var a=0,g=this.polygons.length;a<g;a++)p.polygons[a]=this.polygons[a].clone();a=0;for(g=this.bodies.length;a<g;a++)p.bodies[a]=this.bodies[a].clone();p.physicsEnabled=this.physicsEnabled;p.flip(this.flipX,this.flipY);return p};d.prototype.setPosition=function(d,g,b,c){a.set(d,g,b,c).sub(this.position.vector);this.position.set(d);d=0;for(g=this.bodies.length;d<g;d++)this.bodies[d].translate(a,0)};d.prototype.translate=function(d,g,b,c){a.set(d,g,b,
c);this.position.add(d,g,b,c);d=0;for(g=this.bodies.length;d<g;d++)this.bodies[d].translate(a,c)};d.prototype.setScale=function(d,g){a.set(d,g);for(var b=0,c=this.bodies.length;b<c;b++)this.bodies[b].scaleTo(a);this.scale.set(a)};d.prototype.flip=function(a,g){this.flipX=a;this.flipY=g;for(var b=0,c=this.bodies.length;b<c;b++)this.bodies[b].flip(a,g)};d.prototype.addToWorld=function(a,g){for(var b=0,c=this.bodies.length;b<c;b++)this.bodies[b].addToWorld(a,g,this);b=0;for(c=this.bodies.length;b<c;b++)this.bodies[b].weld(this)};
d.prototype.getReference=function(a){_rReference=this;for(var g=0,b=a.length;g<b;g++)_rReference=_rReference[a[g]];return _rReference};d.prototype.getBox=function(){if(q[this.modelName])this.box.set(q[this.modelName]);else{for(var a=0,g=this.polygons.length;a<g;a++)0==a?this.box.set(this.polygons[a].getBox()):this.box.combine(this.polygons[a].getBox());q[this.modelName]=new C(this.box)}this.box.scale(this.scale);return this.box};d.prototype.getBoxPixel=function(){if(q[this.modelName])this.box.set(q[this.modelName]);
else{for(var a=0,g=this.polygons.length;a<g;a++)0==a?this.box.set(this.polygons[a].getBoxPixel()):this.box.combine(this.polygons[a].getBoxPixel());q[this.modelName]=new C(this.box)}this.box.scale(this.scale);return this.box};d.prototype.clearBoxFromCache=function(){delete q[this.modelName]};d.prototype.removeFromWorld=function(){for(var a=0,g=this.bodies.length;a<g;a++)this.bodies[a].removeFromWorld()};d.prototype.findShapeByFixture=function(a){for(var g=0,b=this.bodies.length;g<b;g++)if(h=this.bodies[g].findShapeByFixture(a))return h;
return!1};d.prototype.pointMap=function(a,g,b){a.save();a.translate(this.position.matrix[0],this.position.matrix[1]);a.scale(this.scale.matrix[0]*(this.flipX?-1:1),this.scale.matrix[1]*(this.flipY?-1:1));m=this.polygons.map(function(c){return c.pointMap(g,b)});a.restore();return m};d.prototype.draw=function(a,g,b){a.save();a.translate(this.position.matrix[0],this.position.matrix[1]);a.rotate(this.position.orientation);a.scale(this.scale.matrix[0]*(this.flipX?-1:1),this.scale.matrix[1]*(this.flipY?
-1:1));a.globalAlpha*=this.alpha;a.lineWidth=this.scale.matrix[0];this.box.isSet()&&a.scale((this.box.getWidth()+1)/this.box.getWidth(),(this.box.getHeight()+1)/this.box.getHeight());if(this.effects.outline){g=0;for(var c=this.polygons.length;g<c;g++)this.polygons[g].draw(a,{outline:this.effects.outline},b,this)}g=0;for(c=this.polygons.length;g<c;g++)this.polygons[g].draw(a,{HSL:this.effects.HSL},b,this);g=0;for(c=this.texts.length;g<c;g++)this.texts[g].draw(a,{HSL:this.effects.HSL},b,this);this.debugFlags&
16&&(a.save(),a.beginPath(),a.strokeStyle="#00FF00",a.strokeWidth=1,a.scale(1/(this.scale.matrix[0]*(this.flipX?-1:1)),1/(this.scale.matrix[1]*(this.flipY?-1:1))),a.rect(this.box.left,this.box.top,this.box.getWidth(),this.box.getHeight()),a.stroke(),a.restore());a.restore()};d.prototype.toSVG=function(a){a="";this.getBox();for(var g=0,b=this.polygons.length;g<b;g++)a+=this.polygons[g].toSVG(this.position,this.scale,this.box,this.alpha);return a};return d}(),C=function(){var p=new u,a=function(a,h,
f,q){this.set(a,h,f,q);this.center=new u};a.prototype.set=function(a,h,f,q){a instanceof C?(this.left=a.left,this.top=a.top,this.right=a.right,this.bottom=a.bottom):(this.left=a||0,this.top=h||0,this.right=f||this.left,this.bottom=q||this.top);return this};a.prototype.clone=function(){return new C(this)};a.prototype.getWidth=function(){return this.right-this.left};a.prototype.getHeight=function(){return this.bottom-this.top};a.prototype.getCenter=function(){return this.center.set(this.left+this.getWidth()/
2,this.top+this.getHeight()/2)};a.prototype.combine=function(a){this.left=Math.min(this.left,a.left);this.top=Math.min(this.top,a.top);this.right=Math.max(this.right,a.right);this.bottom=Math.max(this.bottom,a.bottom);return this};a.prototype.scale=function(a){this.getCenter();this.left*=a.matrix[0];this.top*=a.matrix[1];this.right*=a.matrix[0];this.bottom*=a.matrix[1];return this};a.prototype.translate=function(a){this.left+=a.matrix[0];this.top+=a.matrix[1];this.right+=a.matrix[0];this.bottom+=
a.matrix[1];return this};a.prototype.intersect=function(a,h,f){h=h||p;return this.right<a.left+h.matrix[0]-(f||0)||this.left>a.right+h.matrix[0]+(f||0)||this.bottom<a.top+h.matrix[1]-(f||0)||this.top>a.bottom+h.matrix[1]+(f||0)?!1:!0};a.prototype.pointInBox=function(a,h,f){h=h||p;return this.right<a.matrix[0]+h.matrix[0]-(f||0)||this.left>a.matrix[0]+h.matrix[0]+(f||0)||this.bottom<a.matrix[1]+h.matrix[1]-(f||0)||this.top>a.matrix[1]+h.matrix[1]+(f||0)?!1:!0};a.prototype.isSet=function(){return!!(this.left||
this.top||this.right||this.bottom)};return a}(),ua=function(){var p=0,a,m,h,f,q,d,s=function(a,b,c,d,f){this.id=p++;this.name=f||"";this.stage=a;this.layer=b||0;this.position=new v(c,d);this.inputMouseEvents=[];this.effects={}};s.prototype.save=function(){a={};a.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];a.l=this.layer;a.n=this.name;return a};s.prototype.load=function(a){this.position.set(a.p[0],a.p[1],a.p[2],a.p[3]);this.layer=a.l;this.name=
a.n;return this};s.prototype.clear=function(){this.position.set(0,0,0,0);this.layer=0;this.name=""};s.prototype.instance=function(){a=new s;a.name=this.name;a.layer=this.layer;return a};s.prototype.setPosition=function(a,b,c,d){this.position.set(a,b,c,d)};s.prototype.translate=function(a,b,c,d){this.position.add(a,b,c,d)};s.prototype.getReference=function(a){m=this;q=0;for(d=a.length;q<d;q++)m=m[a[q]];return m};s.prototype.draw=function(a,b,c){a.save();a.translate(this.position.matrix[0],this.position.matrix[1]);
a.beginPath();a.arc(0,0,1,0,6.3,!1);a.arc(0,0,40,0,6.3,!1);a.lineTo(0,40);this.effects&&this.effects.outline&&(a.lineWidth=8,a.strokeStyle=this.effects.outline,a.stroke());a.lineWidth=6;a.strokeStyle="#F0F";a.stroke();if(c&&0<this.inputMouseEvents.length&&a.isPointInPath(c.input.mouseAbosluteX,c.input.mouseAbosluteY))for(h=0,f=this.inputMouseEvents.length;h<f;h++)this.inputMouseEvents[h].mouseHitPass||(this.inputMouseEvents[h].mouseHitPass={objects:[this],polygons:[]}),this.inputMouseEvents[h].mouseHitPass.objects.push(this);
a.restore()};return s}(),V=function(){var p=0,a,m,h,f,q,d,s=new u,g={},b=function(b,a,g,d){this.id=p++;this.position=new v(b,a,g,d);this.scale=new u(1,1);this.alpha=1;this.decay=-1;this.entityClass=this.modelName="";this.timelines={};this.polygons=[];this.bones=[];this.bodies=[];this.box=new C;this.animations={};this.physicsEnabled=this.isStatic=!0;this.fixedRotation=this.tweenDisabled=!1;this.gravityScale=1;this.inputMouseEvents=[];this.effects={outline:!1};this.debugFlags=0;this.renderedLastFrame=
this.flipY=this.flipX=!1};b.prototype.save=function(){this.reset();a={};a.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];a.s=[this.scale.matrix[0],this.scale.matrix[1]];a.a=this.alpha;a.c=this.entityClass;a.ti={};for(var b in this.timelines)a.ti[b]=this.timelines[b].save();a.py=[];for(b in this.polygons)a.py[b]=this.polygons[b].save();a.bn=[];for(b in this.bones)a.bn[b]=this.bones[b].save();a.bd=[];for(b in this.bodies)a.bd[b]=this.bodies[b].save();
a.an={};for(b in this.animations)a.an[b]=this.animations[b].save();a.tw=this.tweenDisabled;a.ef=this.effects;return a};b.prototype.load=function(b,a){if("string"===typeof b){if(!I.models[b])return;q=b;b=I.models[b];b.modelName=q}this.position.set(b.p[0],b.p[1],b.p[2],b.p[3]).normalize();this.scale.set(b.s[0],b.s[1]);this.alpha=b.a;this.entityClass=b.c;this.modelName=b.modelName||"";for(var g in b.ti)this.timelines[g]=(new ta).load(b.ti[g]);for(g in b.py)this.polygons[g]=(new N).load(b.py[g]);for(g in b.bn)this.bones[g]=
(new sa).load(b.bn[g]);for(g in b.bd)this.bodies[g]=(new S).load(b.bd[g]);for(g in b.an)this.animations[g]=(new Ba).load(b.an[g]);for(g in b.ef)this.effects[g]=b.ef[g];this.tweenDisabled=b.tw;a&&this.loadOptions(a);return this};b.prototype.saveOptions=function(){d={};for(var b in this.timelines)d[b]={active:this.timelines[b].active,loop:this.timelines[b].loop};return{m:this.modelName,p:[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation],s:[this.scale.matrix[0],
this.scale.matrix[1]],c:this.entityClass,a:this.alpha,t:d,pe:this.physicsEnabled,gs:this.gravityScale,fr:this.bodies[0]?this.bodies[0].fixedRotation:!1,aw:this.bodies[0]?this.bodies[0].awake:!1,fx:this.flipX,fy:this.flipY,ef:this.effects}};b.prototype.loadOptions=function(b){if(!b)return this;b.id&&(this.id=b.id);if(b.entityClass&&(this.entityClass=b.entityClass,fa[this.entityClass]&&(this.logic=fa[this.entityClass].instance(),this.logic.onSpawn)))this.logic.onSpawn(this,b,this.position);b.flipX&&
(this.flipX=b.flipX);b.flipY&&(this.flipY=b.flipY);if(b.flipX||b.flipY)for(var a=0,g=this.bodies.length;a<g;a++)for(var d=0,f=this.bodies[a].shapes.length;d<f;d++)this.bodies[a].shapes[d].flip(this.flipX,this.flipY);if(void 0!==b.fixedRotation)for(this.fixedRotation=b.fixedRotation,a=0,g=this.bodies.length;a<g;a++)this.bodies[a].fixedRotation=b.fixedRotation;if(void 0!==b.awake)for(this.awake=b.awake,a=0,g=this.bodies.length;a<g;a++)this.bodies[a].awake=b.awake;if(void 0!==b.gravityScale)for(this.gravityScale=
b.gravityScale,a=0,g=this.bodies.length;a<g;a++)this.bodies[a].gravityScale*=b.gravityScale;if(b.timelines)for(a in b.timelines)this.timelines[a]&&(this.timelines[a].active=b.timelines[a].active,this.timelines[a].loop=b.timelines[a].loop);b.scale&&(b.scale instanceof Array&&(b.scale=new u(b.scale[0],b.scale[1])),this.setScale(b.scale.matrix[0],b.scale.matrix[1]));void 0!==b.alpha&&(this.alpha=b.alpha);void 0!==b.physicsEnabled&&(this.physicsEnabled=b.physicsEnabled);return this};b.prototype.clear=
function(){this.position.set(0,0,0,0).normalize();this.scale.set(1,1);this.alpha=1;this.polygons.length=0;this.bones.length=0;this.entityClass="";this.effects={outline:!1};for(var b in this.bodies)this.bodies[b].removeFromWorld();this.bodies.length=0;for(b in this.timelines)delete this.timelines[b];for(b in this.animations)delete this.animations[b];return this};b.prototype.instance=function(){a=new V;a.position=this.position.clone();a.modelName=this.modelName;a.scale=new u(this.scale);a.alpha=this.alpha;
for(var b in this.timelines)a.timelines[b]=this.timelines[b].clone();b=0;for(var g=this.polygons.length;b<g;b++)a.polygons[b]=this.polygons[b].clone();b=0;for(g=this.bones.length;b<g;b++)a.bones[b]=this.bones[b].clone();b=0;for(g=this.bodies.length;b<g;b++)a.bodies[b]=this.bodies[b].clone();a.animations=this.animations;a.isStatic=this.isStatic;a.physicsEnabled=this.physicsEnabled;a.tweenDisabled=this.tweenDisabled;a.entityClass=this.entityClass;a.gravityScale=this.gravityScale;a.flipX=this.flipX;
a.flipY=this.flipY;return a};b.prototype.setPosition=function(b,a,g,d){d=d||0;s.set(b,a,g,d);this.position.set(b,a,g,d);b=0;for(a=this.bodies.length;b<a;b++)this.bodies[b].setTransform(s,d)};b.prototype.setOrientation=function(b){b=b||0;for(var a=0,g=this.bodies.length;a<g;a++)this.bodies[a].setAngle(b)};b.prototype.setGravityScale=function(b){this.gravityScale=b;for(var a=0,g=this.bodies.length;a<g;a++)this.bodies[a].setOptions({GravityScale:b})};b.prototype.translate=function(b,a,g,d){d=d||0;s.set(b,
a,g,d);this.position.add(b,a,g,d);b=0;for(a=this.bodies.length;b<a;b++)this.bodies[b].translate(s,d)};b.prototype.setScale=function(b,a){s.set(b,a);this.scale.set(s);for(var g=0,d=this.bodies.length;g<d;g++)this.bodies[g].scaleTo(s)};b.prototype.flip=function(b,a){if(this.flipX!=b||this.flipY!=a){this.flipX=b;this.flipY=a;for(var g=0,d=this.bodies.length;g<d;g++)this.bodies[g].flip(b,a);return!0}return!1};b.prototype.applyForce=function(b,a){a=a||this.position;this.bodies[0]&&this.bodies[0].applyForce(b,
a)};b.prototype.applyImpulse=function(b,a){a=a||this.position;this.bodies[0]&&this.bodies[0].applyImpulse(b,a)};b.prototype.setLinearVelocity=function(b){this.bodies[0]&&this.bodies[0].setLinearVelocity(b)};b.prototype.getLinearVelocity=function(){return this.bodies[0]?this.bodies[0].getLinearVelocity():new u};b.prototype.addTimeline=function(b){return this.timelines[b]=new ta};b.prototype.addAnimation=function(b,a){return this.animations[b]=a};b.prototype.setAnimation=function(b,a,g,d){this.timelines[b]||
this.addTimeline(b);this.timelines[b].animations.length&&this.timelines[b].animations.join(".")===(a instanceof Array?a:[a]).join(".")||(this.timelines[b].time=0,this.timelines[b].animations=a instanceof Array?a:[a],this.timelines[b].updateDuration(this),this.timelines[b].animationByTime(this,0));this.timelines[b].active=!0;this.timelines[b].loop=g;this.timelines[b].reverse=d;this.isStatic=!1};b.prototype.addToWorld=function(b,a){for(var g=0,d=this.bodies.length;g<d;g++)this.bodies[g].addToWorld(b,
a,this);g=0;for(d=this.bodies.length;g<d;g++)this.bodies[g].weld(this)};b.prototype.removeFromWorld=function(){for(var b=0,a=this.bodies.length;b<a;b++)this.bodies[b].removeFromWorld()};b.prototype.refresh=function(){for(var b=0,a=this.bodies.length;b<a;b++)this.bodies[b].refresh()};b.prototype.findShapeByFixture=function(b){for(var a=0,g=this.bodies.length;a<g;a++)if(f=this.bodies[a].findShapeByFixture(b))return f;return!1};b.prototype.getReference=function(b){m=this;for(var a=0,g=b.length;a<g;a++)m=
m[b[a]];return m};b.prototype.getBox=function(){if(g[this.modelName])this.box.set(g[this.modelName]);else{if(this.isStatic||!this.renderedLastFrame)for(var b=0,a=this.polygons.length;b<a;b++)0==b?this.box.set(this.polygons[b].getBox()):this.box.combine(this.polygons[b].getBox());else for(b in this.timelines)this.timelines[b].frame&&(0==b?this.box.set(this.timelines[b].frame.getBox(this)):this.box.combine(this.timelines[b].frame.getBox(this)));g[this.modelName]=new C(this.box)}this.box.scale(this.scale);
return this.box};b.prototype.getBoxPixel=function(){if(g[this.modelName])this.box.set(g[this.modelName]);else{this.reset();if(this.isStatic)for(var b=0,a=this.polygons.length;b<a;b++)0==b?this.box.set(this.polygons[b].getBoxPixel()):this.box.combine(this.polygons[b].getBoxPixel());else for(b in this.timelines)this.timelines[b].frame&&(0==b?this.box.set(this.timelines[b].frame.getBoxPixel(this)):this.box.combine(this.timelines[b].frame.getBoxPixel(this)));g[this.modelName]=new C(this.box)}this.box.scale(this.scale);
return this.box};b.prototype.clearBoxFromCache=function(){delete g[this.modelName]};b.prototype.callAction=function(b,a){this.logic.actions[b]&&this.logic.actions[b].apply(this,Array.prototype.slice.call(arguments,1))};b.prototype.reset=function(){for(var b=0,a=this.bones.length;b<a;b++)this.bones[b].reset()};b.prototype.update=function(b,a){this.physicsEnabled&&this.position.reset();this.reset();for(var g in this.timelines)this.timelines[g].update(this,b);if(!this.tweenDisabled&&this.renderedLastFrame)for(g in this.timelines)this.timelines[g].tween(this,
b);if(this.physicsEnabled){g=0;for(var d=this.bodies.length;g<d;g++)this.bodies[g].update(this)}if(this.renderedLastFrame)for(g=0,d=this.bones.length;g<d;g++)this.bones[g].update(this);this.logic&&this.logic.update&&b&&this.logic.update.call(this,a,b)};b.prototype.pointMap=function(b,a,g){b.save();b.translate(this.position.matrix[0],this.position.matrix[1]);b.rotate(this.position.orientation);b.scale(this.scale.matrix[0]*(this.flipX?-1:1),this.scale.matrix[1]*(this.flipY?-1:1));h=this.polygons.map(function(b,
c){if(this.isStatic)return b.pointMap(a,g);for(var d in this.timelines)if(this.timelines[d].active&&-1!=this.timelines[d].frame.polygons.indexOf(c))return b.pointMap(a,g);return!1});b.restore();return h};b.prototype.draw=function(b,a,g){b.save();b.translate(this.position.matrix[0],this.position.matrix[1]);b.rotate(this.position.orientation);b.scale(this.scale.matrix[0]*(this.flipX?-1:1),this.scale.matrix[1]*(this.flipY?-1:1));b.globalAlpha*=this.alpha;this.box.isSet()&&b.scale((this.box.getWidth()+
1)/this.box.getWidth(),(this.box.getHeight()+1)/this.box.getHeight());if(this.effects.outline)if(this.isStatic){var d=0;for(a=this.polygons.length;d<a;d++)this.polygons[d].draw(b,{outline:this.effects.outline},g,this)}else for(d in this.timelines)this.timelines[d].draw(b,{outline:this.effects.outline},g,this);if(this.isStatic)for(d=0,a=this.polygons.length;d<a;d++)this.polygons[d].draw(b,{HSL:this.effects.HSL},g,this);else for(d in this.timelines)this.timelines[d].draw(b,{HSL:this.effects.HSL},g,
this);this.debugFlags&16&&(b.save(),b.beginPath(),b.strokeStyle="#00FF00",b.scale(1/(this.scale.matrix[0]*(this.flipX?-1:1)),1/(this.scale.matrix[1]*(this.flipY?-1:1))),b.strokeWidth=2,b.rect(this.box.left,this.box.top,this.box.getWidth(),this.box.getHeight()),b.stroke(),b.restore());b.restore()};b.prototype.toSVG=function(b){var a="";if(this.isStatic){var g=0;for(b=this.polygons.length;g<b;g++)a+=this.polygons[g].toSVG(this.position,this.scale,this.box)}else for(g in this.timelines)a+=this.timelines[g].toSVG(b);
return a};return b}(),La=function(){var p=0,a,m=function(a,f,q,d,m,g,b,c,k,W,u){p++;this.id=a||p;this.memory=f||new Aa("",{});this.actions=q||{};this.onSpawn=d;this.onDestroy=m;this.beginContact=g;this.endContact=b;this.preSolve=c;this.postSolve=k;this.update=W;this.onEmit=u};m.prototype.instance=function(){var h=new Aa(this.memory.id,{RAM:{},ROM:{},HDD:{}});for(a in this.memory.RAM)h.RAM[a]=this.memory.RAM[a];for(a in this.memory.ROM)h.ROM[a]=this.memory.ROM[a];for(a in this.memory.HDD)h.HDD[a]=
this.memory.HDD[a];return new La(this.id,h,this.actions,this.onSpawn,this.onDestroy,this.beginContact,this.endContact,this.preSolve,this.postSolve,this.update,this.onEmit)};m.prototype.update=function(a){if(this.onUpdate)this.onUpdate(a)};return m}(),ta=function(){var p=0,a,m,h,f=function(a,d){this.id=p++;this.time=0;this.duration=d||0;this.animations=a||[];this.reverse=this.loop=this.active=!1;this.alpha=this.speed=1;this.animationIndex=0;this.animationName="";this.animationOffset=0;this.frame=this.animation=
null};f.prototype.save=function(){h={};h.ac=this.active;h.an=this.animations;h.d=this.duration;h.a=this.alpha;h.l=this.loop;return h};f.prototype.load=function(a){this.active=a.ac;this.animations=a.an;this.duration=a.d;this.alpha=a.a;this.loop=a.l;return this};f.prototype.clone=function(){h=new ta(this.animations.slice(),this.duration);h.loop=this.loop;h.active=this.active;h.reverse=this.reverse;h.speed=this.speed;h.alpha=this.alpha;return h};f.prototype.updateDuration=function(a){for(var d=this.duration=
0,f=this.animations.length;d<f;d++)this.duration="number"===typeof this.animations[d]?this.duration+this.animations[d]:this.duration+a.animations[this.animations[d]].duration;return this.duration};f.prototype.animationByTime=function(f,d){for(var h=this.animationOffset=0,g=this.animations.length;h<g;h++){"number"===typeof this.animations[h]?(m=this.animations[h],a=this.animations[h]):(m=f.animations[this.animations[h]],a=m.duration);if(d<this.animationOffset+a)return this.animationIndex=h,this.animationName=
this.animations[h],m;this.animationOffset+=a}this.animationIndex=this.animations.length-1;this.animationName=this.animations[this.animationIndex];return f.animations[this.animations[this.animationIndex]]};f.prototype.modTime=function(a,d,f){f&&(a=this.duration-a);d&&(a%=this.duration);return a};f.prototype.update=function(a,d){this.active&&(this.time=this.modTime(this.time+d*this.speed,this.loop,this.reverse),a.renderedLastFrame&&(this.animation=this.animationByTime(a,this.time),"object"===typeof this.animation?
(this.time>this.duration-this.animation.frames[this.animation.frames.length-1].duration&&!this.loop?(this.frame=this.animation.frames[this.animation.frames.length-1],this.time=this.duration-this.frame.duration):this.frame=this.animation.frameByTime(this.time-this.animationOffset),this.frame.update(a)):this.frame=null))};f.prototype.tween=function(a){this.active&&this.frame&&this.frame.tween(a,this.time-this.animationOffset)};f.prototype.draw=function(a,d,f,g){this.active&&(a.save(),a.globalAlpha*=
this.alpha,this.frame&&this.frame.draw(a,d,f,g),a.restore())};return f}(),Ba=function(){var p=0,a,m=function(a,f){this.id=p++;this.frames=a||[];this.duration=f||0};m.prototype.save=function(){a={};a.d=this.duration;a.f=[];for(var h=0,f=this.frames.length;h<f;h++)a.f[h]=this.frames[h].save();return a};m.prototype.load=function(a){this.duration=a.d;for(var f=0,q=a.f.length;f<q;f++)this.frames[f]=(new Ca).load(a.f[f]);return this};m.prototype.updateDuration=function(){for(var a=this.duration=0,f=this.frames.length;a<
f;a++)this.duration+=this.frames[a].duration;return this.duration};m.prototype.modTime=function(a,f,q){q&&(a=this.duration-a);f&&(a%=this.duration);return a};m.prototype.frameByTime=function(a){for(var f=0,q=this.frames.length;f<q;f++)if(a>=this.frames[f].start&&a<this.frames[f].end)return this.frames[f];return this.frames[this.frames.length-1]};return m}(),Da=function(){var p,a,m=function(a,f,q,d,m){this.reference="string"===typeof a?a.split("."):a;this.start=f;this.change=q;this.easeIn=d;this.easeOut=
m};m.prototype.save=function(){a={};a.r=this.reference;a.i=this.easeIn;a.o=this.easeOut;this.start instanceof v&&(a.s={v:[this.start.matrix[0],this.start.matrix[1],this.start.matrix[2],this.start.orientation]},a.c={v:[this.change.matrix[0],this.change.matrix[1],this.change.matrix[2],this.change.orientation]});this.start instanceof u?(a.s={vc:[this.start.matrix[0],this.start.matrix[1],this.start.matrix[2]]},a.c={vc:[this.change.matrix[0],this.change.matrix[1],this.change.matrix[2]]}):this.start instanceof
x?(a.s={c:[this.start.red,this.start.green,this.start.blue,this.start.alpha]},a.c={c:[this.change.red,this.change.green,this.change.blue,this.change.alpha]}):"number"===typeof this.start&&(a.s={n:this.start},a.c={n:this.change});return a};m.prototype.load=function(a){this.reference=a.r;this.easeIn=a.i;this.easeOut=a.o;a.s.v&&(this.start=new v(a.s.v[0],a.s.v[1],a.s.v[2],a.s.v[3]),this.change=new v(a.c.v[0],a.c.v[1],a.c.v[2],a.c.v[3]));a.s.vc?(this.start=new u(a.s.vc[0],a.s.vc[1],a.s.vc[2]),this.change=
new u(a.c.vc[0],a.c.vc[1],a.c.vc[2])):a.s.c?(this.start=new x(a.s.c[0],a.s.c[1],a.s.c[2],a.s.c[3]),this.change=new x(a.c.c[0],a.c.c[1],a.c.c[2],a.c.c[3])):a.s.n&&(this.start=a.s.n,this.change=a.c.n);return this};m.prototype.update=function(a){p=a.getReference(this.reference);p instanceof v?p.add(this.start):p instanceof u?p.set(this.start):p instanceof x&&p.set(this.start)};m.prototype.tween=function(a,f,q){p=a.getReference(this.reference);Ka(p,this.change,f,q,this.easeIn,this.easeOut)};return m}(),
Ca=function(){var p=0,a,m=function(a,f,q,d,m){this.id=p++;this.start=a;this.end=a+f;this.duration=f;this.polygons=q||[];this.bones=d||[];this.transforms=m||[];this.box=new C};m.prototype.save=function(){a={};a.s=this.start;a.e=this.end;a.d=this.duration;a.py=this.polygons;a.bn=this.bones;a.tr=[];for(var h=0,f=this.transforms.length;h<f;h++)a.tr[h]=this.transforms[h].save();return a};m.prototype.load=function(a){this.start=a.s;this.end=a.e;this.duration=a.d;this.polygons=a.py;this.bones=a.bn;for(var f=
0,q=a.tr.length;f<q;f++)this.transforms[f]=(new Da).load(a.tr[f]);return this};m.prototype.update=function(a){for(var f=0,q=this.transforms.length;f<q;f++)this.transforms[f].update(a)};m.prototype.tween=function(a,f){for(var q=0,d=this.transforms.length;q<d;q++)this.transforms[q].tween(a,f-this.start,this.duration)};m.prototype.getBox=function(a){for(var f=0,q=this.polygons.length;f<q;f++)0==f?this.box.set(a.getReference(["polygons",this.polygons[f]]).getBox()):this.box.combine(a.getReference(["polygons",
this.polygons[f]]).getBox());return this.box};m.prototype.getBoxPixel=function(a){for(var f=0,q=this.polygons.length;f<q;f++)0==f?this.box.set(a.getReference(["polygons",this.polygons[f]]).getBoxPixel()):this.box.combine(a.getReference(["polygons",this.polygons[f]]).getBoxPixel());return this.box};m.prototype.draw=function(a,f,q,d){for(var m=0,g=this.polygons.length;m<g;m++)d.polygons[this.polygons[m]].draw(a,f,q,d);if(d.debugFlags&4)for(m=0,g=this.transforms.length;m<g;m++)"bones"==this.transforms[m].reference[0]&&
d.getReference(this.transforms[m].reference.slice(0,2)).draw(a,d)};return m}(),sa=function(){var p=0,a=new u,m=vec4.create(),h,f=function(a,d,f,g){this.id=p++;this.position=new v(a,d,f,g);this.bindings=[]};f.prototype.save=function(){h={};h.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];h.bi=[];for(var a=0,d=this.bindings.length;a<d;a++)h.bi[a]=[this.bindings[a].reference,this.bindings[a].weight,[this.bindings[a].offset.matrix[0],this.bindings[a].offset.matrix[1]]];
return h};f.prototype.load=function(a){this.position.set(a.p[0],a.p[1],a.p[2],a.p[3]).normalize();for(var d=0,f=a.bi.length;d<f;d++)this.bindings[d]=new pa(a.bi[d][0],a.bi[d][1],new u(a.bi[d][2][0],a.bi[d][2][1]));return this};f.prototype.clone=function(){h=new sa(this.position);for(var a=0,d=this.bindings.length;a<d;a++)h.bindings[a]=this.bindings[a].clone();return h};f.prototype.bind=function(a,d,f){this.bindings.push(new pa(a,d,f))};f.prototype.reset=function(){this.position.reset()};f.prototype.update=
function(a,d,f){d&&vec3.copy(this.position.matrix,d.matrix);void 0!==f&&(this.position.orientation=f);vec4.set(m,Math.cos(this.position.orientation),Math.sin(this.position.orientation),-Math.sin(this.position.orientation),Math.cos(this.position.orientation));d=0;for(f=this.bindings.length;d<f;d++)this.bindings[d].update(a,this.position,m)};f.prototype.draw=function(f,d){f.beginPath();f.strokeStyle="#00FF00";f.lineWidth=1;f.arc(this.position.matrix[0],this.position.matrix[1],5,0,2*Math.PI);f.stroke();
if(d.debugFlags&8)for(var h=0,g=this.bindings.length;h<g;h++)f.beginPath(),f.moveTo(this.position.matrix[0],this.position.matrix[1]),a=d.getReference(this.bindings[h].reference),f.lineTo(a.matrix[0],a.matrix[1]),f.stroke()};return f}(),pa=function(){var p=0,a=new u,m=vec4.create(),h=function(a,h,d){this.id=p++;this.reference="string"===typeof a?a.split("."):a;this.weight=void 0!==h?h:1;this.offset=d?d.clone():new u};h.prototype.clone=function(){return new pa(this.reference.join("."),this.weight,this.offset)};
h.prototype.update=function(f,h,d){this.cachedReference||(this.cachedReference=f.getReference(this.reference));this.cachedReference&&(a.set(h).add(this.offset),a.sub(this.cachedReference.origin),this.cachedReference.vector.set(this.cachedReference.origin).add(a.scale(this.weight)),vec4.scale(m,d,this.weight),this.cachedReference.vector.rotate2D(m,h),this.cachedReference.orientation+=h.orientation)};return h}(),ia=function(){var p=0,a,m,h=new u,f,q,d,s,g=function(b,a,g,d){this.id=p++;this.position=
new v(b,a,g,d);this.scale=new u(1,1);this.triggerClass="";this.bodies=[new S];this.bodies[0].bind("position");this.box=new C;this.action=new Q;this.end=new Q;this.endDelayTime=this.endDelay=this.delayTime=this.delay=0;this.firedEnd=this.firedAction=this.once=!1;this.inputMouseEvents=[];this.effects={};this.callEnd=this.callAction=!1;this.bodies[0].shapes.push(new ha({width:32,height:32,material:new ca({filter:new da(16,1),sensor:"trigger"})}));this.bodies[0].type=0};g.prototype.logic={beginContact:function(b,
a,g,d,f){g.GetFilterData().get_maskBits()&d.GetFilterData().get_categoryBits()&&(b.callAction=!0,b.delayTime=b.delay,b.callEnd=!1)},endContact:function(b,a,g,d,f){g.GetFilterData().get_maskBits()&d.GetFilterData().get_categoryBits()&&(b.callEnd=!0,b.endDelayTime=b.endDelay)}};g.prototype.save=function(){a={};a.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];a.s=[this.scale.matrix[0],this.scale.matrix[1]];a.c=this.triggerClass;a.b=this.bodies[0].save();
a.a=this.action.save();a.d=this.delay;a.e=this.end.save();a.ed=this.endDelay;a.o=this.once;return a};g.prototype.load=function(b){this.position.set(b.p[0],b.p[1],b.p[2],b.p[3]);this.scale.set(b.s[0],b.s[1]);this.triggerClass=b.c;this.bodies=[(new S).load(b.b)];this.action=new Q(b.a[0],b.a[1],b.a[2]);this.delay=b.d;b.e&&(this.end=new Q(b.e[0],b.e[1],b.e[2]));this.endDelay=b.ed;this.once=b.o;b=0;for(var a=this.bodies.length;b<a;b++)this.bodies[b].scaleTo(this.scale);return this};g.prototype.clone=function(){return(new ia).load(this.save())};
g.prototype.clear=function(){this.position.set(0,0,0,0).normalize();this.scale.set(1,1);this.bodies[0].removeFromWorld();this.bodies[0]=new S;this.action=new Q;this.delay=0;this.end=new Q;this.endDelay=0;this.triggerClass=""};g.prototype.instance=function(){a=new g;a.scale=this.scale.clone();a.bodies[0]=this.bodies[0].clone();a.action=this.action.clone();a.delay=this.delay;a.end=this.end.clone();a.endDelay=this.endDelay;a.triggerClass=this.triggerClass;return a};g.prototype.setPosition=function(b,
a,g,d){h.set(b,a,g,d||0).sub(this.position.vector);this.position.set(b);this.bodies[0].translate(h,0)};g.prototype.translate=function(b,a,g,d){d=d||0;h.set(b,a,g,d);this.position.add(b,a,g,d);this.bodies[0].translate(h,0)};g.prototype.setScale=function(b,a){h.set(b,a);this.scale.set(h);for(var g=0,d=this.bodies.length;g<d;g++)this.bodies[g].scaleTo(h)};g.prototype.addToWorld=function(b,a){this.bodies[0].addToWorld(b,a,this);this.bodies[0].weld(this)};g.prototype.removeFromWorld=function(){this.bodies[0].removeFromWorld()};
g.prototype.findShapeByFixture=function(b){return this.bodies[0].findShapeByFixture(b)};g.prototype.getReference=function(b){m=this;d=0;for(s=b.length;d<s;d++)m=m[b[d]];return m};g.prototype.getBox=function(){f=0;for(q=this.bodies[0].shapes.length;f<q;f++)0==f?this.box.set(this.bodies[0].shapes[f].getBox()):this.box.combine(this.bodies[0].shapes[f].getBox());this.box.scale(this.scale);return this.box};g.prototype.update=function(b,a){this.bodies[0].update(this);this.callAction&&0>=this.delayTime--&&
(this.callAction=!1,!this.action.reference||!this.action.reference.length||this.once&&this.firedAction||(this.action.fire(a,this),this.firedAction=!0));this.callEnd&&0>=this.endDelayTime--&&(this.callEnd=!1,!this.end.reference||!this.end.reference.length||this.once&&this.firedEnd||(this.end.fire(a,this),this.firedEnd=!0))};g.prototype.draw=function(b,a,g){b.save();b.translate(this.position.matrix[0],this.position.matrix[1]);b.rotate(this.position.orientation);b.scale(this.scale.matrix[0],this.scale.matrix[1]);
this.bodies[0].draw(b,this.effects,g,this);b.restore()};return g}(),Ea=function(){var p=0,a,m,h,f,q,d,s,g=function(a,c){this.id=p++;this.ppm=a||90;this.mpp=1/this.ppm;this.b2World=new Box2D.b2World(this.toMeters(c||new u(0,900)));this.paused=!1;this.bodies=[];this.groundBody=(new S({type:0})).addToWorld(this);this.b2Body=this.groundBody.b2Body;this.listener=new Box2D.b2ContactListener;b(this,this.listener)};g.prototype.setGravity=function(b){this.b2World.SetGravity(this.toMeters(new u(b)))};g.prototype.join=
function(b,a){this.groundBody.join(b,a)};g.prototype.weld=function(b){this.groundBody.weld(b)};g.prototype.destroy=function(){if(this.b2World){for(var b=0,a=this.bodies.length;b<a;b++)this.bodies[b].removeFromWorld();this.bodies.length=0}this.groundBody=(new S({type:0})).addToWorld(this);this.b2Body=this.groundBody.b2Body};g.prototype.findBody=function(b){a=0;for(m=this.bodies.length;a<m;a++)if(this.bodies[a].b2Body==b)return this.bodies[a]};var b=function(b,a){Box2D.customizeVTable(a,[{original:Box2D.b2ContactListener.prototype.BeginContact,
replacement:function(a,c){h=Box2D.wrapPointer(c,Box2D.b2Contact);d=h.GetFixtureA();s=h.GetFixtureB();f=b.findBody(d.GetBody());q=b.findBody(s.GetBody());f&&(f=f.parentObject);q&&(q=q.parentObject);f&&f.logic&&f.logic.beginContact&&f.logic.beginContact(f,q,d,s,h);q&&q.logic&&q.logic.beginContact&&q.logic.beginContact(q,f,s,d,h)}}]);Box2D.customizeVTable(a,[{original:Box2D.b2ContactListener.prototype.EndContact,replacement:function(a,c){h=Box2D.wrapPointer(c,Box2D.b2Contact);d=h.GetFixtureA();s=h.GetFixtureB();
f=b.findBody(d.GetBody());q=b.findBody(s.GetBody());f&&(f=f.parentObject);q&&(q=q.parentObject);f&&f.logic&&f.logic.endContact&&f.logic.endContact(f,q,d,s,h);q&&q.logic&&q.logic.endContact&&q.logic.endContact(q,f,s,d,h)}}]);Box2D.customizeVTable(a,[{original:Box2D.b2ContactListener.prototype.PreSolve,replacement:function(a,c){h=Box2D.wrapPointer(c,Box2D.b2Contact);d=h.GetFixtureA();s=h.GetFixtureB();f=b.findBody(d.GetBody());q=b.findBody(s.GetBody());f&&(f=f.parentObject);q&&(q=q.parentObject);f&&
f.logic&&f.logic.preSolve&&f.logic.preSolve(f,q,d,s,h);q&&q.logic&&q.logic.preSolve&&q.logic.preSolve(q,f,s,d,h)}}]);Box2D.customizeVTable(a,[{original:Box2D.b2ContactListener.prototype.PostSolve,replacement:function(a,c){h=Box2D.wrapPointer(c,Box2D.b2Contact);d=h.GetFixtureA();s=h.GetFixtureB();f=b.findBody(d.GetBody());q=b.findBody(s.GetBody());f&&(f=f.parentObject);q&&(q=q.parentObject);f&&f.logic&&f.logic.postSolve&&f.logic.postSolve(f,q,d,s,h);q&&q.logic&&q.logic.postSolve&&q.logic.postSolve(q,
f,s,d,h)}}]);b.b2World.SetContactListener(a)},c=function(b,c,g,d){b.context.fillStyle="rgba(0,192,0,0.2)";b.context.strokeStyle="rgba(0,192,0,0.8)";b.context.lineWidth=.01;b.context.beginPath();for(a=0;a<g;a++){var f=Box2D.wrapPointer(c+8*a,Box2D.b2Vec2);0==a?b.context.moveTo(f.get_x(),f.get_y()):b.context.lineTo(f.get_x(),f.get_y())}b.context.closePath();d&&b.context.fill();b.context.stroke()},k=function(b,a,c,g,d){a=Box2D.wrapPointer(a,Box2D.b2Vec2);g=Box2D.wrapPointer(g,Box2D.b2Vec2);b.context.beginPath();
b.context.arc(a.get_x(),a.get_y(),c,0,2*Math.PI,!1);d&&b.context.fill();b.context.stroke();d&&(d=new Box2D.b2Vec2(a.get_x(),a.get_y()),d.op_add(w(g,c)),b.context.beginPath(),b.context.moveTo(a.get_x(),a.get_y()),b.context.lineTo(d.get_x(),d.get_y()),b.context.stroke())},W=function(b,a){var c=Box2D.wrapPointer(a,b2Color),g=255*c.get_r()|0,d=255*c.get_g()|0,c=255*c.get_b()|0,g=g+","+d+","+c;b.context.fillStyle="rgba("+g+",0.5)";b.context.strokeStyle="rgb("+g+")";b.context.lineWidth=.05},w=function(b,
a){return new Box2D.b2Vec2(a*b.get_x(),a*b.get_y())};g.prototype._customizeVTable=function(b,a){Box2D.customizeVTable(this.debugDraw,[{original:b,replacement:a}])};g.prototype.setCanvasDebugDraw=function(b){var a=this;this.debugDraw=new Box2D.b2Draw;this.debugDraw.SetFlags(b);this._customizeVTable(Box2D.b2Draw.prototype.DrawSegment,function(b,c,g,d){W(a,d);b=Box2D.wrapPointer(c,Box2D.b2Vec2);g=Box2D.wrapPointer(g,Box2D.b2Vec2);a.context.fillStyle="rgba(0,192,0,0.2)";a.context.strokeStyle="rgba(0,192,0,0.8)";
a.context.lineWidth=.01;a.context.beginPath();a.context.moveTo(b.get_x(),b.get_y());a.context.lineTo(g.get_x(),g.get_y());a.context.stroke()});this._customizeVTable(Box2D.b2Draw.prototype.DrawPolygon,function(b,g,d,f){W(a,f);c(a,g,d,!1)});this._customizeVTable(Box2D.b2Draw.prototype.DrawPolygon,function(b,g,d,f){W(a,f);c(a,g,d,!1)});this._customizeVTable(Box2D.b2Draw.prototype.DrawSolidPolygon,function(b,g,d,f){W(a,f);c(a,g,d,!0)});this._customizeVTable(Box2D.b2Draw.prototype.DrawCircle,function(b,
c,g,d){W(a,d);k(a,enter,g,Box2D.b2Vec2(0,0),!1)});this._customizeVTable(Box2D.b2Draw.prototype.DrawSolidCircle,function(b,c,g,d,f){W(a,f);k(a,c,g,d,!0)});this._customizeVTable(Box2D.b2Draw.prototype.DrawTransform,function(b,c){var g=Box2D.wrapPointer(c,Box2D.b2Transform),d=g.get_p(),g=g.get_q();a.context.save();a.context.translate(d.get_x(),d.get_y());a.context.scale(.5,.5);a.context.rotate(g.GetAngle());a.context.lineWidth*=2;d=a.context;d.strokeStyle="rgb(192,0,0)";d.beginPath();d.moveTo(0,0);d.lineTo(1,
0);d.stroke();d.strokeStyle="rgb(0,192,0)";d.beginPath();d.moveTo(0,0);d.lineTo(0,1);d.stroke();a.context.restore()});this.b2World.SetDebugDraw(this.debugDraw)};g.prototype.toPixels=function(b){return b instanceof Box2D.b2Vec2?new u(b.get_x()*this.ppm,b.get_y()*this.ppm):b*this.ppm};g.prototype.toMeters=function(b){return b instanceof u||b instanceof v?new Box2D.b2Vec2(b.matrix[0]*this.mpp,b.matrix[1]*this.mpp):b*this.mpp};g.prototype.update=function(b){this.paused||this.b2World.Step(b,8,7,3)};g.prototype.draw=
function(b){this.context=b;b.save();b.scale(this.ppm,this.ppm);this.b2World.DrawDebugData();b.restore()};g.prototype.e_shapeBit=1;g.prototype.e_jointBit=2;g.prototype.e_aabbBit=4;g.prototype.e_pairBit=8;g.prototype.e_centerOfMassBit=16;return g}(),S=function(){var p=0,a=new u,m=vec4.create(),h=0,f,q,d,s,g=Math.PI/2,b=function(b){this.id=p++;b=b||{};this.world=this.b2Body=null;this.active=!1!==b.active;this.allowSleep=!1!==b.allowSleep;this.angularDamping=b.angularDamping||0;this.awake=!1!==b.awake;
this.bullet=b.bullet||!1;this.fixedRotation=b.fixedRotation||!1;this.gravityScale=void 0!==b.gravityScale?b.gravityScale:1;this.linearDamping=b.linearDamping||0;this.type=void 0!==b.type?b.type:Box2D.b2_dynamicBody;this.angle=b.angle||0;this.angularVelocity=b.angularVelocity||0;this.linearVelocity=b.linearVelocity||new u;this.position=b.position||new v;this.scale=b.scale||new u(1,1);this.shapes=[];this.bindings=[];this.joints=[];this.inputMouseEvents=[]};b.prototype.save=function(){f={};f.p=[this.position.matrix[0],
this.position.matrix[1],this.position.matrix[2],this.position.orientation];f.ac=this.active;f.as=this.allowSleep;f.ad=this.angularDamping;f.aw=this.awake;f.bu=this.bullet;f.fr=this.fixedRotation;f.gs=this.gravityScale;f.ld=this.linearDamping;f.tp=this.type;f.an=this.angle;f.av=this.angularVelocity;f.lv=[this.linearVelocity.matrix[0],this.linearVelocity.matrix[1]];f.sh=[];for(var b=0,a=this.shapes.length;b<a;b++)f.sh[b]=this.shapes[b].save();f.bi=[];b=0;for(a=this.bindings.length;b<a;b++)f.bi[b]=[this.bindings[b].reference,
this.bindings[b].weight,[this.bindings[b].offset.matrix[0],this.bindings[b].offset.matrix[1]]];f.jn=[];b=0;for(a=this.joints.length;b<a;b++)f.jn[b]=this.joints[b].save();return f};b.prototype.load=function(b){this.position.set(b.p[0],b.p[1],b.p[2],b.p[3]);this.active=b.ac;this.allowSleep=b.as;this.angularDamping=b.ad;this.awake=b.aw;this.bullet=b.bu;this.fixedRotation=b.fr;this.gravityScale=b.gs;this.linearDamping=b.ld;this.type=b.tp;this.angle=b.an;this.angularVelocity=b.av;this.linearVelocity.set(b.lv[0],
b.lv[1]);for(var a=0,g=b.sh.length;a<g;a++)this.shapes[a]=(new ha).load(b.sh[a]);a=0;for(g=b.bi.length;a<g;a++)this.bindings[a]=new pa(b.bi[a][0],b.bi[a][1],new u(b.bi[a][2][0],b.bi[a][2][1]));a=0;for(g=b.jn.length;a<g;a++)this.joints[a]=(new oa).load(b.jn[a]);return this};b.prototype.clone=function(){f=new S({active:this.active,allowSleep:this.allowSleep,angularDamping:this.angularDamping,awake:this.awake,bullet:this.bullet,fixedRotation:this.fixedRotation,gravityScale:this.gravityScale,linearDamping:this.linearDamping,
type:this.type,userData:this.userData,angle:this.angle,angularVelocity:this.angularVelocity,linearVelocity:this.linearVelocity.clone(),position:this.position.clone()});for(var b=0,a=this.shapes.length;b<a;b++)f.shapes[b]=this.shapes[b].clone();b=0;for(a=this.bindings.length;b<a;b++)f.bindings[b]=this.bindings[b].clone();b=0;for(a=this.joints.length;b<a;b++)f.joints[b]=this.joints[b].clone();return f};b.prototype.flip=function(b,a){for(var g=0,d=this.shapes.length;g<d;g++)this.shapes[g].flip(b,a);
this.refresh()};b.prototype.getBodyDef=function(b,a){f=new Box2D.b2BodyDef;f.set_active(this.active);f.set_allowSleep(this.allowSleep);f.set_angularDamping(this.angularDamping);f.set_awake(this.awake);f.set_bullet(this.bullet);f.set_fixedRotation(this.fixedRotation);f.set_gravityScale(this.gravityScale);f.set_linearDamping(this.linearDamping);f.set_type(this.type);f.set_userData(this.id);f.set_angle(this.angle);f.set_angularVelocity(this.angularVelocity);f.set_linearVelocity(b.toMeters(this.linearVelocity));
f.set_position(b.toMeters(a||this.position));return f};b.prototype.addToWorld=function(b,a,g){this.world=b;this.parentObject=g;a&&a.orientation&&(this.angle=a.orientation);this.b2Body=b.b2World.CreateBody(this.getBodyDef(b,a));this.world.bodies.push(this);a=0;for(g=this.shapes.length;a<g;a++)this.shapes[a].addToBody(b,this);return this};b.prototype.removeFromWorld=function(){this.b2Body&&this.world.b2World.DestroyBody(this.b2Body);this.b2Body=null};b.prototype.refresh=function(){if(this.b2Body){q=
this.b2Body.GetPosition();h=this.b2Body.GetAngle();for(var b=0,a=this.shapes.length;b<a;b++)this.shapes[b].removeFromBody(),this.shapes[b].addToBody(this.world,this);this.b2Body.SetTransform(q,h)}};b.prototype.findShapeByFixture=function(b){for(var a=0,g=this.shapes.length;a<g;a++)if(this.shapes[a].b2Fixture==b)return this.shapes[a];return!1};b.prototype.setAngle=function(b){this.b2Body&&this.b2Body.SetTransform(this.b2Body.GetPosition(),b)};b.prototype.getAngle=function(){this.b2Body&&this.b2Body.GetAngle()};
b.prototype.setAngularVelocity=function(b){this.b2Body&&this.b2Body.SetAngularVelocity(b)};b.prototype.getLinearDamping=function(){if(this.b2Body)return this.b2Body.GetLinearDamping()};b.prototype.getPosition=function(){return this.world.toPixels(this.b2Body.GetPosition())};b.prototype.getMass=function(){if(this.b2Body)return this.world.toPixels(this.b2Body.GetMass())};b.prototype.setLinearDamping=function(b){this.b2Body&&this.b2Body.SetLinearDamping(b)};b.prototype.getLinearVelocity=function(){if(this.b2Body)return this.world.toPixels(this.b2Body.GetLinearVelocity())};
b.prototype.setLinearVelocity=function(b){this.b2Body&&this.b2Body.SetLinearVelocity(this.world.toMeters(b))};b.prototype.applyForce=function(b,a){this.b2Body.ApplyForce(this.world.toMeters(b),this.world.toMeters(a))};b.prototype.applyTorque=function(b){this.b2Body.ApplyTorque(b)};b.prototype.applyImpulse=function(b,a){this.b2Body.ApplyLinearImpulse(this.world.toMeters(b),this.world.toMeters(a))};b.prototype.setTransform=function(b,a){this.b2Body&&(this.b2Body.SetTransform(this.world.toMeters(b),
a||0),this.position.set(b))};b.prototype.translate=function(b,g){this.b2Body&&(a=this.b2Body.GetPosition(),a.op_add(this.world.toMeters(b)),this.b2Body.SetTransform(a,this.b2Body.GetAngle()+g))};b.prototype.setScale=function(b){for(var a=0,g=this.shapes.length;a<g;a++)this.shapes[a].scale.mul(b);this.scale.mul(b);this.refresh()};b.prototype.scaleTo=function(b){for(var a=0,g=this.shapes.length;a<g;a++)this.shapes[a].scale.set(b);this.scale.set(b);this.refresh()};b.prototype.setOptions=function(b){for(var a in b)this.b2Body["Set"+
a](b[a])};b.prototype.bind=function(b,a){this.bindings.push(new pa(b,1,a))};b.prototype.join=function(b,a){this.joints.push(new oa(b,a))};b.prototype.weld=function(b){for(var a=0,g=this.joints.length;a<g;a++)this.joints[a].join(this.world,b,this)};b.prototype.isTouchingGround=function(){for(d=this.b2Body.GetContactList();d;){d.m_contact.GetManifold();s=(void 0).m_normal;h=Math.atan2(s.get_y(),s.get_x());d.contact.GetFixtureB().GetBody()==this.b2Body&&(h*=-1);if(h>g-.51*g&&h<g+.51*g)return!0;d=d.GetNext()}return!1};
b.prototype.draw=function(b,a,g,d){b.save();b.globalAlpha=1;b.translate(this.position.matrix[0],this.position.matrix[1]);for(var f=0,h=this.shapes.length;f<h;f++){b.beginPath();this.shapes[f].polygon&&this.shapes[f].polygon.draw(b);this.shapes[f].radius&&b.arc(this.shapes[f].position.matrix[0],this.shapes[f].position.matrix[1],this.shapes[f].radius,0,2*Math.PI);this.shapes[f].width&&this.shapes[f].height&&(b.lineTo(this.shapes[f].position.matrix[0]-this.shapes[f].width/2,this.shapes[f].position.matrix[1]-
this.shapes[f].height/2),b.lineTo(this.shapes[f].position.matrix[0]+this.shapes[f].width/2,this.shapes[f].position.matrix[1]-this.shapes[f].height/2),b.lineTo(this.shapes[f].position.matrix[0]+this.shapes[f].width/2,this.shapes[f].position.matrix[1]+this.shapes[f].height/2),b.lineTo(this.shapes[f].position.matrix[0]-this.shapes[f].width/2,this.shapes[f].position.matrix[1]+this.shapes[f].height/2),b.closePath());if(this.shapes[f].vertices&&0<this.shapes[f].vertices.length){f=0;for(h=this.shapes[f].vertices.length;f<
h;f++)b.lineTo(this.shapes[f].vertices[j].matrix[0],this.shapes[f].vertices[j].matrix[1]);b.closePath()}if(g&&0<d.inputMouseEvents.length&&b.isPointInPath(g.input.mouseAbosluteX,g.input.mouseAbosluteY))for(f=0,h=d.inputMouseEvents.length;f<h;f++)d.inputMouseEvents[f].mouseHitPass||(d.inputMouseEvents[f].mouseHitPass={entity:d,polygons:[],objects:[]}),d.inputMouseEvents[f].mouseHitPass.objects.push(d),d.inputMouseEvents[f].mouseHitPass.polygons.push(this);b.fillStyle="rgba(255,0,0,0.2)";b.fill();a&&
a.outline&&(b.strokeStyle=a.outline,b.lineWidth=8,b.stroke());b.strokeStyle="#F00";b.lineWidth=2;b.stroke()}b.restore()};b.prototype.update=function(b){if(this.b2Body){a=this.world.toPixels(this.b2Body.GetPosition());h=this.b2Body.GetAngle();this!==b.bodies[0]&&(a.rotate2D(-b.bodies[0].b2Body.GetAngle(),this.world.toPixels(b.bodies[0].b2Body.GetWorldCenter())),a.sub(this.world.toPixels(b.bodies[0].b2Body.GetWorldCenter())));vec4.set(m,Math.cos(h),Math.sin(h),-Math.sin(h),Math.cos(h));a.orientation=
h;for(var g=0,d=this.bindings.length;g<d;g++)this.bindings[g].update(b,a,m)}};return b}(),ha=function(){var p=0,a,m,h,f,q,d=new Box2D.b2RayCastInput,s=new Box2D.b2RayCastOutput,g,b,c=function(b){this.id=p++;b=b||{};this.radius=b.radius||!1;this.width=b.width||!1;this.height=b.height||!1;this.vertices=b.vertices||[];this.polygon=b.polygon;this.position=b.position||new v;this.material=b.material||new ca;this.scale=b.scale||new u(1,1);this.fixtureDef=new Box2D.b2FixtureDef;this.flipY=this.flipX=!1;this.box=
new C};c.prototype.save=function(){a={};a.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2]];a.r=this.radius;a.w=this.width;a.h=this.height;a.v=[];g=0;for(b=this.vertices.length;g<b;g++)a.v[g]=[this.vertices[g].matrix[0],this.vertices[g].matrix[1]];this.polygon&&(a.py=this.polygon.save());a.m=this.material.save();return a};c.prototype.load=function(a){this.position.set(a.p[0],a.p[1],a.p[2],a.p[3]).normalize();this.radius=a.r;this.width=a.w;this.height=a.h;a.py&&(this.polygon=
(new N).load(a.py));this.material=(new ca).load(a.m);g=0;for(b=a.v.length;g<b;g++)this.vertices[g]=new u(a.v[g][0],a.v[g][1]);return this};var k=function(c){a=new Box2D.b2PolygonShape;m=Box2D.allocate(8*c.length,"float",Box2D.ALLOC_STACK);g=h=0;for(b=c.length;g<b;g++)Box2D.setValue(m+h,c[g].get_x(),"float"),Box2D.setValue(m+(h+4),c[g].get_y(),"float"),h+=8;f=Box2D.wrapPointer(m,Box2D.b2Vec2);a.Set(f,c.length);return a};c.prototype.clone=function(){return new ha({radius:this.radius,width:this.width,
height:this.height,position:this.position.clone(),vertices:this.vertices.map(function(b){return b.clone()}),polygon:this.polygon&&this.polygon.clone(),material:this.material.clone()})};c.prototype.flip=function(b,a){this.flipX=b;this.flipY=a};c.prototype.getFixtureDef=function(b){this.radius?(a=new Box2D.b2CircleShape,a.set_m_radius(b.toMeters(this.radius)*this.scale.matrix[0]),this.position&&a.set_m_p(b.toMeters(this.position.clone().vector.mul(this.scale)))):this.width?(a=new Box2D.b2PolygonShape,
a.SetAsBox(b.toMeters(this.width*this.scale.matrix[0])/2,b.toMeters(this.height*this.scale.matrix[1])/2,b.toMeters(this.position.clone().vector.mul(this.scale)),0)):(q=this.polygon?this.polygon.lines.map(function(a){return b.toMeters(a.point.vector.clone().mul(this.scale).mul(this.flipX?-1:1,this.flipY?-1:1))},this):this.vertices.map(function(a){return b.toMeters(a.clone().mul(this.scale).mul(this.flipX?-1:1,this.flipY?-1:1))},this),(this.flipX||this.flipY)&&this.flipX!=this.flipY&&q.reverse(),a=
k(q));this.material.applyToFixture(this.fixtureDef);this.fixtureDef.set_shape(a);return this.fixtureDef};c.prototype.addToBody=function(b,a){this.world=b;this.body=a;this.b2Fixture=a.b2Body.CreateFixture(this.getFixtureDef(b))};c.prototype.removeFromBody=function(){this.body&&this.body.b2Body.DestroyFixture(this.b2Fixture);this.b2Fixture=this.body=this.world=!1};c.prototype.getBox=function(){if(this.width)return this.box.set(0,0,this.width,this.height);if(this.radius)return this.box.set(0,0,2*this.radius,
2*this.radius);if(this.polygon)return this.box.set(this.polygon.getBox())};c.prototype.rayCast=function(b,a,g){return this.b2Fixture&&(d.set_p1(this.world.toMeters(b)),d.set_p2(this.world.toMeters(a)),d.set_maxFraction(g),this.b2Fixture.RayCast(s,d))?{normal:this.world.toPixels(s.get_normal()),fraction:s.get_fraction()}:!1};return c}(),oa=function(){var p,a=function(a,h){this.reference="string"===typeof a?a.split("."):a;this.cachedReference;this.options=h||{}};a.prototype.save=function(){p={};p.r=
this.reference;p.o=this.options;this.options.anchorA&&(p.a=[this.options.anchorA.matrix[0],this.options.anchorA.matrix[1]]);this.options.anchorB&&(p.b=[this.options.anchorB.matrix[0],this.options.anchorB.matrix[1]]);this.options.axis&&(p.ax=[this.options.axis.matrix[0],this.options.axis.matrix[1]]);return p};a.prototype.load=function(a){this.reference=a.r;this.options=a.o;a.a&&(this.options.anchorA=new u(a.a[0],a.a[1]));a.b&&(this.options.anchorB=new u(a.b[0],a.b[1]));a.ax&&(this.options.axis=new u(a.ax[0],
a.ax[1]));return this};a.prototype.getJointDef=function(a){switch(this.options.type){case "revolute":this.jointDef=new Box2D.b2RevoluteJointDef;this.jointDef.set_collideConnected(this.options.collideConnected||!1);this.jointDef.set_enableLimit(this.options.enableLimit||!1);this.jointDef.set_enableMotor(this.options.enableMotor||!1);this.jointDef.set_maxMotorTorque(void 0!==this.options.maxMotorTorque?this.options.maxMotorTorque:Infinity);this.jointDef.set_lowerAngle(this.options.lowerAngle||0);this.jointDef.set_upperAngle(this.options.upperAngle||
0);this.jointDef.set_motorSpeed(this.options.motorSpeed||0);break;case "prismatic":this.jointDef=new Box2D.b2PrismaticJointDef;this.jointDef.set_collideConnected(this.options.collideConnected||!1);this.jointDef.set_enableLimit(this.options.enableLimit||!1);this.jointDef.set_enableMotor(this.options.enableMotor||!1);this.jointDef.set_maxMotorForce(void 0!==this.options.maxMotorForce?this.options.maxMotorForce:Infinity);this.jointDef.set_motorSpeed(this.options.motorSpeed||0);this.jointDef.set_lowerTranslation(a.toMeters(this.options.lowerTranslation)||
0);this.jointDef.set_upperTranslation(a.toMeters(this.options.upperTranslation)||0);this.jointDef.set_referenceAngle(this.options.referenceAngle||0);break;case "distance":this.jointDef=new Box2D.b2DistanceJointDef;this.jointDef.set_collideConnected(this.options.collideConnected||!1);this.jointDef.set_dampingRatio(void 0!==this.options.dampingRatio?this.options.dampingRatio:.5);this.jointDef.set_frequencyHz(void 0!==this.options.frequencyHz?this.options.frequencyHz:1);break;default:this.jointDef=new Box2D.b2WeldJointDef,
this.jointDef.set_collideConnected(this.options.collideConnected||!1),this.jointDef.set_dampingRatio(void 0!==this.options.dampingRatio?this.options.dampingRatio:.5),this.jointDef.set_frequencyHz(void 0!==this.options.frequencyHz?this.options.frequencyHz:1)}return this.jointDef};a.prototype.clone=function(){return new oa(this.reference,this.options)};a.prototype.join=function(a,h,f){this.b2Joint&&a.b2World.DestroyJoint(this.b2Joint);this.cachedReference||(this.cachedReference=h.getReference(this.reference));
switch(this.options.type){case "revolute":this.getJointDef(a).Initialize(f.b2Body,this.cachedReference.b2Body,a.toMeters(this.options.anchorA)||f.b2Body.GetWorldCenter());break;case "prismatic":this.getJointDef(a).Initialize(f.b2Body,this.cachedReference.b2Body,a.toMeters(this.options.anchorA)||f.b2Body.GetWorldCenter(),void 0!==this.options.axis?new Box2D.b2Vec2(this.options.axis.matrix[0],this.options.axis.matrix[1]):new Box2D.b2Vec2(0,1));break;default:this.getJointDef(a).Initialize(f.b2Body,this.cachedReference.b2Body,
a.toMeters(this.options.anchorA)||f.b2Body.GetWorldCenter(),a.toMeters(this.options.anchorB)||this.cachedReference.b2Body.GetWorldCenter())}this.b2Joint=a.b2World.CreateJoint(this.jointDef)};a.prototype.draw=function(){};return a}(),ca=function(){var p=0,a,m=function(a){this.id=p++;a=a||{};this.density=void 0!==a.density?a.density:1;this.friction=void 0!==a.friction?a.friction:.5;this.restitution=void 0!==a.restitution?a.restitution:.5;this.sensor=a.sensor||!1;this.filter=a.filter||new da};m.prototype.save=
function(){a={};a.d=this.density;a.fr=this.friction;a.r=this.restitution;a.s=this.sensor;a.fi=[this.filter.category,this.filter.mask,this.filter.group];return a};m.prototype.load=function(a){this.density=a.d;this.friction=a.fr;this.restitution=a.r;this.sensor=a.s;this.filter=new da(a.fi[0],a.fi[1],a.fi[2]);return this};m.prototype.clone=function(){return new ca({density:this.density,friction:this.friction,restitution:this.restitution,sensor:this.sensor,filter:this.filter.clone()})};m.prototype.applyToFixture=
function(a){a.set_density(this.density);a.set_friction(this.friction);a.set_restitution(this.restitution);a.set_isSensor(this.sensor?!0:!1);this.filter.refresh();a.set_filter(this.filter.b2Filter)};return m}(),da=function(){var p=function(a,m,h){this.category=void 0!==a?a:-1;this.mask=void 0!==m?m:-1;this.group=h||0;this.b2Filter=new Box2D.b2Filter;this.refresh()};p.prototype.refresh=function(){this.b2Filter.set_categoryBits(this.category);this.b2Filter.set_maskBits(this.mask);this.b2Filter.set_groupIndex(this.group)};
p.prototype.clone=function(){return new da(this.category,this.mask,this.group)};return p}(),Ma=function(){var p,a,m,h,f,q,d,s=function(a,b,c,d,f){this.stage=d;this.position=new u(a,b,c);this.scale=new u(1,1);this.alpha=1;this.entities=[];this.triggers=[];this.tiles=[];this.polygons=[];this.texts=[];this.drawables=[];this.bodies=[];this.emitters=[];this.joints=[];this.matrix=this.position.matrix;this.objectsDebugDraw=this.physicsDebugDraw=this.isStaticRendered=this.isStatic=this.hasPhysics=!1;this.layerClass=
this.name="";this.renderTicks=0;this.effects={};this.orientation=0;f&&(this.hasPhysics=f.hp);this.hasPhysics?(this.world=na.allocate("World"),this.world.debugDraw||this.world.setCanvasDebugDraw(this.world.e_shapeBit|this.world.e_jointBit)):(this.world=!1,this.isStatic=!0);f&&this.load(f)};s.prototype.destroy=function(){this.world&&this.world.destroy();na.free("World",this.world);this.world=null};s.prototype.save=function(){m={};m.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2]];
m.s=[this.scale.matrix[0],this.scale.matrix[1]];m.a=this.alpha;m.n=this.name;m.c=this.layerClass;m.hp=this.hasPhysics;m.is=this.isStatic;m.e=[];for(var a in this.entities)m.e[a]=this.entities[a].saveOptions();m.t=[];for(a in this.tiles)m.t[a]=this.tiles[a].saveOptions();m.bd=[];for(a in this.bodies)m.bd[a]=this.bodies[a].save();m.tg=[];for(a in this.triggers)m.tg[a]=this.triggers[a].save();m.py=[];for(a in this.polygons)m.py[a]=this.polygons[a].save();m.tx=[];for(a in this.texts)m.tx[a]=this.texts[a].save();
m.em=[];for(a in this.emitters)this.emitters[a].drawIndex=this.drawables.indexOf(this.emitters[a]),m.em[a]=this.emitters[a].save();m.d=[];for(a in this.drawables)this.drawables[a]instanceof ba?m.d.push({t:this.tiles.indexOf(this.drawables[a])}):this.drawables[a]instanceof N?m.d.push({py:this.polygons.indexOf(this.drawables[a])}):this.drawables[a]instanceof V?m.d.push({e:this.entities.indexOf(this.drawables[a])}):this.drawables[a]instanceof U&&m.d.push({tx:this.texts.indexOf(this.drawables[a])});m.j=
[];for(var b in this.joints)m.j[b]=this.joints[b].save();return m};s.prototype.load=function(a){this.position.set(a.p[0],a.p[1],a.p[2]);this.scale.set(a.s[0],a.s[1]);this.alpha=a.a;this.hasPhysics=a.hp;a.is&&(this.isStatic=a.is);a.n&&(this.name=a.n);a.c&&(this.layerClass=a.c);for(var b in a.e)0==a.e[b].s[0]&&(a.e[b].s[0]=1),0==a.e[b].s[1]&&(a.e[b].s[1]=1),this.addEntity(a.e[b].m,[a.e[b].p[0],a.e[b].p[1],a.e[b].p[2],a.e[b].p[3]],{scale:[a.e[b].s[0],a.e[b].s[1]],alpha:1*a.e[b].a,entityClass:a.e[b].c,
timelines:a.e[b].t,physicsEnabled:a.e[b].pe,gravityScale:a.e[b].gs,fixedRotation:a.e[b].fr,awake:a.e[b].aw,flipX:a.e[b].fx,flipY:a.e[b].fy,effects:a.e[b].ef});for(b in a.t)0==a.t[b].s[0]&&(a.t[b].s[0]=1),0==a.t[b].s[1]&&(a.t[b].s[1]=1),this.addTile(a.t[b].m,[a.t[b].p[0],a.t[b].p[1],a.t[b].p[2],a.t[b].p[3]],{scale:[a.t[b].s[0],a.t[b].s[1]],alpha:1*a.t[b].a,tileClass:a.t[b].c,physicsEnabled:a.t[b].pe,flipX:a.t[b].fx,flipY:a.t[b].fy,effects:a.t[b].ef});for(b in a.tg)this.addTrigger((new ia).load(a.tg[b]),
a.tg[b].p);for(b in a.bd)this.bodies[b]=(new S).load(a.bd[b]),this.bodies[b].addToWorld(this.world,this.bodies[b].position);for(b in a.py)this.polygons[b]=(new N).load(a.py[b]);for(b in a.tx)this.addText((new U).load(a.tx[b]));for(b in a.em)this.addEmitter((new ea(this)).load(a.em[b]));this.drawables=[];for(b in a.d)void 0!=a.d[b].t&&this.tiles[a.d[b].t]&&this.drawables.push(this.tiles[a.d[b].t]),void 0!=a.d[b].py&&this.polygons[a.d[b].py]&&this.drawables.push(this.polygons[a.d[b].py]),void 0!=a.d[b].e&&
this.entities[a.d[b].e]&&this.drawables.push(this.entities[a.d[b].e]),void 0!=a.d[b].tx&&this.texts[a.d[b].tx]&&this.drawables.push(this.texts[a.d[b].tx]);this.joints=[];for(b in a.j)this.addLayerJoint((new Z).load(a.j[b]));for(b in this.joints)this.joints[b].weld(this);return this};s.prototype.getReference=function(g){_rReference=this;p=0;for(a=g.length;p<a;p++)_rReference=_rReference[g[p]];return _rReference};s.prototype.getObjectByID=function(a){for(var b=0,c=this.tiles.length;b<c;b++)if(this.tiles[b]&&
this.tiles[b].id==a)return this.tiles[b];b=0;for(c=this.entities.length;b<c;b++)if(this.entities[b]&&this.entities[b].id==a)return this.entities[b];b=0;for(c=this.triggers.length;b<c;b++)if(this.triggers[b]&&this.triggers[b].id==a)return this.triggers[b];b=0;for(c=this.texts.length;b<c;b++)if(this.texts[b]&&this.texts[b].id==a)return this.texts[b]};s.prototype.getObjectsByClass=function(a){d=[];for(var b=0,c=this.tiles.length;b<c;b++)this.tiles[b]&&this.tiles[b].tileClass==a&&d.push(this.tiles[b]);
b=0;for(c=this.entities.length;b<c;b++)this.entities[b]&&this.entities[b].entityClass==a&&d.push(this.entities[b]);b=0;for(c=this.triggers.length;b<c;b++)this.triggers[b]&&this.triggers[b].triggerClass==a&&d.push(this.triggers[b]);b=0;for(c=this.texts.length;b<c;b++)this.texts[b]&&this.texts[b].textClass==a&&d.push(this.texts[b]);return d};s.prototype.getObjectsByModelName=function(a){d=[];for(var b=0,c=this.tiles.length;b<c;b++)this.tiles[b]&&this.tiles[b].modelName==a&&d.push(this.tiles[b]);b=0;
for(c=this.entities.length;b<c;b++)this.entities[b]&&this.entities[b].modelName==a&&d.push(this.entities[b]);b=0;for(c=this.triggers.length;b<c;b++)this.triggers[b]&&this.triggers[b].modelName==a&&d.push(this.triggers[b]);return d};s.prototype.isObjectInLayer=function(a){return-1<this.drawables.indexOf(a)||-1<this.emitters.indexOf(a)||-1<this.triggers.indexOf(a)||-1<this.joints.indexOf(a)||-1<this.stage.spawnPoints.indexOf(a)?!0:!1};s.prototype.enablePhysics=function(){this.hasPhysics||(this.world=
na.allocate("World"),this.world.debugDraw||this.world.setCanvasDebugDraw(this.world.e_shapeBit|this.world.e_jointBit));this.hasPhysics=!0};s.prototype.disablePhysics=function(){this.world&&this.world.destroy();na.free("World",this.world);this.world=null;this.hasPhysics=!1};s.prototype.draw=function(a,b,c){if(!(0>=this.alpha)){if(this.useCache)return this.drawFromCache(a,b,c);a.save();b=this.stage.camera.position.x;var d=this.stage.camera.position.y;c&&this.stage.camera.parallaxOffset&&(b+=c.getWidth()/
2,d+=c.getHeight()/2);a.translate(this.position.x+this.position.z/100*b,this.position.y+this.position.z/100*d);a.rotate(this.orientation);a.scale(this.scale.x,this.scale.y);a.globalAlpha*=this.alpha;b=0;for(d=this.drawables.length;b<d;b++)!c||c.intersect(this.drawables[b].getBox(),this.drawables[b].position,500)?(this.drawables[b].draw(a,this.effects,this.stage),this.drawables[b].renderedLastFrame=!0):this.drawables[b].renderedLastFrame=!1;if(this.objectsDebugDraw){b=0;for(d=this.triggers.length;b<
d;b++)this.triggers[b]&&(c&&!c.intersect(this.triggers[b].getBox(),this.triggers[b].position,500)||this.triggers[b].draw(a,this.effects,this.stage));b=0;for(d=this.emitters.length;b<d;b++)this.emitters[b]&&this.emitters[b].draw(a,this.effects,this.stage);b=0;for(d=this.joints.length;b<d;b++)this.joints[b]&&this.joints[b].draw(a,this.effects,this.stage,this)}this.physicsDebugDraw&&this.world.draw(a);a.restore()}};s.prototype.toSVG=function(a){for(var b="<svg>",c=0,d=this.drawables.length;c<d;c++)this.drawables[c].toSVG&&
(b+=this.drawables[c].toSVG(a));return b+"</svg>"};s.prototype.drawFromCache=function(a,b,c){if(!(0>=this.alpha)){this.cache||(this.cache={},this.cache.canvas=document.createElement("canvas"),this.cache.context=this.cache.canvas.getContext("2d"));b=!1;for(var d=0,f=this.drawables.length;d<f;d++)b=!0;if(b){this.cache.canvas.width=a.canvas.width;this.cache.canvas.height=a.canvas.height;this.cache.canvas.style.width=a.canvas.width;this.cache.canvas.style.height=a.canvas.height;this.cache.canvas.style.background=
this.stage.backgroundColor;this.cache.canvas.style.opacity=this.stage.alpha;this.cache.context.save();this.cache.context.translate(this.stage.position.x,this.stage.position.y);this.cache.context.scale(this.stage.camera.zoom,this.stage.camera.zoom);this.cache.context.rotate(this.stage.camera.orientation);this.stage.camera.parallaxOffset||this.cache.context.translate(-this.stage.camera.position.x,-this.stage.camera.position.y);this.cache.context.translate(this.position.x+this.position.z/100*this.stage.camera.position.x,
this.position.y+this.position.z/100*this.stage.camera.position.y);this.cache.context.scale(this.scale.x,this.scale.y);this.cache.context.globalAlpha=this.alpha;d=0;for(f=this.drawables.length;d<f;d++)!c||c.intersect(this.drawables[d].getBox(),this.drawables[d].position,500)?(this.drawables[d].draw(this.cache.context,this.effects,this.stage),this.drawables[d].renderedLastFrame=!0):this.drawables[d].renderedLastFrame=!1;if(this.objectsDebugDraw){d=0;for(f=this.triggers.length;d<f;d++)this.triggers[d]&&
(c&&!c.intersect(this.triggers[d].getBox(),this.triggers[d].position,500)||this.triggers[d].draw(this.cache.context,this.effects,this.stage));d=0;for(f=this.emitters.length;d<f;d++)this.emitters[d]&&this.emitters[d].draw(this.cache.context,this.effects,this.stage);d=0;for(f=this.joints.length;d<f;d++)this.joints[d]&&this.joints[d].draw(this.cache.context,this.effects,this.stage,this)}this.physicsDebugDraw&&this.world.draw(this.cache.context);this.cache.context.restore()}a.drawImage(this.cache.canvas,
0,0)}};s.prototype.addDrawable=function(a,b,c,d){void 0!==d?this.drawables.splice(d,0,a):this.drawables.push(a);a instanceof N?this.polygons.push(a):a instanceof U&&this.texts.push(a);b&&this.sort();c&&c.polygonClass&&(a.polygonClass=c.polygonClass);b=0;for(c=this.stage.input.inputEvents.length;b<c;b++)this.stage.input.inputEvents[b].mouse&&this.stage.input.inputEvents[b].mouse.polygonClass&&(this.stage.input.inputEvents[b].mouse.polygonClass!=a.polygonClass&&"*"!=this.stage.input.inputEvents[b].mouse.polygonClass||
a.inputMouseEvents.push(this.stage.input.inputEvents[b]));return this.drawables.length};s.prototype.removeDrawable=function(a){this.drawables.splice(this.drawables.indexOf(a),1);a instanceof ba?this.tiles.splice(this.tiles.indexOf(a),1):a instanceof N&&this.polygons.splice(this.polygons.indexOf(a),1)};s.prototype.addEntity=function(a,b,c,d){if("string"===typeof a){if(!I.models[a])return;var f=a;a=(new V).load(I.models[a]);a.modelName=f}!1===b instanceof v&&(b=new v(b));a.position.set(b);a.setScale(a.scale);
c&&a.loadOptions(c);for(var f=0,h=this.stage.input.inputEvents.length;f<h;f++)this.stage.input.inputEvents[f].mouse&&(this.stage.input.inputEvents[f].mouse.entityClass||this.stage.input.inputEvents[f].mouse.objectClass)&&(this.stage.input.inputEvents[f].mouse.entityClass!=a.entityClass&&"*"!=this.stage.input.inputEvents[f].mouse.entityClass&&this.stage.input.inputEvents[f].mouse.objectClass!=a.entityClass&&"*"!=this.stage.input.inputEvents[f].mouse.objectClass||a.inputMouseEvents.push(this.stage.input.inputEvents[f]));
this.hasPhysics&&a.physicsEnabled?(a.addToWorld(this.world,b),c&&c.linearVelocity&&a.setLinearVelocity(new u(c.linearVelocity))):this.hasPhysics||(a.physicsEnabled=!1);this.addDrawable(a,null,null,d);this.entities.push(a);return a};s.prototype.addTile=function(a,b,c,d){if("string"===typeof a){if(!I.models[a])return;modelName=a;a=(new ba).load(I.models[a]);a.modelName=modelName}!1===b instanceof v&&(b=new v(b));a.position.set(b);c&&a.loadOptions(c);b=0;for(c=this.stage.input.inputEvents.length;b<c;b++)this.stage.input.inputEvents[b].mouse&&
(this.stage.input.inputEvents[b].mouse.tileClass||this.stage.input.inputEvents[b].mouse.objectClass)&&(this.stage.input.inputEvents[b].mouse.tileClass!=a.tileClass&&"*"!=this.stage.input.inputEvents[b].mouse.tileClass&&this.stage.input.inputEvents[b].mouse.objectClass!=a.tileClass&&"*"!=this.stage.input.inputEvents[b].mouse.objectClass||a.inputMouseEvents.push(this.stage.input.inputEvents[b]));if(this.hasPhysics&&a.physicsEnabled){b=0;for(c=a.bodies.length;b<c;b++)for(var f=0,h=a.bodies[b].shapes.length;f<
h;f++)a.bodies[b].type=Box2D.b2_staticBody;a.addToWorld(this.world,a.position)}else this.hasPhysics||(a.physicsEnabled=!1);this.addDrawable(a,null,null,d);this.tiles.push(a);return a};s.prototype.addTrigger=function(a,b,c){b&&!1===b instanceof v&&(b=new v(b));c&&c.triggerClass&&(a.triggerClass=c.triggerClass);c=0;for(var d=this.stage.input.inputEvents.length;c<d;c++)this.stage.input.inputEvents[c].mouse&&(this.stage.input.inputEvents[c].mouse.triggerClass||this.stage.input.inputEvents[c].mouse.objectClass)&&
(this.stage.input.inputEvents[c].mouse.triggerClass!=a.triggerClass&&"*"!=this.stage.input.inputEvents[c].mouse.triggerClass&&this.stage.input.inputEvents[c].mouse.objectClass!=a.triggerClass&&"*"!=this.stage.input.inputEvents[c].mouse.objectClass||a.inputMouseEvents.push(this.stage.input.inputEvents[c]));b&&(a.position=b);a.addToWorld(this.world,b);this.triggers.push(a);return a};s.prototype.addText=function(a,b,c,d){b&&!1===b instanceof v&&(b=new v(b));!1===a instanceof U?f=new U(a,b):(f=a,b&&f.position.set(b));
c&&(c.font&&(f.font=c.font),c.size&&(f.size=c.size),c.fill&&(f.fill=c.fill),c.stroke&&(f.stroke=c.stroke),c.textClass&&(trigger.textClass=c.textClass));a=0;for(b=this.stage.input.inputEvents.length;a<b;a++)this.stage.input.inputEvents[a].mouse&&(this.stage.input.inputEvents[a].mouse.textClass||this.stage.input.inputEvents[a].mouse.objectClass)&&(this.stage.input.inputEvents[a].mouse.textClass!=f.textClass&&"*"!=this.stage.input.inputEvents[a].mouse.textClass&&this.stage.input.inputEvents[a].mouse.objectClass!=
f.textClass&&"*"!=this.stage.input.inputEvents[a].mouse.objectClass||f.inputMouseEvents.push(this.stage.input.inputEvents[a]));f.getBoxPixel();this.addDrawable(f,null,null,d);return f};s.prototype.addBody=function(a){a.addToWorld(this.world);this.bodies.push(a)};s.prototype.addEmitter=function(a,b,c,d){if("string"===typeof a){if(!I.models[a])return;var f=a;a=(new V).load(I.models[a]);a.modelName=f}b&&!1===b instanceof v&&(b=new v(b));a instanceof ea?this.emitters.push(a):this.emitters.push(new ea(this,
a,b,c.max,c.force,c.life,c.interval,c.time,c.forceEmit));q=this.emitters[this.emitters.length-1];q.preload();a=0;for(b=this.stage.input.inputEvents.length;a<b;a++)this.stage.input.inputEvents[a].mouse&&this.stage.input.inputEvents[a].mouse.objectClass&&"*"==this.stage.input.inputEvents[a].mouse.objectClass&&q.inputMouseEvents.push(this.stage.input.inputEvents[a]);q.drawIndex=this.addDrawable(q,null,null,d)-1;return q};s.prototype.addLayerJoint=function(a,b,c){a instanceof Z?this.joints.push(a):this.joints.push(new Z(a,
a,c));a=0;for(b=this.stage.input.inputEvents.length;a<b;a++)this.stage.input.inputEvents[a].mouse&&this.stage.input.inputEvents[a].mouse.objectClass&&"*"==this.stage.input.inputEvents[a].mouse.objectClass&&this.joints[this.joints.length-1].inputMouseEvents.push(this.stage.input.inputEvents[a]);return this.joints[this.joints.length-1]};s.prototype.remove=function(a,b){-1<this.drawables.indexOf(a)&&this.drawables.splice(this.drawables.indexOf(a),1);b?a instanceof V?this.entities.splice(this.entities.indexOf(a),
1):a instanceof ba?this.tiles.splice(this.tiles.indexOf(a),1):a instanceof N?this.polygons.splice(this.polygons.indexOf(a),1):a instanceof U?this.texts.splice(this.texts.indexOf(a),1):a instanceof ea?this.emitters.splice(this.emitters.indexOf(a),1):a instanceof ia?this.triggers.splice(this.triggers.indexOf(a),1):a instanceof Z&&this.joints.splice(this.joints.indexOf(a),1):a instanceof V?this.entities[this.entities.indexOf(a)]=null:a instanceof ba?this.tiles[this.tiles.indexOf(a)]=null:a instanceof
N?this.polygons[this.polygons.indexOf(a)]=null:a instanceof U?this.polygons[this.texts.indexOf(a)]=null:a instanceof ea?this.emitters[this.emitters.indexOf(a)]=null:a instanceof ia?this.triggers[this.triggers.indexOf(a)]=null:a instanceof Z&&(this.joints[this.joints.indexOf(a)]=null);a.removeFromWorld&&a.removeFromWorld()};s.prototype.sort=function(){this.drawables.sort(function(a,b){return b.position.z-a.position.z})};s.prototype.pointMap=function(a,b,c,d){a.save();a.translate(this.position.x-this.position.z/
100*this.stage.camera.position.x,this.position.y-this.position.z/100*this.stage.camera.position.y);a.scale(this.scale.x,this.scale.y);h=this.drawables.map(function(d){return d.pointMap(a,b,c)});a.restore();return h};s.prototype.update=function(a,b){this.world&&b&&this.world.update(1/30*a);for(var c=0,d=this.emitters.length;c<d;c++)this.emitters[c]&&this.emitters[c].update(a,this);c=0;for(d=this.entities.length;c<d;c++)this.entities[c]&&this.entities[c].update(a,this),this.entities[c]&&(0==this.entities[c].decay?
this.remove(this.entities[c]):0<this.entities[c].decay&&this.entities[c].decay--);c=0;for(d=this.joints.length;c<d;c++)this.joints[c]&&this.joints[c].update(a,this);c=0;for(d=this.triggers.length;c<d;c++)this.triggers[c]&&this.triggers[c].update(a,this.stage)};return s}(),va=function(){var p,a,m,h,f,q,d,s=function(a,b,c,d,f,q,s,v,w,x,C,E,D,I,B,A){this.id=d;this.position=new u(a,b,c);this.input=new Ua(this);this.layers=[];this.camera=f;this.isEnabled=!1;this.onCreate=q;this.onReady=s;this.onStop=v;
this.onPause=w;this.onResume=x;this.onUpdate=C;this.actions=E||{};this.sequences={};this.audio=A?new Va:null;this.mapName="";this.height=this.width=1E3;this.backgroundColor="transparent";this.backgroundMusic=null;this.backgroundMusicFile="";this.spawnPoints=[];this.isPaused=!1;this.speed=1;this.physicsEnabled=B;this.alpha=I;this.effects={};for(p in D){E=[];m=0;for(h=D[p].length;m<h;m++)E.push(new Q(D[p][m][0],D[p][m][1],D[p][m][2]));this.sequences[p]=new Fa(E)}this.onCreate&&this.onCreate.call(this,
this)};s.prototype.destroy=function(){for(var a=0,b=this.layers.length;a<b;a++)this.layers[a].destroy()};s.prototype.vacuum=function(){for(var a=0,b=this.layers.length;a<b;a++){for(var c=this.layers[a].emitters.length;0<c;c--)null==this.layers[a].emitters[c-1]&&this.layers[a].emitters.splice(c-1,1);for(c=this.layers[a].tiles.length;0<c;c--)null==this.layers[a].tiles[c-1]&&this.layers[a].tiles.splice(c-1,1);for(c=this.layers[a].texts.length;0<c;c--)null==this.layers[a].texts[c-1]&&this.layers[a].texts.splice(c-
1,1);for(c=this.layers[a].polygons.length;0<c;c--)null==this.layers[a].polygons[c-1]&&this.layers[a].polygons.splice(c-1,1);for(c=this.layers[a].triggers.length;0<c;c--)null==this.layers[a].triggers[c-1]&&this.layers[a].triggers.splice(c-1,1);for(c=this.layers[a].entities.length;0<c;c--)if(null==this.layers[a].entities[c-1]){this.layers[a].entities.splice(c-1,1);for(var d=0,f=this.layers[a].joints.length;d<f;d++)this.layers[a].joints[d]&&(this.layers[a].joints[d].referenceA[1]>c&&(this.layers[a].joints[d].referenceA[1]-=
1),this.layers[a].joints[d].referenceB[1]>c&&(this.layers[a].joints[d].referenceB[1]-=1));d=0;for(f=this.layers[a].triggers.length;d<f;d++)this.layers[a].triggers[d]&&("entities"==this.layers[a].triggers[d].action.reference[0]&&this.layers[a].triggers[d].action.reference[1]>c&&(this.layers[a].triggers[d].action.reference[1]-=1),"entities"==this.layers[a].triggers[d].end.reference[0]&&this.layers[a].triggers[d].end.reference[1]>c&&(this.layers[a].triggers[d].end.reference[1]-=1))}for(c=this.layers[a].joints.length;0<
c;c--)null==this.layers[a].joints[c-1]&&this.layers[a].joints.splice(c-1,1)}};s.prototype.save=function(){this.vacuum();f={};f.w=this.width;f.h=this.height;f.bg=this.backgroundColor;f.bm=this.backgroundMusicFile;f.sp=[];for(p in this.spawnPoints)f.sp[p]=this.spawnPoints[p].save();f.k=[];p=0;for(a=this.layers.length;p<a;p++)for(m=0,h=this.layers[p].entities.length;m<h;m++)0>f.k.indexOf(this.layers[p].entities.modelName)&&f.k.push(this.layers[p].entities.modelName);f.l=[];p=0;for(a=this.layers.length;p<
a;p++)f.l[p]=this.layers[p].save();f.sq=[];p=0;for(a=this.sequences.length;p<a;p++)f.sq[p]=this.sequences[p].save();return f};s.prototype.load=function(a,b){this.layers.length=0;this.spawnPoints.length=0;this.width=a.w;this.height=a.h;this.backgroundColor=a.bg;this.backgroundMusicFile=a.bm;for(var c in a.sp)this.addSpawnPoint((new ua).load(a.sp[c]));c=0;for(var d=a.l.length;c<d;c++)this.addLayer(0,0,0,a.l[c]);c=0;for(d=a.sq.length;c<d;c++)this.sequences[c]=(new Fa).load(a.sq[c]);return this};s.prototype.clear=
function(){this.layers.length=0;this.spawnPoints.length=0;this.actions={};this.sequences={};this.height=this.width=1E3;this.backgroundColor="#FFF"};s.prototype.loadMap=function(a){for(var b in this.layers)this.layers[b].destroy();this.layers.length=0;this.spawnPoints.length=0;I.maps[a]&&(this.mapName!=a&&this.backgroundMusic&&this.backgroundMusic.stop(),this.mapName=a,this.load(I.maps[a]))};s.prototype.addLayer=function(a,b,c,d){return this.layers[this.layers.push(new Ma(a||0,b||0,c||0,this,d))-1]};
s.prototype.isObjectInStage=function(a){return-1<this.spawnPoints.indexOf(a)?!0:!1};s.prototype.getObjectsByClass=function(a){_rObjects=[];for(var b=0;b<this.layers.length;b++){for(var c=0,d=this.layers[b].tiles.length;c<d;c++)this.layers[b].tiles[c]&&this.layers[b].tiles[c].tileClass==a&&_rObjects.push(this.layers[b].tiles[c]);c=0;for(d=this.layers[b].entities.length;c<d;c++)this.layers[b].entities[c]&&this.layers[b].entities[c].entityClass==a&&_rObjects.push(this.layers[b].entities[c]);c=0;for(d=
this.layers[b].triggers.length;c<d;c++)this.layers[b].triggers[c]&&this.layers[b].triggers[c].triggerClass==a&&_rObjects.push(this.layers[b].triggers[c]);c=0;for(d=this.layers[b].texts.length;c<d;c++)this.layers[b].texts[c]&&this.layers[b].texts[c].textClass==a&&_rObjects.push(this.layers[b].texts[c]);c=0;for(d=this.layers[b].joints.length;c<d;c++)this.layers[b].joints[c]&&this.layers[b].joints[c].jointClass==a&&_rObjects.push(this.layers[b].joints[c]);c=0;for(d=this.layers[b].emitters.length;c<d;c++)this.layers[b].emitters[c]&&
this.layers[b].emitters[c].emitterClass==a&&_rObjects.push(this.layers[b].emitters[c])}return _rObjects};s.prototype.getObjectsLayer=function(a){for(var b=0;b<this.layers.length;b++)if(this.layers[b].isObjectInLayer(a))return this.layers[b]};s.prototype.getLayersByClass=function(a){_rObjects=[];for(var b=0;b<this.layers.length;b++)this.layers[b]&&this.layers[b].layerClass==a&&_rObjects.push(this.layers[b]);return _rObjects};s.prototype.addSpawnPoint=function(d,b,c,f){void 0!=b&&!1===b instanceof v&&
(b=new v(b));"string"==typeof d?d=new ua(this,c||0,b.matrix[0],b.matrix[1],d):(b&&d.position.set(b),void 0!=c&&(d.layer=c||0));p=0;for(a=this.input.inputEvents.length;p<a;p++)this.input.inputEvents[p].mouse&&this.input.inputEvents[p].mouse.objectClass&&"*"==this.input.inputEvents[p].mouse.objectClass&&d.inputMouseEvents.push(this.input.inputEvents[p]);this.spawnPoints.push(d);return this.spawnPoints[this.spawnPoints.length-1]};s.prototype.remove=function(a){a instanceof ua&&this.spawnPoints.splice(this.spawnPoints.indexOf(a),
1)};s.prototype.assignCamera=function(a){!1==a instanceof ya&&(a=L.getCamera(a));!1!=a instanceof ya&&(this.camera=a)};s.prototype.getReference=function(a){q=this;r=0;for(n=a.length;r<n;r++)q=q[a[r]];return q};s.prototype.draw=function(d,b){this.input.clearMouse();if(!(0>=this.alpha)){d.save();d.translate(this.position.x,this.position.y);d.scale(this.camera.zoom,this.camera.zoom);d.rotate(this.camera.orientation);d.translate(-this.camera.position.x,-this.camera.position.y);p=0;for(a=this.layers.length;p<
a;p++)if(this.layers[p].draw(d,this.effects,b.culling?(new C(b.viewportBox)).translate(this.position).scale(new u(1/this.camera.zoom,1/this.camera.zoom)).translate(this.camera.position).translate((new u(this.layers[p].position.x+this.layers[p].position.z/100*this.camera.position.x,this.layers[p].position.y+this.layers[p].position.z/100*this.camera.position.y)).scale(-1)):null),this.layers[p].objectsDebugDraw)for(m=0,h=this.spawnPoints.length;m<h;m++)this.spawnPoints[m].draw(d,this.layers[p].effects,
this);d.restore()}};s.prototype.drawStacked=function(d){this.input.clearMouse();p=0;for(a=this.layers.length;p<a;p++)if(99<this.layers[p].position.z&&8<=this.layers[p].renderTicks)this.layers[p].renderTicks=0;else if(97<this.layers[p].position.z&&1<=this.layers[p].renderTicks)this.layers[p].renderTicks=0;else{this.layers[p].renderTicks++;var b=d.getLayerCanvas(this.id,p);0==p&&(b.style.background=this.backgroundColor);b.style.opacity=this.alpha;d.clearCanvas(d.getLayerCanvas(this.id,p));if(!(0>=this.alpha)){ctx=
d.getLayerContext(this.id,p);ctx.save();ctx.scale(d.scale.matrix[0],d.scale.matrix[1]);ctx.scale(d.backingScale,d.backingScale);ctx.translate(this.position.x,this.position.y);ctx.scale(this.camera.zoom,this.camera.zoom);ctx.rotate(this.camera.orientation);ctx.translate(-this.camera.position.x,-this.camera.position.y);this.layers[p].draw(ctx,this.effects,d.culling?(new C(d.viewportBox)).translate(this.position).scale(new u(1/this.camera.zoom,1/this.camera.zoom)).translate(this.camera.position).translate((new u(this.layers[p].position.x+
this.layers[p].position.z/100*this.camera.position.x,this.layers[p].position.y+this.layers[p].position.z/100*this.camera.position.y)).scale(-1)):null);if(this.layers[p].objectsDebugDraw)for(m=0,h=this.spawnPoints.length;m<h;m++)this.spawnPoints[m].draw(ctx,this.layers[p].effects,this);ctx.restore()}}};s.prototype.drawStackedSVG=function(d){this.input.clearMouse();p=0;for(a=this.layers.length;p<a;p++)if(this.layers[p].isStatic){var b=d.getLayerCanvas(this.id,p);this.layers[p].isStaticRendered||(b.innerHTML=
"<div>"+this.layers[p].toSVG()+"</div>",this.layers[p].isStaticRendered=!0);this.lastRenderX||(this.lastRenderX=[],this.lastRenderY=[]);var c=(this.layers[p].position.x+this.layers[p].position.z/100*this.camera.position.x-this.camera.position.x)*this.camera.zoom,f=(this.layers[p].position.y+this.layers[p].position.z/100*this.camera.position.y-this.camera.position.y)*this.camera.zoom;if(!this.lastRenderX[p]||this.lastRenderX[p]<c-1||this.lastRenderX[p]>c+1||this.lastRenderY[p]<f-1||this.lastRenderY[p]>
f+1){b=b.getElementsByTagName("svg");m=0;for(h=b.length;m<h;m++)b[m].setAttribute("viewBox",-c+", "+-f+", "+1E3/this.camera.zoom+", "+562/this.camera.zoom);this.lastRenderX[p]=c;this.lastRenderY[p]=f}}else if(c=d.getLayerCanvas(this.id,p),0==p&&(c.style.background=this.backgroundColor),c.style.opacity=this.alpha,d.clearCanvas(d.getLayerCanvas(this.id,p)),!(0>=this.alpha)){ctx=d.getLayerContext(this.id,p);ctx.save();ctx.scale(d.scale.matrix[0],d.scale.matrix[1]);ctx.scale(d.backingScale,d.backingScale);
ctx.translate(this.position.x,this.position.y);ctx.scale(this.camera.zoom,this.camera.zoom);ctx.rotate(this.camera.orientation);ctx.translate(-this.camera.position.x,-this.camera.position.y);this.layers[p].draw(ctx,this.effects,d.culling?(new C(d.viewportBox)).translate(this.position).scale(new u(1/this.camera.zoom,1/this.camera.zoom)).translate(this.camera.position).translate((new u(this.layers[p].position.x+this.layers[p].position.z/100*this.camera.position.x,this.layers[p].position.y+this.layers[p].position.z/
100*this.camera.position.y)).scale(-1)):null);if(this.layers[p].objectsDebugDraw)for(m=0,h=this.spawnPoints.length;m<h;m++)this.spawnPoints[m].draw(ctx,this.layers[p].effects,this);ctx.restore()}};s.prototype.toSVG=function(){for(var a="",b=0,c=this.layers.length;b<c;b++)a+=this.layers[b].toSVG();return a};s.prototype.start=function(){this.isEnabled=!0;this.isPaused=!1;this.input.reset();this.onReady&&this.onReady.call(this)};s.prototype.stop=function(){this.isEnabled=!1;this.onStop&&this.onStop.call(this)};
s.prototype.pause=function(){this.isPaused=!0;this.onPause&&this.onPause.call(this)};s.prototype.resume=function(){this.isPaused=!1;this.input.reset();this.onResume&&this.onResume.call(this)};s.prototype.pointMap=function(a,b,c,f){a.save();a.translate(this.position.x,this.position.y);a.scale(this.camera.zoom,this.camera.zoom);a.rotate(this.camera.orientation);a.translate(this.camera.position.x,this.camera.position.y);d=this.layers.map(function(d){return d.pointMap(a,b,c,f)});a.restore();return d};
s.prototype.sortLayers=function(){this.layers.sort(function(a,b){return b.position.z-a.position.z})};s.prototype.callAction=function(a,b){if(this.actions[a])return this.actions[a].apply(this,Array.prototype.slice.call(arguments,1))};s.prototype.update=function(d){if(this.isEnabled){if(this.isPaused)this.input&&this.input.clearKeys();else{this.camera&&this.camera.update(this);if(this.onUpdate)this.onUpdate(this.speed,this);this.input&&this.input.update(d);for(p in this.sequences)this.sequences[p].update(this.speed,
this)}p=0;for(a=this.layers.length;p<a;p++)this.layers[p].update(this.isPaused?0:this.speed,this.physicsEnabled);this.audio&&this.audio.update(this.camera)}else this.input&&this.input.clearKeys()};return s}(),Sa=function(){var p=function(){this.aspectRatio=16/9;this.divElement=null;this.clearBeforeRender=!0;this.clearColor="#FFF";this.culling=!0;this.offset=new u(0,0);this.toRender=!0;this.scale=new u(1,1);this.screenDimensions={width:1E3,height:562};this.viewDimensions={width:1E3,height:562};this.viewportDimensions=
{left:0,top:0,width:0,height:0};this.viewportBox=new C;this.graphicsScale=1;this.styleClass="";this._inputCanvas=this._backgroundCanvas=this._containingDiv=this.id=null;this._canvases=[];this._contexts=[];this._stages=[];this.backingScale=m()},a=function(){var a=this.divElement.offsetWidth,d=this.divElement.offsetHeight;a/d>this.aspectRatio?(a=d*this.aspectRatio,this.viewportDimensions.height=d,this.viewportDimensions.width=a):(d=a/this.aspectRatio,this.viewportDimensions.width=a,this.viewportDimensions.height=
d);this.viewportDimensions.left=(this.divElement.offsetWidth-a)/2;this.viewportDimensions.top=(this.divElement.offsetHeight-d)/2;this.offset.matrix[0]=this.viewportDimensions.left;this.offset.matrix[1]=this.viewportDimensions.top;this.scale.matrix[0]=this.viewportDimensions.width/this.screenDimensions.width;this.scale.matrix[1]=this.viewportDimensions.height/this.screenDimensions.height;this.viewportBox.set(0,0,this.screenDimensions.width,this.screenDimensions.height);this.backingScale=m();a=0;for(d=
this._canvases.length;a<d;a++)b.call(this,this._canvases[a]);b.call(this,this._inputCanvas);this.viewportBox.set(0,0,this.screenDimensions.width,this.screenDimensions.height)},m=function(){var a=document.createElement("canvas").getContext("2d");if(1<T)if("devicePixelRatio"in window){if(1<window.devicePixelRatio&&2>a.webkitBackingStorePixelRatio)return window.devicePixelRatio}else return 1;return T},h=function(){for(var a=0,b=this._canvases.length;a<b;a++)g.call(this,this._canvases[a]);this.clearColor&&
this.clearColor!=this._backgroundCanvas.style.background&&(this.clearColor&&"transparent"!=this.clearColor?(this._backgroundCanvas.style.background=this.clearColor,this._backgroundCanvas.setAttribute("moz-opaque","moz-opaque"),this.clearColor=this._backgroundCanvas.style.background):(this._backgroundCanvas.style.background=null,this._backgroundCanvas.setAttribute("moz-opaque",null)))},f=function(){var a=document.createElement("div");a.id=this.id+":containingDiv";a.style.position="relative";a.style.margin=
"0px";a.style.width="100%";a.style.height="100%";a.style.backgroundColor="transparent";this.divElement.appendChild(a);return a},q=function(a,d){var f=document.createElement(navigator.isCocoonJS2?"screencanvas":"canvas");f.id=a;f.style.zIndex=d;f.style.position="absolute";f.style.margin="0px";f.style.backgroundColor="transparent";f.style.outline="none";this._containingDiv.appendChild(f);this._canvases.push(f);this._contexts.push(f.getContext("2d"));b.call(this,f);return f},d=function(a,d){var f=document.createElement("div");
f.id=a;f.style.zIndex=d;f.style.position="absolute";f.style.margin="0px";f.style.backgroundColor="transparent";f.style.outline="none";this._containingDiv.appendChild(f);this._canvases.push(f);this._contexts.push(null);b.call(this,f);return f},s=function(a){for(var b=0,d=a.layers.length;b<d;b++)if(document.getElementById(this.id+":"+a.id+":"+b))a:for(var f=this.id+":"+a.id+":"+b,g=0,h=this._canvases.length;g<h;g++)if(this._canvases[g].id==f){f=document.getElementById(f);f.parentNode.removeChild(f);
this._canvases.splice(g,1);this._contexts.splice(g,1);break a}},g=function(a,b){a.width=a.width},b=function(a){a.style.left=this.viewportDimensions.left+"px";a.style.top=this.viewportDimensions.top+"px";a.style.width=this.viewportDimensions.width+"px";a.style.height=this.viewportDimensions.height+"px";a.width=this.viewportDimensions.width*this.backingScale;a.height=this.viewportDimensions.height*this.backingScale};p.prototype={init:function(b,g,h,q){this.id=b;h&&(this.clearColor=h);q&&(this.styleClass=
q);this.divElement=document.getElementById(g);this.divElement.addEventListener("resize",function(){a()},!1);this.divElement.innerHTML="";this._containingDiv=f.call(this);this._backgroundCanvas=d.call(this,"background",-9999);this._backgroundCanvas.className=this.styleClass;this._inputCanvas=d.call(this,"input",9999);this._inputCanvas.tabIndex=1;this._inputCanvas.focus&&this._inputCanvas.focus();a.call(this)},render:function(){this.clearBeforeRender&&h.call(this);for(var a=0,b=this._stages.length;a<
b;a++)if(!(0>=this._stages[a].alpha)){document.getElementById(this.id+":0")||q.call(this,this.id+":0",0);this._contexts[2].save();this._contexts[2].scale(this.scale.matrix[0],this.scale.matrix[1]);this._contexts[2].scale(this.backingScale,this.backingScale);this._contexts[2].globalAlpha=this._stages[a].alpha;if(this._stages[a].backgroundColor&&"transparent"!=this._stages[a].backgroundColor&&0<this._stages[a].alpha){var d=this._contexts[2];d.fillStyle=this._stages[a].backgroundColor.toString();d.fillRect(0,
0,this.screenDimensions.width,this.screenDimensions.height)}this._stages[a].draw(this._contexts[2],this);this._contexts[2].restore()}},evaluate:a,clear:h,addStage:function(a){!1==a instanceof va&&(a=L.getStage(a));!1!=a instanceof va&&(this._stages.push(a),a.input.listenKeys(this._inputCanvas),a.input.listenMouse(this._inputCanvas),a.input.listenGamepad(this._inputCanvas))},removeStage:function(a){s(a);this._stages.input.removeListeners();this._stages.splice(this._stages.indexOf(a),1)},createCanvas:q,
clearCanvas:g,getLayerCanvas:function(a,b){if(document.getElementById(this.id+":"+a+":"+b))return document.getElementById(this.id+":"+a+":"+b);for(var f=0,g=this._stages.length;f<g;f++)this._stages[f].id==a&&(stageIndex=f);return this._stages[stageIndex].layers[b].isStatic?d.call(this,this.id+":"+a+":"+b,100*stageIndex+b):q.call(this,this.id+":"+a+":"+b,100*stageIndex+b)},getLayerContext:function(a,b){if(document.getElementById(this.id+":"+a+":"+b)){for(var d=0,f=this._stages.length;d<f;d++)this._stages[d].id==
a&&(stageIndex=d);return document.getElementById(this.id+":"+a+":"+b).getContext("2d")}q.call(this,this.id+":"+a+":"+b,a+b)}};return p}(),ya=function(){var p=function(a,m,h,f,q){this.id=q;this.position=new u(a,m,h);this.orientation=0;this.zoom=1;this.following=this.primaryStage=null;this.followType="EaseIn";this.destination=null;this.stiffness=.65;this.boundToStage=!0;this.shakeTime=this.shakeForce=this.shakeDuration=0;this.parallaxOffset=f;this.matrix=this.position.matrix};p.prototype.follow=function(a){this.following=
a;a||(this.destination=null)};p.prototype.shake=function(a,m,h){void 0==a&&(a=1);void 0==m&&(m=10);this.shakeDuration=this.shakeTime=m;this.shakeForce=a;this.shakeEase=h};p.prototype.update=function(a){if(!this.primaryStage||this.primaryStage==a){this.following&&(this.destination||(this.destination=this.following.position.clone()),this.destination.set(this.following.position),this.destination.sub(500/this.zoom,296/this.zoom));if(this.destination)switch(this.followType){case "Static":this.matrix[0]=
this.destination.matrix[0];this.matrix[1]=this.destination.matrix[1];break;case "EaseIn":this.matrix[0]+=((this.destination.matrix[0]-this.matrix[0])*Math.pow(this.stiffness,2)).round(.25);this.matrix[1]+=((this.destination.matrix[1]-this.matrix[1])*Math.pow(this.stiffness,2)).round(.25);break;case "Spring":var m=this.destination.clone().sub(this.position);0<Math.abs(m.matrix[0])&&(this.matrix[0]+=5.5*m.matrix[0]);0<Math.abs(m.matrix[1])&&(this.matrix[1]+=6.5*m.matrix[1])}if(this.shakeTime){var h=
2*Math.random()*Math.PI;switch(this.shakeEase){case "EaseIn":m=Math.cos(h)*(this.shakeForce+-this.shakeForce*Math.pow(this.shakeTime/this.shakeDuration,2));h=Math.sin(h)*(this.shakeForce+-this.shakeForce*Math.pow(this.shakeTime/this.shakeDuration,2));break;case "EaseOut":m=Math.cos(h)*(this.shakeForce+-this.shakeForce*(1-Math.pow(1-this.shakeTime/this.shakeDuration,2)));h=Math.sin(h)*(this.shakeForce+-this.shakeForce*(1-Math.pow(1-this.shakeTime/this.shakeDuration,2)));break;default:m=Math.cos(h)*
this.shakeForce,h=Math.sin(h)*this.shakeForce}this.matrix[0]+=m;this.matrix[1]+=h;this.shakeTime--}a&&this.boundToStage&&(0>this.matrix[0]&&(this.position.matrix[0]=0),this.matrix[0]+1E3/this.zoom>a.width&&(this.matrix[0]=a.width-1E3/this.zoom),0>this.matrix[1]&&(this.position.matrix[1]=0),this.matrix[1]+562/this.zoom>a.height&&(this.matrix[1]=a.height-562/this.zoom))}};return p}(),Ua=function(){var p=0,a,m,h,f,q=function(a){this.id=p++;this.stage=a;this.preventDefaultKeys=!1;this.keyDown=Array(255);
this.keyUp=Array(255);this.keyPressed=Array(255);this.keyFirstDown=Array(255);this.mouseDeltaY=this.mouseDeltaX=this.mouseAbosluteY=this.mouseAbosluteX=this.mouseY=this.mouseX=0;this.mouseFirstDown=Array(5);this.mouseDown=Array(5);this.mouseUp=Array(5);this.mouseClicked=Array(5);this.mouseDblClicked=Array(5);this.mouseWheelDeltaY=this.mouseWheelDeltaX=this.mouseWheelDelta=0;this.firstMouseDownEvent=Array(5);this.gamepadConnected=!1;this.gamepadButtonDown=Array(50);this.gamepadButtonPressed=Array(50);
this.gamepadButtonUp=Array(50);this.gamepadAxes=[0,0,0,0];this.gamepadAxesIdle=!0;this.gamepadAxesDigitalThreshold=.4;this.inputEvents=[]};q.prototype.bind=function(d){d=d||{};this.inputEvents.push(new Wa(this.stage,d.alias||this.id+":"+this.inputEvents.length,d.keys||{},d.mouse||{},d.gamepad||{},d.callback||function(){}));if(d.mouse){if(d.mouse.entities)if(Array.isArray(d.mouse.entities))for(a=0,m=mouse.entities.length;a<m;a++)d.mouse.entities[a].inputMouseEvents.push(this.inputEvents[this.inputEvents.length-
1]);else d.mouse.entities.inputMouseEvents.push(this.inputEvents[this.inputEvents.length-1]);if(d.mouse.entityClass)for(a=0,m=this.stage.layers.length;a<m;a++)for(h=0,f=this.stage.layers[a].entities.length;h<f;h++)this.stage.layers[a].entities[h].entityClass==d.mouse.entityClass&&this.stage.layers[a].entities[h].inputMouseEvents.push(this.inputEvents[this.inputEvents.length-1]);if(d.mouse.textClass)for(a=0,m=this.stage.layers.length;a<m;a++)for(h=0,f=this.stage.layers[a].texts.length;h<f;h++)this.stage.layers[a].texts[h].textClass==
d.mouse.textClass&&this.stage.layers[a].texts[h].inputMouseEvents.push(this.inputEvents[this.inputEvents.length-1])}};q.prototype.checkPath=function(d,f,g){if(d.isPointInPath(this.mouseAbosluteX,this.mouseAbosluteY))for(a in this.mouseEvents)this.mouseEvents[a].entityClass==g.entityClass&&this.queuedEvents.push(this.mouseEvents[a])};q.prototype.isFired=function(a){for(var f=0,g=this.inputEvents.length;f<g;f++)if(this.inputEvents[f].alias==a&&this.inputEvents[f].fired)return!0;return!1};q.prototype.handleEvent=
function(d){if(!this.stage.isPaused&&this.stage.isEnabled){switch(d.type){case "keypress":this.keyPressed[d.charCode]=1;a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerKey("pressed",d.charCode)&&this.preventDefaultKeys&&d.preventDefault();break;case "keydown":if(!(0!=this.keyDown[d.keyCode]&&this.keyDown[d.keyCode]||this.keyFirstDown[d.keyCode]))for(this.keyFirstDown[d.keyCode]=1,a=0,m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerKey("firstDown",d.keyCode)&&this.preventDefaultKeys&&
d.preventDefault();this.keyDown[d.keyCode]=1;delete this.keyUp[d.keyCode];break;case "keyup":delete this.keyDown[d.keyCode];delete this.keyPressed[d.charCode];this.keyUp[d.keyCode]=1;a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerKey("up",d.keyCode)&&this.preventDefaultKeys&&d.preventDefault();break;case "mousedown":case "touchstart2":this.getMouseCoordinates(d);this.mouseFirstDown[d.button]=1;this.mouseDown[d.button]=1;delete this.mouseUp[d.button];this.firstMouseDownEvent[d.button]||
(this.firstMouseDownEvent[d.button]={mouseHitPass:!1});a=0;for(m=this.inputEvents.length;a<m;a++)if(this.inputEvents[a].triggerMouse("firstDown",d.button,this.mouseX,this.mouseY),(this.inputEvents[a].mouse.firstDown||this.inputEvents[a].mouse.down||this.inputEvents[a].mouse.click)&&this.inputEvents[a].mouseHitPass){this.firstMouseDownEvent[d.button]={mouseHitPass:{entity:this.inputEvents[a].mouseHitPass.entity,polygons:[],objects:[]}};h=0;for(f=this.inputEvents[a].mouseHitPass.objects.length;h<f;h++)this.firstMouseDownEvent[d.button].mouseHitPass.objects.push(this.inputEvents[a].mouseHitPass.objects[h]);
h=0;for(f=this.inputEvents[a].mouseHitPass.polygons.length;h<f;h++)this.firstMouseDownEvent[d.button].mouseHitPass.polygons.push(this.inputEvents[a].mouseHitPass.polygons[h])}break;case "mouseup":case "touchend":delete this.mouseFirstDown[d.button];delete this.mouseDown[d.button];this.mouseUp[d.button]=1;a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerMouse("up",d.button,this.mouseX,this.mouseY);this.firstMouseDownEvent[d.button]={mouseHitPass:!1};break;case "click":this.getMouseCoordinates(d);
this.mouseClicked[d.button]=1;a=0;for(m=this.inputEvents.length;a<m;a++)this.firstMouseDownEvent[d.button].mouseHitPass&&this.inputEvents[a].mouseHitPass!=this.firstMouseDownEvent[d.button].mouseHitPass||this.inputEvents[a].triggerMouse("click",d.button,this.mouseX,this.mouseY);break;case "dblclick":this.getMouseCoordinates(d);this.mouseDblClicked[d.button]=1;a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerMouse("dblclick",d.button,this.mouseX,this.mouseY);break;case "mousewheel":this.mouseWheelDelta=
d.wheelDelta;this.mouseWheelDeltaX=d.wheelDeltaX;this.mouseWheelDeltaY=d.wheelDeltaY;break;case "touchmove":case "mousemove":this.getMouseCoordinates(d);a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerMouse("hover",!0,this.mouseX,this.mouseY,this.mouseDeltaX,this.mouseDeltaY);break;case "drag":d.preventDefault();break;case "gamepadAxes":a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerGamepad("axes",d.axes);if(Math.abs(d.axes[0])>this.gamepadAxesDigitalThreshold||
Math.abs(d.axes[1])>this.gamepadAxesDigitalThreshold){if(!0===this.gamepadAxesIdle)for(a=0,m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerGamepad("firstAxes",d.axes);this.gamepadAxesIdle=!1}else this.gamepadAxesIdle=!0;break;case "gamepadButtonDown":if(!(0!=this.gamepadButtonDown[d.button]&&this.gamepadButtonDown[d.button]||this.gamepadButtonPressed[d.button]))for(this.gamepadButtonPressed[d.button]=1,a=0,m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerGamepad("firstDown",
d.button);this.gamepadButtonDown[d.button]=1;a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerGamepad("down",d.button);delete this.gamepadButtonUp[d.button];break;case "gamepadButtonUp":if(1!=this.gamepadButtonUp[d.button])for(this.gamepadButtonUp[d.button]=1,a=0,m=this.inputEvents.length;a<m;a++)this.inputEvents[a].triggerGamepad("up",d.button);delete this.gamepadButtonPressed[d.button];delete this.gamepadButtonDown[d.button]}return!0}};q.prototype.getMouseCoordinates=function(a){aspectX=
a.target.width/1E3;aspectY=a.target.height/562;var f=this.mouseX,g=this.mouseY;if(a.touches&&a.touches[0])this.mouseAbosluteX=a.touches[0].pageX-a.target.offsetLeft,this.mouseAbosluteY=a.touches[0].pageY-a.target.offsetTop,this.mouseX=(a.touches[0].pageX-a.target.offsetLeft)/aspectX,this.mouseY=(a.touches[0].pageY-a.target.offsetTop)/aspectY;else if(a.offsetX||0==a.offsetX)this.mouseAbosluteX=a.offsetX,this.mouseAbosluteY=a.offsetY,this.mouseX=a.offsetX/aspectX,this.mouseY=a.offsetY/aspectY;else if(a.layerX||
0==a.layerX)this.mouseAbosluteX=a.layerX,this.mouseAbosluteY=a.layerY,this.mouseX=a.layerX/aspectX,this.mouseY=a.layerY/aspectY;1!=T&&(this.mouseAbosluteX*=T,this.mouseAbosluteY*=T,this.mouseX*=T,this.mouseY*=T);this.mouseX/=this.stage.camera.zoom;this.mouseY/=this.stage.camera.zoom;this.mouseX+=this.stage.camera.position.x;this.mouseY+=this.stage.camera.position.y;this.mouseDeltaX+=this.mouseX-f;this.mouseDeltaY+=this.mouseY-g};q.prototype.listenKeys=function(a){a.addEventListener("keypress",this,
!1);a.addEventListener("keydown",this,!1);a.addEventListener("keyup",this,!1)};q.prototype.listenMouse=function(a){a.addEventListener("touchstart",this,!1);a.addEventListener("touchend",this,!1);a.addEventListener("touchmove",this,!1);a.addEventListener("mousedown",this,!1);a.addEventListener("drag",this,!1);a.addEventListener("click",this,!1);a.addEventListener("mouseup",this,!1);a.addEventListener("mousewheel",this,!1);a.addEventListener("dblclick",this,!1);a.addEventListener("mousemove",this,!1);
a.oncontextmenu=function(){return!1};a.ondragstart=function(){return!1};a.onselectstart=function(){return!1}};q.prototype.listenGamepad=function(a){window.addEventListener("MozGamepadConnected",function(a){console.log(a)})};q.prototype.clearKeys=function(){this.keyPressed=Array(255);this.keyFirstDown=Array(255);this.keyUp=Array(255)};q.prototype.reset=function(){this.keyDown=Array(255);this.keyPressed=Array(255);this.keyFirstDown=Array(255);this.keyUp=Array(255);this.gamepadButtonDown=Array(50);this.gamepadButtonPressed=
Array(50);this.gamepadButtonUp=Array(50);for(var a=0,f=this.gamepadButtonUp.length;a<f;a++)this.gamepadButtonUp[a]=1,this.gamepadButtonPressed[a]=1};q.prototype.clearMouse=function(){a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].mouseHitPass=!1};q.prototype.update=function(d){if(d=navigator.webkitGetGamepads&&navigator.webkitGetGamepads()[0]){this.gamepadConnected=!0;if(d.buttons)for(h=0,f=d.buttons.length;h<f;h++)1==d.buttons[h]?this.handleEvent({type:"gamepadButtonDown",button:h}):
0==d.buttons[h]&&this.handleEvent({type:"gamepadButtonUp",button:h});d.axes&&((.11<=Math.abs(d.axes[0])||.11<=Math.abs(d.axes[1])||.11<=Math.abs(d.axes[2])||.11<=Math.abs(d.axes[3]))&&this.handleEvent({type:"gamepadAxes",axes:d.axes}),this.gamepadAxes=d.axes)}else this.gamepadConnected=!1;for(a=this.inputEvents.length-1;0<=a;a--){if(this.inputEvents[a].keys)for(h=0,f=this.keyDown.length;h<f;h++)this.keyDown[h]&&this.inputEvents[a].triggerKey("down",h);h=0;for(f=this.mouseDown.length;h<f;h++)this.mouseDown[h]&&
(0==this.mouseDeltaX&&0==this.mouseDeltaY||this.inputEvents[a].triggerMouse("drag",h,this.mouseX,this.mouseY,this.mouseDeltaX,this.mouseDeltaY,this.firstMouseDownEvent[h].mouseHitPass),this.inputEvents[a].triggerMouse("down",h,this.mouseX,this.mouseY,this.mouseDeltaX,this.mouseDeltaY,this.inputEvents[h].mouseHitPass))}for(a=this.inputEvents.length-1;0<=a&&(!this.inputEvents[a].mouse.firstDown||!1!==this.inputEvents[a].fireEvents());a--);for(a=this.inputEvents.length-1;0<=a&&(!this.inputEvents[a].mouse.down||
!1!==this.inputEvents[a].fireEvents());a--);for(a=this.inputEvents.length-1;0<=a&&(!this.inputEvents[a].mouse.up||!1!==this.inputEvents[a].fireEvents());a--);for(a=this.inputEvents.length-1;0<=a&&(!this.inputEvents[a].mouse.click||!1!==this.inputEvents[a].fireEvents());a--);for(a=this.inputEvents.length-1;0<=a&&(!this.inputEvents[a].mouse.drag||!1!==this.inputEvents[a].fireEvents());a--);for(a=this.inputEvents.length-1;0<=a&&(this.inputEvents[a].mouse.firstDown||this.inputEvents[a].mouse.down||this.inputEvents[a].mouse.up||
this.inputEvents[a].mouse.click||this.inputEvents[a].mouse.drag||!1!==this.inputEvents[a].fireEvents());a--);a=0;for(m=this.inputEvents.length;a<m;a++)this.inputEvents[a].update();this.clearKeys();this.mouseFirstDown=Array(5);this.mouseClicked=Array(5);this.mouseDblClicked=Array(5);this.mouseUp=Array(5);this.mouseWheelDeltaY=this.mouseWheelDeltaX=this.mouseWheelDelta=this.mouseDeltaY=this.mouseDeltaX=0};return q}(),Wa=function(){var p,a,m=function(a,f,q,d,m,g){this.stage=a;this.alias=f;this.keys=
q;this.mouse=d;this.gamepad=m;this.callback=g;this.mouseHitPass=this.fired=!1};m.prototype.update=function(a){a&&(this.mouseHitPass=!1);this.fired=!1};m.prototype.fireEvents=function(){if(this.fired)return this.callback(this.stage,this.fired)};m.prototype.queueFired=function(a){this.fired||(this.fired=[]);this.fired.push(a)};m.prototype.trigger=function(){this.fired=!0};m.prototype.triggerKey=function(h,f){var q=!1;if(!this.keys[h])return q;if(Array.isArray(this.keys[h]))for(p=0,a=this.keys[h].length;p<
a;p++)f==this.keys[h][p]&&(this.queueFired({eventType:h,keyCode:f}),q=!0);else f==this.keys[h]&&(this.queueFired({eventType:h,keyCode:f}),q=!0);return q};m.prototype.triggerMouse=function(a,f,q,d,m,g,b){if(this.mouse[a]){if(Array.isArray(this.mouse[a]))for(k=0,p=this.mouse[a].length;k<p;k++){if(f==this.mouse[a][k]){if(this.mouse.area)q>this.mouse.area[0]&&d>this.mouse.area[1]&&q<this.mouse.area[2]&&d<this.mouse.area[3]&&this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,area:this.mouse.area});
else if(this.mouse.objectClass||this.mouse.entities||this.mouse.entityClass||this.mouse.polygons||this.mouse.polygonClass||this.mouse.texts||this.mouse.textClass){var c=!0;if(b){for(var k=0,p=b.objects.length;k<p;k++)this.mouse.textClass&&this.mouse.textClass==b.objects[k]&&(c=!0);c&&this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,mouseDeltaX:m,mouseDeltaY:g,entity:b.entity,polygons:b.polygons,objects:b.objects})}else if(this.mouseHitPass){k=0;for(p=this.mouseHitPass.objects.length;k<p;k++)this.mouse.textClass&&
this.mouse.textClass==this.mouseHitPass.objects[k]&&(c=!0);c&&this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,mouseDeltaX:m,mouseDeltaY:g,entity:this.mouseHitPass.entity,polygons:this.mouseHitPass.polygons,objects:this.mouseHitPass.objects})}}else this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,mouseDeltaX:m,mouseDeltaY:g});break}}else if(f==this.mouse[a])if(this.mouse[a].area)q>this.mouse.area[0]&&d>this.mouse.area[1]&&q<this.mouse.area[2]&&d<this.mouse.area[3]&&this.queueFired({eventType:a,
button:f,mouseX:q,mouseY:d,area:this.mouse.area});else if(this.mouse.objectClass||this.mouse.entities||this.mouse.entityClass||this.mouse.polygons||this.mouse.polygonClass||this.mouse.texts||this.mouse.textClass)if(c=!0,b){k=0;for(p=b.objects.length;k<p;k++)this.mouse.textClass&&this.mouse.textClass==b.objects[k]&&(c=!0);c&&this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,mouseDeltaX:m,mouseDeltaY:g,entity:b.entity,polygons:b.polygons,objects:b.objects})}else{if(this.mouseHitPass){k=0;for(p=
this.mouseHitPass.objects.length;k<p;k++)this.mouse.textClass&&this.mouse.textClass==this.mouseHitPass.objects[k]&&(c=!0);c&&this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,mouseDeltaX:m,mouseDeltaY:g,entity:this.mouseHitPass.entity,polygons:this.mouseHitPass.polygons,objects:this.mouseHitPass.objects})}}else this.queueFired({eventType:a,button:f,mouseX:q,mouseY:d,mouseDeltaX:m,mouseDeltaY:g});return this}};m.prototype.triggerGamepad=function(h,f){var q=!1;if(!this.gamepad||!this.gamepad[h])return q;
if(Array.isArray(this.gamepad[h]))for(p=0,a=this.gamepad[h].length;p<a;p++)if("axes"==h||"firstAxes"==h){if(axes=f,0<this.gamepad[h][0]&&axes[0]>this.gamepad[h][0]||0>this.gamepad[h][0]&&axes[0]<this.gamepad[h][0]||0<this.gamepad[h][1]&&axes[1]>this.gamepad[h][1]||0>this.gamepad[h][1]&&axes[1]<this.gamepad[h][1])this.queueFired({eventType:h,axes:axes}),q=!0}else f==this.gamepad[h][p]&&(this.queueFired({eventType:h,button:f}),q=!0);else"axes"==h||"firstAxes"==h?(axes=f,axes[0]>Math.abs(this.gamepad[h])&&
(this.queueFired({eventType:h,axes:axes}),q=!0)):f==this.gamepad[h]&&(this.queueFired({eventType:h,button:f}),q=!0);return q};return m}(),Va=function(){var p,a,m=null,h=function(){this.masterPanner=this.masterGainNode=this.masterChain=this.audioContext=null;this.audioSources=[];try{this.audioContext=window.AudioContext?new window.AudioContext:window.webkitAudioContext?new window.webkitAudioContext:window.mozAudioContext?new window.mozAudioContext:window.oAudioContext?new window.oAudioContext:window.msAudioContext?
new window.msAudioContext:void 0;this.masterGainNode=this.audioContext.createGain();this.masterGainNode.connect(this.audioContext.destination);var a=this;window.addEventListener("blur",function(){a.browserSupportsWebAudio&&a.masterGainNode.disconnect();for(var d=0;d<a.audioSources.length;d++)if(a.audioSources[d].isMusic&&!a.audioSources[d].isPaused&&!a.audioSources[d].isStopped){var h=a.audioSources[d].isPaused,g=a.audioSources[d].isStopped;a.audioSources[d].pause();a.audioSources[d].isPaused=h;a.audioSources[d].isStopped=
g}});window.addEventListener("focus",function(){a.browserSupportsWebAudio&&a.masterGainNode.connect(a.audioContext.destination);for(var d=0;d<a.audioSources.length;d++)!a.audioSources[d].isMusic||a.audioSources[d].isPaused||a.audioSources[d].isStopped||a.audioSources[d].resume()});window.addEventListener("visibilitychange",function(d){document.hidden?a.masterGainNode.disconnect():a.masterGainNode.connect(a.audioContext.destination)});this.browserSupportsWebAudio=!0}catch(h){}return this};h.prototype.cacheAudio=
function(f){f=f||{};var h;a:{h=f.url||"";var d=f.id||f.url.split("/").pop(),s=void 0==f.defaultGain?1:f.defaultGain,g=f.isMusic||!1,b=f.playOnComplete;f=f.loop||!1;p=0;for(a=this.audioSources.length;p<a;p++)if(""!=d&&this.audioSources[p].id==d){b&&this.audioSources[p].play();h=this.audioSources[p];break a}this.browserSupportsWebAudio?(m=new Xa(d,this.audioContext,this.masterGainNode,s,g,f),this.audioSources.push(m),m.cache(h,b),h=m):h=void 0}return h};h.prototype.play=function(f){f=f||{};a:{var h=
f.id||"",d=f.location;f=f.delay||0;p=0;for(a=this.audioSources.length;p<a;p++)if(this.audioSources[p].id==h){this.audioSources[p].play(d,f);break a}}};h.prototype.update=function(a,h){this.browserSupportsWebAudio&&this.audioContext.listener.setPosition(a.position.matrix[0]+500*(1+a.position.matrix[2]),a.position.matrix[1]+231*(1+a.position.matrix[2]),a.position.matrix[2])};return h}(),Xa=function(){var p=0,a=function(a,h,f,q,d,s){this.id=a||p++;this.url="";this.defaultGain=q||1;this.isMusic=d;this.loop=
s;this.isPaused=!1;this.isStopped=!0;if(this.isMusic){this.audioTag=document.createElement("audio");var g=this;this.audioTag.addEventListener("ended",function(){g.loop&&g.play()},!1)}else this.audioContext=h,this.masterNode=f,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.masterNode),this.audioBufferSource=this.audioBuffer=null,this.panner=h.createPanner(),this.panner.refDistance=900,this.panner.coneInnerAngle=0,this.panner.coneOuterAngle=360,this.panner.coneOuterGain=1,this.panner.connect(this.gainNode)};
a.prototype.cacheAudio=function(a,h){this.audioTag.setAttribute("src",a);this.audioTag.load();h&&this.play()};a.prototype.cacheWebAudio=function(a,h){var f=new XMLHttpRequest;f.open("GET",a,!0);f.responseType="arraybuffer";var q=this;f.onload=function(){q.audioContext.decodeAudioData(f.response,function(a){q.audioBuffer=a;h&&q.play()},function(a){})};f.send()};a.prototype.cache=function(a,h){this.isMusic?this.cacheAudio(a,h):this.cacheWebAudio(a,h)};a.prototype.playAudio=function(a,h,f,q){try{this.audioTag.volume=
f?f:this.defaultGain,this.audioTag.play()}catch(d){console.warn("Could not play audio.",d)}};a.prototype.playWebAudio=function(a,h,f,q){try{this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=this.audioBuffer,this.gainNode.gain.value=f?f:this.defaultGain,this.isMusic?this.audioBufferSource.connect(this.gainNode):(a&&this.panner.setPosition(a.matrix[0],a.matrix[1],a.matrix[2]),h&&this.panner.setVelocity(h.matrix[0],-h.matrix[1],h.matrix[2]),a||h?this.audioBufferSource.connect(this.panner):
this.audioBufferSource.connect(this.gainNode)),this.audioBufferSource.start(q||0)}catch(d){console.warn("Could not play audio.",d)}};a.prototype.play=function(a,h,f,q){if(this.isMusic){try{this.audioTag.currentTime=0}catch(d){}this.playAudio(a,h,f,q)}else this.playWebAudio(a,h,f,q);this.isStopped=this.isPaused=!1};a.prototype.stop=function(){if(this.isMusic){this.audioTag.pause();try{this.audioTag.currentTime=0,this.isPaused=!1,this.isStopped=!0}catch(a){console.warn("Could not stop audio.",a)}}else this.audioBufferSource&&
this.audioBufferSource.stop(0)};a.prototype.pause=function(){this.isMusic?this.audioTag.pause():this.audioBufferSource&&this.audioBufferSource.stop();this.isPaused=!0;this.isStopped=!1};a.prototype.resume=function(){this.isMusic?this.audioTag.play():this.audioBufferSource&&this.audioBufferSource.play();this.isStopped=this.isPaused=!1};return a}();new w;var Na=function(){var p=0,a=function(a){this.id=p++;this.cyclesThisSecond=this.droppedFramesThisSecond=this.framesThisSecond=this.lastFPSCheck=this.framesPerSecond=
this.cyclesPerSecond=this.droppedRenderFrames=0};a.prototype.update=function(){this.framesThisSecond++;999<performance.now()-this.lastFPSCheck&&(this.framesPerSecond=this.framesThisSecond,this.droppedRenderFrames=this.droppedFramesThisSecond,this.cyclesPerSecond=this.cyclesThisSecond,this.lastFPSCheck=performance.now(),this.cyclesThisSecond=this.droppedFramesThisSecond=this.framesThisSecond=0)};return a}(),Qa=function(){var p=0,a=function(a,h){p++;this.id=h||p;this.pools={}};a.prototype.preAllocate=
function(a,h){this.pools[a]||(this.pools[a]=[]);for(var f=0;f<h;f++)"World"==a&&this.pools[a].push({free:!0,obj:new Ea})};a.prototype.allocate=function(a){this.pools[a]||(this.pools[a]=[]);for(var h=0,f=this.pools[a].length;h<f;h++)if(this.pools[a][h].free)return this.pools[a][h].free=!1,this.pools[a][h].obj;console.log("Resizing pool for "+a+" to "+this.pools[a].length);"World"==a&&this.pools[a].push({free:!1,obj:new Ea});return this.pools[a][this.pools[a].length-1].obj};a.prototype.free=function(a,
h){for(var f=0,q=this.pools[a].length;f<q;f++)this.pools[a][f].obj==h&&(this.pools[a][f].free=!0)};return a}(),Pa=function(){var p,a=function(){this.maps={};this.models={}};a.prototype.loadModelCache=function(a){for(p in a)this.models[p]=a[p]};a.prototype.loadMapCache=function(a){for(p in a)this.maps[p]=a[p]};return a}(),Ga=function(){var p=function(){};p.prototype.loadModel=function(a){var m=new V,h=h||1,h=new u(h,h);"string"===typeof a?(cache=Wave.Cache.getCachedModel(a),m.modelName=a,cache&&("string"==
typeof cache?(_JSONstring.compactOutput=!0,_JSONstring.includeProtos=!1,_JSONstring.includeFunctions=!1,_JSONstring.detectCirculars=!0,_JSONstring.restoreCirculars=!0,a=_JSONstring.toObject(cache)):a=cache)):(_JSONstring.compactOutput=!0,_JSONstring.includeProtos=!1,_JSONstring.includeFunctions=!1,_JSONstring.detectCirculars=!0,_JSONstring.restoreCirculars=!0,a.alreadyDecoded||(a=_JSONstring.toObject(a)),a.alreadyDecoded=!0,a&&a.ModelName&&(m.modelName=a.ModelName));if("object"==typeof a){e=m;engineVersion=
a.meta?a.meta.engine:"BETA";switch(engineVersion){case "WAVE":for(var f=0;f<a.Polygons.length;f++){newPoly=m.polygons[m.polygons.push(new N)-1];b=a.Polygons[f];offset=new u(b.Position.X,b.Position.Y);newPoly.name=""==typeof b.Name?0:b.Name;newPoly.width="undefined"==typeof b.Width?0:1*b.Width;newPoly.height="undefined"==typeof b.Height?0:1*b.Height;newPoly.stroke="undefined"==typeof b.StrokeStyle?"white":b.StrokeStyle;newPoly.scaleStrokeWhenScaling="undefined"==typeof b.ScaleStroke?!1:b.ScaleStroke;
newPoly.fill="undefined"==typeof b.FillStyle?"black":b.FillStyle;newPoly.lineWidth="undefined"==typeof b.LineWidth?1:1*b.LineWidth;newPoly.alpha="undefined"==typeof b.Alpha?1:1*b.Alpha;newPoly.stroke=new x(newPoly.stroke);newPoly.fill=new x(newPoly.fill);for(var q=0;q<b.Lines.length;q++)switch(g=b.Lines[q],g.Type){case "Arc":newPoly.addArc([g.P2.X+offset.x,g.P2.Y+offset.y],1*[g.P0],[g.P1.X*h.x]);break;case "ArcTo":newPoly.addArcTo([g.End_X1*h.x+offset.x,g.End_Y1*h.y+offset.y],[g.End_X1*h.x+offset.x,
g.End_Y1*h.y+offset.y],[g.Control_X2]);break;case "BezierCurve":newPoly.addLine([g.P2.X+offset.x,g.P2.Y+offset.y],[g.P0.X+offset.x,g.P0.Y+offset.y],[g.P1.X+offset.x,g.P1.Y+offset.y]);break;case "Line":newPoly.addLine([g.P0.X+offset.x,g.P0.Y+offset.y]);break;case "Move":newPoly.addMove([g.P0.X+offset.x,g.P0.Y+offset.y]);break;case "QuadraticCurve":newPoly.addLine([g.P1.X+offset.x,g.P1.Y+offset.y],[g.P0.X+offset.x,g.P0.Y+offset.y])}}}if(f=a.hull){m.physicsEnabled=!0;q=new S({type:Box2D.b2_dynamicBody});
for(b=0;b<f.length;b++){if(f[b].material)var d=new ca({density:f[b].material.density,friction:f[b].material.friction,restitution:f[b].material.restitution,filter:new da(f[b].filter.category,f[b].filter.mask,f[b].filter.group),isSensor:f[b].isSensor});if(f[b].vertices)for(var p=[],g=0;g<f[b].vertices.length;g++)p.push(new v(f[b].vertices[g][0],f[b].vertices[g][1]));g=new ha({position:new u(f[b].position[0],f[b].position[1]),radius:f[b].radius?f[b].radius:null,width:f[b].width?f[b].width:null,height:f[b].height?
f[b].height:null,vertices:p,material:d});q.shapes.push(g)}q.bind("position",new u(0,0));m.bodies.push(q)}for(f=0;f<a.Bones.length;f++)for(d=new sa(a.Bones[f].Position.X,a.Bones[f].Position.Y,0,a.Bones[f].Rotation),m.bones.push(d),a.Bones[f].BindingAnchor||(a.Bones[f].BindingAnchor=[]),q=0;q<a.Bones[f].Binding.length;q++)if("string"!=typeof a.Bones[f].Binding[q])for(b=0;b<a.Polygons.length;b++)for(g=0;g<a.Polygons[b].Lines.length;g++)a.Polygons[b].Lines[g]==a.Bones[f].Binding[q]&&(a.Bones[f].BindingAnchor[q]&&
(p=new u(a.Polygons[b].Lines[g].Position.X-a.Bones[f].Position.X+a.Polygons[b].Position.X,a.Polygons[b].Lines[g].Position.Y-a.Bones[f].Position.Y+a.Polygons[b].Position.Y),d.bind("polygons."+b+".lines."+g+".point",a.Bones[f].Weight[q],p)),a.Bones[f].BindingHandle1[q]&&m.polygons[b].lines[g].anchor1&&(p=new u(a.Polygons[b].Lines[g].P0.X-a.Bones[f].Position.X+a.Polygons[b].Position.X,a.Polygons[b].Lines[g].P0.Y-a.Bones[f].Position.Y+a.Polygons[b].Position.Y),d.bind("polygons."+b+".lines."+g+".anchor1",
a.Bones[f].Weight[q],p)),a.Bones[f].BindingHandle2[q]&&m.polygons[b].lines[g].anchor2&&(p=new u(a.Polygons[b].Lines[g].P1.X-a.Bones[f].Position.X+a.Polygons[b].Position.X,a.Polygons[b].Lines[g].P1.Y-a.Bones[f].Position.Y+a.Polygons[b].Position.Y),d.bind("polygons."+b+".lines."+g+".anchor2",a.Bones[f].Weight[q],p)));for(f=0;f<a.Animation.length;f++){d=new Ba;for(q=p=0;q<a.Animation[f].KeyFrame.length;q++){g=new Ca(p,1.5*a.Animation[f].KeyFrame[q].Duration);h=a.Animation[f].KeyFrame[q+1];q==a.Animation[f].KeyFrame.length-
1&&(h=a.Animation[f].KeyFrame[0]);for(b=0;b<a.Polygons.length;b++)g.polygons.push(b);for(b=0;b<a.Animation[f].KeyFrame[q].Bones.length;b++)g.transforms.push(new Da("bones."+b+".position",new v(a.Animation[f].KeyFrame[q].Bones[b].Position.X-a.Bones[b].Position.X,a.Animation[f].KeyFrame[q].Bones[b].Position.Y-a.Bones[b].Position.Y,0,a.Animation[f].KeyFrame[q].Bones[b].Rotation-a.Bones[b].Rotation),new v(h.Bones[b].Position.X-a.Bones[b].Position.X-(a.Animation[f].KeyFrame[q].Bones[b].Position.X-a.Bones[b].Position.X),
h.Bones[b].Position.Y-a.Bones[b].Position.Y-(a.Animation[f].KeyFrame[q].Bones[b].Position.Y-a.Bones[b].Position.Y),0,h.Bones[b].Rotation-a.Animation[f].KeyFrame[q].Bones[b].Rotation)));p+=1.5*a.Animation[f].KeyFrame[q].Duration;d.frames.push(g);d.updateDuration()}m.addAnimation(a.Animation[f].Name,d)}}a=null;for(f=0;f<m.polygons.length;f++)0==f?a=m.polygons[f].getBoxPixel():a.combine(m.polygons[f].getBoxPixel());a=a.getCenter();for(f=0;f<m.polygons.length;f++)for(var b=m.polygons[f],q=0;q<b.lines.length;q++){var g=
b.lines[q];g.point&&g.point.sub(a).normalize();g.anchor1&&g.anchor1.sub(a).normalize();g.anchor2&&g.anchor2.sub(a).normalize()}for(f=0;f<m.bones.length;f++)m.bones[f].position.sub(a).normalize();return m};p.prototype.loadMap=function(a){var m=new va;if("string"===typeof a)if(cache=cache.getCachedMap(a),pEntity.ModelName=model,cache)a="string"==typeof cache?JSON.parse(cache):cache;else return;if("object"==typeof a&&(m.mapName=a.Name,a.Width&&(m.width=1*a.Width),a.Height&&(m.height=1*a.Height),a.ClearColor&&
(m.backgroundColor=a.ClearColor),a.Layers&&0<a.Layers.length))for(var h=0;h<a.Layers.length;h++){var f=a.Layers[h];stageLayer=new Ma(f.Position_X,f.Position_Y,f.Position_Z,m);m.layers.push(stageLayer);if(f.Tiles&&0<f.Tiles.length)for(var q=0;q<f.Tiles.length;q++){var d=f.Tiles[q];collidable=editmode=!1;switch(d.TileType){case "Tile":try{var p=stageLayer.addTile(d.ModelName,[Math.ceil(d.Position_X),Math.ceil(d.Position_Y),0,1*d.Angle],{scale:[1*d.Scale_X,1*d.Scale_Y],flipX:d.FlippedHorizontal,flipY:d.FlippedVertical,
physicsEnabled:d.Collidable,tileClass:d.SubType})}catch(g){return}p.physicsEnabled=d.Collidable;p.position.add(p.getBoxPixel().getWidth()/2,p.box.getHeight()/2);break;case "Actor":case "Entity":try{p=stageLayer.addEntity(d.ModelName,[Math.ceil(d.Position_X),Math.ceil(d.Position_Y),0,1*d.Angle],{scale:[1*d.Scale_X,1*d.Scale_Y],angle:1*d.Angle,flipX:d.FlippedHorizontal,flipY:d.FlippedVertical,physicsEnabled:d.Collidable,awake:d.IsAwake,animation:d.AnimationName?{primary:d.AnimationName}:!1,loopAnimation:d.LoopAnimation,
gravityScale:d.Weight,entityClass:d.SubType,fixedRotation:d.AnimationName?!0:!1})}catch(b){return}p.legacyIndex=d.ID;p.physicsEnabled=d.Collidable;p.update(0,stageLayer);p.position.add(p.getBoxPixel().getWidth()/2,p.box.getHeight()/2);break;case "Spawn Location":m.addSpawnPoint("Spawn Point",[1*d.Position_X,1*d.Position_Y],h);break;case "Trigger":var c=new ia(new v(d.Position_X+16*d.Scale_X,d.Position_Y+16*d.Scale_Y));c.bodies[0].shapes.push(new ha({width:Math.round(32*d.Scale_X),height:Math.round(32*
d.Scale_Y),material:new ca({filter:new da(16,1),sensor:"trigger"})}));c.bodies[0].type=0;switch(d.SubType){case "Activate":for(var k=0;k<stageLayer.entities.length&&stageLayer.entities[k].legacyIndex!=d.Bindings[0];k++);c.action=new Q(["layers",h,"entities",k,"bodies",0,"b2Body","SetAwake"],[!0]);break;case "Dialog":c.action=new Q(["actions","dialog"],[d.Value_0])}stageLayer.addTrigger(c,c.position);break;case "Trigger2":currentTile=Wave.Entities.add("_trigger_",[1*d.Position_X,1*d.Position_Y,1*f.Position_Z],
[0,0],[1*d.Scale_X,1*d.Scale_Y],1*d.Angle,1*d.Weight,d.SubType);currentTile.ID=d.ID;currentTile.Type="Trigger";currentTile.Polygons[0].Alpha=editmode?.5:0;d.SubType&&(currentTile.Subtype=d.SubType);currentTile.Value=[];d.Value_0&&(currentTile.Value[0]=parseInt(d.Value_0)?parseInt(d.Value_0):d.Value_0);d.Value_1&&(currentTile.Value[1]=parseInt(d.Value_1)?parseInt(d.Value_1):d.Value_1);d.Value_2&&(currentTile.Value[2]=parseInt(d.Value_2)?parseInt(d.Value_2):d.Value_2);stageLayer.Entities.add(currentTile);
d.Bindings&&(currentTile.Bindings=d.Bindings);break;case "Joint":tileBindings=[];for(var c={},w={},k=0;k<d.Bindings.length;k++);if("World"==d.Bindings[0].id)c="world";else for(k=0;k<stageLayer.entities.length;k++)if(stageLayer.entities[k].legacyIndex==d.Bindings[0].id){c=stageLayer.entities[k];break}if("World"==d.Bindings[1].id)w="world";else for(k=0;k<stageLayer.entities.length;k++)if(stageLayer.entities[k].legacyIndex==d.Bindings[1].id){w=stageLayer.entities[k];break}k={type:d.SubType.toLowerCase()};
k.anchorA=new u(c.position);k.anchorB=new u(w.position);"World"==d.Bindings[0].id&&k.anchorA.set(d.Bindings[0].position.x,d.Bindings[0].position.y);"World"==d.Bindings[1].id&&k.anchorB.set(d.Bindings[1].position.x,d.Bindings[1].position.y);switch(d.SubType){case "Prismatic":k.lowerTranslation=0,k.upperTranslation=k.anchorA.distance(k.anchorB),k.axis=(new u(k.anchorB)).sub(k.anchorA).scale(-1),k.axis.normalize(),k.axis.matrix[0]=k.axis.matrix[0].round(1),k.axis.matrix[1]=k.axis.matrix[1].round(1);
case "Distance":d.JointProperties&&(d.JointProperties.enableLimit&&(k.enableLimit=d.JointProperties.enableLimit),d.JointProperties.enableMotor&&(k.enableMotor=d.JointProperties.enableMotor),d.JointProperties.maxMotorForce&&(k.maxMotorForce=1*d.JointProperties.maxMotorForce),d.JointProperties.motorSpeed&&(k.motorSpeed=1*d.JointProperties.motorSpeed),"Auto Reverse"==d.JointProperties.modulationType&&(k.modulation={auto:!0}),"Timed Reverse"==d.JointProperties.modulationType&&(k.modulation={time:d.JointProperties.modulationTime}));
break;case "Revolute":d.JointProperties&&(d.JointProperties.enableLimit&&(k.enableLimit=d.JointProperties.enableLimit),d.JointProperties.enableMotor&&(k.enableMotor=d.JointProperties.enableMotor),d.JointProperties.maxMotorTorque&&(k.maxMotorTorque=1*d.JointProperties.maxMotorTorque),d.JointProperties.motorSpeed&&(k.motorSpeed=1*d.JointProperties.motorSpeed),"Auto Reverse"==d.JointProperties.modulationType&&(k.modulation={auto:!0}),"Timed Reverse"==d.JointProperties.modulationType&&(k.modulation={time:d.JointProperties.modulationTime}))}"world"==
w?stageLayer.joints.push(new Z(["entities",stageLayer.entities.indexOf(c),"bodies",0],["world"],k)):stageLayer.joints.push(new Z(["entities",stageLayer.entities.indexOf(c),"bodies",0],["entities",stageLayer.entities.indexOf(w),"bodies",0],k));switch(d.SubType){case "Distance1":c=new Wave.Physics.b2DistanceJointDef;c.userData={id:d.ID};d.JointProperties&&(d.JointProperties.enableLimit&&(c.enableLimit=d.JointProperties.enableLimit),d.JointProperties.enableMotor&&(c.enableMotor=d.JointProperties.enableMotor),
d.JointProperties.maxMotorForce&&(c.maxMotorForce=d.JointProperties.maxMotorForce),d.JointProperties.motorSpeed&&(c.motorSpeed=d.JointProperties.motorSpeed));var x,C,E,D;if("World"==d.Bindings[0].id)x=Wave.Physics.world.GetGroundBody(),C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x,d.Bindings[0].position.y);else for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[0].id&&(x=Wave.Entities._Collection[k].physics.b2Body,C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x+
Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[0].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));if(d.Bindings[1].id&&"World"!=d.Bindings[1].id)for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[1].id&&(E=Wave.Entities._Collection[k].physics.b2Body,D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x+Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[1].position.y+
Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));else E=Wave.Physics.world.GetGroundBody(),D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x,d.Bindings[1].position.y);if(C||D)c.Initialize(x,E,Wave.Physics.p2m(C),Wave.Physics.p2m(D)),Wave.Physics.world.CreateJoint(c);break;case "Prismatic1":c=new Wave.Physics.b2PrismaticJointDef;c.userData={id:d.ID};d.JointProperties&&(d.JointProperties.enableLimit&&(c.enableLimit=d.JointProperties.enableLimit),d.JointProperties.enableMotor&&
(c.enableMotor=d.JointProperties.enableMotor),d.JointProperties.maxMotorForce&&(c.maxMotorForce=1*d.JointProperties.maxMotorForce),d.JointProperties.motorSpeed&&(c.motorSpeed=1*d.JointProperties.motorSpeed));if("World"==d.Bindings[0].id)x=Wave.Physics.world.GetGroundBody(),C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x,d.Bindings[0].position.y);else for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[0].id&&(x=Wave.Entities._Collection[k].physics.b2Body,C=
Wave.Physics.toB2Vec2(d.Bindings[0].position.x+Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[0].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));if(d.Bindings[1].id&&"World"!=d.Bindings[1].id)for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[1].id&&(E=Wave.Entities._Collection[k].physics.b2Body,D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x+Wave.Entities._Collection[k].Position.X-
Wave.Entities._Collection[k].Width/2,d.Bindings[1].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));else E=Wave.Physics.world.GetGroundBody(),D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x,d.Bindings[1].position.y);c.lowerTranslation=0;c.upperTranslation=Wave.Math.distanceBetweenTwoPoints(Wave.Physics.p2m(D),Wave.Physics.p2m(C));axis=Wave.Physics.toB2Vec2(-(D.x-C.x),-(D.y-C.y));axis.Normalize();if(C||D){c.Initialize(x,E,Wave.Physics.p2m(C),axis);var I=Wave.Physics.world.CreateJoint(c);
if(d.JointProperties&&d.JointProperties.modulationType)switch(d.JointProperties.modulationType){case "Auto Reverse":Wave.Timers.add(function(a){(0<a.GetMotorSpeed()&&Math.round(10*a.GetUpperLimit())==Math.round(10*a.GetJointTranslation())||0>a.GetMotorSpeed()&&Math.round(10*I.GetLowerLimit())==Math.round(10*a.GetJointTranslation()))&&a.SetMotorSpeed(-a.GetMotorSpeed())},1,!0,0,I);break;case "Timed Reverse":Wave.Timers.add(function(a){Math.round(10*a.GetUpperLimit())==Math.round(10*a.GetJointTranslation())||
(Math.round(10*I.GetLowerLimit()),Math.round(10*a.GetJointTranslation()))},1,!0,0,I);Wave.Timers.add(function(a){a.SetMotorSpeed(-a.GetMotorSpeed())},1*d.JointProperties.modulationTime,!0,0,I);break;default:Wave.Timers.add(function(a){(Math.round(10*a.GetUpperLimit())<=Math.round(10*a.GetJointTranslation())||Math.round(10*I.GetLowerLimit())>=Math.round(10*a.GetJointTranslation()))&&a.EnableMotor(!1)},1,!0,0,I)}}break;case "Revolute1":if("World"==d.Bindings[0].id)x=stageLayer.world.GetGroundBody(),
C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x,d.Bindings[0].position.y);else for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[0].id&&(x=Wave.Entities._Collection[k].physics.b2Body,C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x+Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[0].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));if(d.Bindings[1].id&&"World"!=d.Bindings[1].id)for(k=
0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[1].id&&(E=Wave.Entities._Collection[k].physics.b2Body,D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x+Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[1].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));else E=Wave.Physics.world.GetGroundBody(),D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x,d.Bindings[1].position.y);c=new Wave.Physics.b2RevoluteJointDef;
c.userData={id:d.ID};d.JointProperties&&(d.JointProperties.enableLimit&&(c.enableLimit=d.JointProperties.enableLimit),d.JointProperties.enableMotor&&(c.enableMotor=d.JointProperties.enableMotor),d.JointProperties.maxMotorTorque&&(c.maxMotorTorque=1*d.JointProperties.maxMotorTorque),d.JointProperties.motorSpeed&&(c.motorSpeed=1*d.JointProperties.motorSpeed));if("World"==d.Bindings[0].id)x=Wave.Physics.world.GetGroundBody(),C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x,d.Bindings[0].position.y);
else for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[0].id&&(x=Wave.Entities._Collection[k].physics.b2Body,C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x+Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[0].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));if(d.Bindings[1].id&&"World"!=d.Bindings[1].id)for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==
d.Bindings[1].id&&(E=Wave.Entities._Collection[k].physics.b2Body,D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x+Wave.Entities._Collection[k].Position.X-Wave.Entities._Collection[k].Width/2,d.Bindings[1].position.y+Wave.Entities._Collection[k].Position.Y-Wave.Entities._Collection[k].Height/2));else E=Wave.Physics.world.GetGroundBody(),D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x,d.Bindings[1].position.y);if(C||D)c.Initialize(x,E,Wave.Physics.p2m(C)),Wave.Physics.world.CreateJoint(c);break;case "Pulley":c=
new Wave.Physics.b2PulleyJointDef;c.userData={id:d.ID};d.JointProperties&&(d.JointProperties.enableLimit&&(c.enableLimit=d.JointProperties.enableLimit),d.JointProperties.enableMotor&&(c.enableMotor=d.JointProperties.enableMotor),d.JointProperties.maxMotorForce&&(c.maxMotorForce=d.JointProperties.maxMotorForce),d.JointProperties.motorSpeed&&(c.motorSpeed=d.JointProperties.motorSpeed));if("World"==d.Bindings[0].id)x=Wave.Physics.world.GetGroundBody(),C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x,
d.Bindings[0].position.y);else for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[0].id&&(x=Wave.Entities._Collection[k].physics.b2Body,C=Wave.Physics.toB2Vec2(d.Bindings[0].position.x+Wave.Entities._Collection[k].Position.X,d.Bindings[0].position.y+Wave.Entities._Collection[k].Position.Y));if(d.Bindings[1].id&&"World"!=d.Bindings[1].id)for(k=0;k<Wave.Entities._Collection.length;k++)Wave.Entities._Collection[k].ID==d.Bindings[1].id&&(E=Wave.Entities._Collection[k].physics.b2Body,
D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x+Wave.Entities._Collection[k].Position.X,d.Bindings[1].position.y+Wave.Entities._Collection[k].Position.Y));else E=Wave.Physics.world.GetGroundBody(),D=Wave.Physics.toB2Vec2(d.Bindings[1].position.x,d.Bindings[1].position.y)}}}}return m};_JSONstring=function(){return{compactOutput:!1,includeProtos:!1,includeFunctions:!1,detectCirculars:!0,restoreCirculars:!0,make:function(a,m){this.restore=m;this.mem=[];this.pathMem=[];return this.toJSONstringArray(a).join("")},
toObject:function(a){"string"==typeof a&&(a=JSON.parse(a.replace(/Infinity/g,0).replace(/NaN/g,0)));return a=_JSONstring.recurseCirc(a,a)},recurseCirc:function(a,m){for(var h in m)if("string"==typeof m[h]&&-1!=m[h].indexOf("JSONcircRef")){var f=m[h].split(":")[1];if(f){f=f.split(".");m[h]=a[f[0]];for(var q=1;q<f.length;q++)m[h]=m[h][f[q]]}else m[h]=null}else if("object"==typeof m[h]||"array"==typeof m[h])m[h]=_JSONstring.recurseCirc(a,m[h]);return m},toJSONstringArray:function(a,m){m||(this.path=
[]);m=m||[];switch(typeof a){case "object":this.lastObj=a;if(this.detectCirculars){for(var h=this.mem,f=this.pathMem,q=0;q<h.length;q++)if(a===h[q])return m.push('"JSONcircRef:'+f[q]+'"'),m;h.push(a);f.push(this.path.join("."))}if(a){if(a.constructor==Array){m.push("[");for(q=0;q<a.length;++q)this.path.push(q),0<q&&m.push(",\n"),this.toJSONstringArray(a[q],m),this.path.pop();m.push("]")}else if("undefined"!=typeof a.toString){m.push("{");h=!0;for(q in a)if(this.includeProtos||a[q]!==a.constructor.prototype[q])this.path.push(q),
f=m.length,h||m.push(this.compactOutput?",":",\n"),this.toJSONstringArray(q,m),m.push(":"),this.toJSONstringArray(a[q],m),void 0==m[m.length-1]?m.splice(f,m.length-f):h=!1,this.path.pop();m.push("}")}return m}m.push("null");return m;case "unknown":case "undefined":case "function":if(!this.includeFunctions)return m.push(void 0),m;a="JSONincludedFunc:"+a;m.push('"');h='\\ \\\\ \n \\n \r \\r " \\"'.split(" ");a+="";for(q=0;8>q;q+=2)a=a.split(h[q]).join(h[q+1]);m.push(a);m.push('"');return m;case "string":this.restore&&
0==a.indexOf("JSONcircRef:")&&this.restoreCode.push("this.myObj."+this.path.join(".")+"="+a.split("JSONcircRef:").join("this.myObj."));m.push('"');h='\n \\n \r \\r " \\"'.split(" ");a+="";for(q=0;6>q;q+=2)a=a.split(h[q]).join(h[q+1]);m.push(a);m.push('"');return m;default:return m.push(String(a)),m}}}}();return p}(),Q=function(){var p,a,m,h=/\$C\((\d+)?,\s?(\d+),\s?(\d+),\s?(\d+)\)/,f=/\$V\((\d+),\s?(\d+),\s?(\d+),\s?(\d+)\)/,q=function(a,f,g){this.reference="string"===typeof a?a.split("."):a||[];
this.duration=g||0;this.args=f||[];this.prepareArguments()};q.prototype.prepareArguments=function(){if(!this.args)return[];this.args instanceof Array||(this.args=[this.args]);return this.args=this.args.map(function(a){if("string"===typeof a){if("$C"===a.substring(0,2))return m=a.match(h),new x(1*m[1],1*m[2],1*m[3],1*m[4]);if("$V"===a.substring(0,2))return m=a.match(f),new v(1*m[1],1*m[2],1*m[3],1*m[4])}return a})};q.prototype.save=function(){return[this.reference.slice(),this.args.map(function(a){return a instanceof
x?"$C("+a.red+", "+a.green+", "+a.blue+", "+a.alpha+")":a instanceof v?"$V("+a.matrix[0]+", "+a.matrix[1]+", "+a.matrix[2]+", "+a.orientation+")":a}),this.duration]};q.prototype.clone=function(){return new Q(this.save())};q.prototype.referenceArguments=function(a,f){return this.args?a.map(function(a){return"string"===typeof a&&"&"===a.charAt(0)?f.getReference(a.substring(1).split(".")):a}):[]};q.prototype.fire=function(d,f){p=d.getReference(this.reference);a=d.getReference(this.reference.slice(0,
-1));p.apply(a,this.referenceArguments(this.args,d).concat([f]))};return q}(),Fa=function(){var p,a,m,h,f=function(a,d){this.time=0;this.duration=d||0;this.actions=a||[];this.loop=this.active=!1;this.updateDuration()};f.prototype.save=function(){a={};a.d=this.duration;a.a=[];for(m in this.actions)a.a[m]=this.actions[m].save();return a};f.prototype.load=function(a){this.duration=a.d;for(m in a.a)this.actions[m]=new Q(a.a[m][0],a.a[m][1],a.a[m][2])};f.prototype.start=function(a,d){this.time=0;this.active=
!0;this.loop=a||!1;this.callback=d||!1};f.prototype.stop=function(){this.time=0;this.active=!1};f.prototype.pause=function(){this.active=!1};f.prototype.resume=function(){this.active=!0};f.prototype.updateDuration=function(){this.duration=1<this.actions.length?this.actions.reduce(function(a,d,f){return 1==f?a.duration+d.duration:a+d.duration}):this.actions[0].duration};f.prototype.modTime=function(a,d){d&&(a%=this.duration);return a};f.prototype.fireActions=function(a,d){p=1;m=0;for(h=this.actions.length;m<
h;m++)a==p&&this.actions[m].fire(d),p+=this.actions[m].duration};f.prototype.update=function(a,d){this.active&&(this.time=this.modTime(this.time+a,this.loop),this.fireActions(this.time,d),this.callback&&this.callback.call&&this.time==this.duration&&!this.loop&&this.callback.call(this))};return f}(),ea=function(){var p=0,a,m,h,f=function(a,d,f,g,b,c,h,m){this.id=p++;this.layer=a;this.entity=d;this.position=f||new v;this.max=g||100;this.force=b||new u;this.life=c||-1;this.interval=h||0;this.time=m||
0;this.instances=[];this.drawIndex=this.index=0;this.emitterClass="";this.disabled=!1;this.inputMouseEvents=[];this.effects={};this.forceEmit=void 0!==b?b:!0;this.box=new C(-Infinity,-Infinity,Infinity,Infinity)};f.prototype.save=function(){a={};a.e=this.entity.modelName;a.o=this.entity.saveOptions();a.c=this.emitterClass;a.p=[this.position.matrix[0],this.position.matrix[1],this.position.matrix[2],this.position.orientation];a.mx=this.max;a.f=[this.force.matrix[0],this.force.matrix[1]];a.l=this.life;
a.i=this.interval;a.t=this.time;a.di=this.drawIndex;return a};f.prototype.load=function(a){this.entity=(new V).load(a.e,{scale:[a.o.s[0],a.o.s[1]],alpha:a.o.a|0,entityClass:a.o.c,timelines:a.o.t,physicsEnabled:a.o.pe,gravityScale:a.o.gs,fixedRotation:a.o.fr,awake:a.o.aw,flipX:a.o.fx,flipY:a.o.fy,effects:a.o.ef});this.emitterClass=a.c;this.position.set(a.p[0],a.p[1],a.p[2],a.p[3]).normalize();this.max=a.mx;this.force.set(a.f[0],a.f[1]);this.life=a.l;this.interval=a.i;this.time=a.t;this.drawIndex=a.di;
return this};f.prototype.preload=function(){for(var a=0;a<this.max;a++)m=this.entity.instance(),m.age=-1,this.instances.push(m)};f.prototype.clone=function(){return new ea(this.layer,this.entity,this.position.clone(),this.max,this.force.clone(),this.life,this.interval,this.time)};f.prototype.emit=function(a,d,f){if(this.forceEmit)m=this.instances[this.index];else{m=!1;for(var g=0;g<this.instances.length;g++)-1===this.layer.entities.indexOf(this.instances[g])&&(m=this.instances[g]);if(!m)return}-1==
this.layer.entities.indexOf(m)&&this.layer.addEntity(m,void 0,{entityClass:m.entityClass},this.drawIndex);m.bodies[0].setTransform(a||this.position,a?a.orientation:this.orientation);m.bodies[0].setLinearVelocity(new u(0,0));2==m.bodies[0].type?m.applyForce(d||this.force):1==m.bodies[0].type&&m.setLinearVelocity(d||this.force);m.age=0;for(g in m.timelines)m.timelines[g].time=0,m.timelines[g].active=!0,m.timelines[g].animationByTime(m,0),m.isStatic=!1;++this.index>=this.max&&(this.index=0);m.renderedLastFrame=
!0;m.logic&&m.logic.onEmit&&m.logic.onEmit.call(m,this,this.index);return m};f.prototype.setPosition=function(a,d,f,g){this.position.set(a,d,f,g)};f.prototype.translate=function(a,d,f,g){this.position.add(a,d,f,g)};f.prototype.update=function(a,d){if(!this.disabled&&(this.time+=a,this.interval&&0==this.time%this.interval&&this.time&&this.emit(),-1!==this.life))for(var f=0,g=this.instances.length;f<g;f++)h=this.instances[f],-1!==h.age&&(h.age+=a,h.age>=this.life&&(d.remove(h),h.age=-1))};f.prototype.draw=
function(a,d,f){if(this.layer.objectsDebugDraw){a.save();a.translate(this.position.matrix[0],this.position.matrix[1]);a.beginPath();a.arc(0,0,1,0,6.3,!1);a.arc(0,0,40,0,6.3,!1);a.lineTo(0,40);this.effects&&this.effects.outline&&(a.lineWidth=12,a.strokeStyle=this.effects.outline,a.stroke());a.lineWidth=6;a.strokeStyle="#FF0";a.stroke();if(f&&0<this.inputMouseEvents.length&&a.isPointInPath(f.input.mouseAbosluteX,f.input.mouseAbosluteY))for(d=0,f=this.inputMouseEvents.length;d<f;d++)this.inputMouseEvents[d].mouseHitPass||
(this.inputMouseEvents[d].mouseHitPass={objects:[this],polygons:[]}),this.inputMouseEvents[d].mouseHitPass.objects.push(this);a.restore()}};f.prototype.getBox=function(){return this.box};f.prototype.enable=function(){this.disabled=!1;this.time=this.interval-1};f.prototype.disable=function(){this.disabled=!0;this.time=0};return f}(),Z=function(){var p,a,m=function(a,f,m){this.referenceA="string"===typeof a?a.split("."):a;this.referenceB="string"===typeof f?f.split("."):f;this.options=m||{};this.count=
this.time=0;this.cachedReference;this.inputMouseEvents=[];this.effects={};this.jointClass};m.prototype.save=function(){p={};p.ra=this.referenceA;p.rb=this.referenceB;p.o=this.options;p.c=this.jointClass;this.options.anchorA&&(p.a=[this.options.anchorA.matrix[0],this.options.anchorA.matrix[1]]);this.options.anchorB&&(p.b=[this.options.anchorB.matrix[0],this.options.anchorB.matrix[1]]);this.options.axis&&(p.ax=[this.options.axis.matrix[0],this.options.axis.matrix[1]]);return p};m.prototype.load=function(a){this.referenceA=
a.ra;this.referenceB=a.rb;this.options=a.o;this.jointClass=a.c;a.a&&(this.options.anchorA=new u(a.a[0],a.a[1]));a.b&&(this.options.anchorB=new u(a.b[0],a.b[1]));a.ax&&(this.options.axis=new u(a.ax[0],a.ax[1]));return this};m.prototype.weld=function(a){this.joint=new oa(this.referenceB,this.options);this.cachedReference=a.getReference(this.referenceA);this.joint.join(a.world,a,this.cachedReference)};m.prototype.update=function(h){if(this.options.modulation){switch(this.options.type){case "revolute":a=
Box2D.wrapPointer(this.joint.b2Joint.ptr,Box2D.b2RevoluteJoint);break;case "prismatic":a=Box2D.wrapPointer(this.joint.b2Joint.ptr,Box2D.b2PrismaticJoint);break;default:if(this.options.modulation.auto||this.options.modulation.time||this.options.modulation.count)return}this.options.modulation.auto&&(.05>Math.abs(a.GetJointSpeed())&&(a.SetMotorSpeed(-a.GetMotorSpeed()),this.count++),0>a.GetMotorSpeed()&&(a.GetJointTranslation?a.GetJointTranslation():a.GetJointAngle())<=a.GetLowerLimit()?(a.SetMotorSpeed(-a.GetMotorSpeed()),
this.count++):0<a.GetMotorSpeed()&&(a.GetJointTranslation?a.GetJointTranslation():a.GetJointAngle())>=a.GetUpperLimit()&&(a.SetMotorSpeed(-a.GetMotorSpeed()),this.count++));this.options.modulation.time&&(this.time+=h,this.time>=this.options.modulation.time&&(a.SetMotorSpeed(-a.GetMotorSpeed()),this.time=0,this.count++));this.options.modulation.count&&this.count>=this.options.modulation.count&&a.EnableMotor(!1)}};m.prototype.restart=function(){this.count=this.time=0;switch(this.options.type){case "revolute":a=
Box2D.wrapPointer(this.joint.b2Joint.ptr,Box2D.b2RevoluteJoint);break;case "prismatic":a=Box2D.wrapPointer(this.joint.b2Joint.ptr,Box2D.b2PrismaticJoint);break;default:return}a.EnableMotor(!0)};m.prototype.enableMotor=function(h){void 0===h&&(h=!0);switch(this.options.type){case "revolute":a=Box2D.wrapPointer(this.joint.b2Joint.ptr,Box2D.b2RevoluteJoint);break;case "prismatic":a=Box2D.wrapPointer(this.joint.b2Joint.ptr,Box2D.b2PrismaticJoint);break;default:return}a.EnableMotor(h)};m.prototype.setPosition=
function(a,f,m,d,p){p&&p.position.set(a,f,m,d)};m.prototype.translate=function(a,f,m,d,p){p&&p.position.add(a,f,m,d)};m.prototype.draw=function(a,f,m,d){a.save();this.options.referenceA&&this.drawReference(a,f,m,d,this.options.referenceA);this.options.referenceB&&this.drawReference(a,f,m,d,this.options.referenceB);this.options.anchorA&&this.drawAnchor(a,f,m,this.options.anchorA);this.options.anchorB&&this.drawAnchor(a,f,m,this.options.anchorB);this.options.anchorA&&this.options.anchorB&&(a.beginPath(),
a.moveTo(this.options.anchorA.matrix[0],this.options.anchorA.matrix[1]),a.lineTo(this.options.anchorB.matrix[0],this.options.anchorB.matrix[1]),a.lineWidth=6,a.strokeStyle="#F00",a.stroke());a.restore()};m.prototype.drawReference=function(a,f,m,d,p){if("world"!=p){a.save();d.getReference(p).parentObject&&a.translate(d.getReference(p).parentObject.position.matrix[0],d.getReference(p).parentObject.position.matrix[1]);a.translate(d.getReference(p).position.matrix[0],d.getReference(p).position.matrix[1]);
a.beginPath();a.arc(0,0,1,0,6.3,!1);a.moveTo(0,40);a.arc(0,0,40,0,6.3,!1);this.effects&&this.effects.outline&&(a.lineWidth=12,a.strokeStyle=this.effects.outline,a.stroke());a.lineWidth=6;a.strokeStyle="#F70";a.stroke();if(m&&0<this.inputMouseEvents.length&&a.isPointInPath(m.input.mouseAbosluteX,m.input.mouseAbosluteY))for(i=0,l=this.inputMouseEvents.length;i<l;i++)this.inputMouseEvents[i].mouseHitPass||(this.inputMouseEvents[i].mouseHitPass={objects:[],polygons:[anchor]}),this.inputMouseEvents[i].mouseHitPass.objects.push({joint:this,
effects:this.effects,reference:p,setPosition:function(a,b,c,d){this.reference.position.set(a,b,c,d)},translate:function(a,b,c,d){this.reference.position.add(a,b,c,d)}});a.restore()}};m.prototype.drawAnchor=function(a,f,m,d){a.save();a.translate(d.matrix[0],d.matrix[1]);a.beginPath();a.arc(0,0,1,0,6.3,!1);a.moveTo(0,40);a.arc(0,0,40,0,6.3,!1);this.effects&&this.effects.outline&&(a.lineWidth=12,a.strokeStyle=this.effects.outline,a.stroke());a.lineWidth=6;a.strokeStyle="#F00";a.stroke();if(m&&0<this.inputMouseEvents.length&&
a.isPointInPath(m.input.mouseAbosluteX,m.input.mouseAbosluteY))for(i=0,l=this.inputMouseEvents.length;i<l;i++)this.inputMouseEvents[i].mouseHitPass||(this.inputMouseEvents[i].mouseHitPass={objects:[],polygons:[d]}),this.inputMouseEvents[i].mouseHitPass.objects.push({joint:this,effects:this.effects,anchor:d,setPosition:function(a,d,b,c){this.anchor.set(a,d,b,c);this.joint.joint.options.axis=(new u(this.joint.joint.options.anchorA)).sub(this.joint.joint.options.anchorB).normalize();"prismatic"==this.joint.joint.options.type&&
(this.joint.joint.options.lowerTranslation=this.joint.cachedReference.position.vector.distance(this.joint.joint.options.anchorA),this.joint.joint.options.upperTranslation=this.joint.cachedReference.position.vector.distance(this.joint.joint.options.anchorB),0<this.joint.joint.options.anchorA.clone().sub(this.joint.cachedReference.parentObject.position).dot2D(this.joint.joint.options.axis)&&(this.joint.joint.options.lowerTranslation*=-1),0<this.joint.joint.options.anchorB.clone().sub(this.joint.cachedReference.parentObject.position).dot2D(this.joint.joint.options.axis)&&
(this.joint.joint.options.upperTranslation*=-1))},translate:function(a,d,b,c){this.anchor.add(a,d,b,c);this.joint.joint.options.axis=(new u(this.joint.joint.options.anchorA)).sub(this.joint.joint.options.anchorB).normalize();"prismatic"==this.joint.joint.options.type&&(this.joint.joint.options.lowerTranslation=this.joint.cachedReference.parentObject.position.vector.distance(this.joint.joint.options.anchorA),this.joint.joint.options.upperTranslation=this.joint.cachedReference.parentObject.position.vector.distance(this.joint.joint.options.anchorB),
0<this.joint.joint.options.anchorA.clone().sub(this.joint.cachedReference.parentObject.position).dot2D(this.joint.joint.options.axis)&&(this.joint.joint.options.lowerTranslation*=-1),0<this.joint.joint.options.anchorB.clone().sub(this.joint.cachedReference.parentObject.position).dot2D(this.joint.joint.options.axis)&&(this.joint.joint.options.upperTranslation*=-1))}});a.restore()};return m}();return L}();pyro=new Pyro;
(function(){for(var w=0,L=["ms","moz","webkit","o"],R=0;R<L.length&&!window.requestAnimationFrame;++R)window.requestAnimationFrame=window[L[R]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[L[R]+"CancelAnimationFrame"]||window[L[R]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(L,R){var D=(new Date).getTime(),P=Math.max(0,16-(D-w)),fa=window.setTimeout(function(){L(D+P)},P);w=D+P;return fa});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(w){clearTimeout(w)})})();console||(console={log:function(){},group:function(){}});console.group||(console.warn=function(w){console.log(w)});console.group||(console.group=function(w){console.log(w)});console.groupEnd||(console.groupEnd=function(){});console.groupCollapsed||(console.groupCollapsed=function(w){console.log(w)});window.performance=window.performance||{};
performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();Number.prototype.round=function(w){w=1>w?1/w:Math.pow(10,w);return Math.round(this*w)/w};Storage&&(Storage.prototype.setObject=function(w,L){this.setItem(w,JSON.stringify(L))},Storage.prototype.getObject=function(w){return(w=this.getItem(w))&&JSON.parse(w)});
